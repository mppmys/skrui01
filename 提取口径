联通系统集成有限公司数据提取组
模型常用口径说明文档

公司名称：思柯瑞
1、但凡涉及到用户数就要用到count(user_id) cnt
2、但凡涉及到业务域得到东西就要在子表中sum(流量、收入)、group by(user_id) 
3、CB表是4G和宽带总表--
在取4G的时候一定要限定SERVICE_TYPE = '40AAAAAA'
NM表是2、3、4G全量表
4、DWA_V_M 是月表，DWA_V_D 是日表
5、在NM用户表要限制RN = 1（求用户数加上，收入类不加）
6、在CB表里如果要用号码关联要自己加上
ROW_NUMBER() OVER(PARTITION BY DEVICE_NUMBER ORDER BY IS_INNET,INNET_DATE DESC) RN
过滤重复记录 避免1对多
7、表全是在33库建立，要看表字段的话在33库上
8、在抽数的时候要考虑表中是不是存在多条记录
9、流失用户不能按表里是否流失字段 上个月出账本月不出帐的用户才是流失用户
10、发展用户、离网用户一般都取 是否本月新XXX 这个字段
11、去出账收入的时候 不能限制is_acct 字段
12、短信：取点对点通信
13、挂job要在dbms_jobs里挂 具体挂job语句参考job文档
14、2g/3g 转4g的时候user_id会变，要用中间表list表关联
15、净增：本月出账数减去上月出账数
16、经分系统指标 可以在可以在ZBA_DM_MAN.DMCODE_COMP_KPI@DSSMSS_DA表中找 COMP_KPI_CODE --对应指标id
17、虚拟运营商：VOP –单独一块 不属于联通运营 不计入联通的实名认证
18、宽带：接入分类比较重要:WLAN：无限局域网、XDSL：数字用户线路、FTTH：：光纤到户、LAN：局域网、HFC：有线电视网
19、is_card 0为手机用户 1为上网卡用户 2为2/3g融合用户
20、套内流量：2i产品用：总流量-收费流量=套内流量
定向流量也算套内 具体加不加 跟业务部门沟通清楚
其他产品基本是
SUM(NVL(C.PROD_IN_LOCAL_FLUX, 0) + NVL(C.PROD_IN_ROAM_CONT_FLUX, 0) +
           NVL(C.PROD_IN_ROAM_GAT_FLUX, 0) +
           NVL(C. PROD_IN_ROAM_INT_FLUX, 0))
如果不清楚 跟业务沟通确认后再取



客户域
	主要包括发展客户数、离网客户数、网上用户数、出账用户数、离网用户数、三无用户数、解除用户数、用户出账率、用户离网率等基本指标
移动业务
目前有两种方式统计移动业务：按照套餐分类、按照用户使用网络分类
按照套餐分类
按照用户使用的套餐进行分类
CBSS套餐
公共部分（手机、上网卡通用）
维度


4G套餐分类
指4G手机用户订购的4G套餐类型。

取ZBG_DWA.DWA_V_M_CUS_CB_USER_INFO_PROV（cBSS用户资料表)的PRODUCT_CLASS字段，与ZBG_DIM.DIM_PRODUCT_CLASS@LINK_DSSDWE （套餐码表）中 PRODUCT_CLASS 字段进行关联，利用码表中DIM_1字段对用户进行分类。

利用DIM_1字段对用户进行分类的SQL如下：

SELECT CASE
         WHEN C.DIM_1 LIKE '01%' THEN
          '全国套餐'
         WHEN C.DIM_1 LIKE '02%' THEN
          '共享套餐'
         WHEN C.DIM_1 LIKE '0301%' THEN
          '全国组合套餐'
         WHEN C.DIM_1 LIKE '0302%' THEN
          '本地组合套餐'
         WHEN C.DIM_1 LIKE '0304%' THEN
          '共享组合套餐'
         WHEN C.DIM_1 LIKE '03%' THEN
          '其他组合套餐'
         WHEN C.DIM_1 LIKE '04%' THEN
          '校园套餐'
         WHEN C.DIM_1 LIKE '05%' THEN
          '本地套餐'
         WHEN C.DIM_1 LIKE '06%' THEN
          '智慧沃家共享'
         WHEN C.DIM_1 LIKE '07%' THEN
          '全国数据卡'
         WHEN C.DIM_1 LIKE '08%' THEN
          '本地数据卡'
         WHEN C.DIM_1 LIKE '09%' THEN
          '本地语音'
         WHEN C.DIM_1 LIKE '10%' THEN
          '本地行业'
         WHEN C.DIM_1 LIKE '11%' THEN
          '4G本地个性化'
         WHEN C.DIM_1 LIKE '12%' THEN
          '4G本地迁转'
         ELSE
          NVL(C.DIM_1_DESC, '其他4G套餐')
       END PRODUCT_CLASS --套餐分类名称
  FROM ZBG_DIM.DIM_PRODUCT_CLASS@LINK_DSSDWE C
 WHERE SERVICE_TYPE = '40AAAAAA'
   AND IS_CBSS = '1';
--其余分类
--4G校园小区套餐
SELECT *
  FROM ZBG_DIM.DIM_PRODUCT_CLASS@LINK_DSSDWE
WHERE SERVICE_TYPE = '40AAAAAA'
AND IS_CBSS = '1'
AND DIM_1 LIKE '0401%';
--4G校园非小区套餐
SELECT *
  FROM ZBG_DIM.DIM_PRODUCT_CLASS@LINK_DSSDWE
WHERE SERVICE_TYPE = '40AAAAAA'
AND IS_CBSS = '1'
AND DIM_1 LIKE '0402%';
4G套餐月费
指4G手机用户订购的套餐每月的包月费(最低消费)
取数SQL如下:

SELECT T1.USER_ID,
       CASE
         WHEN T2.DIM_1 LIKE '0301%' THEN --全国组合套餐
          (NVL(T3.FLUX_MON_FEE, 0) + NVL(T3.VOICE_MON_FEE, 0)) * 0.8 +
          NVL(T3.SMS_MON_FEE, 0)
         WHEN T2.DIM_1 LIKE '0302%' THEN --本地组合套餐
          NVL(T3.FLUX_MON_FEE, 0) * 0.8 + NVL(T3.VOICE_MON_FEE, 0) +
          NVL(T3.SMS_MON_FEE, 0)
         WHEN T2.DIM_1 LIKE '03%' THEN --其他组合套餐
          NVL(T3.FLUX_MON_FEE, 0) + NVL(T3.VOICE_MON_FEE, 0) +
          NVL(T3.SMS_MON_FEE, 0)
         ELSE --除了组合套餐外的4G套餐
          T2.PROD_MON_FEE
       END MON_FEE
  FROM (SELECT *
          FROM ZBG_DWA.DWA_V_M_CUS_CB_USER_INFO_011@LINK_DSSDWE T
         WHERE IS_STAT = '1'
           AND SERVICE_TYPE = '40AAAAAA'
           AND MONTH_ID = '201505') T1, --用户资料表中筛选201505账期4G统计用户
       (SELECT C.PRODUCT_CLASS,
               C.DIM_1,
               R.CALL_DURA,
               R.FLUX_M,
               C.MON_FEE       PROD_MON_FEE,
               F.MON_FEE,
               F.CALL_FTFEE    VOICE_MON_FEE,
               F.FLUX_FTFEE    FLUX_MON_FEE
          FROM ZBG_DIM.DIM_PRODUCT_CLASS@LINK_DSSDWE C,
               ZBG_DIM.DIM_PRODUCT_VALUE@LINK_DSSDWE R,
               TEMP_4G_PRODUCT_FTFEE                 F
         WHERE C.SERVICE_TYPE = '40AAAAAA'
           AND C.IS_CBSS = '1'
           AND C.PRODUCT_CLASSIFY_VALUE = R.PRODUCT_CLASS(+)
           AND C.PRODUCT_CLASS = F.PRODUCT_CLASS(+)) T2,
       (SELECT C.USER_ID,
               R1.MON_FEE   FLUX_MON_FEE,
               R1.PKG_VALUE FLUX_M,
               R2.MON_FEE   VOICE_MON_FEE,
               R2.PKG_VALUE CALL_DURA,
               R3.MON_FEE   SMS_MON_FEE,
               R3.PKG_VALUE SMS_M
          FROM (SELECT *
                  FROM ZBG_DWA.DWA_V_M_CUS_CB_DIY_PACKAGE_011@LINK_DSSDWE
                 WHERE SERVICE_TYPE = '40AAAAAA'
                   AND MONTH_ID = '201505') C,
               ZBG_DIM.DIM_CBSS_DISCNT_CODE@LINK_DSSDWE R1,
               ZBG_DIM.DIM_CBSS_DISCNT_CODE@LINK_DSSDWE R2,
               ZBG_DIM.DIM_CBSS_DISCNT_CODE@LINK_DSSDWE R3
         WHERE C.FLUX_PKG = R1.DISCNT_CODE(+)
           AND C.VOICE_PKG = R2.DISCNT_CODE(+)
           AND C.SMS_MMS_PKG = R3.DISCNT_CODE(+)) T3 --DIY
 WHERE T1.PRODUCT_CLASS = T2.PRODUCT_CLASS(+)
   AND T1.USER_ID = T3.USER_ID(+)
入网时间
新办理入网，开始使用联通业务的时间。
取ZBG_DWA.DWA_V_M_CUS_CB_USER_INFO_PROV（cBSS用户基本衍生信息表) 的INNET_DATE字段。
发展渠道类型
指用户的入网渠道，该用户是通过什么渠道被发展为联通用户的。

通过ZBG_DWA.DWA_V_M_CUS_CB_USER_INFO_PROV（cBSS用户资料表)的CHANNEL_ID字段，与ZB_DWD.DWD_M_MRT_AL_BSDM_CHANNEL_S（渠道信息汇总表） 中 CHNL_ID 字段进行关联，
取渠道信息汇总表中CHNL_KIND_ID 对渠道进行分类。

CHNL_KIND_ID所代表的渠道类型，可通过与ZB_DIM.DIM_CHANNEL_TYPE_BSDM（渠道归类信息码表）中LEVEL_3字段关联取出。
归集标签
取用户资料表中的USER_ID字段，与 ZBA_DWD.DWD_M_PRD_AL_GC_USER_FLAG_PROV（集客标签表） 中 USER_ID 进行关联，取集客标签表中BELONG_FLAG字段，无需限定其他条件，取值为0集团，1和空为公众。

注意：
集客标签表ZBA_DWD.DWD_M_PRD_AL_GC_USER_FLAG_PROV数据从201308账期开始具备
用户群标签
取ZBA_DWD.DWD_M_PRD_AL_GC_USER_FLAG表的USER_GROUP_FLAG，0为集团客户，空和1为公众用户，与用户资料表的关联方法详见归集标签部分。
中小企业（只针对集客用户）
首先限定集客用户（集客用户取法详见归集标签部分），
再通过USER_ID与ZBA_DWA.DWA_V_M_CUS_AL_GC_RELATION模型关联，利用该模型中CUST_SIZE来区分用户的企业类型。

利用CUST_SIZE区分用户企业类型的方法如下：
DECODE(CUST_SIZE,'1','小微','2','中小企业','3','大客户','其他')
是否实名制
判断联通用户是否进行了实名登记。
通过ZBG_DWA.DWA_V_M_CUS_CB_USER_INFO_PROV（cBSS用户资料表)的USER_ID，
与表ZBG_DWA.DWA_V_M_CUS_CB_RNS_WIDE@LINK_DSSDWE的SUBS_INSTANCE_ID相关联，
取该表IS_VALID_FLAG字段，无需限定其他条件，取值为“1”表示“是实名制” 。

用户使用的卡类型
卡类型分为SIM卡和USIM卡。

通过ZBG_DWA.DWA_V_M_CUS_CB_USER_INFO_PROV（cBSS用户资料表)的USER_ID，
与表ZBG_DWA.DWA_V_M_CUS_CB_URES_PROV@LINK_DSSDWE的USER_ID相关联，
取该表CARD_TYPE字段即可。

客户信息
指办理使用联通业务的客户的信息。

通过ZBG_DWA.DWA_V_M_CUS_CB_USER_INFO_PROV（cBSS用户资料表）的CUST_ID（客户ID）字段，关联如下表CUST_ID字段，获取姓名、证件类型、证件号码：
SELECT CUST_ID, 
CUST_NAME, --客户名称
        PSPT_TYPE CERT_TYPE, --证件类型
        PSPT_ID CERT_NO--证件号码,可以自己解析用户年龄，身份证
  FROM ZBG_DWD.DWD_M_CUS_CB_CUSTOMER_079@LINK_DSSDWE
 WHERE MONTH_ID = '201603';

通过ZBG_DWA.DWA_V_M_CUS_CB_USER_INFO_PROV（cBSS用户资料表）的CUST_ID（客户ID）字段，关联如下表CUST_ID字段，获取客户性别、年龄：
SELECT T.CUST_ID,
       T.CERT_TYPE,
       T.CUST_SEX,--1,男;2,女
       T.CERT_AGE--年龄
  FROM ZBG_DWA.DWA_V_M_CUS_CB_RNS_079@LINK_DSSDWE T--客户实名衍生信息(月)，除了客户姓名、年龄外，该表中还有证件号码，但是加密的，不可用
 WHERE MONTH_ID='201603' 
AND CERT_TYPE IN ('0101', '0102', '0108')
      AND CERT_NO_IS_VALID='1' 

通过ZBG_DWA.DWA_V_M_CUS_CB_USER_INFO_PROV（cBSS用户资料表）的USER_ID（用户ID）字段，关联如下表USER_ID字段，获取客户性别、年龄：
SELECT SUBS_INSTANCE_ID USER_ID, 
       CUST_SEX, --1,男;2,女
       CERT_AGE
  FROM ZBG_DWA.DWA_V_M_CUS_CB_RNS_WIDE@LINK_DSSDWE
 WHERE PROV_ID = '&PROV_ID'
   AND MONTH_ID = '&MONTH_ID'
   AND IS_VALID_FLAG = '1'
VIP级别
通过ZBG_DWA.DWA_V_M_CUS_CB_USER_INFO_PROV（cBSS用户资料表)的USER_ID，与如下表USER_ID相关联，取VIP_LEVEL字段即可。
VIP_LEVEL取值代表的含义为：02：钻石卡 03：金卡 04：银卡，这三类均归为VIP用户。

SELECT /*+parallel(T9,2)*/
 USER_ID, VIP_LEVEL
  FROM ZBG_DWA.DWA_V_M_CUS_CB_VIP_INFO_011@LINK_DSSDWE T9
 WHERE IS_VIP_VALID = '1'
   AND VIP_LEVEL IN ('02', '03', '04')
   AND SERVICE_TYPE = '40AAAAAA'
   AND MONTH_ID = '201505'
红黑名单
判断联通用户是否红黑名单。
通过ZBG_DWA.DWA_V_M_CUS_CB_USER_INFO_PROV（cBSS用户资料表)的USER_ID，
与表ZBG_DWD.DWD_D_CUS_CB_CUST_SPECLIST_011@LINK_DSSDWE的CUST_ID相关联

SELECT CUST_ID
  FROM ZBG_DWD.DWD_D_CUS_CB_CUST_SPECLIST_011@LINK_DSSDWE A
 WHERE A.MONTH_ID = '201606'
   AND A.DAY_ID = SUBSTR(TO_CHAR(ADD_MONTHS(TO_DATE('201606', 'YYYYMM'), 1) - 1, 'YYYYMMDD'), 7, 2) --取日最后一天
   AND LIST_TYPE IN ('01', '02')--01红名单02黑名单
 GROUP BY CUST_ID
;
终端类型
注意：三无用户不应该区分终端类型，所以在判断终端类型时判断是否是三无用户

Select 
CASE WHEN T3.ONEIN1MON_NET_TYPE_REV = '02' AND T_3WU.USER_ID IS NULL
              THEN   '2G'
            WHEN T3.ONEIN1MON_NET_TYPE_REV = '03' AND T_3WU.USER_ID IS NULL
              THEN  '3G'
            WHEN T3.ONEIN1MON_NET_TYPE_REV = '04' AND T_3WU.USER_ID IS NULL
              THEN  '4G'
       ELSE '无法识别' END ZD_TYPE   --终端类型

From 
 (SELECT  t.user_id,'A'||t.user_id  user_id_new, t.CHANNEL_ID,t.IS_THIS_BREAK,t.IS_ACCT IS_THIS_ACCT,t.is_innet,
             substr(t.innet_date,0,6) innet_date,t.PRODUCT_ID,INNET_MONTHS,'4G' yw,is_card,device_number
              FROM ZBG_DWA.DWA_V_M_CUS_CB_USER_INFO_'010'@LINK_DSSDWE T --4G用户资料表
             WHERE MONTH_ID =  '201708'
               AND T.IS_STAT = '1'
               AND t.IS_INNET='1'
               AND IS_CARD='0'--手机用户
               AND T.service_type='40AAAAAA'
               AND SUBSTR(DEVICE_NUMBER,1,4) NOT IN ('1454','1457')--去除物联网
             ) T1,--4G用户资料表
  (SELECT USER_ID, --带着A的
             ONEIN1MON_NET_TYPE_REV-- 00=无法区分，04=4G、03=3G、02=2G
         FROM ZBG_DWA.DWA_V_M_CUS_ALL_ZCTMF2_'010'@LINK_DSSDWE
          WHERE MONTH_ID =  '201708'
              AND SERVICE_TYPE like '40%' --套餐类型 2G套餐：LIKE '20%'；3G套餐：LIKE '30%'；4G套餐：LIKE '40%'；
                    )T3--关联使用终端类型表

where  T1.user_id_new=T3.user_id(+)--关联使用终端类型表
2I2C产品

注意:2I2C包括2I和冰激凌。只有4G有2I2C。
Product_class 或product_id都可以，因为2I产品都是4G用户，这两个选项是一样的。
集成的码表是 
SELECT * FROM TEMP_JC_2I_PRODUCT_CLASS
国信的码表是 
SELECT * FROM ZBG_DM.DIM_2I_PRO@LINK_DSSDWE
其中如果限制FLAG = '1' 就是冰激凌套餐，其余的是2I产品。
也可以直接从码表中直接取冰激凌套餐

承诺低消送流量
select  
 CASE WHEN t5.USER_ID IS NOT NULL   THEN '1'  ELSE  '0'  end IS_CNDX  --是否办理承诺低消送流量

from
    (SELECT  t.user_id,'A'||t.user_id  user_id_new, t.CHANNEL_ID,t.IS_THIS_BREAK,t.IS_ACCT IS_THIS_ACCT,t.is_innet,
             substr(t.innet_date,0,6) innet_date,t.PRODUCT_ID,INNET_MONTHS,'4G' yw,is_card,device_number
              FROM ZBG_DWA.DWA_V_M_CUS_CB_USER_INFO_011@LINK_DSSDWE T --4G用户资料表
             WHERE MONTH_ID =  '201708'
               AND T.IS_STAT = '1'
               AND T.service_type='40AAAAAA'
             ) T1,--4G用户资料表

     (SELECT *
          FROM (SELECT  USER_ID,
                       AREA_ID,
                       SERVICE_TYPE,
                       IS_THIS_DEV,
                       IS_INNET,
                       IS_ACCT,
                       CASE
                         WHEN PRODUCT_CLASS LIKE '%流量王A%' THEN
                          '01'
                         WHEN PRODUCT_CLASS LIKE '%日租卡%' THEN
                          '03'
                         WHEN PRODUCT_CLASS LIKE '%4G+4K%' THEN
                          '04'
                         WHEN PRODUCT_CLASS LIKE '%包%' THEN
                          '05'
                         ELSE
                          '02'
                       END PRODUCT_CLASS,
                       ROW_NUMBER() OVER(PARTITION BY USER_ID ORDER BY PRODUCT_CLASS, EFFECT_DATE DESC) RN
                  FROM ZBG_DWA.DWA_V_M_CUS_CB_139_011@LINK_DSSDWE
                 WHERE MONTH_ID =  '201708')
         WHERE RN = 1
           AND PRODUCT_CLASS = '02')  T5--4G是否办理承诺低消送流量
 WHERE  T1.USER_ID =  T5.USER_ID(+)
用户星级
注意预评级也需要算在内，需要判断转往前是否被评过星级。三星及以上星级用户属于高价值用户。

------4G
select  
   case when T6.user_id is not null then t6.USER_LEVEL
            when t7.user_id is not null then '0'||t7.USER_LEVEL
            else null end USER_LEVEL--用户星级
from
    (SELECT  t.user_id,'A'||t.user_id  user_id_new, t.CHANNEL_ID,t.IS_THIS_BREAK,t.IS_ACCT IS_THIS_ACCT,t.is_innet,
             substr(t.innet_date,0,6) innet_date,t.PRODUCT_ID,INNET_MONTHS,'4G' yw,is_card,device_number
              FROM ZBG_DWA.DWA_V_M_CUS_CB_USER_INFO_011@LINK_DSSDWE T --4G用户资料表
             WHERE MONTH_ID =  '201708'
               AND T.IS_STAT = '1'
               AND T.service_type='40AAAAAA'
             ) T1,--4G用户资料表

 (SELECT USER_ID, USER_LEVEL
           FROM (SELECT USER_ID,USER_LEVEL,
                        ROW_NUMBER() OVER(PARTITION BY USER_ID ORDER BY MONTH_ID DESC NULLS LAST) RN
                   FROM ZBG_DWA.DWA_V_M_CUS_CBM_VALUE_LIST_011@LINK_DSSDWE --CBSS用户价值评级模型
                  WHERE MONTH_ID >= '201505' --固定值
                    AND MONTH_ID <=  '201708')
           WHERE RN = 1) T6, --CBSS用户价值评级模型
         (SELECT A.USER_ID,A.USER_LEVEL,B.USER_ID_CBSS
            FROM (SELECT USER_ID, USER_LEVEL
                    FROM (SELECT USER_ID,USER_LEVEL,
                                 ROW_NUMBER() OVER(PARTITION BY USER_ID ORDER BY MONTH_ID DESC NULLS LAST) RN
                            FROM ZBG_DWA.MID1_V_M_CUS_MB_VALUE_LIST_011@LINK_DSSDWE
                           WHERE MONTH_ID >= '201505' --固定值
                             AND MONTH_ID <=  '201708')
                   WHERE RN = 1) A,   --BSS用户价值评级模型
             (SELECT USER_ID_CBSS,USER_ID_PROV
                    FROM ZBG_DWD.DWD_M_PRD_CB_USER_LIST_011@LINK_DSSDWE T
                   WHERE T.MONTH_ID =  '201708'
                     AND T.CYCLE_ID <=  '201708') B
        WHERE A.USER_ID = B.USER_ID_PROV) T_67, --23G转换表 BSS用户价值评级模型
         (SELECT USER_ID,USER_LEVEL
                    FROM ZBG_DWA.DWA_V_M_CUS_CBM_VALUE_011@LINK_DSSDWE --CBSS用户价值评级模型
                   WHERE MONTH_ID =  '201708' --固定值
                              ) T7 --预评级
    
            WHERE  T1.USER_ID = T6.USER_ID(+) 
             AND   T1.USER_ID = T7.USER_ID(+)
疑似养卡
一般是判定6个月内是否养卡，新增用户当月是否养卡。
疑似养卡表 从201601才开始有数据，如果账期-5话，数据会不全。2016-201604月的数据量少，不全。

------4G
select  
           CASE  when T_10.user_id is not null then '1' ELSE '0' END IS_RAIS,--是否疑似养卡
 
from
    (SELECT  t.user_id,'A'||t.user_id  user_id_new, t.CHANNEL_ID,t.IS_THIS_BREAK,t.IS_ACCT IS_THIS_ACCT,t.is_innet,
             substr(t.innet_date,0,6) innet_date,t.PRODUCT_ID,INNET_MONTHS,'4G' yw,is_card,device_number
              FROM ZBG_DWA.DWA_V_M_CUS_CB_USER_INFO_011@LINK_DSSDWE T --4G用户资料表
             WHERE MONTH_ID =  '201708'
               AND T.IS_STAT = '1'
               AND T.service_type='40AAAAAA'
             ) T1,--4G用户资料表
 
        (SELECT SUBS_INSTANCE_ID user_id FROM
       (SELECT T.*,
               ROW_NUMBER() OVER(PARTITION BY T.SUBS_INSTANCE_ID ORDER BY MONTH_ID desc,INNET_DATE DESC, SERVICE_TYPE DESC NULLS LAST) RN
          FROM ZB_CSM.DWA_DEV_RAISED T
         WHERE  MONTH_ID BETWEEN '201703' AND  '201708'
               AND PROV_ID ='011'
               AND SERVICE_TYPE NOT LIKE ''40%''--不是4G
               AND  user_type <> ''真实''
               ) WHERE RN=1) t_10--6个月内是否疑似养卡
            WHERE  T1.USER_ID = T10.USER_ID(+) 

指标
4G剔除降欠用户
剔除降欠口径：降欠挂账出帐费用为0，且正常出帐费用大于0的4G出账用户。
 OWE_BILL_FLAG 0：--正常账单
                  1：--降欠挂账账单
                  2: --降欠回收账单

SELECT T2.USER_ID, '4G' NET_TYPE, T3.NOMAL_TOTAL_FEE
  FROM (SELECT USER_ID
          FROM ZBG_DWA.DWA_V_M_CUS_CB_USER_INFO_011@LINK_DSSDWE
         WHERE SERVICE_TYPE = '40AAAAAA'
           AND IS_STAT = '1'
           AND IS_ACCT = '1'
           AND MONTH_ID = '201506') T2,
       (SELECT USER_ID,
               SUM(CASE
                     WHEN OWE_BILL_FLAG = 0 THEN
                      ACCT_FEE
                     ELSE
                      0
                   END) NOMAL_TOTAL_FEE, --正常出帐费用（0）
               SUM(CASE
                     WHEN OWE_BILL_FLAG = 1 THEN
                      ACCT_FEE
                     ELSE
                      0
                   END) JQ_FEE --降欠挂账出帐费用(1)
          FROM ZBG_DWA.DWA_S_M_ACC_CB_CHARGE_011@LINK_DSSDWE
         WHERE MONTH_ID = '201506'
         GROUP BY USER_ID) T3
 WHERE T2.USER_ID = T3.USER_ID(+)
   AND T3.JQ_FEE = 0
   AND T3.NOMAL_TOTAL_FEE > 0
4G计费收入日表
----- --4G日表计费收入
SELECT
  '''||V_MONTH_ID||''',
   '''||V_DAY_ID||''',
   '''||V_PROV_ID||''' ,
 T_USER.IS_INNET,--是否在网
 T_USER.IS_THIS_DEV,--是否新发展
 T_USER.IS_ADD, --新增
 T_USER.IS_CARD,--手机上网卡
 T_USER.SERVICE_TYPE, --业务类型,4G
 T_CHANNEL.CHNL_KIND_ID,--渠道
 T_USER.PRODUCT_ID,--产品ID
 T_USER.PRODUCT_CLASS,
 SUM(NVL(T_FEE.TOTAL_FEE,0)),--计费收入
 COUNT(1) USER_NUM --用户数
FROM
(SELECT * FROM ZBG_DWA.DWA_V_D_CUS_CB_USER_INFO_'||V_PROV_ID||'@LINK_DSSDWE T
           WHERE T.IS_STAT = ''1''
           AND T.MONTH_ID='''||V_MONTH_ID||'''
           AND T.DAY_ID='''||V_DAY_ID||'''--日期
           AND T.SERVICE_TYPE LIKE ''40%'' )T_USER,--4G日用户资料表
(SELECT USER_ID,NVL(T.TOTAL_FEE,0) TOTAL_FEE
        FROM ZBG_DWA.DWA_V_D_CUS_CB_CHARGE_'||V_PROV_ID||'@LINK_DSSDWE T
        WHERE  MONTH_ID = '''||V_MONTH_ID||'''
            AND DAY_ID = '''||V_DAY_ID||'''
                           )T_FEE, --计费收入日表
(SELECT CHNL_KIND_ID, CHNL_ID
             FROM ZB_DWD.DWD_D_MRT_AL_BSDM_CHANNEL_S  T10
            WHERE MONTH_ID = '''||V_MONTH_ID||'''
               AND PROV_ID = '''||V_PROV_ID||'''
               AND DAY_ID='''||V_DAY_ID||''') T_CHANNEL --4G集中渠道渠道类型
 WHERE T_USER.USER_ID=T_FEE.USER_ID(+) --计费收入
   AND T_USER.CHANNEL_ID  = T_CHANNEL.CHNL_ID(+)--渠道
   GROUP by   T_USER.IS_INNET,--是否在网
 T_USER.IS_THIS_DEV,--是否新发展 可以与页面对起来
  T_USER.IS_ADD, --新增
 T_USER.IS_CARD,--手机上网卡
 T_USER.SERVICE_TYPE, --业务类型,4G
 T_CHANNEL.CHNL_KIND_ID,--渠道
 T_USER.PRODUCT_ID ,--产品ID
 T_USER.PRODUCT_CLASS


手机
维度
4G分合约
指4G手机用户与联通公司签订的合约类型。

注意：取当期新增和离网用户的合约时都不能限制合约表里的合约有效，因为当期新增的用户合约可能没有生效，当期离网的用户合约可能在当期已经无效了。新增用户分合约时合约表取当期新增的合约，离网用户分合约时合约表取当期离网的合约。

合约表中ACTIVITY_TYPE字段对应的合约分类如下：
其中，需注意ACTIVITY_TYPE = '05' 表示“总部其他活动”，应和'04'一起归为单卡
CASE
   WHEN ACTIVITY_TYPE = '01' THEN
    '存费送机'
   WHEN ACTIVITY_TYPE = '02' THEN
    '购机送费'
   WHEN ACTIVITY_TYPE = '03' THEN
    '存费送费'
   WHEN ACTIVITY_TYPE IN ('06', '07', '08', '09') THEN
    '存费送业务'
   WHEN ACTIVITY_TYPE = '12' THEN
    '合约惠机'
   ELSE
    '单卡'
 END

分合约取数SQL如下：
出账用户和网上用户
SELECT NVL(B.ACTIVITY_TYPE, '04') ACTIVITY_TYPE,
       SUM(A.IS_ACCT) ACCT_NUM,
       SUM(A.IS_INNET) INNET_NUM
  FROM (SELECT /*+parallel(T,2)*/
         *
          FROM ZBG_DWA.DWA_V_M_CUS_CB_USER_INFO_011@LINK_DSSDWE T
         WHERE MONTH_ID = '201409'
           AND IS_STAT = '1'
           AND SERVICE_TYPE = '40AAAAAA'
           AND IS_CARD = '0') A,
       (SELECT USER_ID, ACTIVITY_TYPE, IS_THIS_ADD
          FROM ZBG_DWA.DWA_V_M_CUS_CB_ACT_INFO_011@LINK_DSSDWE T
         WHERE MONTH_ID = '201409'
           AND IS_VALID = '1'
           AND ACTIVITY_TYPE IN
               (SELECT ACTIVITY_TYPE
                  FROM ZBG_DIM.DIM_CBSS_ACTIVITY_TYPE@LINK_DSSDWE
                 WHERE IS_VALID = '1'
                   AND ACTIVITY_TYPE <> '04')) B
 WHERE A.USER_ID = B.USER_ID(+)
 GROUP BY NVL(B.ACTIVITY_TYPE, '04')

新增用户
SELECT NVL(B.ACTIVITY_TYPE, '04') ACTIVITY_TYPE,
       SUM(A.IS_ADD) ADD_NUM
  FROM (SELECT /*+parallel(T,2)*/
         *
          FROM ZBG_DWA.DWA_V_M_CUS_CB_USER_INFO_011@LINK_DSSDWE T
         WHERE MONTH_ID = '201409'
           AND IS_STAT = '1'
           AND SERVICE_TYPE = '40AAAAAA'
           AND IS_CARD = '0'
           AND IS_ADD = '1') A,
       (SELECT USER_ID, ACTIVITY_TYPE, IS_THIS_ADD
          FROM ZBG_DWA.DWA_V_M_CUS_CB_ACT_INFO_011@LINK_DSSDWE T
         WHERE MONTH_ID = '201409'
           AND IS_CARD = '0'
           AND IS_THIS_ADD = '1'
           AND ACTIVITY_TYPE IN
               (SELECT ACTIVITY_TYPE
                  FROM ZBG_DIM.DIM_CBSS_ACTIVITY_TYPE@LINK_DSSDWE
                 WHERE IS_VALID = '1'
                   AND ACTIVITY_TYPE <> '04')) B
 WHERE A.USER_ID = B.USER_ID(+)
GROUP BY NVL(B.ACTIVITY_TYPE, '04')
离网用户
SELECT NVL(B.ACTIVITY_TYPE, '04') ACTIVITY_TYPE,
       SUM(A.IS_ADD) ADD_NUM
  FROM (SELECT /*+parallel(T,2)*/
         *
          FROM ZBG_DWA.DWA_V_M_CUS_CB_USER_INFO_011@LINK_DSSDWE T
         WHERE MONTH_ID = '201409'
           AND IS_STAT = '1'
           AND SERVICE_TYPE = '40AAAAAA'
           AND IS_CARD = '0'
           AND IS_THIS_BREAK = '1') A,
       (SELECT USER_ID, ACTIVITY_TYPE, IS_THIS_ADD
          FROM ZBG_DWA.DWA_V_M_CUS_CB_ACT_INFO_011@LINK_DSSDWE T
         WHERE MONTH_ID = '201409'
           AND IS_CARD = '0'
           AND IS_THIS_BREAK = '1'
           AND ACTIVITY_TYPE IN
               (SELECT ACTIVITY_TYPE
                  FROM ZBG_DIM.DIM_CBSS_ACTIVITY_TYPE@LINK_DSSDWE
                 WHERE IS_VALID = '1'
                   AND ACTIVITY_TYPE <> '04')) B
 WHERE A.USER_ID = B.USER_ID(+)
GROUP BY NVL(B.ACTIVITY_TYPE, '04')



指标
出账用户数
指报告期内出账账单金额大于零的用户数
SELECT SUM(1)
  FROM ZBG_DWA.DWA_V_M_CUS_CB_USER_INFO_011@LINK_DSSDWE T
 WHERE IS_STAT = '1'
   AND IS_CARD = '0'            --0手机；1上网卡
   AND SERVICE_TYPE = '40AAAAAA'--4G业务
   AND MONTH_ID = '201505'
   AND IS_ACCT = '1'
新增用户数
指报告期内新开通联通某项业务（比如4G业务）的用户数（新增用户=新发展用户+业务互转用户+其他新增用户）
SELECT SUM(1)
  FROM ZBG_DWA.DWA_V_M_CUS_CB_USER_INFO_011@LINK_DSSDWE T
 WHERE IS_STAT = '1'
   AND IS_CARD = '0'            --0手机；1上网卡
   AND SERVICE_TYPE = '40AAAAAA'--4G业务
   AND MONTH_ID = '201505'
   AND IS_ADD = '1'

新发展用户数
指报告期内新办理入网，开始使用联通业务，占用中国联通资源的用户数
SELECT SUM(1)
  FROM ZBG_DWA.DWA_V_M_CUS_CB_USER_INFO_011@LINK_DSSDWE T
 WHERE IS_STAT = '1'
   AND IS_CARD = '0'            --0手机；1上网卡
   AND SERVICE_TYPE = '40AAAAAA'--4G业务
   AND MONTH_ID = '201505'
   AND IS_THIS_DEV = '1'
网上用户数
指报告期末在业务支撑系统中拥有注册信息、占用中国联通网络资源并且用户状态不为预开户、注销和删除期的用户总数。
SELECT SUM(1)
  FROM ZBG_DWA.DWA_V_M_CUS_CB_USER_INFO_011@LINK_DSSDWE T
 WHERE IS_STAT = '1'
   AND IS_CARD = '0'            --0手机；1上网卡
   AND SERVICE_TYPE = '40AAAAAA'--4G业务
   AND MONTH_ID = '201505'
   AND IS_INNET = '1'
流失用户
上月出账本月不出账用户，也有个别业务部门希望按照：上月在网本月不在网用户来计算，但一般不这样处理。
一般都是拍照观察，拍照上月出账的用户，观察在本月的出账情况
流失率=上月出账本月不出账用户/上月出账用户数

新入网用户—分渠道口径的，和集中渠道报表保持一致
可参照过程   P_TEMP_LJT_APP_NEW_N3
4G

SELECT ''A'' || USER_ID USER_ID,
               CHANNEL_ID,
               IS_CARD,
               is_innet,
               SUM(CASE
                     WHEN ADD_TYPE IN (''101'', ''105'', ''108'') THEN
                      1
                     ELSE
                      0
                   END) DEV_NUM
          FROM ZB_DWA.DWA_V_M_CUS_CB_USER_ADD_'||V_PROV||'
         WHERE MONTH_ID = '''||V_MONTH||'''
           AND SERVICE_TYPE = ''40AAAAAA''
         GROUP BY ''A'' || USER_ID, CHANNEL_ID,IS_CARD,is_innet
当期离网用户
SELECT *
     FROM ZBG_DWA.DWA_V_M_CUS_NM_USER_INFO_'||V_PROV||'@LINK_DSSDWE
        WHERE MONTH_ID = '''||V_MONTH||'''
      AND IS_STAT = ''1''
     And  is_this_break_old = ''1''

SELECT ''A''||USER_ID  USER_ID,  IS_ACCT, IS_INNET
  FROM ZBG_DWA.DWA_V_M_CUS_CB_USER_INFO_'||V_PROV||'@LINK_DSSDWE T
 WHERE IS_STAT = ''1''
   AND SERVICE_TYPE = ''40AAAAAA''--4G业务
AND IS_THIS_BREAK,=’’1’’
   AND MONTH_ID ='''||V_OBS_MONTH||'''

4G手机转网用户（新增转网）
由其他套餐（2G、3G）转为4G套餐的用户数。
口径一：与页面口径一致
注意：如下取法与经分页面（CBSS套餐—日关注—新增流失—CBSS手机新增用户—其中：转网用户—日累计）数据一致，具体转网用户的口径还需和用户沟通确定，不一定按照如下取法。
DM层取法：
SELECT SUM(SWITCH_USER)
  FROM ZBG_DM.DM_C_D_DEV_CB_NEW_CLASS@LINK_DSSDWE
 WHERE MONTH_ID = '201605'
   AND SERVICE_TYPE = '40AAAAAA'
AND PROV_ID = ‘010’; --DM层
DW层取法：
SELECT SUM(1)
  FROM ZBG_DWA.DWA_V_D_CUS_CB_USER_ADD_010@LINK_DSSDWE --DWA
 WHERE MONTH_ID = '201605'
   AND ADD_TYPE IN ('108', '221', '222', '223', '224', '225', '226')
口径二：利用转网表关联上月2G/3G用户资料表确定迁转4G用户数
如下SQL是当月3G转4G用户数的示例，在关联上月用户资料表时仅限制了统计用户，依据实际情况可能有所区别，仅供参考。
SELECT '201506', '011', COUNT(C.USER_ID) USER_3TO4G_NUM --当月3G转4G用户数
  FROM (SELECT /*+parallel(T,3)*/
         *
          FROM ZBG_DWA.DWA_V_M_CUS_CB_USER_INFO_011@LINK_DSSDWE T
         WHERE T.MONTH_ID = '201506'
           AND T.IS_STAT = '1'
           AND T.IS_ADD = '1'
           AND ADD_TYPE IN ('108', '221', '222', '223', '224', '225', '226')
           AND SERVICE_TYPE = '40AAAAAA') A,
       (SELECT T1.USER_ID_CBSS, T1.USER_ID_PROV
          FROM ZBG_DWD.DWD_M_PRD_CB_USER_LIST_011@LINK_DSSDWE T1
         WHERE T1.CYCLE_ID <= T1.MONTH_ID
           AND T1.MONTH_ID = '201506') B, --转网表
       (SELECT /*+parallel(T2,3)*/
         T2.USER_ID,
         T2.DEVICE_NUMBER,
         T2.IS_INNET,
         T2.IS_THIS_ACCT,
         T2.IS_CARD
          FROM ZBA_DWA.DWA_V_M_CUS_3G_USER_INFO_011 T2
         WHERE T2.MONTH_ID = '201505' --上月
           AND T2.IS_STAT = '1') C
 WHERE A.USER_ID = B.USER_ID_CBSS(+)
   AND B.USER_ID_PROV = C.USER_ID
4G半年包用户
SELECT /*+PARALLEL(A,8)*/
 '4G',
 RESOURCE_CODE,
 SUM(CASE
       WHEN RN = 1 THEN
        1
       ELSE
        0
     END) USER_NUM, --当月半年包用户数
 COUNT(RESOURCE_INS_ID) PKG_NUM, --当月半年包数
 SUM(CASE
       WHEN RN = 1 AND SUBSTR(START_DATE, 1, 6) = '201505' THEN
        1
       ELSE
        0
     END) USER_ADD,--当月新增订购半年包用户数
 SUM(CASE
       WHEN SUBSTR(START_DATE, 1, 6) = '201505' THEN
        1
       ELSE
        0
     END) PKG_ADD --当月新增半年包数
  FROM (SELECT A.USER_ID,
               RESOURCE_CODE,
               RESOURCE_INS_ID,
               START_DATE,
               ROW_NUMBER() OVER(PARTITION BY A.USER_ID ORDER BY START_DATE DESC) RN
          FROM (SELECT USER_ID, RESOURCE_CODE, RESOURCE_INS_ID, START_DATE
                  FROM ZBG_DWA.DWA_V_M_CUS_CB_RES_DEPOSIT_011@LINK_DSSDWE A
                 WHERE MONTH_ID = '201505'
                   AND VALID_FLAG = '1'
                   AND SUBSTR(END_DATE, 1, 6) >= '201505'
                   AND SUBSTR(START_DATE, 1, 6) <= '201505'
                   AND RESOURCE_CODE IN ('3001', '3002')) A, --3001:全国，3002：省内
               (SELECT USER_ID
                  FROM ZBG_DWA.DWA_V_M_CUS_CB_USER_INFO_011@LINK_DSSDWE
                 WHERE MONTH_ID = '201505'
                   AND IS_STAT = '1'
                   AND IS_INNET = '1'
                   AND SERVICE_TYPE = '40AAAAAA') B
         WHERE A.USER_ID = B.USER_ID) A
 GROUP BY RESOURCE_CODE

注意：
	半年包的表不是单用户表，存在一个用户订购多次，此表为全量数据，使用时按照实际情况加以限制。
三无用户
一般口径：非当月新发展且在网出账的三无用户。三无是指：指报告期内无通话行为、无流量详单和无点对点短信发送记录的网上用户。对应模型解释为总通话次数为0，使用流量为0，点对点短信条数为0。
注意:
	三无用户不应该区分终端类型，以后业务部门要的话也不能提供，因为三无用户没有使用量。
沉淀表：ZB_4G_3WU_USERS （该表不含上网卡）
极低用户
一般口径：非当月新发展，在网出账用户，使用流量<=3MB，主叫计费时长<=5分钟，点对点发送短信条数<=4条。
注意:
在201405账期以前，除了以上条件，还有用户价值小于52.8。
沉淀表：ZB_4G_LOWUSED_USERS （该表不含上网卡）
4G国际漫游到达用户

SERVICE_ID = '50015'--代表国际漫游业务
 IS_VALID = '1'  --代表已开通

SELECT COUNT(DISTINCT T1.BY_USER)
  FROM (SELECT DISTINCT USER_ID BY_USER
          FROM ZBG_DWD.DWD_M_PRD_CB_USER_SVC_079 @LINK_DSSDWE T --用户服务子表
         WHERE MONTH_ID = '201506' --本月开通
           AND SERVICE_ID = '50015'
           AND IS_VALID = '1') T1,
       
       (SELECT /*+PARALLEL (T,4)*/
         *
          FROM ZBG_DWA.DWA_V_M_CUS_CB_USER_INFO_079 @LINK_DSSDWE T
         WHERE MONTH_ID = '201506'
           AND SERVICE_TYPE = '40AAAAAA'
           AND IS_STAT = '1') T3
 WHERE  T1.BY_USER = T3.USER_ID
（特殊需求要求）4G新增国漫用户（本月开通上月未开通）
SELECT COUNT(DISTINCT T1.BY_USER)
  FROM (SELECT DISTINCT USER_ID BY_USER
          FROM ZBG_DWD.DWD_M_PRD_CB_USER_SVC_079 @LINK_DSSDWE T --用户服务子表
         WHERE MONTH_ID = '201506' --本月开通
           AND SERVICE_ID = '50015'
           AND IS_VALID = '1') T1,
       (SELECT DISTINCT USER_ID SY_USER
          FROM ZBG_DWD.DWD_M_PRD_CB_USER_SVC_079 @LINK_DSSDWE T --用户服务子表
         WHERE MONTH_ID = '201505' --上月开通
           AND SERVICE_ID = '50015'
           AND IS_VALID = '1') T2,
       (SELECT /*+PARALLEL (T,4)*/
         *
          FROM ZBG_DWA.DWA_V_M_CUS_CB_USER_INFO_079 @LINK_DSSDWE T
         WHERE MONTH_ID = '201506'
           AND SERVICE_TYPE = '40AAAAAA'
           AND IS_STAT = '1') T3
 WHERE T1.BY_USER = T2.SY_USER(+)
   AND T2.SY_USER IS NULL
   AND T1.BY_USER = T3.USER_ID
4G关闭国漫用户（上月开通本月未开通）准确
SELECT '201506', '079', COUNT(A.SY_USER) GB_USER --本月关闭
  FROM (SELECT T1.SY_USER
          FROM (SELECT DISTINCT USER_ID SY_USER, IS_VALID
                  FROM ZBG_DWD.DWD_M_PRD_CB_USER_SVC_079 @LINK_DSSDWE T --用户服务子表
                 WHERE MONTH_ID = '201505' --上月开通
                   AND SERVICE_ID = '50015'
                   AND IS_VALID = '1') T1,
               (SELECT DISTINCT USER_ID BY_USER
                  FROM ZBG_DWD.DWD_M_PRD_CB_USER_SVC_079 @LINK_DSSDWE T --用户服务子表
                 WHERE MONTH_ID = '201506' --本月开通
                   AND SERVICE_ID = '50015'
                   AND IS_VALID = '1') T2
         WHERE T1.SY_USER = T2.BY_USER(+)
           AND T2.BY_USER IS NULL) A,
       (SELECT /*PARALLEL (T,4)*/
         *
          FROM ZBG_DWA.DWA_V_M_CUS_CB_USER_INFO_079 @LINK_DSSDWE T
         WHERE MONTH_ID = '201506'
           AND SERVICE_TYPE = '40AAAAAA'
           AND IS_STAT = '1') B
 WHERE A.SY_USER = B.USER_ID
4G新增国漫用户(上月开通上月取消，本月重新开通为新增用户)

SELECT COUNT(T1.SY_USER)
  FROM (SELECT DISTINCT USER_ID SY_USER
          FROM ZBG_DWD.DWD_M_PRD_CB_USER_SVC_079 @LINK_DSSDWE T --用户服务子表
         WHERE MONTH_ID = '201506' –本月开通
           AND SERVICE_ID = '50015'
           AND IS_VALID = '1'
           AND SUBSTR(START_DATE, 1, 6) = '201506') T1,
       
       (SELECT /*PARALLEL (T,4)*/
         *
          FROM ZBG_DWA.DWA_V_M_CUS_CB_USER_INFO_079 @LINK_DSSDWE T
         WHERE MONTH_ID = '201506'
           AND SERVICE_TYPE = '40AAAAAA'
           AND IS_STAT = '1') T2
 WHERE T1.SY_USER = T2.USER_ID
上网卡
维度
指标
出账用户数
指报告期内出账账单金额大于零的用户数
SELECT SUM(1)
  FROM ZBG_DWA.DWA_V_M_CUS_CB_USER_INFO_011@LINK_DSSDWE T
 WHERE IS_STAT = '1'
   AND IS_CARD = '1'            --0手机；1上网卡
   AND SERVICE_TYPE = '40AAAAAA'--4G业务
   AND MONTH_ID = '201505'
   AND IS_ACCT = '1'
新增用户数
指报告期内新开通联通某项业务（比如4G业务）的用户数（新增用户=新发展用户+业务互转用户+其他新增用户）
SELECT SUM(1)
  FROM ZBG_DWA.DWA_V_M_CUS_CB_USER_INFO_011@LINK_DSSDWE T
 WHERE IS_STAT = '1'
   AND IS_CARD = '1'            --0手机；1上网卡
   AND SERVICE_TYPE = '40AAAAAA'--4G业务
   AND MONTH_ID = '201505'
   AND IS_ADD = '1'

新发展用户数
指报告期内新办理入网，开始使用联通业务，占用中国联通资源的用户数
SELECT SUM(1)
  FROM ZBG_DWA.DWA_V_M_CUS_CB_USER_INFO_011@LINK_DSSDWE T
 WHERE IS_STAT = '1'
   AND IS_CARD = '1'            --0手机；1上网卡
   AND SERVICE_TYPE = '40AAAAAA'--4G业务
   AND MONTH_ID = '201505'
   AND IS_THIS_DEV = '1'
网上用户数
指报告期末在业务支撑系统中拥有注册信息、占用中国联通网络资源并且用户状态不为预开户、注销和删除期的用户总数。
SELECT SUM(1)
  FROM ZBG_DWA.DWA_V_M_CUS_CB_USER_INFO_011@LINK_DSSDWE T
 WHERE IS_STAT = '1'
   AND IS_CARD = '1'            --0手机；1上网卡
   AND SERVICE_TYPE = '40AAAAAA'--4G业务
   AND MONTH_ID = '201505'
   AND IS_INNET = '1'
3G套餐
公共部分（3G手机、23G融合、3G上网卡通用）
维度
付费模式
取ZBA_DWA.DWA_V_M_CUS_3G_USER_INFO_PROV（3G用户资料表)的PAY_MODE字段，其中PAY_MODE IN ('03','04','05')为预付费，PAY_MODE IN ('01','02')为后付费
入网时间
新办理入网，开始使用联通业务的时间。
取ZBA_DWA.DWA_V_M_CUS_3G_USER_INFO_PROV（3G用户基本衍生信息表)的INNET_DATE字段。

发展渠道类型
指用户的入网渠道，该用户是通过什么渠道被发展为联通用户的。
通过如下SQL取CHNL_KIND_ID字段对渠道进行分类；
CHNL_KIND_ID所代表的渠道类型，可通过与ZB_DIM.DIM_CHANNEL_TYPE_BSDM（渠道归类信息码表）中LEVEL_3字段关联取出。

SELECT T.USER_ID,
       T1.CHNL_ID,
       T2.CHNL_KIND_ID
  FROM (SELECT A.USER_ID, A.ZB_DEV_MAN_ID
          FROM ZBA_DWA.DWA_V_M_CUS_3G_USER_INFO_011 A
         WHERE A.MONTH_ID = '201507'
           AND A.IS_STAT = '1'
   	       AND IS_CARD = '0') T,
       (SELECT B.DEV_CODE, B.CHNL_ID
          FROM ZB_DWD.DWD_M_MRT_AL_DEV_MAN_INFO_011 B
         WHERE B.MONTH_ID = '201507') T1, --渠道发展人信息
       
       (SELECT C.CHNL_ID, C.CHNL_NAME, C.CHNL_KIND_ID
          FROM ZB_DWD.DWD_M_MRT_AL_BSDM_CHANNEL_S C--渠道信息
         WHERE MONTH_ID = '201507'
           AND PROV_ID = '011') T2
 WHERE T.ZB_DEV_MAN_ID = T1.DEV_CODE(+)
   AND T1.CHNL_ID = T2.CHNL_ID(+); 
归集标签
取用户资料表中的USER_ID字段，与 ZBA_DWD.DWD_M_PRD_AL_GC_USER_FLAG_PROV（集客标签表） 中 USER_ID 进行关联，取集客标签表中BELONG_FLAG字段，无需限定其他条件，取值为0集团，1和空为公众。

注意：
1. 集客标签表ZBA_DWD.DWD_M_PRD_AL_GC_USER_FLAG_PROV数据从201308账期开始具备
2. 2013年10月账期之前如下集客标签表一直使用
SELECT /*+PARALLEL(T,2)*/
 T.USER_ID, T.INCOME_BELONG_FLAG -- 1和空的都是公众，0是集团
  FROM ZBA_DWA.DWA_V_D_CUS_GROUP_FLAG_011 T
 WHERE MONTH_ID = '201306'
   AND DAY_ID = '03'
3. OCS上网卡部分关联集客标签的时候只需要关联北京的集客标签表,如下例：
SELECT '201404',
       '011',
       AREA_ID,
       'OCS' NETTYPE,
       A.USER_ID,
       NVL(BELONG_FLAG, '1') BELONG_FLAG,
       NVL(USER_GROUP_FLAG, '1') USER_GROUP_FLAG,
       IS_INNET,
       IS_THIS_ACCT
  FROM (SELECT SUBS_INSTANCE_ID USER_ID, AREA_ID, IS_INNET, IS_THIS_ACCT
          FROM ZBA_DWA.DWA_V_M_CUS_OCS_USER_INFO
         WHERE IS_TEST = '0'
           AND STATUS_ID NOT IN ('51', '13')
           AND PROV_ID = '011'
           AND MONTH_ID = '201404') A,
       (SELECT USER_ID, BELONG_FLAG, USER_GROUP_FLAG
          FROM ZBA_DWD.DWD_M_PRD_AL_GC_USER_FLAG_011
         WHERE MONTH_ID = '201404') B
 WHERE A.USER_ID = B.USER_ID(+)
用户群标签
取ZBA_DWD.DWD_M_PRD_AL_GC_USER_FLAG表的USER_GROUP_FLAG，0为集团客户，空和1为公众用户，与用户资料表的关联方法详见归集标签部分。
中小企业（只针对集客用户）
首先限定集客用户（集客用户取法详见归集标签部分），
再通过USER_ID与ZBA_DWA.DWA_V_M_CUS_AL_GC_RELATION模型关联，利用该模型中CUST_SIZE来区分用户的企业类型。

利用CUST_SIZE区分用户企业类型的方法如下：
DECODE(CUST_SIZE,'1','小微','2','中小企业','3','大客户','其他')

是否实名制
判断联通用户是否进行了实名登记。
通过ZBA_DWA.DWA_V_M_CUS_3G_USER_INFO_PROV（3G用户资料表)的USER_ID，
与表ZBA_DWA.DWA_V_M_CUS_3G_RNS_WIDE的SUBS_INSTANCE_ID相关联，
取该表IS_VALID_FLAG字段，无需限定其他条件，取值为“1”表示“是实名制” 。

客户信息
指办理使用联通业务的客户的信息。

通过ZBA_DWA.DWA_V_M_CUS_3G_USER_INFO_PROV（3G用户资料表)的CUST_ID（客户ID）字段，关联如下表CUST_ID字段，获取姓名、证件类型、证件号码：
SELECT CUST_ID, F_DECRYPT(CUST_NAME) CUST_NAME--客户名称
  FROM ZBA_DWD.DWD_M_CUS_AL_CUSTOMER_079
 WHERE MONTH_ID = '201603' 
;

SELECT CUSTOMER_ID CUST_ID,
       CERT_TYPE,--证件类型
        CERT_NO----证件号码 加密的，尚未找到解密函数
  FROM ZBA_DWD.DWD_M_CUS_AL_CERT_INFO_079 
 WHERE MONTH_ID = '201603';

通过ZBA_DWA.DWA_V_M_CUS_3G_USER_INFO_PROV（3G用户资料表)的CUST_ID（客户ID）字段，关联如下表CUST_ID字段，获取客户性别、年龄：
SELECT T.CUST_ID,
       T.CERT_TYPE,
       T.CUST_SEX,--1,男;2,女
       T.CERT_AGE--年龄
  FROM ZBA_DWA.DWA_V_M_CUS_AL_RNS_079 T--客户实名衍生信息(月)，除了客户姓名、年龄外，该表中还有客户名称和证件号码，但是加密的，不可用
 WHERE MONTH_ID='201603' 
AND CERT_TYPE IN ('0101', '0102', '0108')
      AND CERT_NO_IS_VALID='1';

通过ZBA_DWA.DWA_V_M_CUS_3G_USER_INFO_PROV（3G用户资料表)的USER_ID（用户ID）字段，关联如下表SUBS_INSTANCE_ID字段，获取客户性别、年龄：
SELECT SUBS_INSTANCE_ID USER_ID, 
CUST_SEX, --1,男;2,女
CERT_AGE
  FROM ZBA_DWA.DWA_V_M_CUS_3G_RNS_WIDE
 WHERE PROV_ID = '&PROV_ID'
   AND MONTH_ID = '&MONTH_ID'
   AND IS_VALID_FLAG = '1'

VIP级别
通过ZBA_DWA.DWA_V_M_CUS_3G_USER_INFO_PROV（3G用户资料表)的USER_ID，与如下表USER_ID相关联，取VIP_LEVEL字段即可。
VIP_LEVEL取值代表的含义为：02：钻石卡 03：金卡 04：银卡，这三类均归为VIP用户。

SELECT *
  FROM ZBA_DWA.DWA_V_M_CUS_MB_VIP_INFO_011 T
 WHERE T.IS_VIP_VALID = '1'
   AND T.VIP_LEVEL IN ('02', '03', '04') --02:钻石卡，03：金卡，04：银卡
   AND T.SERVICE_TYPE = '30AAAAAA'
   AND T.MONTH_ID = '201310'

VIP_LEVEL取值参考：
SELECT * FROM ZB_DIM.DIM_BI_CLUB_MEMBER_LVL;
用户使用的卡类型
卡类型分为SIM卡和USIM卡。

通过ZBA_DWA.DWA_V_M_CUS_3G_USER_INFO_PROV（3G用户资料表)的USER_ID，
与表ZBA_DWA.DWA_V_M_CUS_MB_USER_RES_PROV的USER_ID相关联，
取该表CARD_TYPE字段即可。
红黑名单
判断联通用户是否红黑名单。
通过ZBA_DWA.DWA_V_M_CUS_3G_USER_INFO_PROV（3G用户资料表)的CUST_ID，
与表ZBA_DWD.DWD_M_CUS_AL_REDBLACKLIST_011的CUST_ID相关联
SELECT CUST_ID
  FROM ZBA_DWD.DWD_M_CUS_AL_REDBLACKLIST_011 A
 WHERE A.MONTH_ID = '201606'
   AND A.IS_VALID = '1'
   AND LIST_TYPE IN ('01', '02')--01红名单02黑名单
 GROUP BY CUST_ID;
终端类型
select 
       CASE WHEN T3.ONEIN1MON_NET_TYPE_REV = '02' AND T_3WU.USER_ID IS NULL
              THEN   '2G'
            WHEN T3.ONEIN1MON_NET_TYPE_REV = '03' AND T_3WU.USER_ID IS NULL
              THEN  '3G'
            WHEN T3.ONEIN1MON_NET_TYPE_REV = '04' AND T_3WU.USER_ID IS NULL
              THEN  '4G'
       ELSE '无法识别' END ZD_TYPE  --终端类型
from (
            SELECT t.user_id,'B'||t.user_id  user_id_new, t.zb_dev_man_id,t.IS_THIS_BREAK,t.IS_THIS_ACCT,
             t.is_innet,substr(t.innet_date,0,6) innet_date,t.PRODUCT_ID,INNET_MONTHS,'3G' yw,is_card,device_number
              FROM ZBA_DWA.DWA_V_M_CUS_3G_USER_INFO_010 T --3G用户资料表
             WHERE MONTH_ID =  '201708'
               AND T.IS_STAT = '1'
               AND IS_CARD <> '1'
               AND t.IS_INNET='1'
               )T1,
         
  (SELECT USER_ID, --带着B的
             ONEIN1MON_NET_TYPE_REV-- 00=无法区分，04=4G、03=3G、02=2G
         FROM ZBG_DWA.DWA_V_M_CUS_ALL_ZCTMF2_010@LINK_DSSDWE
          WHERE MONTH_ID =  '201708'
              AND SERVICE_TYPE NOT like '40%' --套餐类型 2G套餐：LIKE '20%'；3G套餐：LIKE '30%'；4G套餐：LIKE '40%'；
                    )T3--关联使用终端类型表
where T1.user_id_new=T3.user_id(+)--关联使用终端类型表
承诺低消送流量
select  
 CASE WHEN t5.USER_ID IS NOT NULL   THEN '1'  ELSE  '0'  end IS_CNDX  --是否办理承诺低消送流量
   FROM 
 (
            SELECT t.user_id,'B'||t.user_id  user_id_new, t.zb_dev_man_id,t.IS_THIS_BREAK,t.IS_THIS_ACCT,
             t.is_innet,substr(t.innet_date,0,6) innet_date,t.PRODUCT_ID,INNET_MONTHS,'3G' yw,is_card,device_number
              FROM ZBA_DWA.DWA_V_M_CUS_3G_USER_INFO_011 T --3G用户资料表
             WHERE MONTH_ID =  '201708'
               AND T.IS_STAT = '1'

               ) T1,--23G用户资料表
  (SELECT  USER_ID
          FROM (SELECT T.*,
                       ROW_NUMBER() OVER(PARTITION BY USER_ID ORDER BY PRODUCT_FLAG, EFFECT_DATE DESC) RN
                  FROM zbA_dwa.DWA_V_M_CUS_MB_139_011 T
                 WHERE MONTH_ID =  '201708')
         WHERE RN = 1
           AND product_flag = '02') T5--23G是否办理承诺低消送流量
           
            WHERE  T1.USER_ID = T5.USER_ID(+)

用户星级
注意预评级也需要算在内，三星及以上星级用户属于高价值用户。
select  
   case when T6.user_id is not null then t6.USER_LEVEL
            when t7.user_id is not null then '0'||t7.USER_LEVEL
            else null end USER_LEVEL,--用户星级
   FROM 
 (SELECT  t.user_id,'B'||t.user_id  user_id_new, t.zb_dev_man_id,t.IS_THIS_BREAK,t.IS_THIS_ACCT,
             t.is_innet,substr(t.innet_date,0,6) innet_date,t.PRODUCT_ID,INNET_MONTHS,'3G' yw,'0' is_card,device_number
              FROM ZBA_DWA.DWA_V_M_CUS_3G_USER_INFO_011 T --2G用户资料表
                 WHERE MONTH_ID =  '201708'
               AND T.IS_STAT = '1'
               ) T1,--23G用户资料表
(SELECT  USER_ID, USER_LEVEL
               FROM (SELECT USER_ID,
                            USER_LEVEL,
                            ROW_NUMBER() OVER(PARTITION BY USER_ID ORDER BY MONTH_ID DESC NULLS LAST) RN
                       FROM ZBG_DWA.MID1_V_M_CUS_MB_VALUE_LIST_011@LINK_DSSDWE --BSS用户价值评级模型
                      WHERE MONTH_ID >= '201505' --固定值
                        AND MONTH_ID <=  '201708')--之前被评过就算
                     WHERE RN = 1 ) T6, --BSS用户价值评级模型
   ( SELECT USER_ID,
                            USER_LEVEL
                       FROM ZBG_DWA.MID_V_M_CUS_MB_VALUE_011@LINK_DSSDWE --BSS用户价值评级模型
                      WHERE MONTH_ID =  '201708')T7 --预评级
           
            WHERE  T1.USER_ID = T6.USER_ID(+) 
             AND   T1.USER_ID = T7.USER_ID(+)
疑似养卡
一般是判定6个月内是否养卡，新增用户当月是否养卡。
疑似养卡表 从201601才开始有数据，如果账期-5话，数据会不全。2016-201604月的数据量少，不全。
----------2G
select  
         CASE  when T_10.user_id is not null then '1' ELSE '0' END IS_RAIS,--是否疑似养卡

   FROM 
 (SELECT  t.user_id,'B'||t.user_id  user_id_new, t.zb_dev_man_id,t.IS_THIS_BREAK,t.IS_THIS_ACCT,
             t.is_innet,substr(t.innet_date,0,6) innet_date,t.PRODUCT_ID,INNET_MONTHS,'3G' yw,'0' is_card,device_number
              FROM ZBA_DWA.DWA_V_M_CUS_3G_USER_INFO_011 T --2G用户资料表
                 WHERE MONTH_ID =  '201708'
               AND T.IS_STAT = '1'

          

               ) T1,--23G用户资料表
(    (SELECT SUBS_INSTANCE_ID user_id FROM
       (SELECT T.*,
               ROW_NUMBER() OVER(PARTITION BY T.SUBS_INSTANCE_ID ORDER BY MONTH_ID desc,INNET_DATE DESC, SERVICE_TYPE DESC NULLS LAST) RN
          FROM ZB_CSM.DWA_DEV_RAISED T
         WHERE  MONTH_ID BETWEEN '201703' AND  '201708'
               AND PROV_ID ='011'
               AND SERVICE_TYPE NOT LIKE '40%'--23G
               AND  user_type <> '真实'--一定别忘了
               ) WHERE RN=1) t_10--一般是判定6个月内是否疑似养卡
            WHERE  T1.USER_ID = T10.USER_ID(+)

指标
活跃用户
指报告期内本企业移动手机用户中至少出现一次主/被叫，或者至少主动使用过一次短信或数据及信息业务的移动手机用户数。

通过ZBA_DWA.DWA_V_M_CUS_3G_USER_INFO_PROV（3G用户资料表)的USER_ID，关联ZBA_DWA.DWA_V_M_CUS_3G_SING_USE_XXX并限制IS_ACTIVE='1'

注意:
1、IS_ACTIVE口径加工曾在201312月账期修改过，之前的口径为报告期内本企业移动手机用户中至少出现一次主/被叫，或者至少主动使用过一次短信或数据（流量），如果要用之前的活跃口径请使用DWA_V_M_CUS_SING_USE_OLD，我们目前有需求业务部门要求用旧的活跃口径。
2、对于活跃用户有些业务部门称为有业务量，如果是让统计有业务量的用户，还请咨询业务部门是否是要活跃用户
停机用户
通过ZBA_DWA.DWA_V_M_CUS_3G_USER_INFO_PROV（3G用户资料表)的USER_STATUS，
与码表ZB_DIM.DIM_BI_STATUS的STATUS_ID关联，取STOP_TYPE字段为停机类型，STOP_TYPE为空表示正常开机，其余取值对应的停机类型如下所示：
--欠费停机 STOP_TYPE = '02';
--被动停机 STOP_TYPE IN ('02', '03');
--主动停机 STOP_TYPE ='01';
--停机 STOP_TYPE IN('01','02','03');
--强制停机 STOP_TYPE ='03';
注意:
	停机用户必须是网上用户，用户资料表必须限制IS_INNET='1'
欠费用户
限定每个用户在统计账期下（欠费账期根据需求限定）的总欠费金额大于0，具体如下： 
SELECT /*+parallel(t3,3)*/
 SUBS_INSTANCE_ID, SUM(OWE_FEE) OWE_FEE
  FROM ZBA_DWD.DWD_M_ACC_AL_OWE_FINACE_010 T3
 WHERE OWE_STATUS = '01'
   AND FIN_FLAG = '1'
   AND OWE_MONTH <= '201310'
   AND MONTH_ID = '201310'
 GROUP BY SUBS_INSTANCE_ID
HAVING SUM(OWE_FEE) > 0;
也就是说如果单独看统计账期下的某一个欠费账期的时候，需要把该欠费账期中的所有欠费项加和以后在判断欠费是否大于0。
3G新增国漫用户（本月开通上月未开通）
SELECT COUNT(T1.BY_DAUSER) ADD_USER --本月新增
  FROM (SELECT MAX(STATUS_CHANGE_DATE) MAX_STATUS, USER_ID BY_DAUSER --本月到达用户数
          FROM ZB_DWD.DWD_M_PRD_AL_USER_SERVICE_011
         WHERE MONTH_ID = '201505'
           AND SERVE_STATUS = '01'
           AND SERVE_ID = '0005'
         GROUP BY USER_ID) T1,
       (SELECT MAX(STATUS_CHANGE_DATE) MAX_STATUS, USER_ID SY_DAUSER --上月到达用户数
          FROM ZB_DWD.DWD_M_PRD_AL_USER_SERVICE_011
         WHERE MONTH_ID =
               TO_CHAR(ADD_MONTHS(TO_DATE('201505', 'YYYYMM'), -1), 'YYYYMM') --上月
           AND SERVE_STATUS = '01'
           AND SERVE_ID = '0005'
         GROUP BY USER_ID) T2,
       (SELECT *
          FROM ZBA_DWA.DWA_V_M_CUS_3G_USER_INFO_011 T
         WHERE IS_STAT = '1'
           AND MONTH_ID = '201505') T3
 WHERE T1.BY_DAUSER = T2.SY_DAUSER(+)
   AND T2.SY_DAUSER IS NULL
注意：
开通权限
SERVE_ID = '0005' 国际漫游 SERVE_ID = '0003' 国际长途 
状态
SERVE_STATUS = '01' 开通 SERVE_STATUS = '02' 关闭
3G到达国漫用户（本月开通国漫用户）
SELECT COUNT(T1.BY_DAUSER) ADD_USER --本月到达
  FROM (SELECT MAX(STATUS_CHANGE_DATE) MAX_STATUS, USER_ID BY_DAUSER --本月到达用户数
          FROM ZB_DWD.DWD_M_PRD_AL_USER_SERVICE_079
         WHERE MONTH_ID = '201506'
           AND SERVE_STATUS = '01'
           AND SERVE_ID = '0005'
         GROUP BY USER_ID) T1,
       (SELECT *
          FROM ZBA_DWA.DWA_V_M_CUS_3G_USER_INFO_079 T
         WHERE IS_STAT = '1'
           AND MONTH_ID = '201506') T3
 WHERE T1.BY_DAUSER = T3.USER_ID
3G关闭国漫用户(上月开通本月未开通)
SELECT '''||V_MONTH||''', '''||V_PROV||''', ''2A'', COUNT(A.GB_USER)
  FROM (SELECT T1.SY_DAUSER GB_USER --本月关闭
          FROM (SELECT MAX(STATUS_CHANGE_DATE) MAX_STATUS, USER_ID SY_DAUSER --上月到达用户数
                  FROM ZB_DWD.DWD_M_PRD_AL_USER_SERVICE_'||V_PROV||'
                 WHERE MONTH_ID = TO_CHAR(ADD_MONTHS(TO_DATE('''||V_MONTH||''', 'YYYYMM'), -1),'YYYYMM')
                   AND SERVE_STATUS = ''01''
                   AND SERVE_ID = ''0005''
                 GROUP BY USER_ID) T1,
               (SELECT MAX(STATUS_CHANGE_DATE) MAX_STATUS, USER_ID BY_DAUSER --本月到达用户数
                  FROM ZB_DWD.DWD_M_PRD_AL_USER_SERVICE_'||V_PROV||'
                 WHERE MONTH_ID = '''||V_MONTH||'''
                   AND SERVE_STATUS = ''01''
                   AND SERVE_ID = ''0005''
                 GROUP BY USER_ID) T2
         WHERE T1.SY_DAUSER = T2.BY_DAUSER(+)
           AND T2.BY_DAUSER IS NULL) A,
       (SELECT *
          FROM ZBA_DWA.DWA_V_M_CUS_3G_USER_INFO_'||V_PROV||' T
         WHERE IS_STAT = ''1''
           AND MONTH_ID = ''201505'') B
 WHERE A.GB_USER = B.USER_ID
3G剔除降欠用户
剔除降欠口径：降欠挂账出帐费用为0，且正常出帐费用大于0 的3G出账用户。
SELECT T1.USER_ID, NET_TYPE, NOMAL_TOTAL_FEE
  FROM (SELECT USER_ID, '3G' NET_TYPE
          FROM ZBA_DWA.DWA_V_M_CUS_3G_USER_INFO_011 A
         WHERE IS_STAT = '1'
           AND IS_THIS_ACCT = '1'
           AND MONTH_ID = '201506') T1, --出账
       (SELECT USER_ID,
               NOMAL_TOTAL_FEE, --正常出帐费用（0）
               (TOTAL_FEE - NOMAL_TOTAL_FEE) JQ_FEE --降欠挂账出帐费用(1)
          FROM ZBA_DWA.DWA_V_M_CUS_MB_RH_SCHARGE_011
         WHERE MONTH_ID = '201506') T2 --收入
 WHERE T1.USER_ID = T2.USER_ID(+)
   AND T2.JQ_FEE = 0
   AND T2.NOMAL_TOTAL_FEE > 0 --3G
B侧开放4G网络用户-3G套餐部分
（CB侧用户4G网络默认全部开发）
以3G出账用户为例：
SELECT SUM(CASE
             WHEN T8.USER_ID IS NOT NULL THEN
              '1'
             ELSE
              NVL(T7.IS_4G_OPEN, '0')
           END) IS_4G_OPEN, --开放4G网络
  FROM (SELECT MONTH_ID,
               PROV_ID,
               AREA_ID,
               SERVICE_TYPE,
               IS_CARD,
               IS_THIS_ACCT,
               USER_ID,
               DEVICE_NUMBER,
               IS_INNET,
               PRODUCT_MODE,
               USER_STATUS
          FROM ZBA_DWA.DWA_V_M_CUS_MB_USER_INFO_011
         WHERE MONTH_ID = '201603'
           AND IS_STAT = '1'
           AND IS_THIS_ACCT = '1'
           AND SERVICE_TYPE LIKE '30%' 
AND IS_CARD IN ('0', '2')) T,
       (SELECT USER_ID, IS_4G_OPEN, IS_3G_OPEN
          FROM ZBA_DWA.DWA_V_D_CUS_AL_USER_SERV_011
         WHERE MONTH_ID = '201603'
           AND DAY_ID = '31') T7,  --本月最后一天
       (SELECT USER_ID
          FROM ZBA_DWA.DWA_V_D_CUS_3G_USER_LOST_011 T
         WHERE T.MONTH_ID = '201604'
           AND DAY_ID = '01'   --次月第一天
           AND T.IS_LOST_TYPE = '218') T8
 WHERE T.USER_ID = T7.USER_ID(+)
   AND T.USER_ID = T8.USER_ID(+)
B侧计费收入日表
  SELECT
  '''||V_MONTH_ID||''',
   '''||V_DAY_ID||''',
   '''||V_PROV_ID||''' ,
 T_USER.IS_INNET,--是否在网
 T_USER.IS_THIS_DEV,--是否新发展
 T_USER.IS_ADD ,--新增
 T_USER.IS_CARD,--手机上网卡
 T_USER.SERVICE_TYPE, --业务类型
 T_CHANNEL.CHNL_KIND_ID,--渠道
 T_USER.PRODUCT_ID,--产品ID
 T_USER.PRODUCT_CLASS,
 SUM(NVL(T_FEE.TOTAL_FEE,0)),--计费收入
 COUNT(1) USER_NUM --用户数
FROM (SELECT
 T.USER_ID,
 T.IS_INNET,
 T.IS_CARD,
 T.SERVICE_TYPE,
 T.PRODUCT_ID,
 T.PRODUCT_MODE PRODUCT_CLASS ,
 T.ZB_DEV_MAN_ID,
 T.IS_THIS_DEV,--是否新发展
 T.IS_ADD --新增
  FROM ZBA_DWA.DWA_V_D_CUS_2G_USER_INFO_'||V_PROV_ID||' T --2G用户资料表
           WHERE T.IS_STAT = ''1''
           AND T.MONTH_ID='''||V_MONTH_ID||'''
           AND DAY_ID='''||V_DAY_ID||'''
    UNION ALL
 SELECT
 T.USER_ID,
 T.IS_INNET,
 T.IS_CARD,
 T.SERVICE_TYPE,
 T.PRODUCT_ID,
 T.PRODUCT_MODE PRODUCT_CLASS,
 T.ZB_DEV_MAN_ID,
 T.IS_THIS_DEV,
  T.IS_ADD --新增
  FROM ZBA_DWA.DWA_V_D_CUS_3G_USER_INFO_'||V_PROV_ID||' T --3G用户资料表
           WHERE T.IS_STAT = ''1''
           AND T.MONTH_ID='''||V_MONTH_ID||'''
           AND DAY_ID='''||V_DAY_ID||''' )T_USER,--23G日用户资料表
(SELECT T.SUBS_INSTANCE_ID USER_ID,
     T.TOTAL_FEE
 FROM ZBA_DWA.DWA_V_D_CUS_MB_BCHARGE_'||V_PROV_ID||' T
 WHERE  MONTH_ID = '''||V_MONTH_ID||'''
    AND DAY_ID = '''||V_DAY_ID||''')T_FEE, --23G计费收入日表
 
(SELECT V_FZR.DEV_CODE,V_CHANNEL.CHNL_KIND_ID
             FROM (SELECT B.DEVELOPER_CODE DEV_CODE, B.CHANNEL_ID
                     FROM ZB_DWD.DWD_D_MRT_AL_DEV_MAN_INFO_'||V_PROV_ID||'  B
                    WHERE B.MONTH_ID = '''||V_MONTH_ID||'''
                    AND B.DAY_ID='''||V_DAY_ID||''') V_FZR, --渠道发展人信息
                  (SELECT C.CHNL_ID, C.CHNL_NAME, C.CHNL_KIND_ID
                     FROM ZB_DWD.DWD_D_MRT_AL_BSDM_CHANNEL_S  C --渠道信息
                    WHERE MONTH_ID = '''||V_MONTH_ID||'''
                      AND PROV_ID = '''||V_PROV_ID||'''
                      AND C.DAY_ID='''||V_DAY_ID||''') V_CHANNEL
            WHERE V_FZR.CHANNEL_ID = V_CHANNEL.CHNL_ID(+)) T_CHANNEL --23G集中渠道渠道类型
 WHERE T_USER.USER_ID=T_FEE.USER_ID(+)--计费收入
  AND T_USER.ZB_DEV_MAN_ID  = T_CHANNEL.DEV_CODE(+)--23G渠道
  GROUP by
 T_USER.IS_INNET,--是否在网
 T_USER.IS_THIS_DEV, --是否新发展 可以与页面对起来
  T_USER.IS_ADD, --新增
 T_USER.IS_CARD,--手机上网卡
 T_USER.SERVICE_TYPE, --业务类型
 T_CHANNEL.CHNL_KIND_ID,--渠道
 T_USER.PRODUCT_ID,
 T_USER.PRODUCT_CLASS


3G手机
维度
套餐名称
指3G手机用户订购的3G套餐类型。
1.通过ZBA_DWA.DWA_V_M_CUS_3G_USER_INFO_PROV（3G用户资料表)的PRODUCT_MODE字段，与套餐码表进行关联取套餐名称，需要对套餐码表进行自关联，详细SQL如下：

SELECT NVL(C.PRODUCT_CLASS_DESC, '其他套餐')
  FROM (SELECT PRODUCT_MODE FROM 3G手机用户资料表) A, --可能是出账用户等，根据实际情况查询相应用户群
       (SELECT *
          FROM ZB_DIM.DIM_PRODUCT_CLASS
         WHERE IS_CARD = '0'
           AND SERVICE_TYPE = '30AAAAAA') B, --产品分类表
       (SELECT *
          FROM ZB_DIM.DIM_PRODUCT_CLASS
         WHERE IS_CARD = '0'
           AND SERVICE_TYPE = '30AAAAAA') C
 WHERE A.PRODUCT_MODE = B.PRODUCT_CLASS(+)
   AND NVL(B.PRODUCT_CLASSIFY_VALUE, '020199') = C.PRODUCT_CLASS(+)

2. 利用如上C表的PRODUCT_BASE_CLASS区分套餐类型：A,B,C,IPHONE,沃派36等套餐, PRODUCT_BASE_CLASS取值分别如下：'A'、'B'、'C'、'I'、'O'。

注意:
1. 3G手机C套餐内包含的语音为本地通话拨打分钟数，在计算使用语音占套餐语音比的时候，C套餐用户本地主叫语音时长超过套餐内的语音就算超套餐。
将 ZB_DIM.DIM_PRODUCT_CLASS 与 ZB_DIM.DIM_PRODUCT_RATE关联（关联方法可参照套餐月费取法），取PRODUCT_TYPE='03'为C套餐

2. 用户资料表里的PRODUCT_MODE在2014年之前有些数据有异常，需要处理如下
CASE
              WHEN PRODUCT_MODE = ''9999'' THEN
                   ''020199''
               WHEN PRODUCT_MODE = ''999999'' THEN
                    ''020199''
               WHEN PRODUCT_MODE = ''**'' THEN
                    ''020199''
               WHEN PRODUCT_MODE IS NULL THEN
                    ''020199''
               ELSE
                     PRODUCT_MODE
                   END PRODUCT_MODE
套餐月费
通过ZBA_DWA.DWA_V_M_CUS_3G_USER_INFO_PROV（3G用户资料表)的PRODUCT_MODE字段与下面表的PRODUCT_CLASS关联取MON_FEE：

SELECT T2.PRODUCT_CLASS, T3.MON_FEE
  FROM ZB_DIM.DIM_PRODUCT_CLASS T2,
       ZB_DIM.DIM_PRODUCT_RATE  T3
 WHERE T2.IS_CARD = '0'
   AND T2.SERVICE_TYPE = '30AAAAAA'
   AND T2.PRODUCT_CLASSIFY_VALUE = '02' || T3.PRODUCT_CLASS
合约类型
合约表中ACTIVITY_TYPE字段（用户资料表中USER_ACT_TYPE字段）对应的合约分类如下：
CASE
   WHEN ACTIVITY_TYPE = '01' THEN
    '存费送机'
   WHEN ACTIVITY_TYPE = '02' THEN
    '购机送费'
   WHEN ACTIVITY_TYPE = '03' THEN
    '存费送费'
   WHEN ACTIVITY_TYPE IN ('06', '07', '08', '09') THEN
    '存费送业务'
   ELSE
    '单卡'
 END

出账用户和网上用户
整体目标用户群为3G手机出账用户或网上用户
方法一：
取ZBA_DWA.DWA_V_M_CUS_3G_USER_INFO_PROV（3G用户资料表)的USER_ACT_TYPE字段
方法二：
通过ZBA_DWA.DWA_V_M_CUS_3G_USER_INFO_PROV（3G用户资料表)的USER_ID，
与如下合约表的SUBS_INSTANCE_ID进行关联，取ACTIVITY_TYPE：
SELECT *
  FROM ZBA_DWA.DWA_V_M_CUS_3G_ACT_INFO_011
 WHERE MONTH_ID = '201409'
   AND IS_VALID = '1'
新增用户
整体目标用户群为3G手机新增用户
通过ZBA_DWA.DWA_V_M_CUS_3G_USER_INFO_PROV（3G用户资料表)的USER_ID，与如下合约表的SUBS_INSTANCE_ID 进行关联，取ACTIVITY_TYPE ：
SELECT *
    FROM ZBA_DWA.DWA_V_M_CUS_3G_ACT_INFO_011
 WHERE MONTH_ID = '201409'
    AND IS_THIS_ADD = '1' --且新增合约用户，不能限制is_valid

离网用户
整体目标用户群为3G手机本期离网用户
通过ZBA_DWA.DWA_V_M_CUS_3G_USER_INFO_PROV（3G用户资料表)的USER_ID，与如下合约表的SUBS_INSTANCE_ID 进行关联，取ACTIVITY_TYPE ：
SELECT *
    FROM ZBA_DWA.DWA_V_M_CUS_3G_ACT_INFO_011
 WHERE MONTH_ID = '201409'
   AND IS_THIS_BREAK = '1'--且合约离网用户，不能限制is_valid


指标
出账用户
指报告期内出账账单金额大于零的用户数
SELECT COUNT(1)
  FROM ZBA_DWA.DWA_V_M_CUS_3G_USER_INFO_ '||V_PROV_ID||' T
 WHERE MONTH_ID = '''||V_MONTH_ID||'''
   AND IS_STAT = ''1''
   AND IS_CARD = ''0'' --0：3G手机，1：上网卡，2:23G融合
   AND IS_THIS_ACCT = ''1''
新增用户
报告期内新开通联通某项业务的用户数（新增用户=新发展用户+业务互转用户+其他新增用户）
SELECT COUNT(1)
FROM ZBA_DWA.DWA_V_M_CUS_3G_USER_INFO_'||V_PROV_ID||'  
 WHERE T1.IS_STAT = ''1''
   AND T1.IS_ADD = ''1'' --当月新增
   AND T1.IS_CARD = ''0''
   AND T1.MONTH_ID = '''||V_YEARMONTH_ADD||'''
新发展用户
指报告期内新办理入网，开始使用联通业务，占用中国联通资源的用户数

SELECT count(1)
FROM ZBA_DWA.DWA_V_M_CUS_3G_USER_INFO_'||V_PROV_ID||'  
 WHERE T1.IS_STAT = ''1''
   AND T1.IS_THIS_DEV= ''1'' --当月新发展标识
   AND T1.IS_CARD = ''0''
   AND T1.MONTH_ID = '''||V_YEARMONTH ||'''
网上用户数
指报告期末在业务支撑系统中拥有注册信息、占用中国联通网络资源并且用户状态不为预开户、注销和删除期的用户总数。
SELECT COUNT(1)
FROM ZBA_DWA.DWA_V_M_CUS_3G_USER_INFO_'||V_PROV_ID||'  
 WHERE T1.IS_STAT = ''1''
   AND T1.IS_INNET = ''1'' --在网
   AND T1.IS_CARD = ''0''
   AND T1.MONTH_ID = '''||V_YEARMONTH ||'''
流失用户
上月出账本月不出账用户，也有个别业务部门希望按照：上月在网本月不在网用户来计算，但一般不这样处理。
一般都是拍照观察，拍照上月出账的用户，观察在本月的出账情况。
流失率=上月出账本月不出账用户/上月出账用户数

口径1：需求：市场营销部梅峰（上月出账本月不出账）
具体口径为上月为3G手机出账用户，本月不再是3G手机出账用户，含转网用户
SELECT SUM(CASE
             WHEN B.USER_ID IS NULL THEN
              1
             ELSE
              0
           END)
  FROM (SELECT USER_ID
          FROM ZBA_DWA.DWA_V_M_CUS_3G_USER_INFO_ '|| V_PROV ||' A
         WHERE MONTH_ID = '|| V_LAST_MONTH ||' 
           AND IS_STAT = ''1''
           AND IS_THIS_ACCT = ''1''
           AND IS_CARD = ''0'') A,
       (SELECT /*+PARALLEL(A,3)*/
         USER_ID
          FROM ZBA_DWA.DWA_V_M_CUS_3G_USER_INFO_' || V_PROV ||' A
         WHERE A.MONTH_ID = '|| V_MONTH || '
           AND A.IS_STAT = ''1''
           AND A.IS_THIS_ACCT = ''1''
           AND A.IS_CARD = ''0'') B
 WHERE A.USER_ID = B.USER_ID(+)
口径2：上月出账本月不出账，不包含转网用户，本月不出账在网的3G手机用户且上月存在在3G业务里出账
 SELECT SUM(CASE
             WHEN A.IS_ADD = '0' AND A.IS_THIS_ACCT = '0' AND
                  C.IS_THIS_ACCT = '1' AND A.IS_INNET = '1' THEN
              1
             ELSE
              0
           END)
  FROM (SELECT *
          FROM ZBA_DWA.DWA_V_M_CUS_3G_USER_INFO_011 T
         WHERE T.MONTH_ID = '201409'
           AND IS_CARD = '0'
           AND IS_STAT = '1') A,
       (SELECT T.USER_ID, T.IS_THIS_ACCT, T.IS_INNET, T.PRODUCT_ID, IS_STAT
          FROM ZBA_DWA.DWA_V_M_CUS_3G_USER_INFO_011 T
         WHERE T.MONTH_ID = '201408' /*AND IS_STAT='1'*/
        ) C
 WHERE A.USER_ID = C.USER_ID(+);
SELECT SUM(LM_ACCT_TM_NOACCT_USER)
  FROM ZBA_DM.V_DM_C_M_DEV_3G_BASE
 WHERE IS_CARD = '0'
   AND MONTH_ID = '201408'
   AND PROV_ID = '017'
口径3：经分系统页面3G手机流失用户
 SELECT SUM(LOST_USER_MOB)
  FROM ZBA_DM.DM_C_M_DEV_3G_LOST_CLASS
 WHERE MONTH_ID = '201409';
SELECT COUNT(IS_LOST)
  FROM ZBA_DWA.DWA_V_D_CUS_3G_USER_LOST_011
 WHERE MONTH_ID = '201409'
   AND IS_CARD = '0'
新入网用户—分渠道口径的，和集中渠道报表保持一致
可参照过程   P_TEMP_LJT_APP_NEW_N3

3G

SELECT ''B'' || SUBS_ID USER_ID,
               CHNL_ID,
               SVC_TYPE_3G is_card,
               innet_flag is_innet,
               SUM(CASE
                     WHEN T.DEV_FLAG >= ''1'' THEN
                      T.DEV_FLAG
                     ELSE
                      ''0''
                   END) DEV_NUM
          FROM ZB_DWA.DWA_C_M_BDSM_CHNLKPI_3G_BI T
         WHERE T.ACCT_MONTH = '''||V_MONTH||'''
           AND T.PROV_ID = '''||V_PROV||'''
           AND SVC_TYPE = ''02''
           AND T.INC_USER >= ''1''
           AND IS_BF_OCS = ''1''
         GROUP BY ''B'' || SUBS_ID, CHNL_ID, SVC_TYPE_3G,innet_flag
当期离网用户
SELECT *
     FROM ZBG_DWA.DWA_V_M_CUS_NM_USER_INFO_'||V_PROV||'@LINK_DSSDWE
        WHERE MONTH_ID = '''||V_MONTH||'''
      AND IS_STAT = ''1''
     And  is_this_break_old = ''1''

三无用户
一般口径：非当月新发展且在网出账的三无用户。三无是指：指报告期内无通话行为、无流量详单和无点对点短信发送记录的网上用户。对应模型解释为总通话次数为0，使用流量为0，点对点短信条数为0。
注意:
	三无用户不应该区分终端类型，以后业务部门要的话也不能提供，因为三无用户没有使用量。
沉淀表：ZB_3G_3WU_USERS
极低用户
一般口径：非当月新发展，在网出账用户，使用流量<=3MB，主叫计费时长<=5分钟，点对点发送短信条数<=4条。
注意:
在201405账期以前，除了以上条件，还有用户价值小于52.8。
沉淀表：ZB_3G_LOWUSED_USERS
3G半年包用户
SELECT /*+PARALLEL(B,8)*/
RESOURCE_TYPE,
 SUM(CASE
       WHEN RN = 1 THEN
        1
       ELSE
        0
     END) USER_NUM, --半年包用户数
 COUNT(RESOURCE_INS_ID) PKG_NUM, --半年包数
 SUM(CASE
       WHEN RN = 1 AND SUBSTR(START_DATE, 1, 6) = '201506' THEN
        1
       ELSE
        0
     END) USER_ADD, --当月新增半年包用户数
 SUM(CASE
       WHEN SUBSTR(START_DATE, 1, 6) = '201506' THEN
        1
       ELSE
        0
     END) PKG_ADD --当月新增半年包数
  FROM (SELECT RESOURCE_CODE, RESOURCE_TYPE
          FROM ZBA_DWD.DWD_M_ACC_AL_RES_DEPOSIT_011 A
         WHERE MONTH_ID = '201506'
           AND RESOURCE_TYPE IN ('0101', '0102') --资源账本类型,半年包类型
           AND MEASURE_ID = '01' ---度量单位
        ) A,
       (SELECT B.USER_ID,
               RESOURCE_CODE,
               RESOURCE_INS_ID,
               START_DATE,
               ROW_NUMBER() OVER(PARTITION BY B.USER_ID ORDER BY START_DATE DESC) RN
          FROM (SELECT USER_ID, RESOURCE_CODE, RESOURCE_INS_ID, START_DATE
                  FROM ZBA_DWD.DWD_M_ACC_AL_RES_DPST_LOG_011 B
                 WHERE MONTH_ID = '201506'
                   AND TOTAL_ACCOUNT IS NOT NULL --资源全额面值,即流量包价格
                   AND VALID_TAG = '1'
                   AND SUBSTR(END_DATE, 1, 6) >= '201506'
                   AND SUBSTR(START_DATE, 1, 6) <= '201506') B,
               (SELECT USER_ID
                  FROM ZBA_DWA.DWA_V_M_CUS_3G_USER_INFO_011
                 WHERE IS_STAT = '1'
                   AND IS_INNET = '1'
                   AND MONTH_ID = '201506') C
         WHERE B.USER_ID = C.USER_ID) B
 WHERE A.RESOURCE_CODE = B.RESOURCE_CODE
 GROUP BY RESOURCE_TYPE
注意:
	1. 半年包的表ZBA_DWD.DWD_M_ACC_AL_RES_DPST_LOG不是单用户表，存在一个用户订购多次，此表为全量数据，使用时按照实际情况加以限制。
2. RESOURCE_TYPE(0101：国内流量, 0102: 省内流量),可参考码表:
SELECT * FROM ZB_DIM.DIM_BI_RESOURCE_ACCT_BOOK;
MEASURE_ID (01: 流量单位：MB)可参考码表：
SELECT * FROM ZB_DIM.DIM_BI_MEASURE_TYPE;
3G集客沃商务出账用户数
集客沃商务出账用户数（不区分业务类型）核对路径为：报表中心——>专业报表——>集团业务沃商务用户发展统计月报，参考过程：DM.P_DM_M_WO_SW
集客沃商务出账用户数（区分业务类型）核对路径为：报表中心——>基础报表——>沃商务用户规模、业务量及收入月报，参考过程：DM.P_DM_REP_M_WCOMM_ALL_2012
SELECT SUM(ACCT_USER) ACCT_USER --本月出账集团用户数
  FROM ZB.ZB_WHOME_M_DEV_06 --对应纵向融合业务指标接口规范《7.2.1.4  沃.商务融合业务发展月报  03记录》（SVN地址：http://132.35.224.234/svn/dssdat/ZBJF_接口规范/05-纵向指标规范/中国联通经营分析指标上传接口规范V3.0-融合业务分册-20120109.doc）
 WHERE MONTH_NO = '201508'
   AND PROV_ID = '010'
   AND TYPE_ID = '140302AA' --3G手机
   AND SUBSTR(DINNER_SIGN_ID, 1, 2) IN ('07', '09') --07:中小企业基础版B方案;09:中小企业增强版B方案
   ;

23G融合
维度
省内流量包
方法一：取ZBA_DWA.DWA_V_M_CUS_3G_USER_INFO_PROV（3G用户资料表，限制IS_CARD='2'）PKG_PROD_CLASS字段，取值对应的流量包类型如下：
 CASE
            WHEN PKG_PROD_CLASS = '0101' THEN
             '10元100M省内流量包'
            WHEN PKG_PROD_CLASS = '0102' THEN
             '20元300M省内流量包'
            WHEN PKG_PROD_CLASS = '0103' THEN
             '30元500M省内流量包'
              WHEN PKG_PROD_CLASS = '0104' THEN
             '集客1G省内流量包'
            WHEN PKG_PROD_CLASS = '0105' THEN
             '100元2.5G省内流量包'
            WHEN PKG_PROD_CLASS = '0106' THEN
             '公众1G省内流量包'
END
方法二：通过ZBA_DWA.DWA_V_M_CUS_3G_USER_INFO_PROV（3G用户资料表，限制IS_CARD='2')中PKG_PROD_CLASS与TEMP_DX_3G_PKG_PROD_CLASS中PRODUCT_CLASS关联取得流量包内流量、月费等。
码表参考语句如下：
SELECT *
  FROM TEMP_DX_3G_PKG_PROD_CLASS
 WHERE IS_PKG = '1'
   AND IS_CARD = '2'
本地套餐流量包
方法一：取ZBA_DWA.DWA_V_M_CUS_3G_USER_INFO_PROV（3G用户资料表，限制IS_CARD='2'）PRODUCT_MODE 字段，取值对应的流量包类型如下：
CASE
WHEN PRODUCT_MODE = '020301' THEN
             '3G本地套餐-100MB省内流量'
            WHEN PRODUCT_MODE = '020302' THEN
             '3G本地套餐-300MB省内流量'
            WHEN PRODUCT_MODE = '020303' THEN
             '3G本地套餐-500MB省内流量'
               WHEN PRODUCT_MODE = '020304' THEN
             '集客2G3G融合业务1G套餐'
            WHEN PRODUCT_MODE = '020305' THEN
             '公众2G3G融合业务1G套餐'
            WHEN PRODUCT_MODE = '020306' THEN
             '2G3G融合业务2.5G套餐'
            WHEN PRODUCT_MODE = '020307' THEN 
'2G3G融合业务33元套餐'
             ELSE '其它'
           END
方法二：通过ZBA_DWA.DWA_V_M_CUS_3G_USER_INFO_PROV（3G用户资料表，限制IS_CARD='2')中PRODUCT_MODE与TEMP_DX_3G_PKG_PROD_CLASS中PRODUCT_CLASS关联取得流量包内流量、月费等。
码表参考语句如下：
SELECT *
  FROM TEMP_DX_3G_PKG_PROD_CLASS
 WHERE IS_PKG = '0'
   AND IS_CARD = '2'

指标
出账用户
指报告期内出账账单金额大于零的用户数
SELECT COUNT(1)
  FROM ZBA_DWA.DWA_V_M_CUS_3G_USER_INFO_ '||V_PROV_ID||' T
 WHERE MONTH_ID = '''||V_MONTH_ID||'''
   AND IS_STAT = ''1''
   AND IS_CARD = ''2'' --0：3G手机，1：上网卡，2:23G融合
   AND IS_THIS_ACCT = ''1''
新增用户
报告期内新开通联通某项业务的用户数（新增用户=新发展用户+业务互转用户+其他新增用户）
SELECT COUNT(1)
FROM ZBA_DWA.DWA_V_M_CUS_3G_USER_INFO_'||V_PROV_ID||'  
 WHERE T1.IS_STAT = ''1''
   AND T1.IS_ADD = ''1'' --当月新增
   AND T1.IS_CARD = ''2''
   AND T1.MONTH_ID = '''||V_YEARMONTH_ADD||'''
新发展用户
指报告期内新办理入网，开始使用联通业务，占用中国联通资源的用户数
SELECT COUNT(1)
FROM ZBA_DWA.DWA_V_M_CUS_3G_USER_INFO_'||V_PROV_ID||'  
 WHERE T1.IS_STAT = ''1''
   AND T1.IS_THIS_DEV= ''1'' --当月新发展标识
   AND T1.IS_CARD = ''2''
   AND T1.MONTH_ID = '''||V_YEARMONTH ||'''
网上用户数
指报告期末在业务支撑系统中拥有注册信息、占用中国联通网络资源并且用户状态不为预开户、注销和删除期的用户总数。
SELECT COUNT(1)
FROM ZBA_DWA.DWA_V_M_CUS_3G_USER_INFO_'||V_PROV_ID||'  
 WHERE T1.IS_STAT = ''1''
   AND T1.IS_INNET = ''1'' --在网
   AND T1.IS_CARD = ''2''
   AND T1.MONTH_ID = '''||V_YEARMONTH ||'''
流失用户
上月出账本月不出账用户，也有个别业务部门希望按照：上月在网本月不在网用户来计算，但一般不这样处理。
一般都是拍照观察，拍照上月出账的用户，观察在本月的出账情况
流失率=上月出账本月不出账用户/上月出账用户数

三无用户
一般口径：非当月新发展且在网出账的三无用户。三无是指：指报告期内无通话行为、无流量详单和无点对点短信发送记录的网上用户。对应模型解释为总通话次数为0，使用流量为0，点对点短信条数为0。
注意:
	三无用户不应该区分终端类型，以后业务部门要的话也不能提供，因为三无用户没有使用量。
沉淀表：ZB_3G_3WU_USERS_RH
极低用户
一般口径：非当月新发展，在网出账用户，使用流量<=3MB，主叫计费时长<=5分钟，点对点发送短信条数<=4条。
注意:
在201405账期以前，除了以上条件，还有用户价值小于52.8。
沉淀表：ZB_3G_LOWUSED_USERS_RH

3G上网卡
维度
3G上网卡补充码表
由于ZB_DIM.DIM_PRODUCT_RATE码表中缺少300元/15GB/月基本套餐等类似套餐的套餐内流量，将类似300元/15GB/月基本套餐类的套餐在ZB_DIM.DIM_PRODUCT_CLASS码表中通过字符串截取，沉淀一张3G上网卡的套餐内流量码表：TEMP_NETCARD_PRODUCT_CLASS
使用方法：    
SELECT *
  FROM (SELECT MONTH_ID,
               PROV_ID,
               SUBS_INSTANCE_ID,
               INNET_MONTH,
               PRODUCT_CLASS
          FROM ZBA_DWA.DWA_V_M_CUS_OCS_USER_INFO
         WHERE MONTH_ID = '201505'
           AND PROV_ID = '011'
           AND STATUS_ID NOT IN ('51', '13')
           AND IS_TEST = '0'
           AND IS_THIS_ACCT = '1'
           AND IS_INNET = '1') A,
       (SELECT * FROM TEMP_NETCARD_PRODUCT_CLASS) E
 WHERE A.PRODUCT_CLASS = E.PRODUCT_CLASS(+)
指标
出账用户
指报告期内出账账单金额大于零的用户数
SELECT COUNT(1)
  FROM ZBA_DWA.DWA_V_M_CUS_3G_USER_INFO_ '||V_PROV_ID||' T
 WHERE MONTH_ID = '''||V_MONTH_ID||'''
   AND IS_STAT = ''1''
   AND IS_CARD = ''1'' --0：3G手机，1：上网卡，2:23G融合
   AND IS_THIS_ACCT = ''1''
新增用户
报告期内新开通联通某项业务的用户数（新增用户=新发展用户+业务互转用户+其他新增用户）
SELECT COUNT(1)
FROM ZBA_DWA.DWA_V_M_CUS_3G_USER_INFO_'||V_PROV_ID||'  
 WHERE T1.IS_STAT = ''1''
   AND T1.IS_ADD = ''1'' --当月新增
   AND T1.IS_CARD = ''1''
   AND T1.MONTH_ID = '''||V_YEARMONTH_ADD||'''
新发展用户
指报告期内新办理入网，开始使用联通业务，占用中国联通资源的用户数
SELECT COUNT(1)
FROM ZBA_DWA.DWA_V_M_CUS_3G_USER_INFO_'||V_PROV_ID||'  
 WHERE T1.IS_STAT = ''1''
   AND T1.IS_THIS_DEV= ''1'' --当月新发展标识
   AND T1.IS_CARD = ''1''
   AND T1.MONTH_ID = '''||V_YEARMONTH ||'''
网上用户数
指报告期末在业务支撑系统中拥有注册信息、占用中国联通网络资源并且用户状态不为预开户、注销和删除期的用户总数。
SELECT COUNT(1)
FROM ZBA_DWA.DWA_V_M_CUS_3G_USER_INFO_'||V_PROV_ID||'  
 WHERE T1.IS_STAT = ''1''
   AND T1.IS_INNET = ''1'' --在网
   AND T1.IS_CARD = ''1''
   AND T1.MONTH_ID = '''||V_YEARMONTH ||'''
OCS上网卡
维度
付费模式
属于05,OCS预付费模式，预付费的一种
发展渠道类型
注意：OCS取发展渠道，使用模型ZB_DWD.DWD_M_MRT_AL_BSDM_CHANNEL_S时统一用011的数据。
SELECT T.USER_ID, T1.CHNL_ID, T2.CHNL_KIND_ID
  FROM (SELECT SUBS_INSTANCE_ID USER_ID
          FROM ZBA_DWA.DWA_V_M_CUS_OCS_USER_INFO
         WHERE MONTH_ID = '201505'
           AND PROV_ID = '010'
           AND STATUS_ID NOT IN ('51', '13')
           AND IS_TEST = '0') T,
       (SELECT A.SUBS_ID USER_ID, A.CHNL_ID
          FROM ZB_DWA.DWA_C_M_BDSM_CHNLKPI_OCS_BI A
         WHERE A.ACCT_MONTH = '201505'
           AND A.PROV_ID = '010'
           AND IS_BF_OCS = '2') T1,
       (SELECT B.CHNL_ID, B.CHNL_KIND_ID
          FROM ZB_DWD.DWD_M_MRT_AL_BSDM_CHANNEL_S B
         WHERE B.PROV_ID = '011'--31省及999，此处条件均为'011'
           AND B.MONTH_ID = '201505') T2
 WHERE T.USER_ID = T1.USER_ID(+)
   AND T1.CHNL_ID = T2.CHNL_ID(+)
收入归集标签
注意：取集团客户OCS用户使用ZBA_DWD.DWD_M_PRD_AL_GC_USER_FLAG模型时统一用011的数据
SELECT T.USER_ID,
       DECODE(T1.BELONG_FLAG,'0','1','1','0','0') BELONG_FLAG--1集团,0为公众
  FROM (SELECT SUBS_INSTANCE_ID USER_ID
          FROM ZBA_DWA.DWA_V_M_CUS_OCS_USER_INFO
         WHERE MONTH_ID = '201507'
           AND PROV_ID = '010'
           AND STATUS_ID NOT IN ('51', '13')
           AND IS_TEST = '0'
           ) T,
       (SELECT B.USER_ID, B.BELONG_FLAG--0集团,1和空为公众
          FROM ZBA_DWD.DWD_M_PRD_AL_GC_USER_FLAG_011 B----31省及999，此处条件均ZBA_DWD.DWD_M_PRD_AL_GC_USER_FLAG_011
         WHERE B.MONTH_ID = '201507') T1
 WHERE T.USER_ID = T1.USER_ID(+)
用户群标签
注意：取OCS用户群标签使用ZBA_DWD.DWD_M_PRD_AL_GC_USER_FLAG模型时统一用011的数据
SELECT T.USER_ID,
       DECODE(T1.USER_GROUP_FLAG,'0','1','1','0','0') USER_GROUP_FLAG--1集团,0为公众
  FROM (SELECT SUBS_INSTANCE_ID USER_ID
          FROM ZBA_DWA.DWA_V_M_CUS_OCS_USER_INFO
         WHERE MONTH_ID = '201507'
           AND PROV_ID = '010'
           AND STATUS_ID NOT IN ('51', '13')
           AND IS_TEST = '0'
           ) T,
       (SELECT B.USER_ID, B.USER_GROUP_FLAG--0集团,1和空为公众
          FROM ZBA_DWD.DWD_M_PRD_AL_GC_USER_FLAG_011 B----31省及999，此处条件均ZBA_DWD.DWD_M_PRD_AL_GC_USER_FLAG_011
         WHERE B.MONTH_ID = '201507') T1
 WHERE T.USER_ID = T1.USER_ID(+)
指标
出账用户
指报告期内出账账单金额大于零的用户数
SELECT COUNT(1)
  FROM ZBA_DWA.DWA_V_M_CUS_OCS_USER_INFO
 WHERE MONTH_ID = '201505'
   AND PROV_ID = '011'
   AND STATUS_ID NOT IN ('51', '13')
   AND IS_TEST = '0'
   AND STATUS_ID <> '51'
   AND IS_THIS_ACCT = '1'
注意：
ZBA_DWA.DWA_V_M_CUS_OCS_USER_INFO表中除31省编码外还有有省份编码为999，地市编码为999的情况，在加工数据的时候一定不要忘记，省份编码999，地市编码999统一命名为“其他”，之前有些需求是接维的国信脚本，他们命名为了“重重其他”
新发展用户
指报告期内新办理入网，开始使用联通业务，占用中国联通资源的用户数
OCS新发展用户=OCS新增用户
SELECT COUNT(1)
  FROM ZBA_DWA.DWA_V_M_CUS_OCS_USER_INFO
 WHERE MONTH_ID = '201307'
   AND IS_TEST = '0'
   AND STATUS_ID <> '51'
   AND STATUS_ID NOT IN ('51', '13')
   AND IS_ADD = '1'
   AND PROV_ID = '011'
新发展用户（页面指标）
指报告期内新办理入网，开始使用联通业务，占用中国联通资源的用户数
3G套餐3G套餐(月)—>新增流失(月)，3G套餐新增用户—>3G无线上网卡新增用户发展用户，其中的OCS新发展用户数
DM视图层：
SELECT SUM(INC_USER)
  FROM ZBA_DM.V_DM_C_M_DEV_3G_NEW_CLASS
 WHERE MONTH_ID = '201605'
   AND IS_OCS = '1';
DM层：
SELECT SUM(ADD_USER)
  FROM ZBA_DM.DM_C_M_DEV_3G_OCS_BASE
 WHERE MONTH_ID = '201605' ;
DWA层：
SELECT COUNT(1)
  FROM ZBA_DWA.DWA_V_M_CUS_OCS_USER_LIST A,
       (SELECT SUBS_INSTANCE_ID USER_ID,
               INNET_FLAG,
               USER_GROUP_FLAG,
               MINOR_ENTERPRISES_FLAG,
               CUST_SIZE
          FROM ZBA_DWA.DWA_V_M_CUS_OCS_USER_INFO A
         WHERE A.MONTH_ID = '201605'
           AND A.IS_TEST = '0'
           AND A.STATUS_ID <> '51'
           AND A.STATUS_ID NOT IN ('13', '51')        ) T
 WHERE A.MONTH_ID = '201605'
   AND A.SUBS_INSTANCE_ID = T.USER_ID(+)
   AND A.IS_ADD = '1';



网上用户
指报告期末在业务支撑系统中拥有注册信息、占用中国联通网络资源并且用户状态不为预开户、注销和删除期的用户总数。
SELECT COUNT(1)
  FROM ZBA_DWA.DWA_V_M_CUS_OCS_USER_INFO
 WHERE IS_TEST = '0'
   AND STATUS_ID NOT IN ('51', '13') 
   AND STATUS_ID <> '51'
   AND PROV_ID = '011'
   AND MONTH_ID = '201505'
   AND IS_INNET = '1'
2G套餐
维度
付费模式
取ZBA_DWA.DWA_V_M_CUS_2G_USER_INFO_PROV（2G用户基本衍生信息表)的PAY_MODE字段，其中PAY_MODE IN ('03','04','05')为预付费，PAY_MODE IN ('01','02')为后付费
入网时间
新办理入网，开始使用联通业务的时间。
取ZBA_DWA.DWA_V_M_CUS_2G_USER_INFO_PROV（2G用户基本衍生信息表)的INNET_DATE字段。
发展渠道类型
指用户的入网渠道，该用户是通过什么渠道被发展为联通用户的。
通过如下SQL取CHNL_KIND_ID字段对渠道进行分类；
CHNL_KIND_ID所代表的渠道类型，可通过与ZB_DIM.DIM_CHANNEL_TYPE_BSDM（渠道归类信息码表）中LEVEL_3字段关联取出。

SELECT T.USER_ID,
       T1.CHNL_ID,
       T2.CHNL_KIND_ID
  FROM (SELECT A.USER_ID, A.ZB_DEV_MAN_ID
          FROM ZBA_DWA.DWA_V_M_CUS_2G_USER_INFO_011 A
         WHERE A.MONTH_ID = '201507'
           AND A.IS_STAT = '1') T,
       (SELECT B.DEV_CODE, B.CHNL_ID
          FROM ZB_DWD.DWD_M_MRT_AL_DEV_MAN_INFO_011 B
         WHERE B.MONTH_ID = '201507') T1, --渠道发展人信息
       
       (SELECT C.CHNL_ID, C.CHNL_NAME, C.CHNL_KIND_ID
          FROM ZB_DWD.DWD_M_MRT_AL_BSDM_CHANNEL_S C--渠道信息
         WHERE MONTH_ID = '201507'
           AND PROV_ID = '011') T2
 WHERE T.ZB_DEV_MAN_ID = T1.DEV_CODE(+)
   AND T1.CHNL_ID = T2.CHNL_ID(+)
   ;

归集标签
取用户资料表中的USER_ID字段，与 ZBA_DWD.DWD_M_PRD_AL_GC_USER_FLAG_PROV（集客标签表） 中 USER_ID 进行关联，取集客标签表中BELONG_FLAG字段，无需限定其他条件，取值为0集团，1和空为公众。

注意：
1. 集客标签表ZBA_DWD.DWD_M_PRD_AL_GC_USER_FLAG_PROV数据从201308账期开始具备
2. 2013年10月账期之前如下集客标签表一直使用
SELECT /*+PARALLEL(T,2)*/
 T.USER_ID, T.INCOME_BELONG_FLAG -- 1和空的都是公众，0是集团
  FROM ZBA_DWA.DWA_V_D_CUS_GROUP_FLAG_011 T
 WHERE MONTH_ID = '201306'
   AND DAY_ID = '03'
用户群标签
取ZBA_DWD.DWD_M_PRD_AL_GC_USER_FLAG表的USER_GROUP_FLAG，0为集团客户，空和1为公众用户，与用户资料表的关联方法详见归集标签部分。

中小企业(只针对集客用户)
首先限定集客用户（集客用户取法详见归集标签部分），
再通过USER_ID与ZBA_DWA.DWA_V_M_CUS_AL_GC_RELATION模型关联，利用该模型中CUST_SIZE来区分用户的企业类型。

利用CUST_SIZE区分用户企业类型的方法如下：
DECODE(CUST_SIZE,'1','小微','2','中小企业','3','大客户','其他')
是否实名制
判断联通用户是否进行了实名登记。
通过ZBA_DWA.DWA_V_M_CUS_2G_USER_INFO_PROV（2G用户资料表)的USER_ID，
与表ZBA_DWA.DWA_V_M_CUS_2G_RNS_WIDE的SUBS_INSTANCE_ID相关联，
取该表IS_VALID_FLAG字段，无需限定其他条件，取值为“1”表示“是实名制”
客户信息
指办理使用联通业务的客户的信息。

通过ZBA_DWA.DWA_V_M_CUS_2G_USER_INFO_PROV（2G用户资料表)的CUST_ID（客户ID）字段，关联如下表CUST_ID字段，获取姓名、证件类型、证件号码：
SELECT CUST_ID, F_DECRYPT(CUST_NAME) CUST_NAME--客户名称
  FROM ZBA_DWD.DWD_M_CUS_AL_CUSTOMER_079
 WHERE MONTH_ID = '201603';

SELECT CUSTOMER_ID CUST_ID,
       CERT_TYPE,--证件类型
        CERT_NO----证件号码 加密的，尚未找到解密函数
  FROM ZBA_DWD.DWD_M_CUS_AL_CERT_INFO_079 
 WHERE MONTH_ID = '201603';

通过ZBA_DWA.DWA_V_M_CUS_2G_USER_INFO_PROV（2G用户资料表)的CUST_ID（客户ID）字段，关联如下表CUST_ID字段，获取客户性别、年龄：
SELECT T.CUST_ID,
       T.CERT_TYPE,
       T.CUST_SEX,--1,男;2,女
       T.CERT_AGE--年龄
  FROM ZBA_DWA.DWA_V_M_CUS_AL_RNS_079 T--客户实名衍生信息(月)，除了客户姓名、年龄外，该表中还有客户名称和证件号码，但是加密的，不可用
 WHERE MONTH_ID='201603'
AND CERT_TYPE IN ('0101', '0102', '0108')
   AND CERT_NO_IS_VALID='1';

通过ZBA_DWA.DWA_V_M_CUS_2G_USER_INFO_PROV（2G用户资料表)的USER_ID（用户ID）字段，关联如下表SUBS_INSTANCE_ID字段，获取客户性别、年龄：
SELECT SUBS_INSTANCE_ID USER_ID, 
CUST_SEX, --1,男;2,女
CERT_AGE
  FROM ZBA_DWA.DWA_V_M_CUS_2G_RNS_WIDE
 WHERE PROV_ID = '&PROV_ID'
   AND MONTH_ID = '&MONTH_ID'
   AND IS_VALID_FLAG = '1'

VIP级别
通过ZBA_DWA.DWA_V_M_CUS_2G_USER_INFO_PROV（2G用户资料表)的USER_ID，与如下表USER_ID相关联，取VIP_LEVEL字段即可。
VIP_LEVEL取值代表的含义为：02：钻石卡 03：金卡 04：银卡，这三类均归为VIP用户。
 SELECT *
  FROM ZBA_DWA.DWA_V_M_CUS_MB_VIP_INFO_011 T
 WHERE T.IS_VIP_VALID = '1'
   AND T.VIP_LEVEL IN ('02', '03', '04') --02:钻石卡，03：金卡，04：银卡
   AND T.SERVICE_TYPE IN ('20AAAAAA',
                          '2001AAAA',
                          '200101AA',
                          '200102AA',
                          '2002AAAA',
                          '2099AAAA')
   AND T.MONTH_ID = '201310'
用户使用的卡类型
卡类型分为SIM卡和USIM卡。

通过ZBA_DWA.DWA_V_M_CUS_2G_USER_INFO_PROV（2G用户资料表)的USER_ID，
与表ZBA_DWA.DWA_V_M_CUS_MB_USER_RES_PROV的USER_ID相关联，
取该表CARD_TYPE字段即可。
红黑名单
判断联通用户是否红黑名单。
通过ZBA_DWA.DWA_V_M_CUS_2G_USER_INFO_PROV（2G用户资料表)的CUST_ID，
与表ZBA_DWD.DWD_M_CUS_AL_REDBLACKLIST_011的CUST_ID相关联
SELECT CUST_ID
  FROM ZBA_DWD.DWD_M_CUS_AL_REDBLACKLIST_011 A
 WHERE A.MONTH_ID = '201606'
   AND A.IS_VALID = '1'
   AND LIST_TYPE IN ('01', '02')--01红名单02黑名单
 GROUP BY CUST_ID;
终端类型
select 
       CASE WHEN T3.ONEIN1MON_NET_TYPE_REV = '02' AND T_3WU.USER_ID IS NULL
              THEN   '2G'
            WHEN T3.ONEIN1MON_NET_TYPE_REV = '03' AND T_3WU.USER_ID IS NULL
              THEN  '3G'
            WHEN T3.ONEIN1MON_NET_TYPE_REV = '04' AND T_3WU.USER_ID IS NULL
              THEN  '4G'
       ELSE '无法识别' END ZD_TYPE  --终端类型
from (SELECT  t.user_id,'B'||t.user_id  user_id_new, t.zb_dev_man_id,t.IS_THIS_BREAK,t.IS_THIS_ACCT,
             t.is_innet,substr(t.innet_date,0,6) innet_date,t.PRODUCT_ID,INNET_MONTHS,'2G' yw,'0' is_card,device_number
              FROM ZBA_DWA.DWA_V_M_CUS_2G_USER_INFO_010 T --2G用户资料表
                 WHERE MONTH_ID =  '201708'
               AND T.IS_STAT = '1'
               AND t.IS_INNET='1'

           
               )T1,
         
  (SELECT USER_ID, --带着B的
             ONEIN1MON_NET_TYPE_REV-- 00=无法区分，04=4G、03=3G、02=2G
         FROM ZBG_DWA.DWA_V_M_CUS_ALL_ZCTMF2_010@LINK_DSSDWE
          WHERE MONTH_ID =  '201708'
              AND SERVICE_TYPE NOT like '40%' --套餐类型 2G套餐：LIKE '20%'；3G套餐：LIKE '30%'；4G套餐：LIKE '40%'；
                    )T3--关联使用终端类型表
where T1.user_id_new=T3.user_id(+)--关联使用终端类型表
承诺低消送流量
select  
 CASE WHEN t5.USER_ID IS NOT NULL   THEN '1'  ELSE  '0'  end IS_CNDX  --是否办理承诺低消送流量
   FROM 
 (SELECT  t.user_id,'B'||t.user_id  user_id_new, t.zb_dev_man_id,t.IS_THIS_BREAK,t.IS_THIS_ACCT,
             t.is_innet,substr(t.innet_date,0,6) innet_date,t.PRODUCT_ID,INNET_MONTHS,'2G' yw,'0' is_card,device_number
              FROM ZBA_DWA.DWA_V_M_CUS_2G_USER_INFO_011 T --2G用户资料表
                 WHERE MONTH_ID =  '201708'
               AND T.IS_STAT = '1'

          

               ) T1,--23G用户资料表
  (SELECT  USER_ID
          FROM (SELECT T.*,
                       ROW_NUMBER() OVER(PARTITION BY USER_ID ORDER BY PRODUCT_FLAG, EFFECT_DATE DESC) RN
                  FROM zbA_dwa.DWA_V_M_CUS_MB_139_011 T
                 WHERE MONTH_ID =  '201708')
         WHERE RN = 1
           AND product_flag = '02') T5--23G是否办理承诺低消送流量
           
            WHERE  T1.USER_ID = T5.USER_ID(+)
用户星级
注意预评级也需要算在内，三星及以上星级用户属于高价值用户。
select  
   case when T6.user_id is not null then t6.USER_LEVEL
            when t7.user_id is not null then '0'||t7.USER_LEVEL
            else null end USER_LEVEL,--用户星级
   FROM 
 (SELECT  t.user_id,'B'||t.user_id  user_id_new, t.zb_dev_man_id,t.IS_THIS_BREAK,t.IS_THIS_ACCT,
             t.is_innet,substr(t.innet_date,0,6) innet_date,t.PRODUCT_ID,INNET_MONTHS,'2G' yw,'0' is_card,device_number
              FROM ZBA_DWA.DWA_V_M_CUS_2G_USER_INFO_011 T --2G用户资料表
                 WHERE MONTH_ID =  '201708'
               AND T.IS_STAT = '1'
               ) T1,--23G用户资料表
(SELECT  USER_ID, USER_LEVEL
               FROM (SELECT USER_ID,
                            USER_LEVEL,
                            ROW_NUMBER() OVER(PARTITION BY USER_ID ORDER BY MONTH_ID DESC NULLS LAST) RN
                       FROM ZBG_DWA.MID1_V_M_CUS_MB_VALUE_LIST_011@LINK_DSSDWE --BSS用户价值评级模型
                      WHERE MONTH_ID >= '201505' --固定值
                        AND MONTH_ID <=  '201708')--之前被评过就算
                     WHERE RN = 1 ) T6, --BSS用户价值评级模型
   ( SELECT USER_ID,
                            USER_LEVEL
                       FROM ZBG_DWA.MID_V_M_CUS_MB_VALUE_011@LINK_DSSDWE --BSS用户价值评级模型
                      WHERE MONTH_ID =  '201708')T7 --预评级
           
            WHERE  T1.USER_ID = T6.USER_ID(+) 
             AND   T1.USER_ID = T7.USER_ID(+)
疑似养卡
一般是判定6个月内是否养卡，新增用户当月是否养卡。
疑似养卡表 从201601才开始有数据，如果账期-5话，数据会不全。2016-201604月的数据量少，不全。
----------2G
select  
         CASE  when T_10.user_id is not null then '1' ELSE '0' END IS_RAIS,--是否疑似养卡

   FROM 
 (SELECT  t.user_id,'B'||t.user_id  user_id_new, t.zb_dev_man_id,t.IS_THIS_BREAK,t.IS_THIS_ACCT,
             t.is_innet,substr(t.innet_date,0,6) innet_date,t.PRODUCT_ID,INNET_MONTHS,'2G' yw,'0' is_card,device_number
              FROM ZBA_DWA.DWA_V_M_CUS_2G_USER_INFO_011 T --2G用户资料表
                 WHERE MONTH_ID =  '201708'
               AND T.IS_STAT = '1'

          

               ) T1,--23G用户资料表
(    (SELECT SUBS_INSTANCE_ID user_id FROM
       (SELECT T.*,
               ROW_NUMBER() OVER(PARTITION BY T.SUBS_INSTANCE_ID ORDER BY MONTH_ID desc,INNET_DATE DESC, SERVICE_TYPE DESC NULLS LAST) RN
          FROM ZB_CSM.DWA_DEV_RAISED T
         WHERE  MONTH_ID BETWEEN '201703' AND  '201708'
               AND PROV_ID ='011'
               AND SERVICE_TYPE NOT LIKE '40%'--23G
               AND  user_type <> '真实'--一定别忘了
               ) WHERE RN=1) t_10--一般是判定6个月内是否疑似养卡
            WHERE  T1.USER_ID = T10.USER_ID(+)

指标
出账用户
指报告期内出账账单金额大于零的用户数
SELECT COUNT(1)
  FROM ZBA_DWA.DWA_V_M_CUS_2G_USER_INFO_011 T
 WHERE MONTH_ID = '201505'
   AND IS_STAT = '1'
   AND IS_THIS_ACCT = '1'
网上用户
指报告期末在业务支撑系统中拥有注册信息、占用中国联通网络资源并且用户状态不为预开户、注销和删除期的用户总数。
SELECT COUNT(1)
  FROM ZBA_DWA.DWA_V_M_CUS_2G_USER_INFO_011 T
 WHERE MONTH_ID = '201505'
   AND IS_STAT = '1'
   AND IS_INNET = '1'
流失用户
上月出账本月不出账用户，也有个别业务部门希望按照：上月在网本月不在网用户来计算，但一般不这样处理。
一般都是拍照观察，拍照上月出账的用户，观察在本月的出账情况
流失率=上月出账本月不出账用户/上月出账用户数
新入网用户—分渠道口径的，和集中渠道报表保持一致
可参照过程   P_TEMP_LJT_APP_NEW_N3

--2G
SELECT ''B'' || SUBS_ID USER_ID,
               CHNL_ID,
               SVC_TYPE_3G is_card,
               innet_flag is_innet,
               SUM(CASE
                     WHEN T.DEV_FLAG >= ''1'' THEN
                      T.DEV_FLAG
                     ELSE
                      ''0''
                   END) DEV_NUM
          FROM ZB_DWA.DWA_C_M_BDSM_CHNLKPI_2G_BI T
         WHERE T.ACCT_MONTH = '''||V_MONTH||'''
           AND T.PROV_ID = '''||V_PROV||'''
           AND SVC_TYPE = ''01''
           AND T.INC_USER >= ''1''
           AND IS_BF_OCS = ''1''
         GROUP BY ''B'' || SUBS_ID, CHNL_ID,SVC_TYPE_3G,innet_flag
当期离网用户
SELECT *
     FROM ZBG_DWA.DWA_V_M_CUS_NM_USER_INFO_'||V_PROV||'@LINK_DSSDWE
        WHERE MONTH_ID = '''||V_MONTH||'''
      AND IS_STAT = ''1''
     And  is_this_break_old = ''1''

新发展用户
指报告期内新办理入网，开始使用联通业务，占用中国联通资源的用户数

SELECT COUNT(1)
  FROM ZBA_DWA.DWA_V_M_CUS_2G_USER_INFO_011 T
 WHERE MONTH_ID = '201505'
   AND IS_STAT = '1'
   AND IS_THIS_DEV = '1'
三无用户
一般口径：非当月新发展且在网出账的三无用户。三无是指：指报告期内无通话行为、无流量详单和无点对点短信发送记录的网上用户。对应模型解释为总通话次数为0，使用流量为0，点对点短信条数为0。
注意:
	三无用户不应该区分终端类型，以后业务部门要的话也不能提供，因为三无用户没有使用量。
沉淀表：ZB_2G_3WU_USERS

2G新增国漫用户（本月开通上月未开通）
SELECT COUNT(T1.BY_DAUSER) ADD_USER --本月新增
  FROM (SELECT MAX(STATUS_CHANGE_DATE) MAX_STATUS, USER_ID BY_DAUSER --本月到达用户数
          FROM ZB_DWD.DWD_M_PRD_AL_USER_SERVICE_011
         WHERE MONTH_ID = '201505'
           AND SERVE_STATUS = '01'
           AND SERVE_ID = '0005'
         GROUP BY USER_ID) T1,
       (SELECT MAX(STATUS_CHANGE_DATE) MAX_STATUS, USER_ID SY_DAUSER --上月到达用户数
          FROM ZB_DWD.DWD_M_PRD_AL_USER_SERVICE_011
         WHERE MONTH_ID =
               TO_CHAR(ADD_MONTHS(TO_DATE('201505', 'YYYYMM'), -1), 'YYYYMM') --上月
           AND SERVE_STATUS = '01'
           AND SERVE_ID = '0005'
         GROUP BY USER_ID) T2,
       (SELECT *
          FROM ZBA_DWA.DWA_V_M_CUS_2G_USER_INFO_011 T
         WHERE IS_STAT = '1'
           AND MONTH_ID = '201505') T3
 WHERE T1.BY_DAUSER = T2.SY_DAUSER(+)
   AND T2.SY_DAUSER IS NULL
注意：
开通权限
SERVE_ID = '0005' 国际漫游 SERVE_ID = '0003' 国际长途 
状态
SERVE_STATUS = '01' 开通 SERVE_STATUS = '02' 关闭
2G到达国漫用户（本月开通国漫用户）
SELECT COUNT(T1.BY_DAUSER) ADD_USER --本月到达
  FROM (SELECT MAX(STATUS_CHANGE_DATE) MAX_STATUS, USER_ID BY_DAUSER --本月到达用户数
          FROM ZB_DWD.DWD_M_PRD_AL_USER_SERVICE_079
         WHERE MONTH_ID = '201506'
           AND SERVE_STATUS = '01'
           AND SERVE_ID = '0005'
         GROUP BY USER_ID) T1,
       (SELECT *
          FROM ZBA_DWA.DWA_V_M_CUS_2G_USER_INFO_079 T
         WHERE IS_STAT = '1'
           AND MONTH_ID = '201506') T3
 WHERE T1.BY_DAUSER = T3.USER_ID
2G关闭国漫用户(上月开通本月未开通)
SELECT '''||V_MONTH||''', '''||V_PROV||''', ''2A'', COUNT(A.GB_USER)
  FROM (SELECT T1.SY_DAUSER GB_USER --本月关闭
          FROM (SELECT MAX(STATUS_CHANGE_DATE) MAX_STATUS, USER_ID SY_DAUSER --上月到达用户数
                  FROM ZB_DWD.DWD_M_PRD_AL_USER_SERVICE_'||V_PROV||'
                 WHERE MONTH_ID = TO_CHAR(ADD_MONTHS(TO_DATE('''||V_MONTH||''', 'YYYYMM'), -1),'YYYYMM')
                   AND SERVE_STATUS = ''01''
                   AND SERVE_ID = ''0005''
                 GROUP BY USER_ID) T1,
               (SELECT MAX(STATUS_CHANGE_DATE) MAX_STATUS, USER_ID BY_DAUSER --本月到达用户数
                  FROM ZB_DWD.DWD_M_PRD_AL_USER_SERVICE_'||V_PROV||'
                 WHERE MONTH_ID = '''||V_MONTH||'''
                   AND SERVE_STATUS = ''01''
                   AND SERVE_ID = ''0005''
                 GROUP BY USER_ID) T2
         WHERE T1.SY_DAUSER = T2.BY_DAUSER(+)
           AND T2.BY_DAUSER IS NULL) A,
       (SELECT *
          FROM ZBA_DWA.DWA_V_M_CUS_2G_USER_INFO_'||V_PROV||' T
         WHERE IS_STAT = ''1''
           AND MONTH_ID = ''201505'') B
 WHERE A.GB_USER = B.USER_ID
2G剔除降欠用户
剔除降欠口径：降欠挂账出帐费用为0，且正常出帐费用大于0 的2G出账用户。
SELECT T1.USER_ID, NET_TYPE, NOMAL_TOTAL_FEE
  FROM (SELECT USER_ID, '2G' NET_TYPE
          FROM ZBA_DWA.DWA_V_M_CUS_2G_USER_INFO_011 A
         WHERE IS_STAT = '1'
           AND IS_THIS_ACCT = '1'
           AND MONTH_ID = '201506') T1, --出账
       (SELECT USER_ID,
               NOMAL_TOTAL_FEE,--正常出帐费用（0）
               (TOTAL_FEE - NOMAL_TOTAL_FEE) JQ_FEE --降欠挂账出帐费用(1)
          FROM ZBA_DWA.DWA_V_M_CUS_MB_RH_SCHARGE_011
         WHERE MONTH_ID = '201506') T2 --收入
 WHERE T1.USER_ID = T2.USER_ID(+)
   AND T2.JQ_FEE = 0
   AND T2.NOMAL_TOTAL_FEE > 0
B侧开放4G网络用户-2G套餐部分
（CB侧用户4G网络默认全部开发）
以2G出账用户为例
SELECT SUM(CASE
             WHEN T8.USER_ID IS NOT NULL THEN
              '1'
             ELSE
              NVL(T7.IS_4G_OPEN, '0')
           END) IS_4G_OPEN, --开放4G网络
  FROM (SELECT MONTH_ID,
               PROV_ID,
               AREA_ID,
               SERVICE_TYPE,
               IS_CARD,
               IS_THIS_ACCT,
               USER_ID,
               DEVICE_NUMBER,
               IS_INNET,
               PRODUCT_MODE,
               USER_STATUS
          FROM ZBA_DWA.DWA_V_M_CUS_MB_USER_INFO_011@DSSDWYZ
         WHERE MONTH_ID = '201603'
           AND IS_STAT = '1'
           AND IS_THIS_ACCT = '1'
           AND SERVICE_TYPE LIKE '20%' ) T,
       (SELECT USER_ID, IS_4G_OPEN, IS_3G_OPEN
          FROM ZBA_DWA.DWA_V_D_CUS_AL_USER_SERV_011@DSSDWYZ
         WHERE MONTH_ID = '201603'
           AND DAY_ID = '31') T7,  --本月最后一天
       (SELECT USER_ID
          FROM ZBA_DWA.DWA_V_D_CUS_2G_USER_LOST_011@DSSDWYZ T
         WHERE T.MONTH_ID = '201604'
           AND DAY_ID = '01'  --次月第一天
           AND T.IS_LOST_TYPE = '218') T8
 WHERE T.USER_ID = T7.USER_ID(+)
   AND T.USER_ID = T8.USER_ID(+)

按照网络分类
按照用户使用的网络进行分类，分为4G网络、3G网络、2G网络和无法识别的网络四种。
公共部分
注意：
无法识别网络用户包括两部分：
1. ZBG_DWA.DWA_V_M_CUS_NM_USER_INFO_&prov_id@LINK_DSSDWE中SERVICE_TYPE LIKE '90%'部分，该部分各维度取法详见“公共部分--维度（不含OCS上网卡）”部分；
2. 3GOCS无线上网卡部分，目前不能区分网络类型，直接归属为其他网络，该部分维度和指标取法详见“按照套餐分类—3G套餐—OCS上网卡”部分
维度（不含OCS上网卡）
产品类型、付费模式、归集标签、用户群标签、集中渠道类型
说明：集中渠道类型沿用老口径（不含OCS上网卡），其他可以从新模型直接取
SELECT A.USER_ID,
       A.USER_ID_OLD,
       CASE
         WHEN A.SERVICE_TYPE_OLD LIKE '20%' THEN
          '2G手机'
         WHEN A.SERVICE_TYPE_OLD LIKE '30%' AND A.IS_CARD = '0' THEN
          '3G手机'
         WHEN A.SERVICE_TYPE_OLD LIKE '30%' AND A.IS_CARD = '1' THEN
          '3G上网卡'
         WHEN A.SERVICE_TYPE_OLD LIKE '30%' AND A.IS_CARD = '2' THEN
          '2/3G融合'
         WHEN A.SERVICE_TYPE_OLD LIKE '40%' AND A.IS_CARD = '0' THEN
          '4G手机'
         WHEN A.SERVICE_TYPE_OLD LIKE '40%' AND A.IS_CARD = '1' THEN
          '4G上网卡'
       END SERVICE_TYPE_OLD, --老套餐类型
       CASE
         WHEN A.SERVICE_TYPE LIKE '20%' THEN
          '2G' --2G业务
         WHEN A.SERVICE_TYPE LIKE '30%' THEN
          '3G' --3G业务
         WHEN A.SERVICE_TYPE LIKE '40%' THEN
          '4G' --4G业务
         WHEN A.SERVICE_TYPE LIKE '90%' THEN
          '00' --其他业务
       END SERVICE_TYPE_NET, --新业务类型
       A.IS_CARD, --是否上网卡
       A.PRODUCT_CLASS, --产品分类
       A.PAY_MODE, --付费模式
       A.IS_GROUP, --集客标签    1:集客；0：公众
       A.USER_GROUP_FLAG, --用户群标签  1:集客；0：公众
       CASE
         WHEN A.SERVICE_TYPE_OLD LIKE '20%' THEN
          I2G.CHNL_KIND_ID
         WHEN A.SERVICE_TYPE_OLD LIKE '30%' THEN
          I3G.CHNL_KIND_ID
         WHEN A.SERVICE_TYPE_OLD LIKE '40%' THEN
          I4G.CHNL_KIND_ID
       END CHANNEL_TYPE_ZB --集中渠道渠道类型
  FROM (SELECT /* + PARALLEL (T, 2)*/
         T.USER_ID, --USER_ID 与USER_ID_OLD的关系，1、23G用户,USER_ID='B'||USER_ID_OLD ; 2、4G用户,USER_ID='A'||USER_ID_OLD
         T.USER_ID_OLD,
         T.SERVICE_TYPE,
         T.SERVICE_TYPE_OLD,
         T.IS_CARD,
         T.PAY_MODE,
         T.PRODUCT_CLASS,
         T.IS_GROUP,
         T.USER_GROUP_FLAG,
         T.CHANNEL_ID,
         T.DEVELOPER_ID
          FROM ZBG_DWA.DWA_V_M_CUS_NM_USER_INFO_&prov_id@LINK_DSSDWE T
         WHERE MONTH_ID = '&month_id'
           AND IS_STAT = '1') A, --用户资料表
       (SELECT A.USER_ID, B.CHNL_KIND_ID
          FROM (SELECT A.SUBS_ID USER_ID, A.CHNL_ID
                  FROM ZB_DWA.DWA_C_M_BDSM_CHNLKPI_2G_BI A--ZB_DWA.DWA_C_M_BDSM_CHNLKPI_2G_BI与ZB_DWA.DWA_C_M_BDSM_CHNLKPI_3G_BI表中USER_ID有重复，不能UNION 到一起使用
                 WHERE A.ACCT_MONTH = '&month_id'
                   AND A.PROV_ID = '&prov_id') A,
               (SELECT CHNL_ID, CHNL_KIND_ID
                  FROM ZB_DWD.DWD_M_MRT_AL_BSDM_CHANNEL_S
                 WHERE MONTH_ID = '&month_id'
                   AND PROV_ID = '&prov_id') B
         WHERE A.CHNL_ID = B.CHNL_ID(+)) I2G, --2G集中渠道渠道类型
       (SELECT A.USER_ID, B.CHNL_KIND_ID
          FROM (SELECT A.SUBS_ID USER_ID, A.CHNL_ID
                  FROM ZB_DWA.DWA_C_M_BDSM_CHNLKPI_3G_BI A--ZB_DWA.DWA_C_M_BDSM_CHNLKPI_2G_BI与ZB_DWA.DWA_C_M_BDSM_CHNLKPI_3G_BI表中USER_ID有重复，不能UNION 到一起使用
                 WHERE A.ACCT_MONTH = '&month_id'
                   AND A.PROV_ID = '&prov_id') A,
               (SELECT CHNL_ID, CHNL_KIND_ID
                  FROM ZB_DWD.DWD_M_MRT_AL_BSDM_CHANNEL_S
                 WHERE MONTH_ID = '&month_id'
                   AND PROV_ID = '&prov_id') B
         WHERE A.CHNL_ID = B.CHNL_ID(+)) I3G, --3G集中渠道渠道类型
       (SELECT /* + PARALLEL (T10, 2)*/
         CHNL_KIND_ID, CHNL_ID
          FROM ZB_DWD.DWD_M_MRT_AL_BSDM_CHANNEL_S T10
         WHERE MONTH_ID = '&month_id'
           AND PROV_ID = '&prov_id') I4G --4G集中渠道渠道类型
 WHERE A.USER_ID_OLD = I2G.USER_ID(+)
   AND A.USER_ID_OLD = I3G.USER_ID(+)
   AND A.CHANNEL_ID = I4G.CHNL_ID(+);
合约类型
通过新口径模型，把3G和4G的合约类型一起取出来。
出账用户和网上用户
通过ZBG_DWA.DWA_V_M_CUS_NM_USER_INFO_PROV（新模型用户资料表)的USER_ID，
与合约表（限制IS_VALID = '1'）中经过转换的用户ID进行关联，取ACTIVITY_TYPE，以出账用户合约类型的取法为例：
SELECT A.USER_ID,
       A.USER_ID_OLD,
       CASE
         WHEN A.SERVICE_TYPE_OLD LIKE '20%' THEN
          '2G手机'
         WHEN A.SERVICE_TYPE_OLD LIKE '30%' AND A.IS_CARD = '0' THEN
          '3G手机'
         WHEN A.SERVICE_TYPE_OLD LIKE '30%' AND A.IS_CARD = '1' THEN
          '3G上网卡'
         WHEN A.SERVICE_TYPE_OLD LIKE '30%' AND A.IS_CARD = '2' THEN
          '2/3G融合'
         WHEN A.SERVICE_TYPE_OLD LIKE '40%' AND A.IS_CARD = '0' THEN
          '4G手机'
         WHEN A.SERVICE_TYPE_OLD LIKE '40%' AND A.IS_CARD = '1' THEN
          '4G上网卡'
       END SERVICE_TYPE_OLD, --老套餐类型
       CASE
         WHEN A.SERVICE_TYPE LIKE '20%' THEN
          '2G' --2G业务
         WHEN A.SERVICE_TYPE LIKE '30%' THEN
          '3G' --3G业务
         WHEN A.SERVICE_TYPE LIKE '40%' THEN
          '4G' --4G业务
         WHEN A.SERVICE_TYPE LIKE '90%' THEN
          '00' --其他业务
       END SERVICE_TYPE_NET, --新业务类型
       CASE
         WHEN SERVICE_TYPE_OLD LIKE '30%' THEN
          G3G.ACTIVITY_TYPE
         WHEN SERVICE_TYPE_OLD LIKE '40%' THEN
          G4G.ACTIVITY_TYPE
       END ACT_TYPE --合约类型
  FROM (SELECT /* + PARALLEL (T, 2)*/
         T.USER_ID, --USER_ID 与USER_ID_OLD的关系，1、23G用户,USER_ID='B'||USER_ID_OLD ; 2、4G用户,USER_ID='A'||USER_ID_OLD
         T.USER_ID_OLD,
         T.SERVICE_TYPE,
         T.SERVICE_TYPE_OLD,
         T.IS_CARD
          FROM ZBG_DWA.DWA_V_M_CUS_NM_USER_INFO_&prov_id@LINK_DSSDWE T
         WHERE MONTH_ID = '&month_id'
           AND IS_STAT = '1'
AND IS_ACCT = ‘1’) A, --用户资料表
       (SELECT /* + PARALLEL (T7, 2)*/
         'B' || SUBS_INSTANCE_ID USER_ID, ACTIVITY_TYPE
          FROM ZBA_DWA.DWA_V_M_CUS_3G_ACT_INFO_&prov_id T7
         WHERE MONTH_ID = '&month_id'
           AND IS_VALID = '1') G3G,
       
       (SELECT /* + PARALLEL (T8, 2)*/
         'A' || USER_ID USER_ID, ACTIVITY_TYPE
          FROM ZBG_DWA.DWA_V_M_CUS_CB_ACT_INFO_&prov_id@LINK_DSSDWE T8
         WHERE MONTH_ID = '&month_id'
           AND IS_VALID = '1') G4G --合约用户
 WHERE A.USER_ID = G3G.USER_ID(+)
   AND A.USER_ID = G4G.USER_ID(+);
新增用户
通过ZBG_DWA.DWA_V_M_CUS_NM_USER_INFO_PROV（新模型用户资料表)的USER_ID，
与合约表（限制IS_THIS_ADD = '1'）中经过转换的用户ID进行关联，取ACTIVITY_TYPE，关联方法同出账用户部分。
离网用户
通过ZBG_DWA.DWA_V_M_CUS_NM_USER_INFO_PROV（新模型用户资料表)的USER_ID，
与合约表（限制IS_THIS_BREAK = '1'）中经过转换的用户ID进行关联，取ACTIVITY_TYPE，关联方法同出账用户部分。
指标
移动业务出账用户
指标路径：移动业务月关注运营关注，移动业务出账用户

说明：新模型ZBG_DWA.DWA_V_M_CUS_NM_USER_INFO_&prov_id@LINK_DSSDWE，缺少OCS上网卡的数据，这部分需要单独加进来

SELECT '&MONTH_ID' MONTH_ID,
       '&PROV_ID' PROV_ID,
       CASE
         WHEN A.SERVICE_TYPE_OLD LIKE '20%' THEN
          '2G手机'
         WHEN A.SERVICE_TYPE_OLD LIKE '30%' AND A.IS_CARD = '0' THEN
          '3G手机'
         WHEN A.SERVICE_TYPE_OLD LIKE '30%' AND A.IS_CARD = '1' THEN
          '3G上网卡'
         WHEN A.SERVICE_TYPE_OLD LIKE '30%' AND A.IS_CARD = '2' THEN
          '2/3G融合'
         WHEN A.SERVICE_TYPE_OLD LIKE '40%' AND A.IS_CARD = '0' THEN
          '4G手机'
         WHEN A.SERVICE_TYPE_OLD LIKE '40%' AND A.IS_CARD = '1' THEN
          '4G上网卡'
       END SERVICE_TYPE_OLD, --老套餐类型
       CASE
         WHEN A.SERVICE_TYPE LIKE '20%' THEN
          '2G' --2G业务
         WHEN A.SERVICE_TYPE LIKE '30%' THEN
          '3G' --3G业务
         WHEN A.SERVICE_TYPE LIKE '40%' THEN
          '4G' --4G业务
         WHEN A.SERVICE_TYPE LIKE '90%' THEN
          '00' --其他业务
       END SERVICE_TYPE_NET, --新业务类型
       SUM(1)
  FROM ZBG_DWA.DWA_V_M_CUS_NM_USER_INFO_&prov_id@LINK_DSSDWE A
 WHERE MONTH_ID = '&MONTH_ID'
   AND IS_STAT = '1'
   AND IS_ACCT = '1'
 GROUP BY CASE
            WHEN A.SERVICE_TYPE_OLD LIKE '20%' THEN
             '2G手机'
            WHEN A.SERVICE_TYPE_OLD LIKE '30%' AND A.IS_CARD = '0' THEN
             '3G手机'
            WHEN A.SERVICE_TYPE_OLD LIKE '30%' AND A.IS_CARD = '1' THEN
             '3G上网卡'
            WHEN A.SERVICE_TYPE_OLD LIKE '30%' AND A.IS_CARD = '2' THEN
             '2/3G融合'
            WHEN A.SERVICE_TYPE_OLD LIKE '40%' AND A.IS_CARD = '0' THEN
             '4G手机'
            WHEN A.SERVICE_TYPE_OLD LIKE '40%' AND A.IS_CARD = '1' THEN
             '4G上网卡'
          END, --老套餐类型
          CASE
            WHEN A.SERVICE_TYPE LIKE '20%' THEN
             '2G' --2G业务
            WHEN A.SERVICE_TYPE LIKE '30%' THEN
             '3G' --3G业务
            WHEN A.SERVICE_TYPE LIKE '40%' THEN
             '4G' --4G业务
            WHEN A.SERVICE_TYPE LIKE '90%' THEN
             '00' --其他业务
          END
UNION ALL
SELECT '&MONTH_ID' MONTH_ID,
       '&PROV_ID' PROV_ID,
       '3GOCS上网卡' SERVICE_TYPE_OLD,
       '00' SERVICE_TYPE_NET,
       SUM(1)
  FROM ZBA_DWA.DWA_V_M_CUS_OCS_USER_INFO T
 WHERE MONTH_ID = '&MONTH_ID'
   AND PROV_ID = '&PROV_ID'
   AND IS_TEST = '0'
   AND STATUS_ID NOT IN ('13', '51')
   AND T.IS_THIS_ACCT = '1'
 ORDER BY SERVICE_TYPE_OLD, SERVICE_TYPE_NET;
新发展用户（当日值）
路径：移动业务日关注运营关注，移动业务发展用户，当日值
SELECT CASE
         WHEN A.SERVICE_TYPE_OLD LIKE '20%' THEN
          '2G手机'
         WHEN A.SERVICE_TYPE_OLD LIKE '30%' AND A.IS_CARD = '0' THEN
          '3G手机'
         WHEN A.SERVICE_TYPE_OLD LIKE '30%' AND A.IS_CARD = '1' THEN
          '3G上网卡'
         WHEN A.SERVICE_TYPE_OLD LIKE '30%' AND A.IS_CARD = '2' THEN
          '2/3G融合'
         WHEN A.SERVICE_TYPE_OLD LIKE '40%' AND A.IS_CARD = '0' THEN
          '4G手机'
         WHEN A.SERVICE_TYPE_OLD LIKE '40%' AND A.IS_CARD = '1' THEN
          '4G上网卡'
       END SERVICE_TYPE_OLD, --老套餐类型
       CASE
         WHEN A.SERVICE_TYPE LIKE '20%' THEN
          '2G' --2G业务
         WHEN A.SERVICE_TYPE LIKE '30%' THEN
          '3G' --3G业务
         WHEN A.SERVICE_TYPE LIKE '40%' THEN
          '4G' --4G业务
         WHEN A.SERVICE_TYPE LIKE '90%' THEN
          '00' --其他业务
       END SERVICE_TYPE_NET, --新业务类型
       SUM(1)
  FROM ZBG_DWA.DWA_V_D_CUS_NM_USER_ADD_091@LINK_DSSDWE A
 WHERE MONTH_ID = '201603'
   AND DAY_ID = '17'
   AND IS_THIS_DEV_OLD = '1'
   AND IS_STAT = '1'
 GROUP BY CASE
            WHEN A.SERVICE_TYPE_OLD LIKE '20%' THEN
             '2G手机'
            WHEN A.SERVICE_TYPE_OLD LIKE '30%' AND A.IS_CARD = '0' THEN
             '3G手机'
            WHEN A.SERVICE_TYPE_OLD LIKE '30%' AND A.IS_CARD = '1' THEN
             '3G上网卡'
            WHEN A.SERVICE_TYPE_OLD LIKE '30%' AND A.IS_CARD = '2' THEN
             '2/3G融合'
            WHEN A.SERVICE_TYPE_OLD LIKE '40%' AND A.IS_CARD = '0' THEN
             '4G手机'
            WHEN A.SERVICE_TYPE_OLD LIKE '40%' AND A.IS_CARD = '1' THEN
             '4G上网卡'
          END , --老套餐类型
          CASE
            WHEN A.SERVICE_TYPE LIKE '20%' THEN
             '2G' --2G业务
            WHEN A.SERVICE_TYPE LIKE '30%' THEN
             '3G' --3G业务
            WHEN A.SERVICE_TYPE LIKE '40%' THEN
             '4G' --4G业务
            WHEN A.SERVICE_TYPE LIKE '90%' THEN
             '00' --其他业务
          END
新发展用户（本月累计）
路径：移动业务日关注运营关注，移动业务发展用户，本月累计
SELECT CASE
         WHEN T1.SERVICE_TYPE_OLD LIKE '20%' THEN
          '2G手机'
         WHEN T1.SERVICE_TYPE_OLD LIKE '30%' AND T1.IS_CARD = '0' THEN
          '3G手机'
         WHEN T1.SERVICE_TYPE_OLD LIKE '30%' AND T1.IS_CARD = '1' THEN
          '3G上网卡'
         WHEN T1.SERVICE_TYPE_OLD LIKE '30%' AND T1.IS_CARD = '2' THEN
          '2/3G融合'
         WHEN T1.SERVICE_TYPE_OLD LIKE '40%' AND T1.IS_CARD = '0' THEN
          '4G手机'
         WHEN T1.SERVICE_TYPE_OLD LIKE '40%' AND T1.IS_CARD = '1' THEN
          '4G上网卡'
       END SERVICE_TYPE_OLD, --老套餐类型
       CASE
         WHEN T2.SERVICE_TYPE LIKE '20%' THEN
          '2G' --2G业务
         WHEN T2.SERVICE_TYPE LIKE '30%' THEN
          '3G' --3G业务
         WHEN T2.SERVICE_TYPE LIKE '40%' THEN
          '4G' --4G业务
         WHEN T2.SERVICE_TYPE LIKE '90%' THEN
          '00' --其他业务
         ELSE
          '00'
       END SERVICE_TYPE_NET, --新业务类型
       SUM(1)
  FROM (SELECT USER_ID,
               AREA_ID,
               DEVICE_NUMBER,
               USER_ID_OLD,
               SERVICE_TYPE,
               SERVICE_TYPE_OLD,
               IS_CARD
          FROM ZBG_DWA.DWA_V_D_CUS_NM_USER_ADD_091@LINK_DSSDWE
         WHERE MONTH_ID = '201603'
           AND DAY_ID BETWEEN '01' AND '17'
           AND IS_THIS_DEV_OLD = '1'
           AND IS_STAT = '1') T1,
       (SELECT USER_ID, SERVICE_TYPE, SERVICE_TYPE_OLD
          FROM ZBG_DWA.DWA_V_D_CUS_NM_USER_INFO_091@LINK_DSSDWE
         WHERE MONTH_ID = '201603'
           AND DAY_ID = '17'
           AND IS_STAT = '1') T2
 WHERE T1.USER_ID = T2.USER_ID(+)
 GROUP BY CASE
            WHEN T1.SERVICE_TYPE_OLD LIKE '20%' THEN
             '2G手机'
            WHEN T1.SERVICE_TYPE_OLD LIKE '30%' AND T1.IS_CARD = '0' THEN
             '3G手机'
            WHEN T1.SERVICE_TYPE_OLD LIKE '30%' AND T1.IS_CARD = '1' THEN
             '3G上网卡'
            WHEN T1.SERVICE_TYPE_OLD LIKE '30%' AND T1.IS_CARD = '2' THEN
             '2/3G融合'
            WHEN T1.SERVICE_TYPE_OLD LIKE '40%' AND T1.IS_CARD = '0' THEN
             '4G手机'
            WHEN T1.SERVICE_TYPE_OLD LIKE '40%' AND T1.IS_CARD = '1' THEN
             '4G上网卡'
          END, --老套餐类型
          CASE
            WHEN T2.SERVICE_TYPE LIKE '20%' THEN
             '2G' --2G业务
            WHEN T2.SERVICE_TYPE LIKE '30%' THEN
             '3G' --3G业务
            WHEN T2.SERVICE_TYPE LIKE '40%' THEN
             '4G' --4G业务
            WHEN T2.SERVICE_TYPE LIKE '90%' THEN
             '00' --其他业务
            ELSE
             '00'
          END
物联网（1454、1457）
自201606账期起，移动网非OCS用户中以1454及1457开头的电话号码从用户表中剔了出来（正常用户表剔除1454、1457号码用户存储过程：BSS：ZBA_DWD.P_DWD_D_PRD_MB_USER_INFO 、CBSS：ZBG_DWD.P_DWD_D_PRD_CB_USER_INFO），单独一个模型ZBG_DWA.DWA_V_M_CUS_NM_WLW_INFO_011@LINK_DSSDWE，物联网单独模型还有一个收入模型ZBG_DWA.DWA_V_M_CUS_NM_WLW_CHARGE_017@LINK_DSSDWE，除此两个模型，物联网1454、1457用户无其他模型。

ZBG_DWA.DWA_V_M_CUS_NM_WLW_INFO_011@LINK_DSSDWE与
ZBG_DWA.DWA_V_M_CUS_NM_USER_INFO_011@LINK_DSSDWE 模型基本一致，使用可参考“移动业务-按照网络分类”
维度
SELECT *
  FROM ZBG_DWA.DWA_V_M_CUS_NM_WLW_INFO_011@LINK_DSSDWE
 WHERE MONTH_ID = '201606'
   AND IS_STAT = '1'
指标
物联网（1454、1457）出帐用户
指标路径：移动业务月关注运营关注，物联网（1454、1457）出帐用户
SELECT SUM(1)
  FROM ZBG_DWA.DWA_V_M_CUS_NM_WLW_INFO_011@LINK_DSSDWE
 WHERE MONTH_ID = '201606'
   AND IS_STAT = '1'
   AND IS_ACCT='1'

宽带业务
BSS侧
维度
计费模式
ZBA_DWA.DWA_DS_M_USER_INFO表的BILL_MODEL字段
参见码表ZB_DIM.DIM_BI_PROD_BILL_MODE
包年,包季度,包月限时,包月不限时,包天,按时,按业务量,包半年,包多月,其它
速率
指宽带用户的带宽大小
ZBA_DWA.DWA_DS_M_USER_INFO表的BROAD_RAPID字段，单位为KB
2M，4M，8M等
注意：
	用户资料表中存在速率为空的情况，页面是把速率为空的归到了大于20M里了，这个具体怎么处理咨询业务部门
接入方式
ZBA_DWA.DWA_DS_M_USER_INFO表的SERVICE_TYPE字段
参照码表ZB_DIM.DIM_BI_SERVICE_TYPE
ADSL接入，LAN接入，FTTH/O接入
ADSL接入    SERVICE_TYPE IN ('04010111','04010112')
xDSL接入  SERVICE_TYPE LIKE '040101%'(注意：xDSL包括ADSL)
LAN接入     SERVICE_TYPE LIKE '040102%'
FTTH/O接入  SERVICE_TYPE LIKE '040103%'
IPTV接入方式
SELECT '201605',   
       '011',
       SERVICE_TYPE --接入方式
  FROM (SELECT *
          FROM ZBA_DWA.DWA_S_M_CUS_USER_IPTV_011 T1 
         WHERE T1.MONTH_ID = '201605'  
           AND ORDER_TYPE='01'     ) A,
       (SELECT USER_ID, AREA_ID, IS_GROUP_USER,IS_THIS_INNET,SERVICE_TYPE
          FROM ZBA_DWA.DWA_DS_M_USER_INFO B
         WHERE MONTH_ID = '201605'
           AND PROV_ID = '011'
        UNION ALL
        SELECT USER_ID, AREA_ID, IS_GROUP IS_GROUP_USER,IS_INNET IS_THIS_INNET,SERVICE_TYPE
          FROM ZBA_DWA.DWA_V_M_CUS_FX_USER_INFO_011
         WHERE MONTH_ID = '201605'
           AND IS_STAT = '1') C
 WHERE A.USER_ID = C.USER_ID(+)
城乡类型
ZBA_DWA.DWA_DS_M_USER_INFO表的CITY_TYPE字段
参照ZB_DIM.DIM_BI_REGION_TYPE
城市区域, 乡村区域
城市区域  CITY_TYPE=‘01’
乡村区域  CITY_TYPE=‘02’
在网时长
ZBA_DWA.DWA_DS_M_USER_INFO表的INNET_TIMES字段，单位：月
指标
网上用户
201308月之前（不包括201308月）口径：
SELECT *
  FROM ZBA_DWA.DWA_DS_M_USER_INFO
 WHERE MONTH_ID = '201301'
   AND USER_STATE <> '51'
   AND SERVICE_TYPE LIKE '0401%'
   AND IS_THIS_INNET = '1'
AND PROV_ID = '011'
[201308-201312]（闭区间）口径：
SELECT *
  FROM ZBA_DWA.DWA_DS_M_USER_INFO
 WHERE MONTH_ID >= '201308'
   AND MONTH_ID <= '201312'
   AND USER_STATE NOT IN ('51', '13')
   AND SERVICE_TYPE LIKE '0401%'
   AND USER_TYPE <> '03'
   AND IS_THIS_INNET = '1'
AND PROV_ID = '011'
201401月之后口径：
SELECT *
  FROM ZBA_DWA.DWA_DS_M_USER_INFO
 WHERE MONTH_ID >= '201401'
   AND USER_STATE NOT IN ('51', '13')
   AND (SERVICE_TYPE LIKE '0401%' OR SERVICE_TYPE LIKE '0403%')
   AND USER_TYPE <> '03'
   AND IS_THIS_INNET = '1'
AND PROV_ID = '011'
出账用户
201308月之前（不包括201308月）对于统计宽带出账用户，需要同时限制是否出账和是否在网两个条件： 
SELECT *
  FROM ZBA_DWA.DWA_DS_M_USER_INFO
 WHERE TRIM(USER_STATE) <> '51'
   AND SERVICE_TYPE LIKE '0401%'
   AND IS_THIS_INNET = '1 ' --2014年之前的限定在网
   AND IS_ACCT = '1'
   AND PROV_ID = '011'
 [201308-201312]月（闭区间）老口径：
SELECT *
  FROM ZBA_DWA.DWA_DS_M_USER_INFO
 WHERE MONTH_ID = '201308'
   AND USER_STATE NOT IN ('51', '13')
   AND SERVICE_TYPE LIKE '0401%'
   AND USER_TYPE <> '03'
   AND IS_THIS_INNET = '1'
   AND IS_ACCT = '1'
AND PROV_ID = '011'
201312月 出账新口径
出账新口径,按出账收入大于0为出账用户：
SELECT *
  FROM TEMP_DX_0312_BB_AL_ACCTN
 WHERE IS_ACCT = '1'
   AND MONTH_ID = '201312'
   AND PROV_ID = '011'
限制条件：（在不在网的限定需要跟业务部门沟通，一般不限定）
201401月之后：
SELECT *
  FROM ZBA_DWA.DWA_DS_M_USER_INFO
 WHERE MONTH_ID = '201505'
   AND PROV_ID = '011'
   AND USER_STATE NOT IN ('51', '13')
   AND (SERVICE_TYPE LIKE '0401%' OR SERVICE_TYPE LIKE '0403%')
   AND USER_TYPE <> '03'
   AND IS_ACCT = '1'
新增用户
201401月之前（不包括201401月）：
表：
ZBA_DWA.DWA_DS_D_USER_INFO_ADD
限制条件：
AND USER_STATE<>‘51’
AND SERVICE_TYPE LIKE ‘0401%’ 
AND IS_ADD = ‘1’
201401月之后（包括201401月）：
表：
ZBA_DWA.DWA_DS_D_USER_INFO_ADD
限制条件：
AND USER_STATE<>‘51’
AND (SERVICE_TYPE LIKE ‘0401%’ OR SERVICE_TYPE LIKE ‘0403%’)
AND IS_ADD = ‘1’
注意：
	宽带没有新发展用户一说，新发展就是新增用户
流失/离网用户
201401月之前（不包括201401月）：
SELECT *
  FROM ZBA_DWA.DWA_DS_D_USER_INFO_LOST
 WHERE MONTH_ID = '201312'
   AND PROV_ID = '011'
   AND (SERVICE_TYPE_OLD LIKE '0401%' OR
       (SERVICE_TYPE_OLD IS NULL AND SERVICE_TYPE LIKE '0401%'))
   AND IS_LOST = '1'
201401月之后（包括201401月）：
SELECT *
  FROM ZBA_DWA.DWA_DS_D_USER_INFO_LOST
 WHERE MONTH_ID = '201401'
   AND PROV_ID = '011'
   AND (SERVICE_TYPE_OLD LIKE '0401%' OR SERVICE_TYPE LIKE '0401%')
    OR (SERVICE_TYPE_OLD LIKE '0403%' OR SERVICE_TYPE LIKE '0403%')
   AND IS_LOST = '1'
IPTV和互联网电视（OTT）用户数DM层
SELECT NVL(T2.PROV_DESC, '全国'), 
SUM(NVL(T1.ONLINE_USER, 0)),--在网 
SUM(NVL(T1.ACCT_USER, 0))--出账 
FROM (SELECT * 
FROM ZBA_DM.DM_C_M_DEV_IPTV_USERINFO 
WHERE INC_TELE_TYPE = '040803' --040801 IPTV 040802 党员远程教育 040803 互联网电视 
AND MONTH_ID = '201512') T1, 
DIM_PROV T2 
WHERE T2.PROV_ID = T1.PROV_ID(+) 
GROUP BY ROLLUP(T2.PROV_DESC, T2.ORD_ID3) 
HAVING GROUPING_ID(T2.PROV_DESC, T2.ORD_ID3) <> 1 
ORDER BY T2.ORD_ID3 NULLS FIRST; 
CBSS侧
维度
速率
指宽带用户的带宽大小
SELECT T1.AREA_ID,
       T1.USER_ID,
       T1.S_TYPE,
       TO_NUMBER(T2.BROAD_RAPID) * 1024 BROAD_RAPID
  FROM (SELECT AREA_ID, USER_ID, 'CBSS' S_TYPE
          FROM ZBG_DWA.DWA_V_M_CUS_CB_USER_INFO_011@LINK_DSSDWE T
         WHERE MONTH_ID = '201505'
           AND IS_STAT = '1'
           AND SERVICE_TYPE LIKE '04%'
           AND IS_INNET = '1') T1, --4G用户资料表
       (SELECT USER_ID, BROAD_RAPID
          FROM ZBG_DWD.DWD_M_PRD_CB_USER_ATTR_011@LINK_DSSDWE
         WHERE MONTH_ID = '201505') T2
 WHERE T1.USER_ID = T2.USER_ID(+)
接入方式
SELECT T1.USER_ID,
       CASE WHEN T2.CB_ACCESS_TYPE = 'A11' THEN 'XDSL'
         WHEN T2.CB_ACCESS_TYPE = 'A12' THEN 'LAN'
         WHEN T2.CB_ACCESS_TYPE = 'A13' THEN 'FTTH'
         ELSE '其他'
       END --接入方式
  FROM (SELECT USER_ID
          FROM ZBG_DWA.DWA_V_M_CUS_CB_USER_INFO_011@LINK_DSSDWE T
         WHERE MONTH_ID = '201605'
           AND IS_STAT = '1'
           AND SERVICE_TYPE LIKE '04%') T1, --用户资料
       (SELECT A.USER_ID, A.CB_ACCESS_TYPE
          FROM (SELECT T.*,
                       ROW_NUMBER() OVER(PARTITION BY T.USER_ID ORDER BY SUBSTR(T.START_DATE, 1, 8) DESC) RN
                  FROM ZBG_DWA.DWA_V_M_CUS_CB_ACCESS_TYPE_011@LINK_DSSDWE T
                 WHERE T.MONTH_ID = '201605'
                   AND T.IS_VALID = '1'
                   AND T.SERVICE_TYPE LIKE '04%') A
         WHERE A.RN = 1) T2
 WHERE T1.USER_ID = T2.USER_ID(+)
IPTV接入方式
SELECT '201605',
       '011',
       T3.CB_ACCESS_TYPE --接入方式

  FROM (SELECT *
          FROM ZBG_DWA.DWA_S_M_EVT_CB_TV_INFO_011 @LINK_DSSDWE
         WHERE MONTH_ID = '201605'
           AND SER_TYPE = '01') T1,
           
       (SELECT *
          FROM ZBG_DWA.DWA_V_M_CUS_CB_USER_INFO_011 @link_dssdwe
         WHERE MONTH_ID = '201605'
           AND IS_STAT = '1'
           AND SERVICE_TYPE LIKE '04%') T2,
           
       (SELECT A.*
          FROM (SELECT T.*,
                       ROW_NUMBER() OVER(PARTITION BY T.USER_ID ORDER BY SUBSTR(T.START_DATE, 1, 8) DESC) RN
                  FROM ZBG_DWA.DWA_V_M_CUS_CB_ACCESS_TYPE_011@LINK_DSSDWE T
                 WHERE T.MONTH_ID = '201605'
                   AND T.IS_VALID = '1'
                   AND T.SERVICE_TYPE LIKE '04%') A
                WHERE A.RN = 1) T3--接入类型描述
           
 WHERE T1.USER_ID = T2.USER_ID
   AND T2.USER_ID = T3.USER_ID(+)
城乡类型
城市区域  CITY_TYPE=‘02’
乡村区域  CITY_TYPE=‘01’
与BSS系统区分城乡类型反着。

SELECT T1.AREA_ID,
       T1.USER_ID,
       T1.S_TYPE,
       CITY_TYPE
  FROM (SELECT AREA_ID, USER_ID, 'CBSS' S_TYPE
          FROM ZBG_DWA.DWA_V_M_CUS_CB_USER_INFO_011@LINK_DSSDWE T
         WHERE MONTH_ID = '201505'
           AND IS_STAT = '1'
           AND SERVICE_TYPE LIKE '04%'
           AND IS_INNET = '1') T1, --4G用户资料表
       (SELECT USER_ID, CITY_TYPE
          FROM ZBG_DWD.DWD_M_PRD_CB_USER_ATTR_011@LINK_DSSDWE
         WHERE MONTH_ID = '201505') T2
 WHERE T1.USER_ID = T2.USER_ID(+)
指标
网上用户
指报告期末在业务支撑系统中拥有注册信息、占用中国联通网络资源并且用户状态不为预开户、注销和删除期的用户总数。

SELECT SUM(1)
  FROM ZBG_DWA.DWA_V_M_CUS_CB_USER_INFO_011@LINK_DSSDWE T
 WHERE MONTH_ID = '201409'
   AND IS_STAT = '1'
   AND SERVICE_TYPE LIKE '04%'
   AND IS_INNET = '1'

出账用户
指报告期内出账账单金额大于零的用户数
SELECT SUM(1)
  FROM ZBG_DWA.DWA_V_M_CUS_CB_USER_INFO_011@LINK_DSSDWE T
 WHERE MONTH_ID = '201409'
   AND IS_STAT = '1'
   AND SERVICE_TYPE LIKE '04%'
   AND IS_ACCT = '1'
固话业务
BSS侧
维度
指标
网上用户
指报告期末在业务支撑系统中拥有注册信息、占用中国联通网络资源并且用户状态不为预开户、注销和删除期的用户总数。

SELECT SUM(DECODE(SERVICE_TYPE, '010402AA', IS_INNET * 15, IS_INNET))
  FROM ZBA_DWA.DWA_V_M_CUS_FX_USER_INFO_011
 WHERE IS_STAT = '1'
   AND SUBSTR(SERVICE_TYPE, 1, 2) = '01'
   AND SUBSTR(SERVICE_TYPE, 1, 4) <> '0105'
   AND MONTH_ID = '201409'
出账用户
指报告期内出账账单金额大于零的用户数
SELECT SUM(DECODE(SERVICE_TYPE, '010402AA', IS_ACCT * 15, IS_ACCT))
  FROM ZBA_DWA.DWA_V_M_CUS_FX_USER_INFO_011
 WHERE IS_STAT = '1'
   AND SUBSTR(SERVICE_TYPE, 1, 2) = '01'
   AND SUBSTR(SERVICE_TYPE, 1, 4) <> '0105'
   AND MONTH_ID = '201409'

发展用户
指报告期内新办理入网，开始使用联通业务，占用中国联通资源的用户数
SELECT SUM(DECODE(SERVICE_TYPE, '010402AA', IS_ADD * 15, IS_ADD))
  FROM ZBA_DWA.DWA_V_D_CUS_FX_USER_ADD_011
 WHERE IS_STAT = '1'
   AND SUBSTR(SERVICE_TYPE, 1, 2) = '01'
   AND SUBSTR(SERVICE_TYPE, 1, 4) <> '0105'
   AND MONTH_ID = '201409'
注意：
1、如果单独求网上用户时需要对SERVICE_TYPE为'010402AA'的进行处理，
2、如果网上用户的使用量信息，不需要对SERVICE_TYPE为'010402AA'进行处理。
3、SERVICE_TYPE为'010402AA'即为“N-ISDN(30B+D)” N-ISDN用户统计为固定电话用户时，N-ISDN（2B+D）1个端口按1个电话用户、ISDN（30B+D）1个端口按15个电话用户统计
CBSS侧
维度
指标
网上用户
指报告期末在业务支撑系统中拥有注册信息、占用中国联通网络资源并且用户状态不为预开户、注销和删除期的用户总数。

SELECT SUM(1)
  FROM ZBG_DWA.DWA_V_M_CUS_CB_USER_INFO_011@LINK_DSSDWE T
 WHERE MONTH_ID = '201409'
   AND IS_STAT = '1'
   AND SERVICE_TYPE LIKE '01%'
   AND IS_INNET = '1'
出账用户
指报告期内出账账单金额大于零的用户数
SELECT SUM(1)
  FROM ZBG_DWA.DWA_V_M_CUS_CB_USER_INFO_011@LINK_DSSDWE T
 WHERE MONTH_ID = '201409'
   AND IS_STAT = '1'
   AND SERVICE_TYPE LIKE '01%'
   AND IS_ACCT = '1'

融合业务
BSS侧
维度
指标
3G手机沃家庭在网用户
SELECT *
  FROM ZBA_DWA.DWA_V_M_CUS_AL_ORD_MEMBER_011
 WHERE MONTH_ID = '201404'
   AND SERVICE_TYPE = '30AAAAAA' --3G业务
   AND IS_CARD = '0' --3G手机
   AND COMP_TYPE IN ('61', '62', '67') --沃家庭
   AND IS_INNET = '1' --在网
3G手机沃家庭出账用户
SELECT *
  FROM ZBA_DWA.DWA_V_M_CUS_AL_ORD_MEMBER_011
 WHERE MONTH_ID = '201404'
   AND SERVICE_TYPE = '30AAAAAA' --3G业务
   AND IS_CARD = '0' --3G手机
   AND COMP_TYPE IN ('61', '62', '67') --沃家庭
   AND IS_ACCT = '1' --出账
注意：
1、目前明细替换指标只替换了沃家庭，沃商务的数据没有替换，还是指标。
2、其他业务的沃家庭，如2G，请修改相应的SERVICE_TYPE
是否出账、是否在网都限制了订购实例组有效、订购实例组成员有效
2G手机集客沃商务出账用户数
集客沃商务出账用户数（不区分业务类型）核对路径为：报表中心——>专业报表——>集团业务沃商务用户发展统计月报，参考过程：DM.P_DM_M_WO_SW
集客沃商务出账用户数（区分业务类型）核对路径为：报表中心——>基础报表——>沃商务用户规模、业务量及收入月报，参考过程：DM.P_DM_REP_M_WCOMM_ALL_2012

SELECT SUM(ACCT_USER) ACCT_USER --本月出账集团用户数
  FROM ZB.ZB_WHOME_M_DEV_06 --对应纵向融合业务指标接口规范《7.2.1.4  沃.商务融合业务发展月报  03记录》（SVN地址：http://132.35.224.234/svn/dssdat/ZBJF_接口规范/05-纵向指标规范/中国联通经营分析指标上传接口规范V3.0-融合业务分册-20120109.doc）
 WHERE MONTH_NO = '201508'
   AND PROV_ID = '010'
   AND TYPE_ID = '140301AA' --2G手机
   AND SUBSTR(DINNER_SIGN_ID, 1, 2) IN ('06', '07', '08', '09') --06:中小企业基础版A方案;07:中小企业基础版B方案;08:中小企业增强版A方案;09:中小企业增强版B方案
智慧沃家本地版
--本地智慧沃家受理受理手机用户
SELECT 
          '''||V_MONTH_ID||''',
          '''||V_DAY_ID||''',
          '''||V_PROV_ID||''',
          A.SERVICE_TYPE SERVICE_TYPE,
          ''ZHWJBD-SJYH'' SERV_TYPE,
          B.CHNL_KIND_ID,
          NULL IS_CARD,
          COUNT(1)
          
FROM(   SELECT T.COMP_ID,
           T.CHANNEL_ID,
           T.IS_CARD,
           T.SERVICE_TYPE
     FROM ZBA_DWA.DWA_V_D_CUS_MB_RH_MEM_WIT_'||V_PROV_ID||' T  ---固移融合手机用户 本地智慧沃家
    WHERE MONTH_ID =  '''||V_MONTH_ID||'''
      AND DAY_ID = '''||V_DAY_ID||'''
      AND T.SERVICE_TYPE IN( ''200101AA'',''30AAAAAA'') 
      AND IS_CARD<>''1''
      AND ACCEPT_DATE='''||V_MONTH_ID||'''||'''||V_DAY_ID||'''
      AND COMP_TYPE IN (''71'',''72'',''73'')
      )A,
(SELECT CHNL_KIND_ID, CHNL_ID
             FROM ZB_DWD.DWD_D_MRT_AL_BSDM_CHANNEL_S T10
            WHERE MONTH_ID = '''||V_MONTH_ID||'''
              AND DAY_ID = '''||V_DAY_ID||'''
              AND PROV_ID = '''||V_PROV_ID||''')B
 WHERE A.CHANNEL_ID = B.CHNL_ID(+)
    GROUP BY A.SERVICE_TYPE,B.CHNL_KIND_ID
--本地智慧沃家受理受理手机用户
SELECT 
          '''||V_MONTH_ID||''',
          '''||V_DAY_ID||''',
          '''||V_PROV_ID||''',
          A.SERVICE_TYPE SERVICE_TYPE,
          ''ZHWJBD-SJYH'' SERV_TYPE,
          B.CHNL_KIND_ID,
          NULL IS_CARD,
          COUNT(1)
          
FROM(   SELECT T.COMP_ID,
           T.CHANNEL_ID,
           T.IS_CARD,
           T.SERVICE_TYPE
     FROM ZBA_DWA.DWA_V_D_CUS_MB_RH_MEM_WIT_'||V_PROV_ID||' T  ---固移融合手机用户 本地智慧沃家
    WHERE MONTH_ID =  '''||V_MONTH_ID||'''
      AND DAY_ID = '''||V_DAY_ID||'''
      AND T.SERVICE_TYPE IN( ''200101AA'',''30AAAAAA'') 
      AND IS_CARD<>''1''
      AND ACCEPT_DATE='''||V_MONTH_ID||'''||'''||V_DAY_ID||'''
      AND COMP_TYPE IN (''71'',''72'',''73'')
      )A,
(SELECT CHNL_KIND_ID, CHNL_ID
             FROM ZB_DWD.DWD_D_MRT_AL_BSDM_CHANNEL_S T10
            WHERE MONTH_ID = '''||V_MONTH_ID||'''
              AND DAY_ID = '''||V_DAY_ID||'''
              AND PROV_ID = '''||V_PROV_ID||''')B
 WHERE A.CHANNEL_ID = B.CHNL_ID(+)
    GROUP BY A.SERVICE_TYPE,B.CHNL_KIND_ID

CBSS侧
维度
指标
4G区分共享组合套餐主副卡
通过以下SQL取出共享组合套餐主卡用户，不是主卡用户的归为副卡。

   71：共享组合套餐（沃享）
   81：智慧沃家组合套餐
   82：智慧沃家共享套餐
SELECT USER_ID
  FROM ZBG_DWD.DWD_M_PRD_CB_USER_ITEM_011@LINK_DSSDWE
 WHERE USER_ID IN (SELECT USER_ID
                     FROM ZBG_DWA.DWA_V_M_CUS_CB_OM_DERIVE_011@LINK_DSSDWE
                    WHERE MONTH_ID = '201502'
                      AND IF_VALID = '1'
                      AND COMP_TYPE = '71')
   AND ATTR_CODE = 'IS_WO_MAIN_NUM'
   AND ATTR_VALUE = '1'
   AND MONTH_ID = '201502'
   AND SUBSTR(START_DATE, 1, 6) <= '201502'
   AND SUBSTR(END_DATE, 1, 6) >= '201502'
 GROUP BY USER_ID;
智慧沃家
--新增智慧沃家套餐数，新增智慧沃家套餐里的成员（基本上）都是新增的（新办理智慧沃家套餐），只有少数是从别的智慧沃家组里转过来的，没有判断为成员新增。
SELECT 
comp_id
          FROM ZBG_DWA.DWA_V_M_CUS_CB_RH_COMP_WIT_017 @LINK_DSSDWE T
         WHERE T.MONTH_ID = '201510' and COMP_TYPE IN ('81', '82', '83')
           AND T.IS_DEV = '1' 
           
           
--智慧沃家套餐到达数
SELECT 
comp_id,
is_comp_valid,--新增智慧沃家套餐都是有效的
is_acct -- 该智慧沃家组是否出帐
COMP_TYPE,         --智慧沃家类型：81：智慧沃家组合；82：智慧沃家共享；83：智慧沃家组合优化版
SHARE_FLUX        --共享流量包：SELECT DISCNT_CODE,PKG_VALUE FROM ZBG_DIM.DIM_CBSS_DISCNT_CODE@LINK_DSSDWE
          FROM ZBG_DWA.DWA_V_M_CUS_CB_RH_COMP_WIT_017 @LINK_DSSDWE T
         WHERE T.MONTH_ID = '201510' and COMP_TYPE IN ('81', '82', '83')
           AND T.IS_COMP_VALID = '1'     
                  
           
           
--智慧沃家成员到达数              
           
SELECT T.COMP_ID,
               T.USER_ID,
               T.AREA_ID,
               T.SERVICE_TYPE,
               T.IS_ADD,--新增智慧沃家成员。
               T.IS_DEV,--智慧沃家新发展用户，本月或上网入网的成员，当月IS_DEV=1时，IS_ADD都等于1
               T.IS_ACCT
          FROM ZBG_DWA.DWA_V_M_CUS_CB_RH_MEM_WIT_017 @LINK_DSSDWE T
         WHERE T.MONTH_ID = '201510'
           AND T.IS_COMP_VALID = '1'--组有效
           AND T.IS_MEM_VALID = '1'--成员有效
           AND T.COMP_TYPE IN ('81', '82', '83')
           AND SERVICE_TYPE LIKE '40%'  --04AAAAAA 宽带 01AAAAAA固话 40AAAAAA 手机
           
       

--智慧沃家新增用户(包括老用户和新用户办理智慧沃家)
           
SELECT T.COMP_ID,
               T.USER_ID
              FROM ZBG_DWA.DWA_V_M_CUS_CB_RH_MEM_WIT_017 @LINK_DSSDWE T
         WHERE T.MONTH_ID = '201510'
           AND T.IS_COMP_VALID = '1'
           AND T.IS_MEM_VALID = '1'
           AND T.is_add='1'
           AND T.COMP_TYPE IN ('81', '82', '83')
           AND SERVICE_TYPE LIKE '40%'  --04AAAAAA 宽带 01AAAAAA固话 40AAAAAA 手机

          
           

--智慧沃家新发展成员（本月新增的智慧沃家用户，成员为本月或上月入网的用户）

SELECT T.COMP_ID,
               T.USER_ID  FROM ZBG_DWA.DWA_V_M_CUS_CB_RH_MEM_WIT_017 @LINK_DSSDWE T
         WHERE T.MONTH_ID = '201510'
           AND T.IS_COMP_VALID = '1'
           AND T.IS_MEM_VALID = '1'
           AND T.IS_DEV='1'
           AND T.COMP_TYPE IN ('81', '82', '83')
           AND SERVICE_TYPE LIKE '40%'  --04AAAAAA 宽带 01AAAAAA固话 40AAAAAA 手机--新增智慧沃家套餐数，，新增智慧沃家套餐里的成员（基本上）都是新增的（新办理智慧沃家套餐），只有少数是从别的智慧沃家组里转过来的，没有判断为成员新增。
SELECT 
comp_id
          FROM ZBG_DWA.DWA_V_M_CUS_CB_RH_COMP_WIT_017 @LINK_DSSDWE T
         WHERE T.MONTH_ID = '201510' and COMP_TYPE IN ('81', '82', '83')
           AND T.IS_DEV = '1' 
           
           
--智慧沃家套餐到达数
SELECT 
comp_id,
is_comp_valid,--新增智慧沃家套餐都是有效的
is_acct -- 该智慧沃家组是否出帐
COMP_TYPE,         --智慧沃家类型：81：智慧沃家组合；82：智慧沃家共享；83：智慧沃家组合优化版
SHARE_FLUX        --共享流量包：SELECT DISCNT_CODE,PKG_VALUE FROM ZBG_DIM.DIM_CBSS_DISCNT_CODE@LINK_DSSDWE
          FROM ZBG_DWA.DWA_V_M_CUS_CB_RH_COMP_WIT_017 @LINK_DSSDWE T
         WHERE T.MONTH_ID = '201510' and COMP_TYPE IN ('81', '82', '83')
           AND T.IS_COMP_VALID = '1'     
                  
           
           
--智慧沃家成员到达数              
           
SELECT T.COMP_ID,
               T.USER_ID,
               T.AREA_ID,
               T.SERVICE_TYPE,
               T.IS_ADD,--新增智慧沃家成员。
               T.IS_DEV,--智慧沃家新发展用户，本月或上网入网的成员，当月IS_DEV=1时，IS_ADD都等于1
               T.IS_ACCT
          FROM ZBG_DWA.DWA_V_M_CUS_CB_RH_MEM_WIT_017 @LINK_DSSDWE T
         WHERE T.MONTH_ID = '201510'
           AND T.IS_COMP_VALID = '1'--组有效
           AND T.IS_MEM_VALID = '1'--成员有效
           AND T.COMP_TYPE IN ('81', '82', '83')
           AND SERVICE_TYPE LIKE '40%'  --04AAAAAA 宽带 01AAAAAA固话 40AAAAAA 手机
           
       

--智慧沃家新增用户(包括老用户和新用户办理智慧沃家)
           
SELECT T.COMP_ID,
               T.USER_ID
              FROM ZBG_DWA.DWA_V_M_CUS_CB_RH_MEM_WIT_017 @LINK_DSSDWE T
         WHERE T.MONTH_ID = '201510'
           AND T.IS_COMP_VALID = '1'
           AND T.IS_MEM_VALID = '1'
           AND T.is_add='1'
           AND T.COMP_TYPE IN ('81', '82', '83')
           AND SERVICE_TYPE LIKE '40%'  --04AAAAAA 宽带 01AAAAAA固话 40AAAAAA 手机

          
           

--智慧沃家新发展成员（本月新增的智慧沃家用户，成员为本月或上月入网的用户）

SELECT T.COMP_ID,
               T.USER_ID  FROM ZBG_DWA.DWA_V_M_CUS_CB_RH_MEM_WIT_017 @LINK_DSSDWE T
         WHERE T.MONTH_ID = '201510'
           AND T.IS_COMP_VALID = '1'
           AND T.IS_MEM_VALID = '1'
           AND T.IS_DEV='1'
           AND T.COMP_TYPE IN ('81', '82', '83')
           AND SERVICE_TYPE LIKE '40%'  --04AAAAAA 宽带 01AAAAAA固话 40AAAAAA 手机

--全国智慧沃家受理受理手机用户
   SELECT  '''||V_MONTH_ID||''',
          '''||V_DAY_ID||''',
          '''||V_PROV_ID||''',
          A.SERVICE_TYPE SERVICE_TYPE,
          ''ZHWJ-SJYH'' SERV_TYPE,
          B.CHNL_KIND_ID,
          NULL IS_CARD,
          COUNT(1)
  FROM (  
        SELECT COMP_TYPE,
                AREA_ID,
                SERVICE_TYPE,
                ACCEPT_DATE,
                USER_ID,
                DAY_ID,
                TRADE_DEPART_ID CHANNEL_ID
          FROM ZBG_DWA.DWA_S_D_EVT_RH_USER_TRADE_'||V_PROV_ID||'@LINK_DSSDWE T   
         WHERE NVL(T.CANCEL_FLAG, ''0'') = ''0''
           AND T.MONTH_ID = '''||V_MONTH_ID||'''
           AND T.DAY_ID = '''||V_DAY_ID||'''
        ) A,
            (SELECT CHNL_KIND_ID, CHNL_ID
               FROM ZB_DWD.DWD_D_MRT_AL_BSDM_CHANNEL_S T10
              WHERE MONTH_ID = '''||V_MONTH_ID||'''
                AND DAY_ID = '''||V_DAY_ID||'''
                AND PROV_ID = '''||V_PROV_ID||''') B
      WHERE A.CHANNEL_ID = B.CHNL_ID(+)
           AND  A.SERVICE_TYPE = ''40AAAAAA''
           AND  A.COMP_TYPE IN (''81'', ''82'', ''83'')
           AND  A.DAY_ID='''||V_DAY_ID||'''
 GROUP BY  A.SERVICE_TYPE,B.CHNL_KIND_ID

-智慧沃家全国CB受理套餐数        
   SELECT '''||V_MONTH_ID||''',
            '''||V_DAY_ID||''',
            '''||V_PROV_ID||''',
            A.AREA_ID,
            NULL SERVICE_TYPE,
            ''ZHWJ-SLTC'' SERV_TYPE,
            NULL IS_INNET,
            NULL IS_THIS_DEV,
            NULL IS_THIS_BREAK,
            NULL ,
            NULL ,
            D.CHNL_KIND_ID,
            COUNT(1),
            0
       FROM (SELECT AREA_ID,COMP_ID,TRADE_DEPART_ID
               FROM (SELECT AREA_ID,T.COMP_ID,T.TRADE_DEPART_ID,
                            ROW_NUMBER() OVER(PARTITION BY COMP_ID ORDER BY ACCEPT_DATE DESC)  RN
                       FROM ZBG_DWA.DWA_S_D_EVT_RH_COMP_TRADE_'||V_PROV_ID||'@LINK_DSSDWE T
                      WHERE NVL(T.CANCEL_FLAG,''0'') = ''0''
                        AND MONTH_ID = '''||V_MONTH_ID||'''
                        AND DAY_ID = '''||V_DAY_ID||'''  
                        AND COMP_TYPE IN (''81'',''82'',''83''))
              WHERE RN = 1 ) A,
            (SELECT CHNL_KIND_ID, CHNL_ID
               FROM ZB_DWD.DWD_D_MRT_AL_BSDM_CHANNEL_S T10
              WHERE MONTH_ID = '''||V_MONTH_ID||'''
                AND DAY_ID = '''||V_DAY_ID||'''
                AND PROV_ID = '''||V_PROV_ID||''') D
      WHERE A.TRADE_DEPART_ID = D.CHNL_ID(+)
      GROUP BY A.AREA_ID,
               D.CHNL_KIND_ID';

主副卡和共享套餐有效用户模型表
SELECT *
  FROM ZBG_DWA.DWA_V_M_CUS_CB_RH_MEM_MM_011@LINK_DSSDWE T
 WHERE T.MONTH_ID = '201602'
   AND T.COMP_TYPE in （ '71', '72' ）
   AND T.IS_COMP_VALID = '1'
   AND T.IS_MEM_VALID = '1';
新增移移融合用户，以及新增移移套餐里的新用户和老用户
SELECT SUM(T.IS_ADD), --新增移移融合用户
       SUM(CASE WHEN T.IS_ADD = '1' AND T.IS_DEV = '1' THEN 1 ELSE 0 END), --新增移移融合用户且是新用户
       SUM(CASE WHEN T.IS_ADD = '1' AND T.IS_DEV = '0' THEN 1 ELSE 0 END) --新增移移融合用户且是存量用户
  FROM ZBG_DWA.DWA_V_M_CUS_CB_RH_MEM_MM_011@LINK_DSSDWE T
 WHERE T.MONTH_ID = '201602'
   AND T.COMP_TYPE IN ('71', '72')
   AND T.IS_COMP_VALID = '1'
   AND T.IS_MEM_VALID = '1'
业务域
移动业务
按照套餐分类
按照用户使用的套餐进行分类
CBSS套餐
公共部分（4G手机、上网卡通用）
指标
流量
4G用户资料表与ZBG_DWA.DWA_V_M_CUS_CB_SING_FLUX_PROV通过USER_ID关联，取TOTAL_FLUX
短信条数
4G用户资料表与ZBG_DWA.DWA_V_M_CUS_CB_SING_SMS_PROV通过USER_ID关联，取TOTAL_SMS_NUM
点对点发送短信条数
4G用户资料表与ZBG_DWA.DWA_V_M_CUS_CB_SING_SMS_PROV通过USER_ID关联，取
PTP_OUT_FREE_NUM + PTP_OUT_BILL_NUM
通话时长
4G用户资料表与ZBG_DWA.DWA_V_M_CUS_CB_SING_VOICE_PROV通过USER_ID关联，取TOTAL_DURA
计费时长
4G用户资料表与ZBG_DWA.DWA_V_M_CUS_CB_SING_VOICE_PROV通过USER_ID关联，取TOTAL_TIMES
主叫计费时长
4G用户资料表与ZBG_DWA.DWA_V_M_CUS_CB_SING_VOICE_PROV通过USER_ID关联，取OUT_JF_TIMES
定向免流流量
2I产品有一些包含定向流量，比如腾讯王卡在使用微信、QQ音乐的时候是免流的。主要是根据上网详单中的serv_id进行区分，如果详单中，serv_id是2I产品制定的免流的serv_id，则该条上网记录就是定向免流的。
定向流量详单已经传到oracle中了，从20170501开始累计数据
定向免流日表
 SELECT *
   FROM ZBG_DWA.DWA_S_D_USE_CB_FLUX_SERV_079@LINK_DSSDWE
  WHERE MONTH_ID = '201705'
    AND DAY_ID = '01'

定向免流月表—此表可能数不全
 SELECT *
   FROM ZBG_DWA.DWA_S_M_USE_CB_FLUX_SERV_079@LINK_DSSDWE
  WHERE MONTH_ID = '201705'
    
定向流量码表
SELECT * FROM ZBA_CZC.TEMP_JC_2I_SERV_ID

手机
维度
4G 国漫套餐表
SELECT *
  FROM (SELECT /*+PARALLEL (T,5)*/
        DISTINCT DISCNT_CODE,
                 DISCNT_NAME,
                 START_DATE,
                 END_DATE,
                 T.DISNCT_SALEFEE / 100, --费用总额
                 ROW_NUMBER() OVER(PARTITION BY DISCNT_CODE ORDER BY START_DATE DESC, END_DATE DESC) RN
          FROM ZBG_DWD.DWD_D_PRD_CB_DISCNT T ---资费表
         WHERE DISCNT_CODE LIKE '%5%'
           AND SUBSTR(START_DATE, 1, 6) <= '201506'
           AND SUBSTR(END_DATE, 1, 6) >= '201506'
              -- AND(DISCNT_NAME LIKE '%漫游%' OR  DISCNT_NAME LIKE '%畅游%' OR DISCNT_NAME LIKE '%国际及台港澳长途%')
           AND DISCNT_CODE IN ('5704000',
                               '5705000',
                               '5706000',
                               '5707000',
                               '5744110',
                               '5744000',
                               '5744010',
                               '5708000',
                               '5709000',
                               '5710000',
                               '5711000',
                               '20050118',
                               '5712000',
                               '5744100'))
 WHERE RN = '1'
注释： 本需求需要14个套餐，但在本表中只找到10个，另外四个是通过询问cbss而得，
 T.DISNCT_SALEFEE有部分不可用。没有套餐码表生产那边也是通过cbss交流手动添加的套餐，可能更新不及时。现手动创建了一个select * from  temp_country；可参考
指标
套外流量
指用户使用的非套餐套包内的流量。
SELECT SUM(CASE
             WHEN T_FLUX.TOTAL_FLUX > T.PKG_FLUX THEN
              T_FLUX.TOTAL_FLUX - T.PKG_FLUX
             ELSE
              0
           END) --套外流量
  FROM (SELECT T1.USER_ID,
               T1.IS_GROUP,
               T3.DIM_1,
               CASE
                 WHEN T3.DIM_1 LIKE '03%' THEN
                  NVL(T4.CALL_DURA, 0)
                 ELSE
                  NVL(T3.CALL_DURA, 0)
               END PKG_TIMES, --套内语音时长
               CASE
                 WHEN T3.DIM_1 LIKE '03%' THEN
                  NVL(T4.FLUX_M, 0)
                 ELSE
                  NVL(T3.FLUX_M, 0)
               END PKG_FLUX --套内流量
          FROM (SELECT /*+PARALLEL(A,2)*/
                 A.USER_ID, A.PRODUCT_CLASS, A.IS_GROUP
                  FROM ZBG_DWA.DWA_V_M_CUS_CB_USER_INFO_011@LINK_DSSDWE A
                 WHERE A.MONTH_ID = '201603'
                   AND A.SERVICE_TYPE = '40AAAAAA'
                   AND A.IS_STAT = '1'
                   AND A.IS_CARD = '0'
                   AND A.IS_ACCT = '1') T1,
               (SELECT C.PRODUCT_CLASS,
                       C.DIM_1,
                       R.CALL_DURA,
                       R.FLUX_M,
                       C.MON_FEE       PROD_MON_FEE,
                       F.MON_FEE,
                       F.CALL_FTFEE    VOICE_MON_FEE,
                       F.FLUX_FTFEE    FLUX_MON_FEE
                  FROM ZBG_DIM.DIM_PRODUCT_CLASS@LINK_DSSDWE C,
                       ZBG_DIM.DIM_PRODUCT_VALUE@LINK_DSSDWE R,
                       TEMP_4G_PRODUCT_FTFEE                 F
                 WHERE C.SERVICE_TYPE = '40AAAAAA'
                   AND C.IS_CBSS = '1'
                   AND C.PRODUCT_CLASSIFY_VALUE = R.PRODUCT_CLASS(+)
                   AND C.PRODUCT_CLASS = F.PRODUCT_CLASS(+)) T3,
               (SELECT C.USER_ID,
                       R1.MON_FEE   FLUX_MON_FEE,
                       R1.PKG_VALUE FLUX_M,
                       R2.MON_FEE   VOICE_MON_FEE,
                       R2.PKG_VALUE CALL_DURA,
                       R3.MON_FEE   SMS_FEE,
                       R3.PKG_VALUE SMS_MON_FEE
                  FROM (SELECT /*+PARALLEL(T,2)*/
                         *
                          FROM ZBG_DWA.DWA_V_M_CUS_CB_DIY_PACKAGE_011@LINK_DSSDWE T
                         WHERE SERVICE_TYPE = '40AAAAAA'
                           AND MONTH_ID = '201603') C,
                       ZBG_DIM.DIM_CBSS_DISCNT_CODE@LINK_DSSDWE R1,
                       ZBG_DIM.DIM_CBSS_DISCNT_CODE@LINK_DSSDWE R2,
                       ZBG_DIM.DIM_CBSS_DISCNT_CODE@LINK_DSSDWE R3
                 WHERE C.FLUX_PKG = R1.DISCNT_CODE(+)
                   AND C.VOICE_PKG = R2.DISCNT_CODE(+)
                   AND C.SMS_MMS_PKG = R3.DISCNT_CODE(+)) T4
         WHERE T1.PRODUCT_CLASS = T3.PRODUCT_CLASS(+)
           AND T1.USER_ID = T4.USER_ID(+)) T,
       (SELECT A.USER_ID, TOTAL_FLUX
          FROM ZBG_DWA.DWA_V_M_CUS_CB_SING_FLUX_011@LINK_DSSDWE A
         WHERE A.MONTH_ID = '201603') T_FLUX
 WHERE T.USER_ID = T_FLUX.USER_ID(+)
套外主叫计费时长
指用户使用的非套餐包内的语音主叫计费时长。
SELECT SUM(CASE
             WHEN (DIM_1 LIKE '0302%' --4G本地组合套餐
                  OR DIM_1 LIKE '04%' --4G校园套餐
                  OR DIM_1 LIKE '05%' --4G本地套餐
                  OR DIM_1 LIKE '08%' --本地数据卡
                  OR DIM_1 LIKE '09%' --本地语音
                  OR DIM_1 LIKE '10%' --本地行业
                  OR DIM_1 LIKE '11%' --4G本地个性化
                  OR DIM_1 LIKE '12%' --4G本地迁转
                  ) THEN
              (CASE
                WHEN NVL(T_VOICE.OUT_JF_TIMES_LOCAL, 0) > NVL(T.PKG_TIMES, 0) THEN
                 NVL(T_VOICE.OUT_JF_TIMES, 0) - NVL(T.PKG_TIMES, 0)
                ELSE
                 NVL(T_VOICE.OUT_JF_TIMES, 0) - NVL(T_VOICE.OUT_JF_TIMES_LOCAL, 0)
              END)
             WHEN NVL(T_VOICE.OUT_JF_TIMES, 0) > NVL(T.PKG_TIMES, 0) THEN
              NVL(T_VOICE.OUT_JF_TIMES, 0) - NVL(T.PKG_TIMES, 0)
             ELSE
              0
           END) --套外主叫计费时长
  FROM (SELECT T1.USER_ID,
               T1.IS_GROUP,
               T3.DIM_1,
               CASE
                 WHEN T3.DIM_1 LIKE '03%' THEN
                  NVL(T4.CALL_DURA, 0)
                 ELSE
                  NVL(T3.CALL_DURA, 0)
               END PKG_TIMES, --套内语音时长
               CASE
                 WHEN T3.DIM_1 LIKE '03%' THEN
                  NVL(T4.FLUX_M, 0)
                 ELSE
                  NVL(T3.FLUX_M, 0)
               END PKG_FLUX --套内流量
          FROM (SELECT /*+PARALLEL(A,2)*/
                 A.USER_ID, A.PRODUCT_CLASS, A.IS_GROUP
                  FROM ZBG_DWA.DWA_V_M_CUS_CB_USER_INFO_011@LINK_DSSDWE A
                 WHERE A.MONTH_ID = '201603'
                   AND A.SERVICE_TYPE = '40AAAAAA'
                   AND A.IS_STAT = '1'
                   AND A.IS_CARD = '0'
                   AND A.IS_ACCT = '1') T1,
               (SELECT C.PRODUCT_CLASS,
                       C.DIM_1,
                       R.CALL_DURA,
                       R.FLUX_M,
                       C.MON_FEE       PROD_MON_FEE,
                       F.MON_FEE,
                       F.CALL_FTFEE    VOICE_MON_FEE,
                       F.FLUX_FTFEE    FLUX_MON_FEE
                  FROM ZBG_DIM.DIM_PRODUCT_CLASS@LINK_DSSDWE C,
                       ZBG_DIM.DIM_PRODUCT_VALUE@LINK_DSSDWE R,
                       TEMP_4G_PRODUCT_FTFEE                 F
                 WHERE C.SERVICE_TYPE = '40AAAAAA'
                   AND C.IS_CBSS = '1'
                   AND C.PRODUCT_CLASSIFY_VALUE = R.PRODUCT_CLASS(+)
                   AND C.PRODUCT_CLASS = F.PRODUCT_CLASS(+)) T3,
               (SELECT C.USER_ID,
                       R1.MON_FEE   FLUX_MON_FEE,
                       R1.PKG_VALUE FLUX_M,
                       R2.MON_FEE   VOICE_MON_FEE,
                       R2.PKG_VALUE CALL_DURA,
                       R3.MON_FEE   SMS_FEE,
                       R3.PKG_VALUE SMS_MON_FEE
                  FROM (SELECT /*+PARALLEL(T,2)*/
                         *
                          FROM ZBG_DWA.DWA_V_M_CUS_CB_DIY_PACKAGE_011@LINK_DSSDWE T
                         WHERE SERVICE_TYPE = '40AAAAAA'
                           AND MONTH_ID = '201603') C,
                       ZBG_DIM.DIM_CBSS_DISCNT_CODE@LINK_DSSDWE R1,
                       ZBG_DIM.DIM_CBSS_DISCNT_CODE@LINK_DSSDWE R2,
                       ZBG_DIM.DIM_CBSS_DISCNT_CODE@LINK_DSSDWE R3
                 WHERE C.FLUX_PKG = R1.DISCNT_CODE(+)
                   AND C.VOICE_PKG = R2.DISCNT_CODE(+)
                   AND C.SMS_MMS_PKG = R3.DISCNT_CODE(+)) T4
         WHERE T1.PRODUCT_CLASS = T3.PRODUCT_CLASS(+)
           AND T1.USER_ID = T4.USER_ID(+)) T,
       (SELECT USER_ID,
               NVL(OUT_JF_TIMES, 0) OUT_JF_TIMES, --主叫计费时长
               NVL(IN_JF_TIMES, 0) IN_JF_TIMES, --被叫计费时长
               NVL(LOCAL_CALLING_TIMES, 0) OUT_JF_TIMES_LOCAL --主叫计费时长（本地）
          FROM ZBG_DWA.DWA_V_M_CUS_CB_SING_VOICE_011@LINK_DSSDWE
         WHERE MONTH_ID = '201603') T_VOICE
 WHERE T.USER_ID = T_VOICE.USER_ID(+)
4G国漫流量
SELECT USER_ID,
       NVL(TOTAL_FLUX, 0) TOTAL_FLUX,
       NVL(UP_ROAM_GAT_FLUX, 0) + NVL(UP_ROAM_INT_FLUX, 0) +
       NVL(DOWN_ROAM_GAT_FLUX, 0) + NVL(DOWN_ROAM_INT_FLUX, 0) GM_FLUX
  FROM ZBG_DWA.DWA_V_M_CUS_CB_SING_FLUX_011 @LINK_DSSDWE T
 WHERE MONTH_ID = '201505' --流量

4G国漫语音
CALL_TYPE--呼叫类型
LONG_TYPE--长途类型
ROAM_TYPE--漫游类型

 SELECT /*PARALLEL(T,4)*/
 USER_ID,
 SUM(CASE
       WHEN CALL_TYPE IN ('01', '03') AND LONG_TYPE NOT IN ('0301', '0401') AND
            ROAM_TYPE IN ('01AA', '0201', '0202') THEN
        NVL(BASE_TIMES, 0)
       ELSE
        0
     END) GN_ZJJF, --国内主叫总计费时长
 SUM(CASE
       WHEN CALL_TYPE IN ('01', '03') AND LONG_TYPE NOT IN ('0301', '0401') AND
            ROAM_TYPE IN ('01AA', '0201', '0202') THEN
        NVL(CDR_NUMS, 0)
       ELSE
        0
     END) GN_ZJCS, --国内主叫总次数
 SUM(CASE
       WHEN CALL_TYPE IN ('02', '04') AND LONG_TYPE NOT IN ('0301', '0401') AND
            ROAM_TYPE IN ('01AA', '0201', '0202') THEN
        NVL(BASE_TIMES, 0)
       ELSE
        0
     END) GN_BJJF, --国内被叫总计费时长
 SUM(CASE
       WHEN CALL_TYPE IN ('02', '04') AND LONG_TYPE NOT IN ('0301', '0401') AND
            ROAM_TYPE IN ('01AA', '0201', '0202') THEN
        NVL(CDR_NUMS, 0)
       ELSE
        0
     END) GN_BJCS, --国内被叫次数
 SUM(CASE
       WHEN CALL_TYPE IN ('01', '03') AND LONG_TYPE IN ('0301', '0401') AND
            ROAM_TYPE IN ('01AA', '0201', '0202') THEN
        NVL(BASE_TIMES, 0)
       ELSE
        0
     END) GJ_ZJJF, --国际主叫长途时长
 SUM(CASE
       WHEN CALL_TYPE IN ('01', '03') AND LONG_TYPE IN ('0301', '0401') AND
            ROAM_TYPE IN ('01AA', '0201', '0202') THEN
        NVL(CDR_NUMS, 0)
       ELSE
        0
     END) GJ_ZJCS, --国际主叫长途次数
 SUM(CASE
       WHEN CALL_TYPE IN ('02', '04') AND LONG_TYPE IN ('0301', '0401') AND
            ROAM_TYPE IN ('01AA', '0201', '0202') THEN
        NVL(BASE_TIMES, 0)
       ELSE
        0
     END) GJ_BJJF, --国际被叫长途时长
 SUM(CASE
       WHEN CALL_TYPE IN ('02', '04') AND LONG_TYPE IN ('0301', '0401') AND
            ROAM_TYPE IN ('01AA', '0201', '0202') THEN
        NVL(CDR_NUMS, 0)
       ELSE
        0
     END) GJ_BJCS, --国际被叫长途次数
 SUM(CASE
       WHEN CALL_TYPE IN ('01', '03') AND ROAM_TYPE IN ('0203', '0204') THEN
        NVL(BASE_TIMES, 0)
       ELSE
        0
     END) GM_ZJJF, --国际漫游主叫时长
 SUM(CASE
       WHEN CALL_TYPE IN ('01', '03') AND ROAM_TYPE IN ('0203', '0204') THEN
        NVL(CDR_NUMS, 0)
       ELSE
        0
     END) GM_ZJCS, --国际漫游主叫次数
 
 SUM(CASE
       WHEN CALL_TYPE IN ('02', '04') AND ROAM_TYPE IN ('0203', '0204') THEN
        NVL(BASE_TIMES, 0)
       ELSE
        0
     END) GM_BJJF, --国际漫游被叫时长
 SUM(CASE
       WHEN CALL_TYPE IN ('02', '04') AND ROAM_TYPE IN ('0203', '0204') THEN
        NVL(CDR_NUMS, 0)
       ELSE
        0
     END) GM_BJCS --国际漫游被叫次数
  FROM ZBG_DWA.DWA_S_M_USE_CB_VOICE_S_011 @LINK_DSSDWE T
 WHERE MONTH_ID = '201506'
 GROUP BY USER_ID

4G国漫短信
SELECT USER_ID,
       NVL(PTP_OUT_FREE_NUM, 0) + NVL(PTP_OUT_BILL_NUM, 0) PTP_SMS, --发送点对点总条数
       NVL(PTT_OUT_INT_NUM, 0) GJ_PTT_SMS --发送国际点对点条数
  FROM ZBG_DWA.DWA_V_M_CUS_CB_SING_SMS_011 @LINK_DSSDWE
 WHERE MONTH_ID = '201505' --短信

上网卡
维度
指标
3G套餐
公共部分（3G手机、23G融合、3G上网卡通用）
指标
流量
3G用户资料表与ZBA_DWA.DWA_V_M_CUS_3G_SING_USE_PROV通过USER_ID关联，取(flux_up+flux_down)，其中flux_up为上行流量，flux_down下行流量
短信条数
3G用户资料表与ZBA_DWA.DWA_V_M_CUS_3G_SING_USE_PROV通过USER_ID关联，取SMS_NUM
点对点发送短信条数
3G用户资料表与ZBA_DWA.DWA_V_M_CUS_3G_SING_SMS_PROV通过USER_ID关联，取
PTP_OUT_FREE_NUM + PTP_OUT_BILL_NUM
注意：没有点对点接收短信条数，不能提供
通话时长
3G用户资料表与ZBA_DWA.DWA_V_M_CUS_3G_SING_USE_PROV通过USER_ID关联，取CALL_DURATION
计费时长
3G用户资料表与ZBA_DWA.DWA_V_M_CUS_3G_SING_USE_PROV通过USER_ID关联，取MOBILE_TIMES
主叫计费时长
3G用户资料表与ZBA_DWA.DWA_V_M_CUS_3G_SING_USE_PROV通过USER_ID关联，取
(LOCAL_CALLING_TIMES + ROAM_CALLING_TIMES + TOLL_TIMES)
3G手机
维度
2G\3G国漫套餐
根据《中国联通总部与省分数据分析系统纵向数据接口规范_20141120(实施稿).doc》的4.2.2.6移动国际漫游套餐订购用户，查到国漫套餐情况
SELECT '201506' MONTH_ID,
       '011' PROV_ID,
       '2G',
       INTROAM_PRD_TYPE,
       COUNT(DISTINCT CASE
               WHEN SUBSTR(EFFECT_DATE, 1, 6) <= '201506' AND
                    SUBSTR(EXPIRE_DATE, 1, 6) >= '201506' THEN
                T.USER_ID
               ELSE
                NULL
             END), --订购用户数
       COUNT(DISTINCT CASE
               WHEN SUBSTR(EFFECT_DATE, 1, 6) = '201506' THEN
                T.USER_ID
               ELSE
                NULL
             END), --新增
       COUNT(DISTINCT CASE
               WHEN SUBSTR(EXPIRE_DATE, 1, 6) = '201506' THEN
                T.USER_ID
               ELSE
                NULL
             END) --退订
  FROM (SELECT *
          FROM ZBA_DWD.DWD_M_PRD_MB_INTROAM_USER_011 A
         WHERE MONTH_ID = '201506') T,
       (SELECT USER_ID
          FROM ZBA_DWA.DWA_V_M_CUS_2G_USER_INFO_011
         WHERE MONTH_ID = '201506'
           AND IS_STAT = '1') T1
 WHERE T.USER_ID = T1.USER_ID
 GROUP BY INTROAM_PRD_TYPE;

2G\3G国漫套餐编码和名称对应
2G/3G参考码表：SELECT * FROM ZB_DIM.DIM_BI_ROAM_PRODUCT;
DECODE(INTROAM_PRD_TYPE,
              '01',
              '全国统一套餐70元20M/天',
              '02',
              '全国统一套餐86元/天',
              '03',
              '全国统一套餐120元包120M/月（限日本使用)',
              '04',
              '3G国际及台港澳定向套餐',
              '05',
              '国际及台港澳定向套餐A',
              '06',
              '国际及台港澳定向套餐B',
              '07',
              '国际及台港澳定向套餐C',
              '08',
              '国际及台港澳定向套餐D',
              '09',
              '全国统一套餐170元60M/月',
              '10',
              '全国统一套餐370元160M/月',
              '11',
              '66元出访数据漫游日套66元60M/天',
              '12',
              '20元50MB/天畅游香港套餐',
              '13',
              '新版66元出访数据漫游日套餐 40M/每天',
              '14',
              '新版66元出访数据漫游日套餐 80M/每天',
              '15',
              '新版166元出访数据漫游月套餐 100M/每月',
              '16',
              '新版166元出访数据漫游月套餐 60M/每月'),
订购实例服务开通状态
	记录订购实例是否具备某种服务的能力，包括2G、3G、固话、宽带业务。
ZB_DWD.DWD_M_PRD_AL_USER_SERVICE
   1）、服务状态 01：开通，02：关闭
   2）、STATUS_CHANGE_DATE状态变更时间
注意：
1、表ZB_DWD.DWD_M_PRD_AL_USER_SERVICE,非单用户，用户可以订购多个服务，如基本语音、国际长途等，详见服务标识码表
2、取2G\3G\固话\宽带的情况时与对应的用户资料表进行关联即可
下面为常用到的口径
1、国际及台港澳漫游权限实际用户数：取国际漫游权限并且为开通状态，并且剔重后的用户。					
2、国际及台港澳漫游权限新增用户数：取国际漫游权限并且为开通状态，状态变更时间为当月，并且剔重后用户					
3、国际及台港澳漫游权限取消用户数：取国际漫游权限并且为关闭状态，状态变更时间为当月，并且剔重后用户					
4、国际及台港澳长途权限实际用户数：取国际长途权限并且为开通状态，并且剔重后的用户。					
5、国际及台港澳长途权限新增用户数：取国际长途权限并且为开通状态，状态变更时间为当月，并且剔重后用户					
6、国际及台港澳长途权限取消用户数：取国际长途权限并且为关闭状态，状态变更时间为当月，并且剔重后用户	
7、双权合计：取国际漫游权限开通状态并且国际长途权限开通，并且剔重后用户
一般要限定在网用户	
移动国际漫游套餐订购
订购移动国际漫游套餐的所有用户信息，包含受理已生效与未生效。受理生效后，拆机导致的立即失效，在发生月，不在接口内剔除	
ZBA_DWD.DWD_M_PRD_MB_INTROAM_USER_省份ID
指标
套外流量
指用户使用的非套餐套包内的流量。
SELECT SUM(CASE
             WHEN (M.PRODUCT_CLASSIFY_VALUE IS NULL OR
                  M.PRODUCT_CLASSIFY_VALUE = '020199') THEN
              0
             WHEN NVL(B2.TOTAL_FLUX, 0) >
                  (NVL(M.FLUX_M, 0) + NVL(A.CONT_FLUX, 0)) THEN
              NVL(B2.TOTAL_FLUX, 0) - NVL(M.FLUX_M, 0) - NVL(A.CONT_FLUX, 0)
             ELSE
              0
           END) FLUX_OVERFLOW --套外流量,套内流量包含流量包
  FROM (SELECT USER_ID,
               CASE
                 WHEN PRODUCT_MODE = '9999' THEN
                  '020199'
                 WHEN PRODUCT_MODE = '999999' THEN
                  '020199'
                 WHEN PRODUCT_MODE = '**' THEN
                  '020199'
                 WHEN PRODUCT_MODE IS NULL THEN
                  '020199'
                 ELSE
                  PRODUCT_MODE
               END PRODUCT_MODE,
               CASE
                 WHEN PKG_PROD_CLASS = '0201' THEN
                  100
                 WHEN PKG_PROD_CLASS = '0202' THEN
                  300
                 WHEN PKG_PROD_CLASS = '0203' THEN
                  500
                 ELSE
                  0
               END CONT_FLUX, --流量包
               USER_ACT_TYPE,
               IS_THIS_ACCT,
               PKG_PROD_CLASS
          FROM ZBA_DWA.DWA_V_M_CUS_3G_USER_INFO_011 T
         WHERE IS_STAT = '1'
           AND IS_CARD = '0'
           AND MONTH_ID = '201506'
           AND IS_THIS_ACCT = '1') A, --当月出账
       
       (SELECT SUBS_INSTANCE_ID,
               NVL(FLUX_UP, 0) + NVL(FLUX_DOWN, 0) TOTAL_FLUX,
               MOBILE_TIMES
          FROM ZBA_DWA.DWA_V_M_CUS_3G_SING_USE_011
         WHERE MONTH_ID = '201506') B2,
       
       (SELECT H.PRODUCT_CLASS,
               J.PRODUCT_CLASS_DESC,
               J.PRODUCT_BASE_CLASS,
               R.MON_FEE,
               R.PRODUCT_CLASS RATE_CLASS,
               R.CALL_DURA,
               R.FLUX_M,
               T.FLUX_FTFEE,
               T.CALL_FTFEE,
               J.PRODUCT_CLASSIFY_VALUE
          FROM (SELECT *
                  FROM ZB_DIM.DIM_PRODUCT_CLASS
                 WHERE SERVICE_TYPE = '30AAAAAA'
                   AND IS_CARD = '0') H,
               (SELECT *
                  FROM ZB_DIM.DIM_PRODUCT_CLASS
                 WHERE SERVICE_TYPE = '30AAAAAA'
                   AND IS_CARD = '0') J,
               ZB_DIM.DIM_PRODUCT_RATE R,
               TEMP_3G_AL_PRODUCT_FTFEE T
         WHERE H.PRODUCT_CLASSIFY_VALUE = J.PRODUCT_CLASS(+)
           AND J.PRODUCT_CLASSIFY_VALUE = '02' || R.PRODUCT_CLASS(+)
           AND H.PRODUCT_CLASS = T.PRODUCT_CLASS(+)) M
 WHERE A.USER_ID = B2.SUBS_INSTANCE_ID(+)
   AND A.PRODUCT_MODE = M.PRODUCT_CLASS(+)

套外主叫计费时长
指用户使用的非套餐包内的语音主叫计费时长。
SELECT SUM(CASE
             WHEN M.PRODUCT_CLASSIFY_VALUE IS NULL OR
                  M.PRODUCT_CLASSIFY_VALUE = '020199' THEN
              0
             WHEN M.PRODUCT_BASE_CLASS = 'C' AND
                  NVL(B1.LOCAL_CALLING_TIMES, 0) > NVL(M.CALL_DURA, 0) THEN
              NVL(B1.OUT_JF_TIMES, 0) - NVL(M.CALL_DURA, 0)
             WHEN M.PRODUCT_BASE_CLASS = 'C' AND
                  NVL(B1.LOCAL_CALLING_TIMES, 0) <= NVL(M.CALL_DURA, 0) THEN
              NVL(B1.OUT_JF_TIMES, 0) - NVL(B1.LOCAL_CALLING_TIMES, 0)
             WHEN M.PRODUCT_BASE_CLASS <> 'C' AND
                  NVL(B1.OUT_JF_TIMES, 0) > NVL(M.CALL_DURA, 0) THEN
              NVL(B1.OUT_JF_TIMES, 0) - NVL(M.CALL_DURA, 0)
             ELSE
              0
           END) TIMES_OVERFLOW --套外主叫计费时长
  FROM (SELECT USER_ID,
               CASE
                 WHEN PRODUCT_MODE = '9999' THEN
                  '020199'
                 WHEN PRODUCT_MODE = '999999' THEN
                  '020199'
                 WHEN PRODUCT_MODE = '**' THEN
                  '020199'
                 WHEN PRODUCT_MODE IS NULL THEN
                  '020199'
                 ELSE
                  PRODUCT_MODE
               END PRODUCT_MODE,
               CASE
                 WHEN PKG_PROD_CLASS = '0201' THEN
                  100
                 WHEN PKG_PROD_CLASS = '0202' THEN
                  300
                 WHEN PKG_PROD_CLASS = '0203' THEN
                  500
                 ELSE
                  0
               END CONT_FLUX, --流量包
               USER_ACT_TYPE,
               IS_THIS_ACCT,
               PKG_PROD_CLASS
          FROM ZBA_DWA.DWA_V_M_CUS_3G_USER_INFO_011 T
         WHERE IS_STAT = '1'
           AND IS_CARD = '0'
           AND MONTH_ID = '201506'
           AND IS_THIS_ACCT = '1') A, --当月出账
       (SELECT SUBS_INSTANCE_ID,
               NVL(LOCAL_CALLING_TIMES, 0) LOCAL_CALLING_TIMES,
               TOTAL_TIMES,
               OUT_JF_TIMES
          FROM ZBA_DWA.DWA_V_M_CUS_3G_SING_VOICE_011
         WHERE MONTH_ID = '201506') B1,
       (SELECT H.PRODUCT_CLASS,
               J.PRODUCT_CLASS_DESC,
               J.PRODUCT_BASE_CLASS,
               R.MON_FEE,
               R.PRODUCT_CLASS RATE_CLASS,
               R.CALL_DURA,
               R.FLUX_M,
               T.FLUX_FTFEE,
               T.CALL_FTFEE,
               J.PRODUCT_CLASSIFY_VALUE
          FROM (SELECT *
                  FROM ZB_DIM.DIM_PRODUCT_CLASS
                 WHERE SERVICE_TYPE = '30AAAAAA'
                   AND IS_CARD = '0') H,
               (SELECT *
                  FROM ZB_DIM.DIM_PRODUCT_CLASS
                 WHERE SERVICE_TYPE = '30AAAAAA'
                   AND IS_CARD = '0') J,
               ZB_DIM.DIM_PRODUCT_RATE R,
               TEMP_3G_AL_PRODUCT_FTFEE T
         WHERE H.PRODUCT_CLASSIFY_VALUE = J.PRODUCT_CLASS(+)
           AND J.PRODUCT_CLASSIFY_VALUE = '02' || R.PRODUCT_CLASS(+)
           AND H.PRODUCT_CLASS = T.PRODUCT_CLASS(+)) M
 WHERE A.USER_ID = B2.SUBS_INSTANCE_ID(+)
   AND A.PRODUCT_MODE = M.PRODUCT_CLASS(+)

3G国漫流量
SELECT SUBS_INSTANCE_ID,
       NVL(TOTAL_FLUX, 0) TOTAL_FLUX,
       NVL(UP_ROAM_GAT_FLUX, 0) + NVL(UP_ROAM_INT_FLUX, 0) +
       NVL(DOWN_ROAM_GAT_FLUX, 0) + NVL(DOWN_ROAM_INT_FLUX, 0) GM_FLUX
  FROM ZBA_DWA.DWA_V_M_CUS_3G_SING_FLUX_011 T
 WHERE MONTH_ID = '201506' --流量
3G国漫语音
  SELECT /*PARALLEL(T,4)*/
         SUBS_INSTANCE_ID,
         SUM(CASE
               WHEN CALL_TYPE IN ('01', '03') AND
                    LONG_TYPE NOT IN ('0301', '0401') AND
                    ROAM_TYPE IN ('01AA', '0201', '0202') THEN
                NVL(BASE_TIMES, 0)
               ELSE
                0
             END) GN_ZJJF, --国内主叫总计费时长
         SUM(CASE
               WHEN CALL_TYPE IN ('01', '03') AND
                    LONG_TYPE NOT IN ('0301', '0401') AND
                    ROAM_TYPE IN ('01AA', '0201', '0202') THEN
                NVL(CDR_NUMS, 0)
               ELSE
                0
             END) GN_ZJCS, --国内主叫总次数
         SUM(CASE
               WHEN CALL_TYPE IN ('02', '04') AND
                    LONG_TYPE NOT IN ('0301', '0401') AND
                    ROAM_TYPE IN ('01AA', '0201', '0202') THEN
                NVL(BASE_TIMES, 0)
               ELSE
                0
             END) GN_BJJF, --国内被叫总计费时长
         SUM(CASE
               WHEN CALL_TYPE IN ('02', '04') AND
                    LONG_TYPE NOT IN ('0301', '0401') AND
                    ROAM_TYPE IN ('01AA', '0201', '0202') THEN
                NVL(CDR_NUMS, 0)
               ELSE
                0
             END) GN_BJCS, --国内被叫次数
         0, --国内语音饱和度
         SUM(CASE
               WHEN CALL_TYPE IN ('01', '03') AND LONG_TYPE IN ('0301', '0401') AND
                    ROAM_TYPE IN ('01AA', '0201', '0202') THEN
                NVL(BASE_TIMES, 0)
               ELSE
                0
             END) GJ_ZJJF, --国际主叫长途时长
         SUM(CASE
               WHEN CALL_TYPE IN ('01', '03') AND LONG_TYPE IN ('0301', '0401') AND
                    ROAM_TYPE IN ('01AA', '0201', '0202') THEN
                NVL(CDR_NUMS, 0)
               ELSE
                0
             END) GJ_ZJCS, --国际主叫长途次数
         SUM(CASE
               WHEN CALL_TYPE IN ('02', '04') AND LONG_TYPE IN ('0301', '0401') AND
                    ROAM_TYPE IN ('01AA', '0201', '0202') THEN
                NVL(BASE_TIMES, 0)
               ELSE
                0
             END) GJ_BJJF, --国际被叫长途时长
         SUM(CASE
               WHEN CALL_TYPE IN ('02', '04') AND LONG_TYPE IN ('0301', '0401') AND
                    ROAM_TYPE IN ('01AA', '0201', '0202') THEN
                NVL(CDR_NUMS, 0)
               ELSE
                0
             END) GJ_BJCS, --国际被叫长途次数
         SUM(CASE
               WHEN CALL_TYPE IN ('01', '03') AND ROAM_TYPE IN ('0203', '0204') THEN
                NVL(BASE_TIMES, 0)
               ELSE
                0
             END) GM_ZJJF, --国际漫游主叫时长
         SUM(CASE
               WHEN CALL_TYPE IN ('01', '03') AND ROAM_TYPE IN ('0203', '0204') THEN
                NVL(CDR_NUMS, 0)
               ELSE
                0
             END) GM_ZJCS, --国际漫游主叫次数
         
         SUM(CASE
               WHEN CALL_TYPE IN ('02', '04') AND ROAM_TYPE IN ('0203', '0204') THEN
                NVL(BASE_TIMES, 0)
               ELSE
                0
             END) GM_BJJF, --国际漫游被叫时长
         SUM(CASE
               WHEN CALL_TYPE IN ('02', '04') AND ROAM_TYPE IN ('0203', '0204') THEN
                NVL(CDR_NUMS, 0)
               ELSE
                0
             END) GM_BJCS --国际漫游被叫次数
          FROM ZBA_DWA.DWA_S_M_USE_3G_VOICE_S_011 T
         WHERE MONTH_ID = '201506'
         GROUP BY SUBS_INSTANCE_ID --语音
3G国漫短信
SELECT SUBS_INSTANCE_ID,
       NVL(PTP_OUT_FREE_NUM, 0) + NVL(PTP_OUT_BILL_NUM, 0) PTP_SMS, --发送点对点总条数
       NVL(PTT_OUT_INT_NUM, 0) GJ_PTT_SMS --发送国际点对点条数
  FROM ZBA_DWA.DWA_V_M_CUS_3G_SING_SMS_011
 WHERE MONTH_ID = '201506' —短信
3G彩信条数（指标数据）
SELECT ROUND(SUM(INFO_NUM)) KPI_VALUE
  FROM ZB.ZB_USE_M_3G_INC_02
 WHERE (SMS_DIREC_ID = '01' AND
       SMS_TYPE_ID IN ('20100',
                        '20201',
                        '20202',
                        '20301',
                        '20302',
                        '20501',
                        '20502',
                        '20503',
                        '20504',
                        '20600'))
    OR (SMS_DIREC_ID = '02' AND
       SMS_TYPE_ID IN ('20501', '20502', '20503', '20504'))
   AND MONTH_NO = '201410';
23G融合
维度
指标
套外流量
指用户使用的非套餐套包内的流量。
SELECT SUM(CASE
             WHEN NVL(TOTAL_FLUX, 0) > NVL(FLUX_M, 0) THEN
              NVL(TOTAL_FLUX, 0) - NVL(FLUX_M, 0)
             ELSE
              0
           END) --套外流量
  FROM (SELECT USER_ID,
               NVL(T2.FLUX_M, 0) + NVL(T3. FLUX_M, 0) FLUX_M,
               NVL(T2.CALL_DURA, 0) CALL_DURA,
               NVL(T2.FLUX_FTFEE, 0) + NVL(T3.FLUX_FTFEE, 0) FLUX_FTFEE,
               NVL(T2.CALL_FTFEE, 0) CALL_FTFEE,
               USER_ACT_TYPE
          FROM (SELECT /*+PARALLEL(T,2)*/
                 USER_ID,
                 NVL(PRODUCT_MODE, '020199') PRODUCT_MODE,
                 IS_CARD,
                 PKG_PROD_CLASS,
                 USER_ACT_TYPE
                  FROM ZBA_DWA.DWA_V_M_CUS_3G_USER_INFO_011 T
                 WHERE MONTH_ID = '201603'
                   AND IS_THIS_ACCT = '1'
                   AND IS_STAT = '1'
                   AND IS_CARD = '2') T1,
               (SELECT * FROM TEMP_DX_3G_PKG_PROD_CLASS WHERE IS_PKG = '0') T2,
               (SELECT * FROM TEMP_DX_3G_PKG_PROD_CLASS WHERE IS_PKG = '1') T3
         WHERE T1.PRODUCT_MODE = T2.PRODUCT_CLASS(+)
           AND T1.PKG_PROD_CLASS = T3.PRODUCT_CLASS(+)) T, --23G融合出账用户 +套餐信息
       
       (SELECT /*+PARALLEL(T,2)*/
         SUBS_INSTANCE_ID USER_ID,
         CASE
           WHEN NVL(TOTAL_FLUX, 0) < 0 THEN
            0
           ELSE
            NVL(TOTAL_FLUX, 0)
         END TOTAL_FLUX
          FROM ZBA_DWA.DWA_V_M_CUS_3G_SING_FLUX_011 T
         WHERE MONTH_ID = '201603') T_FLUX --流量 

 WHERE  T.USER_ID = T_FLUX.USER_ID(+)

套外主叫计费时长
指用户使用的非套餐包内的语音主叫计费时长。
SELECT SUM(CASE
             WHEN NVL(T_VOICE.OUT_JF_TIMES, 0) > NVL(CALL_DURA, 0) THEN
              NVL(T_VOICE.OUT_JF_TIMES, 0) - NVL(CALL_DURA, 0)
             ELSE
              0
           END) --套外主叫计费时长
  FROM (SELECT USER_ID,
               NVL(T2.FLUX_M, 0) + NVL(T3. FLUX_M, 0) FLUX_M,
               NVL(T2.CALL_DURA, 0) CALL_DURA,
               NVL(T2.FLUX_FTFEE, 0) + NVL(T3.FLUX_FTFEE, 0) FLUX_FTFEE,
               NVL(T2.CALL_FTFEE, 0) CALL_FTFEE,
               USER_ACT_TYPE
          FROM (SELECT /*+PARALLEL(T,2)*/
                 USER_ID,
                 NVL(PRODUCT_MODE, '020199') PRODUCT_MODE,
                 IS_CARD,
                 PKG_PROD_CLASS,
                 USER_ACT_TYPE
                  FROM ZBA_DWA.DWA_V_M_CUS_3G_USER_INFO_011 T
                 WHERE MONTH_ID = '201603'
                   AND IS_THIS_ACCT = '1'
                   AND IS_STAT = '1'
                   AND IS_CARD = '2') T1,
               (SELECT * FROM TEMP_DX_3G_PKG_PROD_CLASS WHERE IS_PKG = '0') T2,
               (SELECT * FROM TEMP_DX_3G_PKG_PROD_CLASS WHERE IS_PKG = '1') T3
         WHERE T1.PRODUCT_MODE = T2.PRODUCT_CLASS(+)
           AND T1.PKG_PROD_CLASS = T3.PRODUCT_CLASS(+)) T, --23G融合出账用户 +套餐信息
       
       (SELECT /*+PARALLEL(T,2)*/
         SUBS_INSTANCE_ID USER_ID,
         NVL(TOTAL_TIMES, 0) TOTAL_TIMES, --计费时长
         NVL(OUT_JF_TIMES, 0) OUT_JF_TIMES --主叫计费时长
          FROM ZBA_DWA.DWA_V_M_CUS_3G_SING_VOICE_011 T
         WHERE MONTH_ID = '201603') T_VOICE --语音

 WHERE T.USER_ID = T_VOICE.USER_ID(+)
3G上网卡
维度
指标
OCS上网卡
维度
指标
短信条数
OCS用户资料表与ZBA_DWA.DWA_V_M_CUS_3G_SING_OCSSMS通过用户ID关联取TOTAL_SMS_NUM
流量
OCS用户资料表与DWA_V_M_CUS_3G_SING_OCSFLUX通过用户ID关联取TOTAL_FLUX
O域流量
如果要取OCS是O域流量直接关联ZBA_DWA.DWA_V_CUS_ALL_IMEI_FLUX，限制PROV_DESC='011'
通话时长
OCS上网卡没有通话的功能，所以为0
2G套餐
维度
指标
流量
2G用户资料表与ZBA_DWA.DWA_V_M_CUS_2G_SING_FLUX_PROV通过USER_ID关联，取TOTAL_FLUX
短信条数
2G用户资料表与ZBA_DWA.DWA_V_M_CUS_2G_SING_SMS_PROV 通过USER_ID关联，取TOTAL_SMS_NUM
通话时长
2G用户资料表与ZBA_DWA.DWA_V_M_CUS_2G_SING_VOICE_PROV通过USER_ID关联，取TOTAL_DURA
2G国漫流量
SELECT SUBS_INSTANCE_ID,
       NVL(UP_ROAM_GAT_FLUX, 0) + NVL(DOWN_ROAM_GAT_FLUX, 0) +
       NVL(UP_ROAM_INT_FLUX, 0) + NVL(DOWN_ROAM_INT_FLUX, 0) FLUX_SYL
  FROM ZBA_DWA.DWA_V_M_CUS_2G_SING_FLUX_011
 WHERE MONTH_ID = '201505' --流量

2G国漫语音
SELECT /*PARALLEL(T,4)*/
         SUBS_INSTANCE_ID,
         SUM(CASE
               WHEN CALL_TYPE IN ('01', '03') AND
                    LONG_TYPE NOT IN ('0301', '0401') AND
                    ROAM_TYPE IN ('01AA', '0201', '0202') THEN
                NVL(BASE_TIMES, 0)
               ELSE
                0
             END) GN_ZJJF, --国内主叫总计费时长
         SUM(CASE
               WHEN CALL_TYPE IN ('01', '03') AND
                    LONG_TYPE NOT IN ('0301', '0401') AND
                    ROAM_TYPE IN ('01AA', '0201', '0202') THEN
                NVL(CDR_NUMS, 0)
               ELSE
                0
             END) GN_ZJCS, --国内主叫总次数
         SUM(CASE
               WHEN CALL_TYPE IN ('02', '04') AND
                    LONG_TYPE NOT IN ('0301', '0401') AND
                    ROAM_TYPE IN ('01AA', '0201', '0202') THEN
                NVL(BASE_TIMES, 0)
               ELSE
                0
             END) GN_BJJF, --国内被叫总计费时长
         SUM(CASE
               WHEN CALL_TYPE IN ('02', '04') AND
                    LONG_TYPE NOT IN ('0301', '0401') AND
                    ROAM_TYPE IN ('01AA', '0201', '0202') THEN
                NVL(CDR_NUMS, 0)
               ELSE
                0
             END) GN_BJCS, --国内被叫次数
         0, --国内语音饱和度
         SUM(CASE
               WHEN CALL_TYPE IN ('01', '03') AND LONG_TYPE IN ('0301', '0401')
                 AND ROAM_TYPE IN ('01AA', '0201', '0202')  THEN
                NVL(BASE_TIMES, 0)
               ELSE
                0
             END) GJ_ZJJF, --国际主叫长途时长
         SUM(CASE
               WHEN CALL_TYPE IN ('01', '03') AND LONG_TYPE IN ('0301', '0401')
                  AND ROAM_TYPE IN ('01AA', '0201', '0202')
                  THEN
                NVL(CDR_NUMS, 0)
               ELSE
                0
             END) GJ_ZJCS, --国际主叫长途次数
         SUM(CASE
               WHEN CALL_TYPE IN ('02', '04') AND LONG_TYPE IN ('0301', '0401')
                 AND    ROAM_TYPE IN ('01AA', '0201', '0202')THEN
                NVL(BASE_TIMES, 0)
               ELSE
                0
             END) GJ_BJJF, --国际被叫长途时长
         SUM(CASE
               WHEN CALL_TYPE IN ('02', '04') AND LONG_TYPE IN ('0301', '0401')
                 AND    ROAM_TYPE IN ('01AA', '0201', '0202')  THEN
                NVL(CDR_NUMS, 0)
               ELSE
                0
             END) GJ_BJCS, --国际被叫长途次数
         SUM(CASE
               WHEN CALL_TYPE IN ('01', '03') AND ROAM_TYPE IN ('0203', '0204') THEN
                NVL(BASE_TIMES, 0)
               ELSE
                0
             END) GM_ZJJF, --国际漫游主叫时长
         SUM(CASE
               WHEN CALL_TYPE IN ('01', '03') AND ROAM_TYPE IN ('0203', '0204') THEN
                NVL(CDR_NUMS, 0)
               ELSE
                0
             END) GM_ZJCS, --国际漫游主叫次数

         SUM(CASE
               WHEN CALL_TYPE IN ('02', '04') AND ROAM_TYPE IN ('0203', '0204') THEN
                NVL(BASE_TIMES, 0)
               ELSE
                0
             END) GM_BJJF, --国际漫游被叫时长
         SUM(CASE
               WHEN CALL_TYPE IN ('02', '04') AND ROAM_TYPE IN ('0203', '0204') THEN
                NVL(CDR_NUMS, 0)
               ELSE
                0
             END) GM_BJCS --国际漫游被叫次数

          FROM ZBA_DWA.DWA_S_M_USE_2G_VOICE_S_011 T
         WHERE MONTH_ID = '201505'
         GROUP BY SUBS_INSTANCE_ID--语音               
2G国漫短信
SELECT SUBS_INSTANCE_ID,
       NVL(PTP_OUT_FREE_NUM, 0) + NVL(PTP_OUT_BILL_NUM, 0) PTP_SMS, --发送点对点总条数
       NVL(PTT_OUT_INT_NUM, 0) GJ_PTT_SMS --发送国际点对点条数
  FROM ZBA_DWA.DWA_V_M_CUS_2G_SING_SMS_011
 WHERE MONTH_ID = '201505' --短信
按照网络分类
按照用户使用的网络进行分类，分为4G网络、3G网络、2G网络和无法识别的网络四种。
公共部分
注意：
无法识别网络用户包括两部分：
1. ZBG_DWA.DWA_V_M_CUS_NM_USER_INFO_&prov_id@LINK_DSSDWE中SERVICE_TYPE LIKE '90%'部分，该部分各维度取法详见“公共部分--维度（不含OCS上网卡）”部分；
2. 3GOCS无线上网卡部分，目前不能区分网络类型，直接归属为其他网络，该部分维度和指标取法详见“按照套餐分类—3G套餐—OCS上网卡”部分
维度
指标
语音表
SELECT /* + PARALLEL (T, 2)*/
 USER_ID, TOTAL_DURA, TOTAL_TIMES, OUT_JF_TIMES TOTAL_CALLING_TIMES
  FROM ZBG_DWA.DWA_V_M_CUS_NM_SING_VOICE_&prov_id@LINK_DSSDWE T
 WHERE MONTH_ID = '&month_id';
短信表
SELECT /* + PARALLEL (T, 2)*/
 USER_ID, NVL(PTP_OUT_FREE_NUM, 0) + NVL(PTP_OUT_BILL_NUM, 0) PTP_OUT_NUM
  FROM ZBG_DWA.DWA_V_M_CUS_NM_SING_SMS_&prov_id@LINK_DSSDWE T
 WHERE MONTH_ID = '&month_id';
流量表
SELECT /* + PARALLEL (T, 2)*/
 USER_ID, TOTAL_FLUX
  FROM ZBG_DWA.DWA_V_M_CUS_NM_SING_FLUX_&prov_id@LINK_DSSDWE T
 WHERE MONTH_ID = '&month_id';
宽带业务
BSS侧
维度
指标
CBSS侧
该部分相关使用量指标取法详见“按照套餐分类—CBSS套餐—公共部分”
固话业务
BSS侧
维度
指标
CBSS侧
该部分相关使用量指标取法详见“按照套餐分类—CBSS套餐—公共部分”
融合业务
首先要确定用户属于哪种套餐类型（2G/3G/4G），然后参见不同套餐相关指标的取法，取出对应的维度或指标信息
账务域
移动业务
按照套餐分类
按照用户使用的套餐进行分类
CBSS套餐
公共部分（手机、上网卡通用）
指标
出账收入
SELECT USER_ID,TOTAL_FEE --总收入
    FROM ZBG_DWA.DWA_V_M_CUS_CB_CHARGE_011@LINK_DSSDWE T
WHERE MONTH_ID = '201505'
正常出账费用
SELECT /*+PARALLEL(A,4)(B,4)*/
 '201505', '011', A.AREA_ID, '4G', SUM(B.ACCT_FEE)
  FROM (SELECT *
          FROM ZBG_DWA.DWA_V_M_CUS_CB_USER_INFO_011@LINK_DSSDWE T
         WHERE IS_STAT = '1'
           AND MONTH_ID = '201505'
           AND SERVICE_TYPE = '40AAAAAA') A,
       (SELECT USER_ID, SUM(ACCT_FEE) ACCT_FEE
          FROM ZBG_DWA.DWA_S_M_ACC_CB_CHARGE_011@LINK_DSSDWE
         WHERE MONTH_ID = '201505'
           AND OWE_BILL_FLAG = '0' --正常（0）、降欠挂账（1）、降欠挂账回收（2）
         GROUP BY USER_ID) B
 WHERE A.USER_ID = B.USER_ID(+)
 GROUP BY A.AREA_ID
欠费金额
用户资料表关联如下表
SELECT ACCT_MONTH, USER_ID, OWE_FEE
  FROM ZBG_DWA.DWA_S_M_ACC_CB_OWE_011@LINK_DSSDWE
 WHERE SERVICE_TYPE = '40AAAAAA'
   AND MONTH_ID = '201505'
注意：
欠费存在超出当前账期范围的，该类欠费数据都是递延分摊未来的数据，该部分费用现在收了，但是体现在未来的费用。例如没有交半年流量包的钱或者只交了一部分，将会做递延分摊欠费。本需求数据已经将该部分欠费剔除不做统计。
逾期欠费金额
SELECT /*+PARALLEL(T,2)*/
 USER_ID, SUM(OWE_FEE) OWE_FEE
  FROM ZBG_DWA.DWA_S_M_ACC_CB_OWE_011@LINK_DSSDWE T
 WHERE SERVICE_TYPE = '40AAAAAA'
   AND MONTH_ID = '201603'
      --AND NVL(IS_OWE_FLAG, '0') <> '1'  该条件判断欠费是否是降欠挂账产生的欠费，因需求没有说只取正常欠费，不取降欠挂账欠费，所以不加该条件
   AND ACCT_MONTH < '201603'
 GROUP BY USER_ID
HAVING SUM(OWE_FEE) > 0
4G缴费
存在用户当月缴费多次，多条记录，注意使用
SELECT *
  FROM ZBG_DWD.DWD_M_ACC_CB_PAYLOG_079@LINK_DSSDWE C
 WHERE C.MONTH_ID = '201508'
   AND C.PAYMENT_OP = '16000' --储值操作类型为“16000 储值”
4G用户缴费次数及缴费金额
SELECT T1.USER_ID,
       NVL(T3.PAY_METHOD, '本月无缴费') PAY_METHOD,
       SUM(NVL(T3.PAY_NUM, 0)) PAY_NUM, 
       SUM(NVL(T3.PAY_FEE, 0)) PAY_FEE
  FROM (SELECT A.USER_ID
          FROM ZBG_DWA.DWA_V_M_CUS_CB_USER_INFO_010@LINK_DSSDWE A
         WHERE A.MONTH_ID = '201508'
           AND A.SERVICE_TYPE = '40AAAAAA'
           AND A.IS_CARD IN ('0', '1')
           AND A.IS_STAT = '1'
           AND A.IS_ACCT = '1') T1,
       (SELECT C.USER_ID,
               C.PAY_METHOD,--缴费方式，参见ZBG_DIM.DIM_MAP_CBSS_PAYMOD@LINK_DSSDWE
               COUNT(1) PAY_NUM,
               SUM(C.RECV_FEE) PAY_FEE
          FROM ZBG_DWD.DWD_M_ACC_CB_PAYLOG_010@LINK_DSSDWE C
         WHERE C.MONTH_ID = '201508'
           AND C.PAYMENT_OP = '16000' --储值操作类型为“16000 储值”（必加条件）（16000	储值;16001	清退;16003	返销;16004	转出;16005	转入）
         GROUP BY C.USER_ID,C.PAY_METHOD) T3
 WHERE T1.USER_ID = T3.USER_ID(+)
 GROUP BY T1.USER_ID, NVL(T3.PAY_METHOD, '本月无缴费')
4G用户账户余额
SELECT USER_ID,
       NVL(T_BALANCE.BALANCE_FEE,0) BALANCE_FEE
  FROM (SELECT T.USER_ID, T.IS_CARD,T.DEVICE_NUMBER, T.PRODUCT_CLASS,T.CUST_ID,T.AREA_ID
          FROM ZBG_DWA.DWA_V_M_CUS_CB_USER_INFO_&PROV_ID@LINK_DSSDWE T
         WHERE MONTH_ID = '&MONTH_ID'
           AND SERVICE_TYPE='40AAAAAA'
           AND IS_STAT = '1'
           AND IS_ACCT = '1') T,
      (SELECT USER_ID,
              SUM(CASE WHEN MOD(&MONTH_ID,2)=0 THEN EVEN_MONEY ELSE ODD_MONEY END) BALANCE_FEE--EVEN_MONEY 账户余额-偶数月,ODD_MONEY 账户余额-奇数月
         FROM ZBG_DWD.DWD_M_ACC_CB_ACCT_DEPOSIT_&PROV_ID@LINK_DSSDWE
        WHERE MONTH_ID = '&MONTH_ID'
          AND SUBSTR(START_DATE,1,6)<='&MONTH_ID'
          AND SUBSTR(END_DATE,1,6)>='&MONTH_ID'
          AND SUBSTR(END_DATE,1,6)>=SUBSTR(START_DATE,1,6)
          AND VALID_FLAG='1'
        GROUP BY USER_ID
        )T_BALANCE
 WHERE T.USER_ID=T_BALANCE.USER_ID(+)
手机
维度
指标
4G流量总收入
用户使用流量产生的收入。包括套内收入和套外收入
SELECT SUM(CASE
             WHEN SUBSTR(T2.DIM_1, 1, 4) IN ('0301', '0302') THEN
              NVL(T4.MOBILE_NET_FEE, 0) + NVL(T3.FLUX_MON_FEE, 0) * 0.8  --全国组合、本地组合流量打八折
             WHEN T2.DIM_1 LIKE '03%' THEN
              NVL(T4.MOBILE_NET_FEE, 0) + NVL(T3.FLUX_MON_FEE, 0)
             ELSE
              NVL(T4.MOBILE_NET_FEE, 0) + NVL(T2.FLUX_MON_FEE, 0)
           END)
  FROM (SELECT *
          FROM ZBG_DWA.DWA_V_M_CUS_CB_USER_INFO_011@LINK_DSSDWE T
         WHERE IS_STAT = '1'
           AND IS_CARD = '0'
           AND SERVICE_TYPE = '40AAAAAA'
           AND MONTH_ID = '201505') T1,
       (SELECT C.PRODUCT_CLASS,
               C.DIM_1,
               R.CALL_DURA,
               R.FLUX_M,
               C.MON_FEE       PROD_MON_FEE,
               F.MON_FEE,
               F.CALL_FTFEE    VOICE_MON_FEE,
               F.FLUX_FTFEE    FLUX_MON_FEE
          FROM ZBG_DIM.DIM_PRODUCT_CLASS@LINK_DSSDWE C,
               ZBG_DIM.DIM_PRODUCT_VALUE@LINK_DSSDWE R,
               TEMP_4G_PRODUCT_FTFEE                 F
         WHERE C.SERVICE_TYPE = '40AAAAAA'
           AND C.IS_CBSS = '1'
           AND C.PRODUCT_CLASSIFY_VALUE = R.PRODUCT_CLASS(+)
           AND C.PRODUCT_CLASS = F.PRODUCT_CLASS(+)) T2,
       (SELECT C.USER_ID,
               R1.MON_FEE   FLUX_MON_FEE,
               R1.PKG_VALUE FLUX_M,
               R2.MON_FEE   VOICE_MON_FEE,
               R2.PKG_VALUE CALL_DURA
          FROM (SELECT *
                  FROM ZBG_DWA.DWA_V_M_CUS_CB_DIY_PACKAGE_011@LINK_DSSDWE
                 WHERE SERVICE_TYPE = '40AAAAAA'
                   AND MONTH_ID = '201505') C,
               ZBG_DIM.DIM_CBSS_DISCNT_CODE@LINK_DSSDWE R1,
               ZBG_DIM.DIM_CBSS_DISCNT_CODE@LINK_DSSDWE R2
         WHERE C.FLUX_PKG = R1.DISCNT_CODE(+)
           AND C.VOICE_PKG = R2.DISCNT_CODE(+)) T3, --DIY
       (SELECT USER_ID,
               TOTAL_FEE, --总收入
               NVL(T.BASE_CALL_FEE, 0) + NVL(T.PROV_LONG_FEE, 0) +
               NVL(T.COUN_LONG_LFEE, 0) + NVL(T.INTER_LONG_LFEE, 0) +
               NVL(T.GAT_LONG_LFEE, 0) + NVL(T.COUN_ROAM_BFEE, 0) +
               NVL(T.INTER_ROAM_BFEE, 0) + NVL(T.GAT_RAOM_BFEE, 0) +
               NVL(T.OTHER_CALL_LFEE, 0) + NVL(T.VP_FEE, 0) OUT_CALL_FEE, --套外语音收入
               MOBILE_NET_FEE --套外流量收入
          FROM ZBG_DWA.DWA_V_M_CUS_CB_CHARGE_011@LINK_DSSDWE T
         WHERE MONTH_ID = '201505') T4
 WHERE T1.PRODUCT_CLASS = T2.PRODUCT_CLASS(+)
   AND T1.USER_ID = T3.USER_ID(+)
   AND T1.USER_ID = T4.USER_ID(+)

4G套内流量收入
用户套餐包分摊的收入
SELECT SUM(CASE
             WHEN SUBSTR(T2.DIM_1, 1, 4) IN ('0301', '0302') THEN
              NVL(T3.FLUX_MON_FEE, 0) * 0.8 --全国组合、本地组合流量打八折
             WHEN T2.DIM_1 LIKE '03%' THEN
              NVL(T3.FLUX_MON_FEE, 0)
             ELSE
              NVL(T2.FLUX_MON_FEE, 0)
           END)
  FROM (SELECT *
          FROM ZBG_DWA.DWA_V_M_CUS_CB_USER_INFO_011@LINK_DSSDWE T
         WHERE IS_STAT = '1'
           AND IS_CARD = '0'
           AND SERVICE_TYPE = '40AAAAAA'
           AND MONTH_ID = '201505') T1,
       (SELECT C.PRODUCT_CLASS,
               C.DIM_1,
               R.CALL_DURA,
               R.FLUX_M,
               C.MON_FEE       PROD_MON_FEE,
               F.MON_FEE,
               F.CALL_FTFEE    VOICE_MON_FEE,
               F.FLUX_FTFEE    FLUX_MON_FEE
          FROM ZBG_DIM.DIM_PRODUCT_CLASS@LINK_DSSDWE C,
               ZBG_DIM.DIM_PRODUCT_VALUE@LINK_DSSDWE R,
               TEMP_4G_PRODUCT_FTFEE                 F
         WHERE C.SERVICE_TYPE = '40AAAAAA'
           AND C.IS_CBSS = '1'
           AND C.PRODUCT_CLASSIFY_VALUE = R.PRODUCT_CLASS(+)
           AND C.PRODUCT_CLASS = F.PRODUCT_CLASS(+)) T2,
       (SELECT C.USER_ID,
               R1.MON_FEE   FLUX_MON_FEE,
               R1.PKG_VALUE FLUX_M,
               R2.MON_FEE   VOICE_MON_FEE,
               R2.PKG_VALUE CALL_DURA
          FROM (SELECT *
                  FROM ZBG_DWA.DWA_V_M_CUS_CB_DIY_PACKAGE_011@LINK_DSSDWE
                 WHERE SERVICE_TYPE = '40AAAAAA'
                   AND MONTH_ID = '201505') C,
               ZBG_DIM.DIM_CBSS_DISCNT_CODE@LINK_DSSDWE R1,
               ZBG_DIM.DIM_CBSS_DISCNT_CODE@LINK_DSSDWE R2
         WHERE C.FLUX_PKG = R1.DISCNT_CODE(+)
           AND C.VOICE_PKG = R2.DISCNT_CODE(+)) T3 --DIY
 WHERE T1.PRODUCT_CLASS = T2.PRODUCT_CLASS(+)
   AND T1.USER_ID = T3.USER_ID(+)
4G套外流量收入
用户使用套餐外流量产生的收入
SELECT USER_ID,
       TOTAL_FEE, --总收入
       MOBILE_NET_FEE --套外流量收入
  FROM ZBG_DWA.DWA_V_M_CUS_CB_CHARGE_011@LINK_DSSDWE T
 WHERE MONTH_ID = '201505'
4G语音总收入
用户使用语音产生的收入。包括套内收入和套外收入
SELECT SUM(CASE
             WHEN SUBSTR(T2.DIM_1, 1, 4) = '0301' THEN
              NVL(T4.OUT_CALL_FEE, 0) + NVL(T3.VOICE_MON_FEE, 0) * 0.8 --全国组合语音打八折
             WHEN T2.DIM_1 LIKE '03%' THEN
              NVL(T4.OUT_CALL_FEE, 0) + NVL(T3.VOICE_MON_FEE, 0)
             ELSE
              NVL(T4.OUT_CALL_FEE, 0) + NVL(T2.VOICE_MON_FEE, 0)
           END)
  FROM (SELECT *
          FROM ZBG_DWA.DWA_V_M_CUS_CB_USER_INFO_011@LINK_DSSDWE T
         WHERE IS_STAT = '1'
           AND IS_CARD = '0'
           AND SERVICE_TYPE = '40AAAAAA'
           AND MONTH_ID = '201505') T1,
       (SELECT C.PRODUCT_CLASS,
               C.DIM_1,
               R.CALL_DURA,
               R.FLUX_M,
               C.MON_FEE       PROD_MON_FEE,
               F.MON_FEE,
               F.CALL_FTFEE    VOICE_MON_FEE,
               F.FLUX_FTFEE    FLUX_MON_FEE
          FROM ZBG_DIM.DIM_PRODUCT_CLASS@LINK_DSSDWE C,
               ZBG_DIM.DIM_PRODUCT_VALUE@LINK_DSSDWE R,
               TEMP_4G_PRODUCT_FTFEE                 F
         WHERE C.SERVICE_TYPE = '40AAAAAA'
           AND C.IS_CBSS = '1'
           AND C.PRODUCT_CLASSIFY_VALUE = R.PRODUCT_CLASS(+)
           AND C.PRODUCT_CLASS = F.PRODUCT_CLASS(+)) T2,
       (SELECT C.USER_ID,
               R1.MON_FEE   FLUX_MON_FEE,
               R1.PKG_VALUE FLUX_M,
               R2.MON_FEE   VOICE_MON_FEE,
               R2.PKG_VALUE CALL_DURA
          FROM (SELECT *
                  FROM ZBG_DWA.DWA_V_M_CUS_CB_DIY_PACKAGE_011@LINK_DSSDWE
                 WHERE SERVICE_TYPE = '40AAAAAA'
                   AND MONTH_ID = '201505') C,
               ZBG_DIM.DIM_CBSS_DISCNT_CODE@LINK_DSSDWE R1,
               ZBG_DIM.DIM_CBSS_DISCNT_CODE@LINK_DSSDWE R2
         WHERE C.FLUX_PKG = R1.DISCNT_CODE(+)
           AND C.VOICE_PKG = R2.DISCNT_CODE(+)) T3,
       (SELECT USER_ID,
               TOTAL_FEE, --总收入
               NVL(T.BASE_CALL_FEE, 0) + NVL(T.PROV_LONG_FEE, 0) +
               NVL(T.COUN_LONG_LFEE, 0) + NVL(T.INTER_LONG_LFEE, 0) +
               NVL(T.GAT_LONG_LFEE, 0) + NVL(T.COUN_ROAM_BFEE, 0) +
               NVL(T.INTER_ROAM_BFEE, 0) + NVL(T.GAT_RAOM_BFEE, 0) +
               NVL(T.OTHER_CALL_LFEE, 0) + NVL(T.VP_FEE, 0) OUT_CALL_FEE, --套外语音收入
               MOBILE_NET_FEE --套外流量收入
          FROM ZBG_DWA.DWA_V_M_CUS_CB_CHARGE_011@LINK_DSSDWE T
         WHERE MONTH_ID = '201505') T4
 WHERE T1.PRODUCT_CLASS = T2.PRODUCT_CLASS(+)
   AND T1.USER_ID = T3.USER_ID(+)
   AND T1.USER_ID = T4.USER_ID(+)

4G套内语音收入
用户套餐包分摊的收入
SELECT SUM(CASE
             WHEN SUBSTR(T2.DIM_1, 1, 4) = '0301' THEN
              NVL(T3.VOICE_MON_FEE, 0) * 0.8 --全国组合语音打八折
             WHEN T2.DIM_1 LIKE '03%' THEN
              NVL(T3.VOICE_MON_FEE, 0)
             ELSE
              NVL(T2.VOICE_MON_FEE, 0)
           END)
  FROM (SELECT *
          FROM ZBG_DWA.DWA_V_M_CUS_CB_USER_INFO_011@LINK_DSSDWE T
         WHERE IS_STAT = '1'
           AND IS_CARD = '0'
           AND SERVICE_TYPE = '40AAAAAA'
           AND MONTH_ID = '201505') T1,
       (SELECT C.PRODUCT_CLASS,
               C.DIM_1,
               R.CALL_DURA,
               R.FLUX_M,
               C.MON_FEE       PROD_MON_FEE,
               F.MON_FEE,
               F.CALL_FTFEE    VOICE_MON_FEE,
               F.FLUX_FTFEE    FLUX_MON_FEE
          FROM ZBG_DIM.DIM_PRODUCT_CLASS@LINK_DSSDWE C,
               ZBG_DIM.DIM_PRODUCT_VALUE@LINK_DSSDWE R,
               TEMP_4G_PRODUCT_FTFEE                 F
         WHERE C.SERVICE_TYPE = '40AAAAAA'
           AND C.IS_CBSS = '1'
           AND C.PRODUCT_CLASSIFY_VALUE = R.PRODUCT_CLASS(+)
           AND C.PRODUCT_CLASS = F.PRODUCT_CLASS(+)) T2,
       (SELECT C.USER_ID,
               R1.MON_FEE   FLUX_MON_FEE,
               R1.PKG_VALUE FLUX_M,
               R2.MON_FEE   VOICE_MON_FEE,
               R2.PKG_VALUE CALL_DURA
          FROM (SELECT *
                  FROM ZBG_DWA.DWA_V_M_CUS_CB_DIY_PACKAGE_011@LINK_DSSDWE
                 WHERE SERVICE_TYPE = '40AAAAAA'
                   AND MONTH_ID = '201505') C,
               ZBG_DIM.DIM_CBSS_DISCNT_CODE@LINK_DSSDWE R1,
               ZBG_DIM.DIM_CBSS_DISCNT_CODE@LINK_DSSDWE R2
         WHERE C.FLUX_PKG = R1.DISCNT_CODE(+)
           AND C.VOICE_PKG = R2.DISCNT_CODE(+)) T3
 WHERE T1.PRODUCT_CLASS = T2.PRODUCT_CLASS(+)
   AND T1.USER_ID = T3.USER_ID(+)
4G套外语音收入
用户使用套餐外语音产生的收入
SELECT USER_ID,
       TOTAL_FEE, --总收入
       NVL(T.BASE_CALL_FEE, 0) + NVL(T.PROV_LONG_FEE, 0) +
       NVL(T.COUN_LONG_LFEE, 0) + NVL(T.INTER_LONG_LFEE, 0) +
       NVL(T.GAT_LONG_LFEE, 0) + NVL(T.COUN_ROAM_BFEE, 0) +
       NVL(T.INTER_ROAM_BFEE, 0) + NVL(T.GAT_RAOM_BFEE, 0) +
       NVL(T.OTHER_CALL_LFEE, 0) + NVL(T.VP_FEE, 0) OUT_CALL_FEE --套外语音收入
       FROM ZBG_DWA.DWA_V_M_CUS_CB_CHARGE_011@LINK_DSSDWE T
 WHERE MONTH_ID = '201505'
DM层4G套餐用户计费收入
注意: 
1. 以全国组合套餐为例，目前只具备201501账期之后数据，使用之前先确认账期数据是否被删除。
2. 该表只能区分套餐，及渠道类型。

SELECT /*+PARALLEL(A,40)*/
 MONTH_ID,
 PROV_ID,
 A.PRODUCT_CLASS,
 PRODUCT_CLASS_DESC,
 CHANNEL_TYPE,
 SUM(TOTAL_FEE)
  FROM ZBG_DM.DM_C_D_INC_CB_CHARGE@LINK_DSSDWE A,
       (SELECT T1.PRODUCT_CLASS, T1.PRODUCT_CLASS_DESC
          FROM ZBG_DIM.DIM_PRODUCT_CLASS@LINK_DSSDWE T1
         WHERE SERVICE_TYPE = '40AAAAAA'
           AND IS_CBSS = '1'
           AND DIM_1 LIKE '0301%') B
 WHERE MONTH_ID BETWEEN '201501' AND '201510'
   AND SERVICE_TYPE = '40AAAAAA'
   AND A.PRODUCT_CLASS = B.PRODUCT_CLASS
 GROUP BY MONTH_ID, PROV_ID, A.PRODUCT_CLASS, PRODUCT_CLASS_DESC, CHANNEL_TYPE
 ORDER BY MONTH_ID, PROV_ID, A.PRODUCT_CLASS, PRODUCT_CLASS_DESC, CHANNEL_TYPE;
上网卡
维度
指标
3G套餐
公共部分（3G手机、23G融合、3G上网卡通用）
指标
出账收入表
    根据业务部门的要求从201401月开始所有的出账收入都采用融合分摊后账单，以后不再有分摊前和分摊后账单，请各位在提数的时候特别注意！
最新融合分摊后账单说明：
1、接口数据来源： 
4.6.1.13 明细帐单（融合分摊）   ZB_SRC.ZB_M_BIDWAL06013_010 
2、DWD账单表：ZBA_DWD.DWD_M_ACC_AL_RH_CHARGE_010
3、DWA汇总表：
ZBA_DWA.DWA_S_M_ACC_AL_RH_SCHARGE_XXX    融合分摊后账单汇总表（全业务）。
ZBA_DWA.DWA_S_M_ACC_BB_RH_CHARGE_XXX      宽带帐单明细汇总信息（融合-月） 
ZBA_DWA.DWA_S_M_ACC_FX_RH_CHARGE_XXX      固话帐单明细汇总信息（融合-月） 
4、DWA单用户衍生表：
1）、DWA_V_M_CUS_FX_RH_SCHARGE_010  融合分摊后账单，固话单用户收入表      ---同之前所用的ZBA_DWA.DWA_V_M_CUS_FX_BCHARGE_010 结构保持一致
  2）、DWA_V_M_CUS_BB_RH_SCHARGE_010     融合分摊后账单，宽带单用户收入表     --- 同之前所用ZBA_DWA.DWA_DS_M_ACC_CHARGE 结构保持一致。
  3）、DWA_V_M_CUS_MB_RH_SCHARGE_010     融合分摊后账单，移动业务单用户收入表     ---同之前所用的ZBA_DWA.DWA_V_M_CUS_MB_BCHARGE_010 结构保持一致。
注意：
 ZBA_DWA.DWA_V_M_CUS_BB_RH_CHARGE_010  融合分摊后账单，宽带单用户收入表， 管理处口径
 ZBA_DWA.DWA_V_M_CUS_FX_RH_CHARGE_010 融合分摊后账单，固话单用户收入表,管理处口径
     管理处口径说明：管理处针对总部的费用项按照收入管理目录进行归类，费用归类码表：ZB_DIM.DIM_BI_CHARGE_CODE_NEW 。宽带业务取：BB_LEVEL_ITEM ，固话业务取：FX_LEVEL_ITEM 。
正常出账费用
SELECT USER_ID,NOMAL_TOTAL_FEE
          FROM ZBA_DWA.DWA_V_M_CUS_MB_RH_SCHARGE_'||V_PROV_ID||'
         WHERE MONTH_ID = '''||V_MONTH_ID||'''
欠费金额
欠费金数据均采用“中国联通总部与省分数据分析系统纵向数据接口规范” 中的“欠费明细帐单(财务取数时间点)06009”。具体口径是：属于财务上报范围，用户不包括测试用户，正常欠费账单。
具体口径为：
SELECT OWE_FEE
  FROM ZB_OUT.DM_KPI_AL_OWE_FINANCE A
 WHERE A.INSTANCE_TYPE <> '03'
   AND A.FIN_FLAG = '1'
   AND A.OWE_STATUS = '01'
   AND MONTH_ID = '201409'
   AND OWE_MONTH = '201406'
区分业务类型 增加SERVICE_TYPE的限制：
2G：SERVICE_TYPE IN ('20AAAAAA','2001AAAA','200101AA','200102AA','2002AAAA','2099AAAA')
3G: SERVICE_TYPE='30AAAAAA'
固网业务：SERVICE_TYPE NOT IN ('20AAAAAA','2001AAAA','200101AA','200102AA','2002AAAA','2099AAAA','30AAAAAA')
 区分客户群 增加CUST_KIND限制：
      公众客户：CUST_KIND = '01'
      大客户：CUST_KIND = '21'
 注意：
业务类型，客户类别均是取自欠费表中的相关字段，并未关联用户资料表。使用欠费表中的相关字段的原因是因为历史遗留问题较多，省份对欠费用户单独打的标记
逾期欠费
SELECT /*+PARALLEL(T,4)*/
 SUBS_INSTANCE_ID, SUM(OWE_FEE) OWE_FEE
  FROM ZBA_DWD.DWD_M_ACC_AL_OWE_FINACE_011 T
 WHERE OWE_STATUS = '01' --欠费账单状态
   AND FIN_FLAG = '1' --财务数据标识
   AND OWE_MONTH < '201605'
   AND MONTH_ID = '201605'
 GROUP BY SUBS_INSTANCE_ID
HAVING SUM(OWE_FEE) > 0


3G 缴费：存在用户当月缴费多次，多条记录，注意使用
SELECT *
  FROM ZB_DWD.DWD_M_ACC_AL_PAY_LOG_079 C
 WHERE C.MONTH_ID = '201508'
   AND C.PAY_OPR_TYPE = '01'; --储值操作类型为“01 储值”
3G用户缴费次数及缴费金额
SELECT T1.USER_ID,
       CASE WHEN T3.USER_ID IS NOT NULL THEN T3.PAY_METHOD
            WHEN T4.ACCT_ID IS NOT NULL THEN T4.PAY_METHOD
            ELSE '本月无缴费'
       END PAY_METHOD,
       SUM(NVL(T3.PAY_NUM, NVL(T4.PAY_NUM, 0))) PAY_NUM,--优先通过USER_ID关联，其次通过ACCOUT_ID关联
       SUM(NVL(T3.PAY_FEE, NVL(T4.PAY_FEE, 0))) PAY_FEE
  FROM (SELECT A.USER_ID, A.ACCOUNT_ID
          FROM ZBA_DWA.DWA_V_M_CUS_3G_USER_INFO_010 A
         WHERE A.MONTH_ID = '201508'
           AND A.IS_STAT = '1'
           AND A.IS_THIS_ACCT = '1'
           ) T1,
       (SELECT C.USER_ID,
               C.PAY_METHOD,--缴费方式
                            --参见ZB_DIM.DIM_BI_PAY_METHOD，或纵向明细接口规范《7.37  缴费方式》（SVN地址：http://132.35.224.234/svn/dssdat/ZBJF_接口规范/04-纵向明细规范/纵向明细/中国联通总部与省分数据分析系统纵向数据接口规范_20150525(实施稿).doc）
               
               COUNT(1) PAY_NUM,
               SUM(C.PAY_FEE) PAY_FEE
          FROM ZB_DWD.DWD_M_ACC_AL_PAY_LOG_010 C --不是单用户表，注意聚合
         WHERE C.MONTH_ID = '201508'
           AND C.PAY_OPR_TYPE = '01' --储值操作类型为“01 储值”（必加条件）
                                     --参见ZB_DIM.DIM_BI_PAY_OPR_TYPE，或纵向明细接口规范《7.38  储值操作类型》（SVN地址：http://132.35.224.234/svn/dssdat/ZBJF_接口规范/04-纵向明细规范/纵向明细/中国联通总部与省分数据分析系统纵向数据接口规范_20150525(实施稿).doc）
         GROUP BY C.USER_ID, C.PAY_METHOD) T3,
       (SELECT D.ACCT_ID,
               D.PAY_METHOD,
               COUNT(1) PAY_NUM,
               SUM(D.PAY_FEE) PAY_FEE
          FROM ZB_DWD.DWD_M_ACC_AL_PAY_LOG_010 D--不是单用户表，注意聚合
         WHERE D.MONTH_ID = '201508'
           AND D.PAY_OPR_TYPE = '01' --储值操作类型为“01 储值”（必加条件）
         GROUP BY D.ACCT_ID, D.PAY_METHOD) T4
 WHERE T1.USER_ID = T3.USER_ID(+)
   AND T1.ACCOUNT_ID = T4.ACCT_ID(+)
 GROUP BY T1.USER_ID,
       CASE WHEN T3.USER_ID IS NOT NULL THEN T3.PAY_METHOD
            WHEN T4.ACCT_ID IS NOT NULL THEN T4.PAY_METHOD
            ELSE '本月无缴费'
       END;
3G账户余额
SELECT USER_ID,
       NVL(T_BALANCE1.BALANCE_FEE,NVL(T_BALANCE2.BALANCE_FEE,0)) BALANCE_FEE
  FROM (SELECT T.USER_ID, T.IS_CARD,T.DEVICE_NUMBER, T.PRODUCT_MODE, T.ACCOUNT_ID,T.CUST_ID,T.AREA_ID
          FROM ZBA_DWA.DWA_V_M_CUS_3G_USER_INFO_011 T
         WHERE MONTH_ID = '201606'
           AND IS_STAT = '1'
           AND IS_THIS_ACCT = '1') T,
      (SELECT SUBS_INSTANCE_ID USER_ID,SUM(BALANCE_FEE) BALANCE_FEE
         FROM ZB_DWD.DWD_M_ACC_AL_ACCT_BALANCE_011--可根据需要增加账本类型限制：ACCT_BALANCE_TYPE,参考 SELECT * FROM ZB_DIM.DIM_BI_PAY_BALANCE_TYPE
        WHERE MONTH_ID = '201606'--注意，BEGIN_DATE END_DATE大部分省是空值
        GROUP BY SUBS_INSTANCE_ID

        )T_BALANCE1,
      (SELECT ACCT_ID ,SUM(BALANCE_FEE) BALANCE_FEE
         FROM ZB_DWD.DWD_M_ACC_AL_ACCT_BALANCE_011--可根据需要增加账本类型限制：ACCT_BALANCE_TYPE,参考 SELECT * FROM ZB_DIM.DIM_BI_PAY_BALANCE_TYPE

        WHERE MONTH_ID = '201606'--注意，BEGIN_DATE END_DATE大部分省是空值
        GROUP BY ACCT_ID
        )T_BALANCE2
 WHERE T.USER_ID=T_BALANCE1.USER_ID(+)
   AND T.ACCOUNT_ID=T_BALANCE2.ACCT_ID(+)
3G手机
维度
指标
套外语音收入
IF(V_MONTH_ID > '201312') THEN
      V_BCHARGE_TABLE := 'SELECT USER_ID , TOTAL_FEE,MOBILE_NET_FEE,NVL(BASE_CALL_FEE, 0) + NVL(PROV_LONG_FEE, 0) +
                                                         NVL(COUN_LONG_LFEE, 0) + NVL(INTER_LONG_LFEE, 0) +
                                                         NVL(GAT_LONG_LFEE, 0) + NVL(COUN_ROAM_BFEE, 0) +
                                                         NVL(INTER_ROAM_BFEE, 0) + NVL(GAT_RAOM_BFEE, 0) +
                                                         NVL(OTHER_CALL_LFEE, 0) + NVL(VP_FEE, 0) OUT_CALL_FEE
                            FROM ZBA_DWA.DWA_V_M_CUS_MB_RH_SCHARGE_010
                           WHERE MONTH_ID = '''||V_MONTH_ID||'''
                          ';
  ELSE
      V_BCHARGE_TABLE := 'SELECT SUBS_INSTANCE_ID USER_ID, TOTAL_FEE,MOBILE_NET_FEE,
                                                   NVL(BASE_CALL_FEE, 0) + NVL(PROV_LONG_FEE, 0) +
                                                   NVL(COUN_LONG_LFEE, 0) + NVL(INTER_LONG_LFEE, 0) +
                                                    NVL(GAT_LONG_LFEE, 0) + NVL(COUN_ROAM_BFEE, 0) +
                                                    NVL(INTER_ROAM_BFEE, 0) + NVL(GAT_RAOM_BFEE, 0) +
                                                      NVL(OTHER_CALL_LFEE, 0) + NVL(VP_FEE, 0) OUT_CALL_FEE
                            FROM ZBA_DWA.DWA_V_M_CUS_MB_BCHARGE_010
                           WHERE MONTH_ID = '''||V_MONTH_ID||'''
                          ';
  END IF;


套外流量收入（包含流量包收入）
SELECT SUM(NVL(C.MOBILE_NET_FEE, 0)) MOBILE_NET_FEE --套外流量收入（包含流量包收入）
         FROM ZBA_DWA.DWA_V_M_CUS_MB_RH_SCHARGE_011
         WHERE MONTH_ID = '201506'

套餐内语音分摊收入
SELECT SUM(CASE
             WHEN M.CALL_DURA = 0 OR M.CALL_DURA IS NULL THEN
              0
             WHEN M.CALL_DURA > 0 THEN
              NVL(M.CALL_FTFEE, 0)
             ELSE
              0
           END) CALL_FTFEE --套餐内语音分摊收入(其它无法归类的3G手机套餐、3G-20 元预付费套餐、3G手机标准资费、36元/月数据套餐 、关联不到的)
  FROM (SELECT USER_ID,
               PRODUCT_MODE,
               CASE
                 WHEN PKG_PROD_CLASS = '0201' THEN
                  100
                 WHEN PKG_PROD_CLASS = '0202' THEN
                  300
                 WHEN PKG_PROD_CLASS = '0203' THEN
                  500
                 ELSE
                  0
               END CONT_FLUX, --流量包
               USER_ACT_TYPE,
               IS_THIS_ACCT,
               PKG_PROD_CLASS
          FROM ZBA_DWA.DWA_V_M_CUS_3G_USER_INFO_011 T
         WHERE IS_STAT = '1'
           AND IS_CARD = '0'
           AND MONTH_ID = '201505'
           AND IS_THIS_ACCT = '1') A, --当月出账
       (SELECT H.PRODUCT_CLASS,
               J.PRODUCT_CLASS_DESC,
               J.PRODUCT_BASE_CLASS,
               R.MON_FEE,
               R.PRODUCT_CLASS RATE_CLASS,
               R.CALL_DURA,
               R.FLUX_M,
               T.FLUX_FTFEE,
               T.CALL_FTFEE,
               J.PRODUCT_CLASSIFY_VALUE
          FROM (SELECT *
                  FROM ZB_DIM.DIM_PRODUCT_CLASS
                 WHERE SERVICE_TYPE = '30AAAAAA'
                   AND IS_CARD = '0') H,
               (SELECT *
                  FROM ZB_DIM.DIM_PRODUCT_CLASS
                 WHERE SERVICE_TYPE = '30AAAAAA'
                   AND IS_CARD = '0') J,
               ZB_DIM.DIM_PRODUCT_RATE R,
               TEMP_3G_AL_PRODUCT_FTFEE T
         WHERE H.PRODUCT_CLASSIFY_VALUE = J.PRODUCT_CLASS(+)
           AND J.PRODUCT_CLASSIFY_VALUE = '02' || R.PRODUCT_CLASS(+)
           AND H.PRODUCT_CLASS = T.PRODUCT_CLASS(+)) M
 WHERE A.PRODUCT_MODE = M.PRODUCT_CLASS(+)

套外语音收入
IF(V_MONTH_ID > '201312') THEN
      V_BCHARGE_TABLE := 
      'SELECT USER_ID,
       TOTAL_FEE,
       MOBILE_NET_FEE,
       NVL(BASE_CALL_FEE, 0) + NVL(PROV_LONG_FEE, 0) +
       NVL(COUN_LONG_LFEE, 0) + NVL(INTER_LONG_LFEE, 0) +
       NVL(GAT_LONG_LFEE, 0) + NVL(COUN_ROAM_BFEE, 0) +
       NVL(INTER_ROAM_BFEE, 0) + NVL(GAT_RAOM_BFEE, 0) +
       NVL(OTHER_CALL_LFEE, 0) + NVL(VP_FEE, 0) OUT_CALL_FEE
  FROM ZBA_DWA.DWA_V_M_CUS_MB_RH_SCHARGE_'||V_PROV_ID||'
    WHERE MONTH_ID = '''||V_MONTH_ID||'''
         ';
  ELSE
      V_BCHARGE_TABLE := '
      SELECT SUBS_INSTANCE_ID USER_ID,
       TOTAL_FEE,
       MOBILE_NET_FEE,
       NVL(BASE_CALL_FEE, 0) + NVL(PROV_LONG_FEE, 0) +
       NVL(COUN_LONG_LFEE, 0) + NVL(INTER_LONG_LFEE, 0) +
       NVL(GAT_LONG_LFEE, 0) + NVL(COUN_ROAM_BFEE, 0) +
       NVL(INTER_ROAM_BFEE, 0) + NVL(GAT_RAOM_BFEE, 0) +
       NVL(OTHER_CALL_LFEE, 0) + NVL(VP_FEE, 0) OUT_CALL_FEE
  FROM ZBA_DWA.DWA_V_M_CUS_MB_BCHARGE_'||V_PROV_ID||'
    WHERE MONTH_ID = '''||V_MONTH_ID||'''
                          ';
  END IF;

增值业务出账收入
页面核对路径：报表中心—基础报表--3G手机业务收入月报： CZSR0011：增值业务出账收入。页面口径如下： 
SELECT SUM(VAS_FEE + FLUX_FEE + FUNCTION_FEE + OT_FIX_FEE)
  FROM ZBA_DMA.DM_C_M_INC_3G_CHARGE  --16库
 WHERE MONTH_ID = '201509'
   AND IS_CARD = '0'
224库对应表：ZBA_DM.DM_C_M_INC_3G_CHARGE 过程：P_DM_C_M_INC_3G_CHARGE
与收入表ZBA_DWA.DWA_V_M_CUS_MB_RH_SCHARGE_对应字段：
VAS_FEE --->增值业务费：
NVL(SUM(P2P_FEE) ,0)+ NVL(SUM( LTZX_FEE ),0)+ NVL(SUM( RBT_FEE ) ,0)+ NVL(SUM( NICAM_FEE ) ,0) + SUM(NVL(OTHER_INCR_FEE,0)) 
              +  SUM(MMS_FEE)+SUM(INFO_MMS_FEE)+ SUM(MOBILE_NET_FEE)+ SUM(MOBILE_TV_FEE)+SUM(MOBILE_PAPER_FEE)+ 
              SUM(MOBILE_MUSIC_FEE)+SUM(MOBILE_EMAIL_FEE)+ SUM(INSTANT_MESSAGE_FEE)+SUM(MOBILE_SEARCH_FEE+WIDEBRAND_FEE +OTHER_NET_FEE)
FLUX_FEE --->上网费：
SUM(OTHER_INTERNET_FEE+ WIRLESS_CARD_FEE+ WLAN_FEE )
FUNCTION_FEE --->->功能费：
SUM(NVL(FUNCATION_RENT_FEE,0) ) +SUM(NVL(FUNCATION_FEE,0))
OT_FIX_FEE --->->其他固定费：
SUM(NVL(OTHER_RENT_FEE ,0))

23G融合套餐
维度
指标
总流量收入=套内流量收入+套外流量收入
SELECT USER_ID,
       NVL(T3.MON_FEE, NVL(T4.MON_FEE, 0)) + NVL(T2. MOBILE_NET_FEE, 0)
  FROM (SELECT USER_ID, PRODUCT_MODE, PKG_PROD_CLASS
          FROM ZBA_DWA.DWA_V_M_CUS_3G_USER_INFO_011
         WHERE MONTH_ID = '201410'
           AND IS_STAT = '1'
           AND IS_CARD = '2') T1,
       (SELECT SUBS_INSTANCE_ID, MOBILE_NET_FEE
          FROM ZBA_DWA.DWA_V_M_CUS_MB_BCHARGE_011
         WHERE MONTH_ID = '201410') T2,
       (SELECT *
          FROM TEMP_DX_3G_PKG_PROD_CLASS
         WHERE IS_CARD = '2'
           AND IS_PKG = '1') T3,
       (SELECT *
          FROM TEMP_DX_3G_PKG_PROD_CLASS
         WHERE IS_CARD = '2'
           AND IS_PKG = '0') T4
 WHERE T1.USER_ID = T2. SUBS_INSTANCE_ID(+)
   AND T1.PKG_PROD_CLASS = T3.PRODUCT_CLASS(+)
   AND T1.PRODUCT_MODE = T4.PRODUCT_CLASS(+)
套外语音收入
IF V_MONTH < '201401' THEN
   V_CHARGE_TABLE:='SELECT SUBS_INSTANCE_ID USER_ID,
   NVL(TOTAL_FEE, 0) TOTAL_FEE,
                 NVL(T.BASE_CALL_FEE, 0) + NVL(T.PROV_LONG_FEE, 0) +
                 NVL(T.COUN_LONG_LFEE, 0) + NVL(T.INTER_LONG_LFEE, 0) +
                 NVL(T.GAT_LONG_LFEE, 0) + NVL(T.COUN_ROAM_BFEE, 0) +
                 NVL(T.INTER_ROAM_BFEE, 0) + NVL(T.GAT_RAOM_BFEE, 0) +
                 NVL(T.OTHER_CALL_LFEE, 0) + NVL(T.VP_FEE, 0) OUT_CALL_FEE, --套外语音收入
                  NVL(T.BASE_CALL_FEE, 0) +
                 NVL(T.COUN_LONG_LFEE, 0) + NVL(T.INTER_LONG_LFEE, 0) +
                 NVL(T.GAT_LONG_LFEE, 0) + NVL(T.COUN_ROAM_BFEE, 0) +
                 NVL(T.INTER_ROAM_BFEE, 0) + NVL(T.GAT_RAOM_BFEE, 0) +
                 NVL(T.OTHER_CALL_LFEE, 0) + NVL(T.VP_FEE, 0) OUT_CALL_FEENOTPROV, --语音收入(不包含省际) 
          FROM ZBA_DWA.DWA_V_M_CUS_MB_BCHARGE_'||V_PROV||' T
         WHERE MONTH_ID = '''||V_MONTH||'''';
  ELSE

    V_CHARGE_TABLE :='SELECT  USER_ID, NVL(TOTAL_FEE, 0) TOTAL_FEE,
                 NVL(T.BASE_CALL_FEE, 0) + NVL(T.PROV_LONG_FEE, 0) +
                 NVL(T.COUN_LONG_LFEE, 0) + NVL(T.INTER_LONG_LFEE, 0) +
                 NVL(T.GAT_LONG_LFEE, 0) + NVL(T.COUN_ROAM_BFEE, 0) +
                 NVL(T.INTER_ROAM_BFEE, 0) + NVL(T.GAT_RAOM_BFEE, 0) +
                 NVL(T.OTHER_CALL_LFEE, 0) + NVL(T.VP_FEE, 0) OUT_CALL_FEE, -- 套外语音收入 
                 NVL(T.BASE_CALL_FEE, 0) +
                 NVL(T.COUN_LONG_LFEE, 0) + NVL(T.INTER_LONG_LFEE, 0) +
                 NVL(T.GAT_LONG_LFEE, 0) + NVL(T.COUN_ROAM_BFEE, 0) +
                 NVL(T.INTER_ROAM_BFEE, 0) + NVL(T.GAT_RAOM_BFEE, 0) +
                 NVL(T.OTHER_CALL_LFEE, 0) + NVL(T.VP_FEE, 0) OUT_CALL_FEENOTPROV --语音收入(不包含省级)
             FROM ZBA_DWA.DWA_V_M_CUS_MB_RH_SCHARGE_'||V_PROV||' T
         WHERE MONTH_ID = '''||V_MONTH||''' '; --2014年
   END IF;
3G上网卡
维度
指标
OCS上网卡
维度
指标
出账收入
SELECT SUM(TOTAL_FEE)
  FROM ZBA_DWA.DWA_V_M_CUS_OCS_USER_INFO
 WHERE MONTH_ID = '201505'
   AND PROV_ID = '011'
   AND STATUS_ID NOT IN ('51', '13')
   AND IS_TEST = '0'

2G套餐
维度
指标
正常出账费用
SELECT /*+PARALLEL(A,4)(B,4)*/
 A.AREA_ID, '2G', SUM(B.NOMAL_TOTAL_FEE)
  FROM (SELECT *
          FROM ZBA_DWA.DWA_V_M_CUS_2G_USER_INFO_011 T
         WHERE IS_STAT = '1'
           AND MONTH_ID = '201505') A,
       (SELECT USER_ID, NOMAL_TOTAL_FEE
          FROM ZBA_DWA.DWA_V_M_CUS_MB_RH_SCHARGE_011
         WHERE MONTH_ID = '201505') B
 WHERE A.USER_ID = B.USER_ID(+)
 GROUP BY A.AREA_ID
总流量收入（与页面一致）
路径：报表中心基础报表统一报表月报2G业务2G业务收入月报
IF V_MONTH < '201401' THEN
   V_CHARGE_TABLE:='SELECT SUBS_INSTANCE_ID USER_ID,
                 NVL(MOBILE_NET_FEE, 0) FLUX_FEE 
            FROM ZBA_DWA.DWA_V_M_CUS_MB_BCHARGE_'||V_PROV||' T
         WHERE MONTH_ID = '''||V_MONTH||'''';
  ELSE

    V_CHARGE_TABLE :='SELECT  USER_ID, 
                 NVL(MOBILE_NET_FEE, 0) FLUX_FEE 
             FROM ZBA_DWA.DWA_V_M_CUS_MB_RH_SCHARGE_'||V_PROV||' T
         WHERE MONTH_ID = '''||V_MONTH||''' '; --2014年
   END IF;
语音收入
IF V_MONTH < '201401' THEN
   V_CHARGE_TABLE:='SELECT SUBS_INSTANCE_ID USER_ID,
                 NVL(T.BASE_CALL_FEE, 0) + NVL(T.PROV_LONG_FEE, 0) +
                 NVL(T.COUN_LONG_LFEE, 0) + NVL(T.INTER_LONG_LFEE, 0) +
                 NVL(T.GAT_LONG_LFEE, 0) + NVL(T.COUN_ROAM_BFEE, 0) +
                 NVL(T.INTER_ROAM_BFEE, 0) + NVL(T.GAT_RAOM_BFEE, 0) +
                 NVL(T.OTHER_CALL_LFEE, 0) + NVL(T.VP_FEE, 0) OUT_CALL_FEE --语音收入
                FROM ZBA_DWA.DWA_V_M_CUS_MB_BCHARGE_'||V_PROV||' T
         WHERE MONTH_ID = '''||V_MONTH||'''';
  ELSE

    V_CHARGE_TABLE :='SELECT  USER_ID, 
                 NVL(T.BASE_CALL_FEE, 0) + NVL(T.PROV_LONG_FEE, 0) +
                 NVL(T.COUN_LONG_LFEE, 0) + NVL(T.INTER_LONG_LFEE, 0) +
                 NVL(T.GAT_LONG_LFEE, 0) + NVL(T.COUN_ROAM_BFEE, 0) +
                 NVL(T.INTER_ROAM_BFEE, 0) + NVL(T.GAT_RAOM_BFEE, 0) +
                 NVL(T.OTHER_CALL_LFEE, 0) + NVL(T.VP_FEE, 0) OUT_CALL_FEE --语音收入 
            FROM ZBA_DWA.DWA_V_M_CUS_MB_RH_SCHARGE_'||V_PROV||' T
         WHERE MONTH_ID = '''||V_MONTH||''' '; --2014年
   END IF;
2G用户缴费次数及缴费金额
SELECT T1.USER_ID,
       CASE WHEN T3.USER_ID IS NOT NULL THEN T3.PAY_METHOD
            WHEN T4.ACCT_ID IS NOT NULL THEN T4.PAY_METHOD
            ELSE '本月无缴费'
       END PAY_METHOD,
       SUM(NVL(T3.PAY_NUM, NVL(T4.PAY_NUM, 0))) PAY_NUM,--优先通过USER_ID关联，其次通过ACCOUT_ID关联
       SUM(NVL(T3.PAY_FEE, NVL(T4.PAY_FEE, 0))) PAY_FEE
  FROM (SELECT A.USER_ID, A.ACCOUNT_ID
          FROM ZBA_DWA.DWA_V_M_CUS_2G_USER_INFO_010 A
         WHERE A.MONTH_ID = '201508'
           AND A.IS_STAT = '1'
           AND A.IS_THIS_ACCT = '1'
           ) T1,
       (SELECT C.USER_ID,
               C.PAY_METHOD,--缴费方式
                            --参见ZB_DIM.DIM_BI_PAY_METHOD，或纵向明细接口规范《7.37	缴费方式》（SVN地址：http://132.35.224.234/svn/dssdat/ZBJF_接口规范/04-纵向明细规范/纵向明细/中国联通总部与省分数据分析系统纵向数据接口规范_20150525(实施稿).doc）
               
               COUNT(1) PAY_NUM,
               SUM(C.PAY_FEE) PAY_FEE
          FROM ZB_DWD.DWD_M_ACC_AL_PAY_LOG_010 C --不是单用户表，注意聚合
         WHERE C.MONTH_ID = '201508'
           AND C.PAY_OPR_TYPE = '01' --储值操作类型为“01 储值”（必加条件）
                                     --参见ZB_DIM.DIM_BI_PAY_OPR_TYPE，或纵向明细接口规范《7.38  储值操作类型》（SVN地址：http://132.35.224.234/svn/dssdat/ZBJF_接口规范/04-纵向明细规范/纵向明细/中国联通总部与省分数据分析系统纵向数据接口规范_20150525(实施稿).doc）
         GROUP BY C.USER_ID, C.PAY_METHOD) T3,
       (SELECT D.ACCT_ID,
               D.PAY_METHOD,
               COUNT(1) PAY_NUM,
               SUM(D.PAY_FEE) PAY_FEE
          FROM ZB_DWD.DWD_M_ACC_AL_PAY_LOG_010 D--不是单用户表，注意聚合
         WHERE D.MONTH_ID = '201508'
           AND D.PAY_OPR_TYPE = '01' --储值操作类型为“01 储值”（必加条件）
         GROUP BY D.ACCT_ID, D.PAY_METHOD) T4
 WHERE T1.USER_ID = T3.USER_ID(+)
   AND T1.ACCOUNT_ID = T4.ACCT_ID(+)
 GROUP BY T1.USER_ID,
       CASE WHEN T3.USER_ID IS NOT NULL THEN T3.PAY_METHOD
            WHEN T4.ACCT_ID IS NOT NULL THEN T4.PAY_METHOD
            ELSE '本月无缴费'
       END;
2G账户余额
SELECT USER_ID,
       NVL(T_BALANCE1.BALANCE_FEE,NVL(T_BALANCE2.BALANCE_FEE,0)) BALANCE_FEE
  FROM (SELECT T.USER_ID, T.IS_CARD,T.DEVICE_NUMBER, T.PRODUCT_MODE, T.ACCOUNT_ID,T.CUST_ID,T.AREA_ID
          FROM ZBA_DWA.DWA_V_M_CUS_2G_USER_INFO_011 T--可根据需要增加账本类型限制：ACCT_BALANCE_TYPE,参考 SELECT * FROM ZB_DIM.DIM_BI_PAY_BALANCE_TYPE
         WHERE MONTH_ID = '201606'
           AND IS_STAT = '1'
           AND IS_THIS_ACCT = '1') T,
      (SELECT SUBS_INSTANCE_ID USER_ID,SUM(BALANCE_FEE) BALANCE_FEE
         FROM ZB_DWD.DWD_M_ACC_AL_ACCT_BALANCE_011--可根据需要增加账本类型限制：ACCT_BALANCE_TYPE,参考 SELECT * FROM ZB_DIM.DIM_BI_PAY_BALANCE_TYPE
        WHERE MONTH_ID = '201606'--注意，BEGIN_DATE END_DATE大部分省是空值
        GROUP BY SUBS_INSTANCE_ID

        )T_BALANCE1,
      (SELECT ACCT_ID ,SUM(BALANCE_FEE) BALANCE_FEE
         FROM ZB_DWD.DWD_M_ACC_AL_ACCT_BALANCE_011
        WHERE MONTH_ID = '201606'--注意，BEGIN_DATE END_DATE大部分省是空值
        GROUP BY ACCT_ID
        )T_BALANCE2
 WHERE T.USER_ID=T_BALANCE1.USER_ID(+)
   AND T.ACCOUNT_ID=T_BALANCE2.ACCT_ID(+)

按照网络分类
按照用户使用的网络进行分类，分为4G网络、3G网络、2G网络和无法识别的网络四种。
公共部分
注意：
无法识别网络用户包括两部分：
1. ZBG_DWA.DWA_V_M_CUS_NM_USER_INFO_&prov_id@LINK_DSSDWE中SERVICE_TYPE LIKE '90%'部分，该部分各维度取法详见“公共部分--维度（不含OCS上网卡）”部分；
2. 3GOCS无线上网卡部分，目前不能区分网络类型，直接归属为其他网络，该部分维度和指标取法详见“按照套餐分类—3G套餐—OCS上网卡”部分
维度
指标
收入表
SELECT A.USER_ID, NVL(A.TOTAL_FEE, 0) TOTAL_FEE --当月话费总额
  FROM ZBG_DWA.DWA_V_M_CUS_NM_CHARGE_&PROV_ID@LINK_DSSDWE A
 WHERE A.MONTH_ID = '&MONTH_ID';
物联网（1454、1457）
维度
指标
收入表
指标路径：移动业务月关注运营关注，物联网（1454、1457）出帐用户
SELECT *
  FROM ZBG_DWA.DWA_V_M_CUS_NM_WLW_CHARGE_011@LINK_DSSDWE
 WHERE MONTH_ID = '201606'
宽带业务
BSS侧
维度
指标
出账收入
201401账期及之后：
SELECT USER_ID, TOTAL_FEE
  FROM ZBA_DWA.DWA_V_M_CUS_BB_RH_SCHARGE_011
 WHERE MONTH_ID = '201401'
201401之前账期，不含201401：
SELECT USER_ID, TOTAL_FEE
  FROM ZBA_DWA.DWA_DS_M_ACC_CHARGE
 WHERE MONTH_ID = '201309'
   AND PROV_ID = '011'
出账收入DM层
    SELECT MONTH_ID, PROV_ID, SUM(TOT_CHARGE) TOTAL_FEE
           FROM ZBA_DM.DM_C_M_BI_BB_INFO—宽带
          WHERE MONTH_ID = '201410'
          GROUP BY MONTH_ID, PROV_ID
CBSS侧
该部分相关维度和指标取法详见“按照套餐分类—CBSS套餐—公共部分”
固话业务
BSS侧
维度
指标
出账收入
SELECT USER_ID, TOTAL_FEE
  FROM ZBA_DWA.DWA_V_M_CUS_FX_RH_CHARGE_011
 WHERE MONTH_ID = '201604'
出账收入DM层
 SELECT MONTH_ID, PROV_ID, SUM(TOTAL_FEE) TOTAL_FEE
           FROM ZBA_DM.DM_C_M_INC_FX_MANAGE_CHARGE—固定电话
          WHERE MONTH_ID = '201410'
            AND SUBSTR(SERVICE_TYPE, 1, 2) = '01'
            AND SUBSTR(SERVICE_TYPE, 1, 4) <> '0105'
          GROUP BY MONTH_ID, PROV_ID
出账收入(固网主营收入) DM层指标
与“报表中心-基础报表-月报-固网业务-固网收入月报”中“合计”一致
SELECT T2.PROV_DESC,
       SUM(CASE
             WHEN T1.MONTH_ID = '201410' THEN
              T1.TOTAL_FEE
             ELSE
              0
           END)
  FROM (SELECT PROV_ID, MONTH_NO MONTH_ID, SUM(KPI_VALUE) TOTAL_FEE
          FROM DM.DM_REP_M_GW_INCO_NEW_TZ T
         WHERE MONTH_NO IN ('201410')
           AND CITY_NO = '-1'
           AND KPI_CODE = '0506' --IN ('0001','0117','0173','0213','0266','0276','0288','0411','0436','0450','0479','0689','0491')
           GROUP BY PROV_ID, MONTH_NO
        ) T1,
       DIM_PROV T2
 WHERE T1.PROV_ID = T2.PROV_ID
 GROUP BY T2.PROV_DESC, T2.ORD_ID3
 ORDER BY T2.ORD_ID3
CBSS侧
该部分相关维度和指标取法详见“按照套餐分类—CBSS套餐—公共部分”
融合业务
首先要确定用户属于哪种套餐类型（2G/3G/4G），然后参见不同套餐相关指标的取法，取出对应的维度或指标信息
收入管理取数方法
--根据收入目录取对应的收入。因该模型中的收入目录编码都是最细的编码及对应的收入，所以当不能确定一个目录编码是不是最细的编码 而要取该编码的收入，需用LIKE,然后SUM所有的收入就可以。如下例：
SELECT '&MONTH_ID' MONTH_ID, '&PROV_ID' PROV_ID, INCOME_CODE, TOTAL_CHARGE
  FROM ZBA_ODS.ZB_M_ACC_AL_REV_SUMM_&PROV_ID
 WHERE MONTH_ID = '&MONTH_ID'
   AND INCOME_CODE LIKE 'B4020317P12010200%'

资源域
移动业务
按照套餐分类
按照用户使用的套餐进行分类
CBSS套餐
手机
维度
指标
上网卡
维度
指标
3G套餐
3G手机
维度
存费送机合约区分终端是否iphone
3G用户资料表(ZBA_DWA.DWA_V_M_CUS_3G_USER_INFO_)通过用户ID关联合约表（ZBA_DWA.DWA_V_M_CUS_3G_ACT_INFO）,之后合约表通过RES_MODE与ZBA_CODE.DIM_C_TERM_MODEL表的TERM_MODEL关联取
IPHONE 终端（term_type5为空的部分也为iPhone终端）：
SELECT *
  FROM ZBA_CODE.DIM_C_TERM_MODEL
 WHERE UPPER(DEVICE_MODEL_DESC) LIKE '%IPHONE%'
其中根据TERML_TYPE5可部分区分iphone型号，以'01','0105','0106','0107','0108'开头，TERML_TYPE5为空的根据DEVICE_MODEL_DESC可进行再次区分。其他为非iphone终端，另需要限制合约类型存费送机。
3G用户ID与IMSI的对应关系
主要工作在于用户ID与IMSI的对应关系，提供模型如下：
ZB_DWD.DWD_M_PRD_AL_USER_RES_省份 
具体结构为：
序号	中文名	字段名	类型(长度)	使用说明
1	订购实例标识	USER_ID	6	　
2	资源属性编码	RES_ATTR_CODE	2	01：IMSI
02：ICCID
3	资源属性值	RES_ATTR_VALUE	20	当资源属性编码为01时，资源属性值应该满足IMSI的标准格式。
当资源属性编码为02时，资源属性值应该满足ICCID的标准格式。
4	更新时间	UPDATE_DATE	20	　
5	省份	PROV_ID	20	　
6	账期	MONTH_ID	4	
 
SQL语句：
SELECT USER_ID, RES_ATTR_VALUE
  FROM ZB_DWD.DWD_M_PRD_AL_USER_RES_010 T
 WHERE MONTH_ID = '201406'
   AND RES_ATTR_CODE = '01'
注意：
User_id 与RES_ATTR_VALUE不是一一对应的关系，取update_time最晚的一条
不唯一是因为用户换sim卡了，所以一个用户对应了多个imsi
接口规范：纵向明细接口规范里的3.1.1.5	订购实例资源属性(日)
注:
ICCID：Integrate circuit card identity 集成电路卡识别码（固化在手机SIM卡中） ICCID为IC卡的唯一识别号码，共有20位数字组成。
IMSI： International Mobile SubscriberIdentification Number 国际移动用户识别码，是区别移动用户的标志，储存在SIM卡中，可用于区别移动用户的有效信息。其总长度不超过15位，同样使用0～9的数字。其中MCC是移动用户所属国家代号，占3位数字，中国的MCC规定为460；MNC是移动网号码，最多由两位数字组成，用于识别移动用户所归属的移动通信网；MSIN是移动用户识别码，用以识别某一移动通信网中的移动用户。例如开头是46000是中国移动用户，46001是联通用户，46003是电信用户。
一张SIM卡，里面有ICCID，也有IMSI。 ICCID是卡的标识，IMSI是用户的标识。
ICCID只是用来区别SIM卡，不作接入网络的鉴权认证。而IMSI在接入网络的时候，会到运营商的服务器中进行验证。
ICCID可以伪造，可以用一张空白多号卡，写入IMSI和KI，只要是经过破解的IMSI和KI，就可以接入网络，而ICCID可以任意20位数字。
iPhone手机在激活的时候，会把ICCID和IMSI一起发送到苹果服务器端进行验证。特别是有锁的手机，就使用IMSI来判断是否合法运营商，如果不合法，就无法激活。ICCID作为SIM卡标识，在激活的时候被记录下来，直到下次刷机，在服务端的记录都不会被改变。
以下是iPhone激活时发送到苹果服务器的部分验证数据
IntegratedCircuitCardIdentity
89011200000056767***
InternationalMobileEquipmentIdentity
990002252729***
InternationalMobileSubscriberIdentity
310120005676***
MobileEquipmentIdentifier
99000225272***
区分手机支撑网络类型
适用所有移动手机业务，2G,3G,4G
ZB_OUT.ZB_M_TAC_INFO里的NET_TYPE：
0-2G,1-3G,2-TD,3-FDD,4-同时支撑TD和FDD
是否IPHONE
适用所有移动手机业务，2G,3G,4G
ZB_OUT.ZB_M_TAC_INFO模型is_iphone字段
指标
3G裸机销售量
SELECT '&month_id',
       SUM(CASE WHEN IS_BACK = '1' THEN -1 ELSE 1 END), --销售量
  FROM ZBA_DWD.DWD_D_RES_3G_TERM_SALE_&prov_id--日增量表
 WHERE MONTH_ID = '&month_id'
   AND SALE_TYPE = '3'; --销售类型  1 存费送机 2 购机送费 3 裸机
3G裸机销售明细（剔除返销）
SELECT LJ_3G1.MONTH_ID,
       LJ_3G1.CHANNEL_TYPE,
       LJ_3G1.SALE_TYPE ACTIVITY_TYPE, --销售类型
       LJ_3G1.PURCHASE_PRICE MOB_COST_FEE, --手机成本价
       LJ_3G1.SALE_FEE TERMINAL_FEE, --终端款（销售金额）
       0 CON_PLAN_FEE, --合约计划总价
       SUBSTR(LJ_3G1.IMEI, 1, 8) IMEI_8,
       SUBSTR(LJ_3G1.
, 1, 14) IMEI_14,
       LJ_3G1.TERMINAL_ID,
       LJ_3G1.TERM_TYPE,
       NULL PRODUCT_ID
  FROM (SELECT A.*,
               ROW_NUMBER() OVER(PARTITION BY SUBSTR(IMEI, 1, 14) ORDER BY DAY_ID DESC NULLS LAST) RN
          FROM ZBA_DWD.DWD_D_RES_3G_TERM_SALE_&prov_id A--日增量表
         WHERE MONTH_ID = '&month_id'
           AND SALE_TYPE = '3' --销售类型  1 存费送机 2 购机送费 3 裸机
           AND IS_BACK = '0' --是否返销
           AND (CHANNEL_TYPE LIKE '10%' OR CHANNEL_TYPE LIKE '01%') --自有渠道
        ) LJ_3G1,
       (SELECT SUBSTR(IMEI, 1, 14) IMEI, --电子串号
               SUM(CASE WHEN IS_BACK = '1' THEN -1 ELSE 1 END) SALE_NUM --销售量
          FROM ZBA_DWD.DWD_D_RES_3G_TERM_SALE_&prov_id
         WHERE MONTH_ID = '&month_id'
           AND SALE_TYPE = '3' --裸机
         GROUP BY SUBSTR(IMEI, 1, 14)
        HAVING SUM(CASE WHEN IS_BACK = '1' THEN -1 ELSE 1 END) >= 1
       ) LJ_3G2
 WHERE LJ_3G1.RN = 1
   AND SUBSTR(LJ_3G1.IMEI, 1, 14) = LJ_3G2.IMEI;
23G融合套餐
维度
指标
3G上网卡
维度
指标
2G套餐
维度
指标
按照网络分类
按照用户使用的网络进行分类，分为4G网络、3G网络、2G网络和无法识别的网络四种。
相关维度和指标可根据用户的套餐类型（2G/3G/4G）分别按对应口径去取
宽带业务
BSS侧
维度
指标
CBSS侧
维度
指标
固话业务
BSS侧
维度
指标
CBSS侧
维度
指标
融合业务
首先要确定用户属于哪种套餐类型（2G/3G/4G），然后参见不同套餐相关指标的取法，取出对应的维度或指标信息
市场营销域
集客名单制
根据关键字求收入
ZB.ZB_INCO_M_MD_02的账期加CUSTOMER_NAME LIKE '%关键字%' 求
通讯收入： SUM(TX_TOTAL_INCOME)
固网业务收入SUM(NVL(GW_TOTAL_INCOME, 0))
移动业务收入：SUM(NVL(YD_TOTAL_INCOME, 0))
普通电话收入：SUM(NVL(NP_TOTAL_INCOME, 0)) 
CENTREX电话收入：SUM(NVL(CENTREX_TOTAL_INCOME, 0))
模拟中继线收入：SUM(NVL(SIMULATION_TRUNK_TOTAL_INCOME, 0))  
数字中继线收入： SUM(NVL(DSL_TRUNK_TOTAL_INCOME, 0)) 
其他基础语音业务收入：SUM(NVL(OTHER_VOICE_TOTAL_INCOME, 0)) 、
数据通信业务收入：SUM(NVL(DATA_TX_TOTAL_INCOME, 0)) 
网元出租收入： SUM(NVL(WY_RENT_TOTAL_INCOME, 0))         
互联网接入及数据收入：SUM(NVL(INTERNET_DATA_TOTAL_INCOME, 0))
互联网接入业务收入： SUM(NVL(INTERNET_TOTAL_INCOME, 0))         
互联网增值收入：SUM(NVL(INET_INC_TOTAL_INCOME, 0))
根据关键字统计业务量
ZB.ZB_INCO_M_MD_02的账期加CUSTOMER_NAME LIKE '%关键字%' 求业务量
语音增值400业务：SUM(NVL(VOICE_INC_400_INCOME,0))
移动非数据增值业务短信：SUM(NVL(YD_FSJ_DX_INCOME, 0))
移动数据增值业务彩信： SUM(NVL(YD_SJ_CX_INCOME, 0)) 
ICT业务：SUM(NVL(ICT_INCOME, 0))
集中渠道
3G出账用户分集中渠道7种类型
SELECT CASE
         WHEN D.LEVEL_2_CODE LIKE '%渠道%' THEN
          LEVEL_1_CODE || LEVEL_2_CODE || '渠道'
         WHEN D.LEVEL_2_CODE IS NOT NULL THEN
          LEVEL_1_CODE || LEVEL_2_CODE || '渠道'
         ELSE
          '无渠道'
       END QD,
       COUNT(A.USER_ID)
  FROM (SELECT /*+parallel(b,3)*/
         USER_ID, PRODUCT_MODE
          FROM ZBA_DWA.DWA_V_M_CUS_3G_USER_INFO_011@DSSDWYZ B
         WHERE IS_STAT = '1'
           AND IS_CARD = '0'
           AND IS_THIS_ACCT = '1'
           AND MONTH_ID = '201403') A, --出账用户
       (SELECT A.ACCT_MONTH, A.PROV_ID, A.CHNL_ID, A.SUBS_ID
          FROM ZB_DWA.DWA_C_M_BDSM_CHNLKPI_3G_BI@DSSDWYZ A
         WHERE A.ACCT_MONTH = '201403'
           AND A.PROV_ID = '011') B,
       (SELECT B.CHNL_ID, B.CHNL_KIND_ID
          FROM ZB_DWD.DWD_M_MRT_AL_BSDM_CHANNEL_S@DSSDWYZ B
         WHERE B.PROV_ID = '011'
           AND B.MONTH_ID = '201403') C,
       ZB_DIM.DIM_CHANNEL_TYPE_BSDM@DSSDWYZ D
WHERE A.USER_ID = B.SUBS_ID(+)
   AND B.CHNL_ID = C.CHNL_ID(+)
   AND C.CHNL_KIND_ID = D.LEVEL_3(+)
GROUP BY CASE
            WHEN D.LEVEL_2_CODE LIKE '%渠道%' THEN
             LEVEL_1_CODE || LEVEL_2_CODE || '渠道'
            WHEN D.LEVEL_2_CODE IS NOT NULL THEN
             LEVEL_1_CODE || LEVEL_2_CODE || '渠道'
            ELSE
             '无渠道'
          END
4G出账用户分集中渠道7种类型
SELECT CASE
         WHEN D.LEVEL_2_CODE LIKE '%渠道%' THEN
          LEVEL_1_CODE || LEVEL_2_CODE || '渠道'
         WHEN D.LEVEL_2_CODE IS NOT NULL THEN
          LEVEL_1_CODE|| LEVEL_2_CODE || '渠道'
         ELSE
          '无渠道'
       END QD,
       SUM(NVL(A.IS_ACCT, 0)) ACCT_NUM
  FROM (SELECT /*+parallel(T,2)*/
         USER_ID, IS_ACCT, CHANNEL_ID
          FROM ZBG_DWA.DWA_V_M_CUS_CB_USER_INFO_011@LINK_DSSDWE T
         WHERE MONTH_ID = '201410'
           AND IS_STAT = '1'
           AND SERVICE_TYPE = '40AAAAAA'
           AND IS_CARD = '0') A,
       (SELECT B.CHNL_ID, C.LEVEL_2_CODE, C.LEVEL_1_CODE
          FROM ZB_DWD.DWD_M_MRT_AL_BSDM_CHANNEL_S B,
               ZB_DIM.DIM_CHANNEL_TYPE_BSDM       C
         WHERE B.PROV_ID = '011'
           AND B.MONTH_ID = '201410'
           AND B.CHNL_KIND_ID = C.LEVEL_3(+)) D
 WHERE A.CHANNEL_ID = D.CHNL_ID(+)
 GROUP BY CASE
            WHEN D.LEVEL_2_CODE LIKE '%渠道%' THEN
             LEVEL_1_CODE || LEVEL_2_CODE || '渠道'
            WHEN D.LEVEL_2_CODE IS NOT NULL THEN
             LEVEL_1_CODE || LEVEL_2_CODE || '渠道'
            ELSE
             '无渠道'
          END
3G-2013名单厅用户
SELECT '201410', '011', T.SUBS_ID, T.QD
  FROM (SELECT /*+parallel(a,2)(b,2)*/
         A.SUBS_ID,
         CASE
           WHEN C.LEVEL_2 IS NOT NULL AND C.LEVEL_2 LIKE '10%' THEN
            '名单厅'
           ELSE
            NULL
         END QD
          FROM (SELECT A.ACCT_MONTH, A.PROV_ID, A.CHNL_ID, A.SUBS_ID
                  FROM ZB_DWA.DWA_C_M_BDSM_CHNLKPI_3G_BI A
                 WHERE A.ACCT_MONTH = '201410'
                   AND A.PROV_ID = '011') A,
               (SELECT B.CHNL_ID, B.CHNL_KIND_ID
                  FROM ZB_DWD.DWD_M_MRT_AL_BSDM_CHANNEL_S B
                 WHERE B.PROV_ID = '011'
                   AND B.MONTH_ID = '201410') B,
               (SELECT A.SOCIETYCHNL_CODE CHNL_ID,
                       A.OWNNERCHNL_CODE  SELF_CHNL_ID
                  FROM ZB_DWD.DIM_SOCIETY_CHNL_CODE A, ZB_DWD.DIM_HALL_LIST B
                 WHERE B.CHNL_CODE = A.OWNNERCHNL_CODE(+)
                   AND A.OWNNERCHNL_CODE IS NOT NULL
                UNION ALL
                SELECT A.CHNL_CODE CHNL_ID, ‘ SELF_CHNL_ID
                  FROM ZB_DWD.DIM_HALL_LIST A) D,
               (SELECT * FROM ZB_DIM.DIM_CHANNEL_TYPE_BSDM) C
         WHERE A.CHNL_ID = D.CHNL_ID(+)
           AND CASE
                 WHEN D.SELF_CHNL_ID IS NOT NULL THEN
                  D.SELF_CHNL_ID
                 ELSE
                  D.CHNL_ID
               END = B.CHNL_ID(+)
           AND B.CHNL_KIND_ID = C.LEVEL_3(+)) T
 WHERE T.QD IS NOT NULL
4G-2013名单厅用户
SELECT '201410', '011', T.USER_ID, T.QD
  FROM (SELECT /*+parallel(a,2)(b,2)*/
         A.USER_ID,
         CASE
           WHEN C.LEVEL_2 IS NOT NULL AND C.LEVEL_2 LIKE '10%' THEN
            '名单厅'
           ELSE
            NULL
         END QD
          FROM (SELECT /*+parallel(T,2)*/
                 T.USER_ID, T.CHANNEL_ID
                  FROM ZBG_DWA.DWA_V_M_CUS_CB_USER_INFO_011@LINK_DSSDWE T
                 WHERE MONTH_ID = '201410'
                   AND IS_STAT = '1'
                   AND SERVICE_TYPE = '40AAAAAA') A,
               (SELECT B.CHNL_ID, B.CHNL_KIND_ID
                  FROM ZB_DWD.DWD_M_MRT_AL_BSDM_CHANNEL_S B
                 WHERE B.PROV_ID = '011'
                   AND B.MONTH_ID = '201410') B,
               (SELECT A.SOCIETYCHNL_CODE CHNL_ID,
                       A.OWNNERCHNL_CODE  SELF_CHNL_ID
                  FROM ZB_DWD.DIM_SOCIETY_CHNL_CODE A, ZB_DWD.DIM_HALL_LIST B
                 WHERE B.CHNL_CODE = A.OWNNERCHNL_CODE(+)
                   AND A.OWNNERCHNL_CODE IS NOT NULL
                UNION ALL
                SELECT A.CHNL_CODE CHNL_ID, ‘ SELF_CHNL_ID
                  FROM ZB_DWD.DIM_HALL_LIST A) D,
               (SELECT * FROM ZB_DIM.DIM_CHANNEL_TYPE_BSDM) C
         WHERE A.CHANNEL_ID = D.CHNL_ID(+)
           AND CASE
                 WHEN D.SELF_CHNL_ID IS NOT NULL THEN
                  D.SELF_CHNL_ID
                 ELSE
                  D.CHNL_ID
               END = B.CHNL_ID(+)
           AND B.CHNL_KIND_ID = C.LEVEL_3(+)) T
 WHERE T.QD IS NOT NULL
渠道用户明细报表3G新增
路径：报表中心->专业报表->渠道用户月报->渠道用户明细报表 
筛选：浙江，3G，新增用户数，其余为全部。
SELECT /*+parallel(A,2)(B,2)(C,2)(D,2)*/
 F.AREA_DESC,
 C.DEVICE_NUMBER,
 NVL(G.STATUS_DESC1, '无法区分') STATUS_DESC,
 NVL(H.PAY_MODE_DESC, '无法区分') PAY_MODE,
 '不支撑',
 CASE
   WHEN D.SUBS_INSTANCE_ID IS NOT NULL THEN
    '是'
   ELSE
    '否'
 END IS_ACTIVITY,
 NVL(E.PRODUCT_CLASS_DESC, '无法识别3G套餐') PRODUCT_CLASS_DESC,
 C.INNET_DATE,
 '暂不支撑',
 A.CHNL_ID,
 B.CHNL_NAME,
 '暂不支撑',
 '暂不支撑',
 B.LEVEL_1_CODE || B.LEVEL_2_CODE || '渠道' CHNL_TYPE,
 CASE
   WHEN A.DEV_FLAG = '1' THEN
    '新发展'
   WHEN A.IS_SWITCH_USER = '1' THEN
    '2G转3G'
   ELSE
    '其他新增'
 END ADD_TYPE
  FROM (SELECT SUBS_ID,
               CHNL_ID,
               AREA_ID,
               DEV_FLAG,
               IS_SWITCH_USER,
               SUM(CASE
                     WHEN T.INC_USER >= '1' THEN
                      T.INC_USER
                     ELSE
                      '0'
                   END)
          FROM ZB_DWA.DWA_C_M_BDSM_CHNLKPI_3G_BI T
         WHERE T.ACCT_MONTH = '201412'
           AND T.PROV_ID = '036'
           AND T.INC_USER >= '1'
           AND AREA_ID = 'V0330100'
           AND SVC_TYPE = '02'
           AND IS_BF_OCS = '1'
         GROUP BY SUBS_ID, CHNL_ID, AREA_ID, DEV_FLAG, IS_SWITCH_USER) A,
       (SELECT CHNL_ID, CHNL_NAME, B.LEVEL_2_CODE, B.LEVEL_1_CODE
          FROM ZB_DWD.DWD_M_MRT_AL_BSDM_CHANNEL_S A,
               ZB_DIM.DIM_CHANNEL_TYPE_BSDM       B
         WHERE MONTH_ID = '201412'
           AND PROV_ID = '036'
           AND A.CHNL_KIND_ID = B.LEVEL_3(+)) B,
       (SELECT *
          FROM ZBA_DWA.DWA_V_M_CUS_3G_USER_INFO_036 T
         WHERE MONTH_ID = '201412'
           AND IS_STAT = '1') C,
       (SELECT T.IS_THIS_ADD, T.ACTIVITY_TYPE, T.SUBS_INSTANCE_ID
          FROM ZBA_DWA.DWA_V_M_CUS_3G_ACT_INFO_036 T
         WHERE MONTH_ID = '201412'
           AND ACTIVITY_TYPE IN ('01', '02', '03', '06', '07', '08')
           AND IS_CARD = '0'
           AND IS_THIS_ADD = '1') D,
       (SELECT J.PRODUCT_CLASS_DESC,
               H.PRODUCT_CLASS,
               J.PRODUCT_CLASSIFY_VALUE,
               J.PRODUCT_BASE_CLASS,
               R.MON_FEE,
               R.CALL_DURA,
               R.FLUX_M
          FROM (SELECT *
                  FROM ZB_DIM.DIM_PRODUCT_CLASS
                 WHERE SERVICE_TYPE = '30AAAAAA'
                   AND IS_CARD = '0') H,
               (SELECT *
                  FROM ZB_DIM.DIM_PRODUCT_CLASS
                 WHERE SERVICE_TYPE = '30AAAAAA'
                   AND IS_CARD = '0') J,
               ZB_DIM.DIM_PRODUCT_RATE R
         WHERE H.PRODUCT_CLASSIFY_VALUE = J.PRODUCT_CLASS(+)
           AND J.PRODUCT_CLASSIFY_VALUE = '02' || R.PRODUCT_CLASS(+)) E,
       (SELECT * FROM ZB_DIM.V_DIM_AREA) F,
       (SELECT * FROM ZB_DIM.DIM_BI_STATUS) G,
       (SELECT * FROM ZB_DIM.DIM_BI_PAY_MODE) H
 WHERE A.CHNL_ID = B.CHNL_ID(+)
   AND A.SUBS_ID = C.USER_ID(+)
   AND A.SUBS_ID = D.SUBS_INSTANCE_ID(+)
   AND C.PRODUCT_MODE = E.PRODUCT_CLASS(+)
   AND A.AREA_ID = F.AREA_ID(+)
   AND C.USER_STATUS = G.STATUS_ID(+)
   AND C.PAY_MODE = H.PAY_MODE(+)
   AND B.LEVEL_1_CODE = '自有'
   AND B.LEVEL_2_CODE = '实体'
渠道用户明细报表4G新增
路径：报表中心->专业报表->渠道用户月报->渠道用户明细报表 
筛选：浙江，4G，新增用户数，其余为全部。

SELECT F.AREA_DESC,
       T.CHANNEL_ID,
       C.CHNL_NAME,
       A.ACCEPT_TIME,
       A.START_DATE,
       A.END_DATE,
       T.DEVICE_NUMBER,
       CASE
         WHEN SUBSTR(B.DIM_1, 1, 2) = '03' THEN
          DIM_1_DESC
         ELSE
          B.MON_FEE || '元' || B.DIM_1_DESC
       END PRODUCT_CLASS_DESC,
       DECODE(SUBSTR(B.DIM_1, 1, 2),
              '01',
              '3/4G一体化套餐',
              '02',
              '共享套餐',
              '03',
              '自由组合套餐',
              '04',
              '校园套餐',
              '05',
              '4G本地套餐',
              '06',
              '智慧沃家共享',
              '其他套餐') PRODUCT_TYPE,
       NVL(E.ACTIVITY_TYPE_DESC, '单卡') ACTIVITY_TYPE,
       T.INNET_DATE,
       '暂不支撑',
       '暂不支撑',
       T.USER_ID,
       D.DEV_NAME,
       CASE
         WHEN T.DEV_NUM >= 1 THEN
          '新发展'
         WHEN T.SWICH_NUM >= 1 THEN
          '转网'
         ELSE
          '其他新增'
       END ADD_TYPE
  FROM (SELECT USER_ID,
               AREA_ID,
               DEVICE_NUMBER,
               INNET_DATE,
               DEVELOPER_ID,
               CHANNEL_ID,
               PRODUCT_CLASS,
               SUM(CASE
                     WHEN ADD_TYPE IN ('101', '105', '108') THEN
                      1
                     ELSE
                      0
                   END) DEV_NUM,
               SUM(CASE
                     WHEN IS_CHANGE = '1' THEN
                      1
                     ELSE
                      0
                   END) SWICH_NUM,
               COUNT(*) ADD_NUM
          FROM ZB_DWA.DWA_V_M_CUS_CB_USER_ADD_036
         WHERE MONTH_ID = '201412'
           AND SERVICE_TYPE = '40AAAAAA'
           AND AREA_ID = 'V0330100'
         GROUP BY USER_ID,
                  AREA_ID,
                  DEVICE_NUMBER,
                  INNET_DATE,
                  DEVELOPER_ID,
                  CHANNEL_ID,
                  PRODUCT_CLASS) T,
       (SELECT *
          FROM ZBG_DWA.DWA_V_M_CUS_CB_ACT_INFO_036@LINK_DSSDWE T
         WHERE MONTH_ID = '201412'
           AND ACTIVITY_TYPE IN
               (SELECT ACTIVITY_TYPE
                  FROM ZBG_DIM.DIM_CBSS_ACTIVITY_TYPE@LINK_DSSDWE
                 WHERE IS_VALID = '1'
                   AND ACTIVITY_TYPE <> '04')
           AND IS_CARD = '0'
           AND IS_THIS_ADD = '1') A,
       (SELECT *
          FROM ZBG_DIM.DIM_PRODUCT_CLASS@LINK_DSSDWE
         WHERE SERVICE_TYPE = '40AAAAAA'
           AND IS_CBSS = '1') B,
       (SELECT CHNL_ID, CHNL_NAME, B.LEVEL_2_CODE, B.LEVEL_1_CODE
          FROM ZB_DWD.DWD_M_MRT_AL_BSDM_CHANNEL_S A,
               ZB_DIM.DIM_CHANNEL_TYPE_BSDM       B
         WHERE MONTH_ID = '201412'
           AND PROV_ID = '036'
           AND A.CHNL_KIND_ID = B.LEVEL_3(+)) C,
       (SELECT DEV_CODE, DEV_NAME
          FROM ZB_DWD.DWD_M_MRT_AL_DEV_MAN_INFO_036
         WHERE MONTH_ID = '201412'
           AND AREA_ID = 'V0330100') D,
       (SELECT ACTIVITY_TYPE, ACTIVITY_TYPE_DESC
          FROM ZBG_DIM.DIM_CBSS_ACTIVITY_TYPE@LINK_DSSDWE
         WHERE IS_VALID = '1'
           AND ACTIVITY_TYPE <> '04') E,
       (SELECT * FROM ZB_DIM.V_DIM_AREA) F
 WHERE T.CHANNEL_ID = C.CHNL_ID(+)
   AND C.LEVEL_1_CODE = '自有'
   AND C.LEVEL_2_CODE = '实体'
   AND T.PRODUCT_CLASS = B.PRODUCT_CLASS(+)
   AND T.DEVELOPER_ID = D.DEV_CODE(+)
   AND A.ACTIVITY_TYPE = E.ACTIVITY_TYPE(+)
   AND T.AREA_ID = F.AREA_ID(+)
   AND T.USER_ID = A.USER_ID(+)
自有营业厅用户报表3G新增
路径：报表中心->专业报表->渠道用户月报->自有营业厅用户报表 
筛选：浙江，3G，新增用户数，其余为全部。

SELECT /*+parallel(A,2)(B,2)(C,2)(D,2)*/
 F.AREA_DESC,
 C.DEVICE_NUMBER,
 NVL(G.STATUS_DESC1, '无法区分') STATUS_DESC,
 NVL(H.PAY_MODE_DESC, '无法区分') PAY_MODE,
 CASE
   WHEN D.SUBS_INSTANCE_ID IS NOT NULL THEN
    '是'
   ELSE
    '否'
 END IS_ACTIVITY,
 NVL(E.PRODUCT_CLASS_DESC, '无法识别3G套餐') PRODUCT_CLASS_DESC,
 C.INNET_DATE,
 A.CHNL_ID,
 B.CHNL_NAME,
 B.LEVEL_1_CODE || B.LEVEL_2_CODE || '渠道' CHNL_TYPE,
 CASE
   WHEN A.DEV_FLAG = '1' THEN
    '新发展'
   WHEN A.IS_SWITCH_USER = '1' THEN
    '2G转3G'
   ELSE
    '其他新增'
 END ADD_TYPE,
 CASE
   WHEN J.SELF_OPER_TYPE = '0' THEN
    '自有自营'
   WHEN J.SELF_OPER_TYPE = '1' THEN
    '自有他营'
   WHEN J.OPER_TYPE = '2' THEN
    '柜台外包-自营'
   WHEN J.SELF_OPER_TYPE = '2' AND J.OPER_TYPE = '9' THEN
    '柜台外包-外包代理商'
   ELSE
    '其他自有营业厅类型'
 END ZY_TYPE
  FROM (SELECT SUBS_ID,
               CHNL_ID,
               AREA_ID,
               DEV_FLAG,
               IS_SWITCH_USER,
               SUM(CASE
                     WHEN T.INC_USER >= '1' THEN
                      T.INC_USER
                     ELSE
                      '0'
                   END)
          FROM ZB_DWA.DWA_C_M_BDSM_CHNLKPI_3G_BI T
         WHERE T.ACCT_MONTH = '201412'
           AND T.PROV_ID = '036'
           AND T.INC_USER >= '1'
           AND SVC_TYPE = '02'
           AND IS_BF_OCS = '1'
         GROUP BY SUBS_ID, CHNL_ID, AREA_ID, DEV_FLAG, IS_SWITCH_USER) A,
       (SELECT CHNL_ID, CHNL_NAME, B.LEVEL_2_CODE, B.LEVEL_1_CODE
          FROM ZB_DWD.DWD_M_MRT_AL_BSDM_CHANNEL_S A,
               ZB_DIM.DIM_CHANNEL_TYPE_BSDM       B
         WHERE MONTH_ID = '201412'
           AND PROV_ID = '036'
           AND A.CHNL_KIND_ID = B.LEVEL_3(+)) B,
       (SELECT *
          FROM ZBA_DWA.DWA_V_M_CUS_3G_USER_INFO_036 T
         WHERE MONTH_ID = '201412'
           AND IS_STAT = '1') C,
       (SELECT T.IS_THIS_ADD, T.ACTIVITY_TYPE, T.SUBS_INSTANCE_ID
          FROM ZBA_DWA.DWA_V_M_CUS_3G_ACT_INFO_036 T
         WHERE MONTH_ID = '201412'
           AND ACTIVITY_TYPE IN ('01', '02', '03', '06', '07', '08')
           AND IS_CARD = '0'
           AND IS_THIS_ADD = '1') D,
       (SELECT J.PRODUCT_CLASS_DESC,
               H.PRODUCT_CLASS,
               J.PRODUCT_CLASSIFY_VALUE,
               J.PRODUCT_BASE_CLASS,
               R.MON_FEE,
               R.CALL_DURA,
               R.FLUX_M
          FROM (SELECT *
                  FROM ZB_DIM.DIM_PRODUCT_CLASS
                 WHERE SERVICE_TYPE = '30AAAAAA'
                   AND IS_CARD = '0') H,
               (SELECT *
                  FROM ZB_DIM.DIM_PRODUCT_CLASS
                 WHERE SERVICE_TYPE = '30AAAAAA'
                   AND IS_CARD = '0') J,
               ZB_DIM.DIM_PRODUCT_RATE R
         WHERE H.PRODUCT_CLASSIFY_VALUE = J.PRODUCT_CLASS(+)
           AND J.PRODUCT_CLASSIFY_VALUE = '02' || R.PRODUCT_CLASS(+)) E,
       (SELECT * FROM ZB_DIM.V_DIM_AREA) F,
       (SELECT * FROM ZB_DIM.DIM_BI_STATUS) G,
       (SELECT * FROM ZB_DIM.DIM_BI_PAY_MODE) H,
       (SELECT CHNL_ID, CHNL_ID_SH, OPER_TYPE, SELF_OPER_TYPE
          FROM ZBA_DMA.CH_RPT_CHNL_INFO_ZY@DSSMSS_BA
         WHERE MONTH_ID = '201412'
           AND PROV_ID = '036') J
 WHERE A.CHNL_ID = B.CHNL_ID(+)
   AND A.SUBS_ID = C.USER_ID(+)
   AND A.SUBS_ID = D.SUBS_INSTANCE_ID(+)
   AND C.PRODUCT_MODE = E.PRODUCT_CLASS(+)
   AND A.AREA_ID = F.AREA_ID(+)
   AND C.USER_STATUS = G.STATUS_ID(+)
   AND C.PAY_MODE = H.PAY_MODE(+)
   AND J.CHNL_ID_SH = A.CHNL_ID

自有营业厅用户报表4G新增
路径：报表中心->专业报表->渠道用户月报->自有营业厅用户报表 
筛选：浙江，4G，新增用户数，其余为全部。

SELECT F.AREA_DESC,
       T.CHANNEL_ID,
       C.CHNL_NAME,
       C.LEVEL_1_CODE || C.LEVEL_2_CODE || '渠道' CHNL_TYPE,
       A.ACCEPT_TIME,
       A.START_DATE,
       A.END_DATE,
       T.DEVICE_NUMBER,
       CASE
         WHEN SUBSTR(B.DIM_1, 1, 2) = '03' THEN
          DIM_1_DESC
         ELSE
          B.MON_FEE || '元' || B.DIM_1_DESC
       END PRODUCT_CLASS_DESC,
       DECODE(SUBSTR(B.DIM_1, 1, 2),
              '01',
              '3/4G一体化套餐',
              '02',
              '共享套餐',
              '03',
              '自由组合套餐',
              '04',
              '校园套餐',
              '05',
              '4G本地套餐',
              '06',
              '智慧沃家共享',
              '其他套餐') PRODUCT_TYPE,
       NVL(E.ACTIVITY_TYPE_DESC, '单卡') ACTIVITY_TYPE,
       T.INNET_DATE,
       T.USER_ID,
       D.DEV_NAME,
       CASE
         WHEN T.DEV_NUM >= 1 THEN
          '新发展'
         WHEN T.SWICH_NUM >= 1 THEN
          '转网'
         ELSE
          '其他新增'
       END ADD_TYPE,
       CASE
         WHEN G.SELF_OPER_TYPE = '0' THEN
          '自有自营'
         WHEN G.SELF_OPER_TYPE = '1' THEN
          '自有他营'
         WHEN G.OPER_TYPE = '2' THEN
          '柜台外包-自营'
         WHEN G.SELF_OPER_TYPE = '2' AND G.OPER_TYPE = '9' THEN
          '柜台外包-外包代理商'
         ELSE
          '其他自有营业厅类型'
       END ZY_TYPE
  FROM (SELECT USER_ID,
               AREA_ID,
               DEVICE_NUMBER,
               INNET_DATE,
               DEVELOPER_ID,
               CHANNEL_ID,
               PRODUCT_CLASS,
               SUM(CASE
                     WHEN ADD_TYPE IN ('101', '105', '108') THEN
                      1
                     ELSE
                      0
                   END) DEV_NUM,
               SUM(CASE
                     WHEN IS_CHANGE = '1' THEN
                      1
                     ELSE
                      0
                   END) SWICH_NUM,
               COUNT(*) ADD_NUM
          FROM ZB_DWA.DWA_V_M_CUS_CB_USER_ADD_036
         WHERE MONTH_ID = '201412'
           AND SERVICE_TYPE = '40AAAAAA'
        /*           AND AREA_ID = 'V0330100'
        */
         GROUP BY USER_ID,
                  AREA_ID,
                  DEVICE_NUMBER,
                  INNET_DATE,
                  DEVELOPER_ID,
                  CHANNEL_ID,
                  PRODUCT_CLASS) T,
       (SELECT *
          FROM ZBG_DWA.DWA_V_M_CUS_CB_ACT_INFO_036@LINK_DSSDWE T
         WHERE MONTH_ID = '201412'
           AND ACTIVITY_TYPE IN
               (SELECT ACTIVITY_TYPE
                  FROM ZBG_DIM.DIM_CBSS_ACTIVITY_TYPE@LINK_DSSDWE
                 WHERE IS_VALID = '1'
                   AND ACTIVITY_TYPE <> '04')
           AND IS_CARD = '0'
           AND IS_THIS_ADD = '1') A,
       (SELECT *
          FROM ZBG_DIM.DIM_PRODUCT_CLASS@LINK_DSSDWE
         WHERE SERVICE_TYPE = '40AAAAAA'
           AND IS_CBSS = '1') B,
       (SELECT CHNL_ID, CHNL_NAME, B.LEVEL_2_CODE, B.LEVEL_1_CODE
          FROM ZB_DWD.DWD_M_MRT_AL_BSDM_CHANNEL_S A,
               ZB_DIM.DIM_CHANNEL_TYPE_BSDM       B
         WHERE MONTH_ID = '201412'
           AND PROV_ID = '036'
           AND A.CHNL_KIND_ID = B.LEVEL_3(+)) C,
       (SELECT DEV_CODE, DEV_NAME
          FROM ZB_DWD.DWD_M_MRT_AL_DEV_MAN_INFO_036
         WHERE MONTH_ID = '201412'
        /*AND AREA_ID = 'V0330100'*/
        ) D,
       (SELECT ACTIVITY_TYPE, ACTIVITY_TYPE_DESC
          FROM ZBG_DIM.DIM_CBSS_ACTIVITY_TYPE@LINK_DSSDWE
         WHERE IS_VALID = '1'
           AND ACTIVITY_TYPE <> '04') E,
       (SELECT * FROM ZB_DIM.V_DIM_AREA) F,
       (SELECT CHNL_ID, CHNL_ID_SH, OPER_TYPE, SELF_OPER_TYPE
          FROM ZBA_DMA.CH_RPT_CHNL_INFO_ZY@DSSMSS_BA
         WHERE MONTH_ID = '201412'
           AND PROV_ID = '036') G
 WHERE T.CHANNEL_ID = C.CHNL_ID(+)
   AND T.PRODUCT_CLASS = B.PRODUCT_CLASS(+)
   AND T.DEVELOPER_ID = D.DEV_CODE(+)
   AND A.ACTIVITY_TYPE = E.ACTIVITY_TYPE(+)
   AND T.AREA_ID = F.AREA_ID(+)
   AND T.USER_ID = A.USER_ID(+)
   AND G.CHNL_ID_SH = T.CHANNEL_ID

自有营业厅用户发展量
以3G手机为例：

SELECT /*PARALLEL(A,20)(B,20)*/
 SUM(DECODE(B.SELF_OPER_TYPE, '0', NVL(DEV_NUM, 0), 0)) OP_DEV,  /*自由自营发展量*/
 SUM(DECODE(B.SELF_OPER_TYPE, '1', NVL(DEV_NUM, 0), 0)) CODO_DEV,  /*自由他营发展量*/
 SUM(DECODE(B.OPER_TYPE, '2', NVL(DEV_NUM, 0), 0)) CO_SELE_DEV,  /*柜台外包-自营发展量*/
 SUM(CASE
       WHEN B.SELF_OPER_TYPE = '2' AND B.OPER_TYPE = '9' THEN
        NVL(DEV_NUM, 0)
       ELSE
        0
     END) CO_AGENT_DEV /*柜台外包-外包代理商发展量*/
  FROM (SELECT SUBS_ID,
               CHNL_ID,
               SUM(CASE
                     WHEN T.DEV_FLAG >= '1' THEN
                      T.DEV_FLAG
                     ELSE
                      '0'
                   END) DEV_NUM
          FROM ZB_DWA.DWA_C_M_BDSM_CHNLKPI_3G_BI T
         WHERE T.ACCT_MONTH = '201511'
           AND T.PROV_ID = '011'
           AND SVC_TYPE = '02'
           AND SVC_TYPE_3G = '0'
           AND T.INC_USER >= '1'
           AND IS_BF_OCS = '1'
         GROUP BY SUBS_ID, CHNL_ID) A,
       (SELECT MONTH_ID,
               CHNL_ID,
               CHNL_ID      CHNL_ID_SH,
               OPER_TYPE,
               CHNL_KIND_ID,
               PROV_ID,
               AREA_ID,
               OPER_TYPE    SELF_OPER_TYPE
          FROM ZB_DWD.DWD_M_MRT_AL_BSDM_CHANNEL_S B
         WHERE MONTH_ID = '201511'
           AND B.OPER_TYPE <> '9'  --自有营业厅运营方式  0 自营；1 他营；2 柜台外包
           AND B.PROV_ID = '011'
           AND B.CHNL_KIND_ID IN
               ('1010100', '1010200', '1010300', '1010400')    --自有自营、自有他营、柜台外包中的自有渠道
        UNION ALL
        SELECT B.MONTH_ID,
               B.SELF_CHNL_ID CHNL_ID,
               B.CHNL_ID      CHNL_ID_SH,
               B.OPER_TYPE,
               B.CHNL_KIND_ID,
               B.PROV_ID,
               B.AREA_ID,
               C.OPER_TYPE    SELF_OPER_TYPE
          FROM (SELECT *
                  FROM ZB_DWD.DWD_M_MRT_AL_BSDM_CHANNEL_S B
                 WHERE MONTH_ID = '201511'
                   AND B.OPER_TYPE = '9'   --上层加工时关联运营信息ZB_ODS.ZB_M_MRT_AL_HALL_INFO（OPER_TYPE：0 1 2 null）时  NVL(B.OPER_TYPE, ''9'') OPER_TYPE,
                   AND B.PROV_ID = '011'
                   AND SELF_CHNL_ID IS NOT NULL) B,    --自有他营的社会渠道、 --柜台外包的社会渠道		 
               (SELECT *
                  FROM ZB_DWD.DWD_M_MRT_AL_BSDM_CHANNEL_S C
                 WHERE C.OPER_TYPE IN ('1', '2')
                   AND MONTH_ID = '201511'
                   AND C.PROV_ID = '011'
                   AND C.CHNL_KIND_ID IN
                       ('1010100', '1010200', '1010300', '1010400')) C
         WHERE C.CHNL_ID = B.SELF_CHNL_ID) B --SELF_CHNL_ID 归属自有渠道 
 WHERE A.CHNL_ID = B.CHNL_ID_SH
渠道用户月报
指标类型：发展用户数
3G
SELECT /*+parallel(A,4)(B,4)*/
 '201506',
 '011',
 B.AREA_ID,
 B.CHNL_ID,
 B.CHNL_NAME,
 CASE
   WHEN A.SVC_TYPE_3G = '0' THEN
    '3G手机'
   WHEN A.SVC_TYPE_3G = '2' THEN
    '23G融合'
   ELSE
    '3G上网卡'
 END SERV_TYPE,
 SUM(DEV_NUM) DEV_NUM
  FROM (SELECT SUBS_ID, 
				CHNL_ID, 
	      SVC_TYPE_3G,
        SUM(CASE
            WHEN T.DEV_FLAG >= '1' THEN
              T.DEV_FLAG
            ELSE
              '0'
          END) DEV_NUM
          FROM ZB_DWA.DWA_C_M_BDSM_CHNLKPI_3G_BI T
         WHERE T.ACCT_MONTH = '201506'
           AND T.PROV_ID = '011'
           AND SVC_TYPE = '02'
           AND T.INC_USER >= '1'
           AND IS_BF_OCS = '1'
        GROUP BY SUBS_ID, CHNL_ID, SVC_TYPE_3G) A,
       (SELECT CHNL_ID, CHNL_NAME, AREA_ID
          FROM ZB_DWD.DWD_M_MRT_AL_BSDM_CHANNEL_S
         WHERE MONTH_ID = '201506'
           AND PROV_ID = '011'
           AND CHNL_KIND_ID IN ('2010100', '2010200', '2010300') --渠道类型  
           AND STATE = '10'--渠道状态：10 正常；11 清算；12 终止) B
 WHERE A.CHNL_ID = B.CHNL_ID
 GROUP BY B.AREA_ID,
          B.CHNL_ID,
          B.CHNL_NAME,
          CASE
            WHEN A.SVC_TYPE_3G = '0' THEN
             '3G手机'
            WHEN A.SVC_TYPE_3G = '2' THEN
             '23G融合'
            ELSE
             '3G上网卡'
          END
4G
SELECT /*+parallel(A,4)(B,4)*/
 B.CHNL_ID,
 B.CHNL_NAME,
 CASE
   WHEN IS_CARD = '0' THEN
    '4G手机'
   ELSE
    '4G数据卡'
 END SERV_TYPE,
 SUM(DEV_NUM) DEV_NUM
  FROM (SELECT USER_ID,
               CHANNEL_ID,
               IS_CARD,
               SUM(CASE
                     WHEN ADD_TYPE IN ('101', '105', '108') THEN
                      1
                     ELSE
                      0
                   END) DEV_NUM
          FROM ZB_DWA.DWA_V_M_CUS_CB_USER_ADD_011
         WHERE MONTH_ID = '201501'
           AND SERVICE_TYPE = '40AAAAAA'
         GROUP BY USER_ID, CHANNEL_ID，IS_CARD) A,
       (SELECT CHNL_ID, CHNL_NAME, AREA_ID
          FROM ZB_DWD.DWD_M_MRT_AL_BSDM_CHANNEL_S
         WHERE MONTH_ID = '201501'
           AND PROV_ID = '011'
           AND CHNL_KIND_ID IN ('2010100', '2010200', '2010300')
           AND STATE = '10') B
 WHERE A.CHANNEL_ID = B.CHNL_ID
 GROUP BY B.CHNL_ID,
          B.CHNL_NAME,
          CASE
            WHEN IS_CARD = '0' THEN
             '4G手机'
            ELSE
             '4G数据卡'
          END
指标类型：合约销售量
来源路径：专业报表—》市场营销部—》渠道用户月报（渠道用户明细报表）—》指标类型：iPhone合约销售量
3G
SELECT /*+PARALLEL(A,4)*/
 '3G',
 CASE
   WHEN LENGTH(A.CHANNEL_ID) > 8 THEN
    SUBSTR(A.CHANNEL_ID, 3, 7)
   ELSE
    A.CHANNEL_ID
 END CHNL_ID,
 B.CHNL_NAME,
 A.AGREE_TYPE,
 SUM(CASE
       WHEN A.IS_BACK = '1' THEN
        -1
       ELSE
        1
     END) SALE_NUM
  FROM (SELECT *
          FROM ZB_DWD.DW_M_ESS_ALL_USER_T_ZL -- ESS移动业务销售订单统计-针对担保租机用户
         WHERE MONTH_ID = '201501'
           AND PROV_ID = '011'
           AND CHANNEL_TYPE IN ('2010000',
                                '2010100',
                                '2010200',
                                '2010300',
                                '2040000',
                                '2040100',
                                '2040200',
                                '2040300',
                                '2040400')
           AND SERVICE_TYPE = '0301' --手机用户
           AND AGREE_TYPE IN ('01', '02')) A, --01 存费送机  02  购机送费 
       (SELECT CHNL_ID, CHNL_NAME, CITY_NO, AREA_ID
          FROM ZB_DWD.DWD_M_MRT_AL_BSDM_CHANNEL_S
         WHERE MONTH_ID = '201501'
           AND PROV_ID = '011') B
 WHERE (CASE
         WHEN LENGTH(A.CHANNEL_ID) > 8 THEN
          SUBSTR(A.CHANNEL_ID, 3, 7)
         ELSE
          A.CHANNEL_ID
       END) = B.CHNL_ID(+)
 GROUP BY CASE
            WHEN LENGTH(A.CHANNEL_ID) > 8 THEN
             SUBSTR(A.CHANNEL_ID, 3, 7)
            ELSE
             A.CHANNEL_ID
          END,
          B.CHNL_NAME,
          A.AGREE_TYPE
4G
SELECT /*+PARALLEL(A,4)*/
 '4G', A.TRADE_DEPART_ID, B.CHNL_NAME, ACTIVITY_TYPE, COUNT(A.USER_ID)
  FROM (SELECT *
          FROM ZBG_DWA.DWA_S_M_EVT_CB_ACT_TRADE_011@LINK_DSSDWE
         WHERE MONTH_ID = '201501'
           AND SUBSTR(ACCEPT_DATE, 1，6) = '201501'
           AND CANCEL_FLAG = '0'
           AND ACTIVITY_TYPE IN ('01', '02', '12')
           AND CHNL_TYPE IN ('2010000',
                             '2010100',
                             '2010200',
                             '2010300',
                             '2040000',
                             '2040100',
                             '2040200',
                             '2040300',
                             '2040400')) A,
       (SELECT CHNL_ID, CHNL_NAME, CITY_NO, AREA_ID
          FROM ZB_DWD.DWD_M_MRT_AL_BSDM_CHANNEL_S
         WHERE MONTH_ID = '201501'
           AND PROV_ID = '011') B
 WHERE A.TRADE_DEPART_ID = B.CHNL_ID(+)
 GROUP BY TRADE_DEPART_ID, CHNL_NAME, ACTIVITY_TYPE
渠道出账收入月报
2G
SELECT /*+parallel(A,2)(B,2)(C,2)(D,2)*/
 A.SUBS_ID,
 C.DEVICE_NUMBER,
 '2G' SERV_TYPE,
 D.DEV_CODE,
 D.DEV_NAME,
 A.CHNL_ID,
 B.CHNL_NAME,
 C.INNET_DATE,
 B.LEVEL_1_CODE || B.LEVEL_2_CODE CHNL_TYPE2,
 B.LEVEL_3_CODE CHNL_TYPE3,
 CASE
   WHEN B.STATE = '10' THEN
    '正常'
   WHEN B.STATE = '11' THEN
    '清算'
   WHEN B.STATE = '12' THEN
    '终止'
   ELSE
    '其他'
 END CHNL_STATE, --渠道状态
 A.INCOME
  FROM (SELECT SUBS_ID,
               CHNL_ID,
               AREA_ID,
               DEVELOPER_NO,
               SUM(NVL(TOTAL_FEE, 0)) INCOME
          FROM ZB_DWA.DWA_C_M_BDSM_CHNLKPI_2G_BI T
         WHERE T.ACCT_MONTH = '201501'
           AND T.PROV_ID = '011'
           AND SVC_TYPE = '01'
           AND IS_BF_OCS = '1'
         GROUP BY SUBS_ID, CHNL_ID, AREA_ID, DEVELOPER_NO) A,
       (SELECT A.CHNL_KIND_ID,
               CHNL_ID,
               CHNL_NAME,
               STATE,
               B.LEVEL_1_CODE,
               B.LEVEL_2_CODE,
               B.LEVEL_3_CODE
          FROM ZB_DWD.DWD_M_MRT_AL_BSDM_CHANNEL_S A,
               ZB_DIM.DIM_CHANNEL_TYPE_BSDM       B
         WHERE MONTH_ID = '201501'
           AND PROV_ID = '011'
           AND B.LEVEL_2_CODE = '电子'
           AND A.CHNL_KIND_ID = B.LEVEL_3) B,
       (SELECT USER_ID, DEVICE_NUMBER, INNET_DATE
          FROM ZBA_DWA.DWA_V_M_CUS_2G_USER_INFO_011 T
         WHERE MONTH_ID = '201501'
           AND IS_STAT = '1') C,
       (SELECT DEV_CODE, DEV_NAME, CHNL_ID
          FROM ZB_DWD.DWD_M_MRT_AL_DEV_MAN_INFO_011
         WHERE MONTH_ID = '201501'
           AND PROV_ID = '011') D
 WHERE A.CHNL_ID = B.CHNL_ID
   AND A.SUBS_ID = C.USER_ID(+)
   AND A.DEVELOPER_NO = D.DEV_CODE(+)
3G
 SELECT /*+parallel(A,2)(B,2)(C,2)(D,2)*/
 A.SUBS_ID,
 C.DEVICE_NUMBER,
 '3G' SERV_TYPE,
 D.DEV_CODE,
 D.DEV_NAME,
 A.CHNL_ID,
 B.CHNL_NAME,
 C.INNET_DATE,
 B.LEVEL_1_CODE || B.LEVEL_2_CODE CHNL_TYPE2,
 B.LEVEL_3_CODE CHNL_TYPE3,
 CASE
   WHEN B.STATE = '10' THEN
    '正常'
   WHEN B.STATE = '11' THEN
    '清算'
   WHEN B.STATE = '12' THEN
    '终止'
   ELSE
    '其他'
 END CHNL_STATE,
 A.INCOME
  FROM (SELECT SUBS_ID,
               CHNL_ID,
               AREA_ID,
               DEVELOPER_NO,
               SUM(NVL(TOTAL_FEE, 0)) INCOME
          FROM ZB_DWA.DWA_C_M_BDSM_CHNLKPI_3G_BI T
         WHERE T.ACCT_MONTH = '201501'
           AND T.PROV_ID = '011'
           AND SVC_TYPE = '02'
           AND IS_BF_OCS = '1'
         GROUP BY SUBS_ID, CHNL_ID, AREA_ID, DEVELOPER_NO) A,
       (SELECT A.CHNL_KIND_ID,
               CHNL_ID,
               CHNL_NAME,
               STATE,
               B.LEVEL_1_CODE,
               B.LEVEL_2_CODE,
               B.LEVEL_3_CODE
          FROM ZB_DWD.DWD_M_MRT_AL_BSDM_CHANNEL_S A,
               ZB_DIM.DIM_CHANNEL_TYPE_BSDM       B
         WHERE MONTH_ID = '201501'
           AND PROV_ID = '011'
           AND B.LEVEL_2_CODE = '电子'
           AND A.CHNL_KIND_ID = B.LEVEL_3) B,
       (SELECT USER_ID, DEVICE_NUMBER, INNET_DATE
          FROM ZBA_DWA.DWA_V_M_CUS_3G_USER_INFO_011 T
         WHERE MONTH_ID = '201501'
           AND IS_STAT = '1') C,
       (SELECT DEV_CODE, DEV_NAME
          FROM ZB_DWD.DWD_M_MRT_AL_DEV_MAN_INFO_011
         WHERE MONTH_ID = '201501'
           AND PROV_ID = '011') D
 WHERE A.CHNL_ID = B.CHNL_ID
   AND A.SUBS_ID = C.USER_ID(+)
   AND A.DEVELOPER_NO = D.DEV_CODE(+)
4G
SELECT /*+parallel(T,2)(A,2)(B,2)(C,2)*/
 T.USER_ID,
 A.DEVICE_NUMBER,
 '4G' SERV_TYPE,
 C.DEV_CODE,
 C.DEV_NAME,
 T.CHANNEL_ID,
 B.CHNL_NAME,
 A.INNET_DATE,
 B.LEVEL_1_CODE || B.LEVEL_2_CODE CHNL_TYPE2,
 B.LEVEL_3_CODE CHNL_TYPE3,
 CASE
   WHEN B.STATE = '10' THEN
    '正常'
   WHEN B.STATE = '11' THEN
    '清算'
   WHEN B.STATE = '12' THEN
    '终止'
   ELSE
    '其他'
 END CHNL_STATE,
 T.INCOME
  FROM (SELECT USER_ID,
               AREA_ID,
               DEVELOPER_ID,
               CHANNEL_ID,
               SUM(NVL(TOTAL_FEE, 0)) INCOME
          FROM ZB_DWA.DWA_C_M_BDSM_CHNLKPI_CB_BI
         WHERE MONTH_ID = '201501'
           AND SERVICE_TYPE = '40AAAAAA'
           AND PROV_ID = '011'
         GROUP BY USER_ID, AREA_ID, DEVELOPER_ID, CHANNEL_ID) T,
       (SELECT USER_ID, DEVICE_NUMBER, INNET_DATE
          FROM ZBG_DWA.DWA_V_M_CUS_CB_USER_INFO_011@LINK_DSSDWE
         WHERE MONTH_ID = '201501'
           AND SERVICE_TYPE = '40AAAAAA'
           AND IS_STAT = '1') A,
       (SELECT CHNL_ID,
               CHNL_NAME,
               STATE,
               B.LEVEL_1_CODE,
               B.LEVEL_2_CODE,
               B.LEVEL_3_CODE
          FROM ZB_DWD.DWD_M_MRT_AL_BSDM_CHANNEL_S A,
               ZB_DIM.DIM_CHANNEL_TYPE_BSDM       B
         WHERE MONTH_ID = '201501'
           AND PROV_ID = '011'
           AND B.LEVEL_2_CODE = '电子'
           AND A.CHNL_KIND_ID = B.LEVEL_3) B,
       (SELECT DEV_CODE, DEV_NAME
          FROM ZB_DWD.DWD_M_MRT_AL_DEV_MAN_INFO_011
         WHERE MONTH_ID = '201501') C,
       (SELECT * FROM ZB_DIM.V_DIM_AREA) E
 WHERE T.CHANNEL_ID = B.CHNL_ID
   AND T.DEVELOPER_ID = C.DEV_CODE(+)
   AND T.AREA_ID = E.AREA_ID(+)
   AND T.USER_ID = A.USER_ID(+)
固话
  SELECT /*+parallel(T,2)(A,2)(B,2)(C,2)*/
 T.SUBS_ID,
 A.DEVICE_NUMBER,
 '固话' SERV_TYPE,
 C.DEV_CODE,
 C.DEV_NAME,
 T.CHNL_ID,
 B.CHNL_NAME,
 A.INNET_DATE,
 B.LEVEL_1_CODE || B.LEVEL_2_CODE CHNL_TYPE2,
 B.LEVEL_3_CODE CHNL_TYPE3,
 CASE
   WHEN B.STATE = '10' THEN
    '正常'
   WHEN B.STATE = '11' THEN
    '清算'
   WHEN B.STATE = '12' THEN
    '终止'
   ELSE
    '其他'
 END CHNL_STATE,
 T.INCOME
  FROM （SELECT       SUBS_ID,
       AREA_ID,
       CHNL_ID,
       DEVELOPER_NO， SUM(NVL(TOTAL_FEE, 0)) INCOME
  FROM ZB_DWA.DWA_C_M_BDSM_CHNLKPI_MID1_BI --固网
 WHERE ACCT_MONTH = '201501'
   AND PROV_ID = '011'
 GROUP BY SUBS_ID, AREA_ID, CHNL_ID, DEVELOPER_NO
UNION ALL
SELECT SUBS_ID,
       AREA_ID,
       CHNL_ID,
       DEVELOPER_NO， SUM(NVL(TOTAL_FEE, 0)) INCOME
  FROM ZB_DWA.DWA_C_M_BDSM_CHNLKPI_BB_BI –宽带
 WHERE ACCT_MONTH = '201501'
   AND PROV_ID = '011'
   AND SVC_TYPE = '04'
 GROUP BY SUBS_ID,
          AREA_ID,
          CHNL_ID,
          DEVELOPER_NO）T,
          (SELECT USER_ID,
                  DEVICE_NUMBER,
                  TO_CHAR(INNET_DATE, 'YYYYMMDD') INNET_DATE
             FROM ZBA_DWA.DWA_V_M_CUS_FX_USER_INFO_011
            WHERE IS_STAT = '1'
              AND MONTH_ID = '201501'
           UNION ALL
           SELECT USER_ID,
                  SERVICE_ID DEVICE_NUMBER,
                  TO_CHAR(INNET_DATE, 'YYYYMMDD') INNET_DATE
             FROM ZBA_DWA.DWA_DS_M_USER_INFO
            WHERE PROV_ID = '011'
              AND MONTH_ID = '201501'
              AND (SERVICE_TYPE LIKE '0401%' OR SERVICE_TYPE LIKE '0403%')) A,
          (SELECT A.CHNL_KIND_ID,
                  CHNL_ID,
                  CHNL_CODE,
                  CHNL_NAME,
                  STATE,
                  B.LEVEL_1_CODE,
                  B.LEVEL_2_CODE,
                  B.LEVEL_3_CODE
             FROM ZB_DWD.DWD_M_MRT_AL_BSDM_CHANNEL_S A,
                  ZB_DIM.DIM_CHANNEL_TYPE_BSDM       B
            WHERE MONTH_ID = '201501'
              AND PROV_ID = '011'
              AND B.LEVEL_2_CODE = '电子'
              AND A.CHNL_KIND_ID = B.LEVEL_3) B,
          (SELECT DEV_CODE, DEV_NAME, CHNL_ID
             FROM ZB_DWD.DWD_M_MRT_AL_DEV_MAN_INFO_011
            WHERE MONTH_ID = '201501'
              AND PROV_ID = '011') C --发展人信息
 WHERE T.CHNL_ID = B.CHNL_ID
   AND T.DEVELOPER_NO = C.DEV_CODE(+)
   AND T.SUBS_ID = A.USER_ID(+)

其他
SELECT /*+parallel(T,2)(A,2)(B,2)(C,2)*/
 T.SUBS_ID,
 A.SERVICE_ID,
 '其他' SERV_TYPE,
 C.DEV_CODE,
 C.DEV_NAME,
 T.CHNL_ID,
 B.CHNL_NAME,
 A.INNET_DATE,
 B.LEVEL_1_CODE || B.LEVEL_2_CODE CHNL_TYPE2,
 B.LEVEL_3_CODE CHNL_TYPE3,
 CASE
   WHEN B.STATE = '10' THEN
    '正常'
   WHEN B.STATE = '11' THEN
    '清算'
   WHEN B.STATE = '12' THEN
    '终止'
   ELSE
    '其他'
 END CHNL_STATE,
 T.INCOME
  FROM （SELECT SUBS_ID,
       AREA_ID,
       CHNL_ID,
       DEVELOPER_NO,
       SUM(NVL(TOTAL_FEE, 0)) INCOME
  FROM ZB_DWA.DWA_C_M_BDSM_CHNLKPI_BB_BI
 WHERE ACCT_MONTH = '201501'
   AND PROV_ID = '011'
   AND SVC_TYPE <> '04'
 GROUP BY SUBS_ID,
          AREA_ID,
          CHNL_ID,
          DEVELOPER_NO）T,
          (SELECT USER_ID,
                  SERVICE_ID,
                  TO_CHAR(INNET_DATE, 'YYYYMMDD') INNET_DATE
             FROM ZBA_DWA.DWA_DS_M_USER_INFO
            WHERE PROV_ID = '011'
              AND MONTH_ID = '201501'
              AND (SERVICE_TYPE LIKE '0401%' OR SERVICE_TYPE LIKE '0403%')) A,
          (SELECT A.CHNL_KIND_ID,
                  CHNL_ID,
                  CHNL_CODE,
                  CHNL_NAME,
                  STATE,
                  B.LEVEL_1_CODE,
                  B.LEVEL_2_CODE,
                  B.LEVEL_3_CODE
             FROM ZB_DWD.DWD_M_MRT_AL_BSDM_CHANNEL_S A,
                  ZB_DIM.DIM_CHANNEL_TYPE_BSDM       B
            WHERE MONTH_ID = '201501'
              AND PROV_ID = '011'
              AND B.LEVEL_2_CODE = '电子'
              AND A.CHNL_KIND_ID = B.LEVEL_3) B,
          (SELECT DEV_CODE, DEV_NAME, CHNL_ID
             FROM ZB_DWD.DWD_M_MRT_AL_DEV_MAN_INFO_011
            WHERE MONTH_ID = '201501'
              AND PROV_ID = '011') C --发展人信息
 WHERE T.CHNL_ID = B.CHNL_ID
   AND T.DEVELOPER_NO = C.DEV_CODE(+)
   AND T.AREA_ID = D.AREA_ID(+)
应付佣金（计提佣金）
渠道级的佣金
SELECT MONTH_ID,
       CHANNEL_ID,
       CHANNEL_COMM_TYPE,  --佣金类型
       RECORD_TYPE, --数据类型（1、非现返佣金2、补贴佣金，3、现返佣金4、手工调整佣金） 
       SUM(NVL(CHANNEL_COMM_AMOUNT, 0)) COMM_AMMOUNT
  FROM ZB_DWD.DWD_M_MRT_BSDM_CHNL_COMM_011
 WHERE MONTH_ID = '201602'
 GROUP BY MONTH_ID, CHANNEL_ID, CHANNEL_COMM_TYPE, RECORD_TYPE
使用规则：
1. 常用字段如下图方框所示：

2. 数据类型中，补贴佣金也叫渠道补贴；非现返佣金和现返佣金加起来即等同于用户级佣金（即可以落到用户身上的，渠道发展用户所得的佣金）；
3. 佣金类型分为四种，01 ：销售佣金，02 ：清欠佣金，03 ：服务佣金，04 ：奖罚佣金；只有非现返佣金和现返佣金（即用户级佣金）有区分佣金类型，其余两种（补贴佣金和手工调整佣金）不区分佣金类型，对应的列值为空。
用户级佣金
SELECT USER_ID, SUM(NVL(CHANNEL_USER_COMM_AMMOUNT, 0)) COMM_AMMOUNT
  FROM ZB_DWD.DWD_M_MRT_BSDM_USER_COMM_011
 WHERE MONTH_ID = '201602'
   AND SERVICE_TYPE = '01' --业务类型
 GROUP BY USER_ID
使用规则
1.具体各字段取值含义如下所示：
序号	字段编码	字段名称	数据类型	最大长度	说明
1.	USER_NO	用户编号/卡号/渠道ID	CHAR	20	　
2.	SVC_TYPE	业务类型	CHAR	2	取值范围：
01:2G
02:3G
03:固网
04:融合
05:共用
06:4G
3.	COMM_TYPE	佣金类型	CHAR	2	01 ：销售佣金
02 ：清欠佣金
03 ：服务佣金
04 ：奖罚佣金
2.SERVICE_TYPE = ‘03’ 为固网，含固话和宽带
预提佣金
渠道级佣金
/*使用方法同应付佣金口径*/
SELECT MONTH_ID,
       CHANNEL_ID,
       CHANNEL_COMM_TYPE,
       RECORD_TYPE,
       SUM(NVL(CHANNEL_COMM_AMOUNT, 0)) COMM_AMMOUNT
  FROM ZB_DWD.DWD_M_MRT_BSDM_CHNL_YTCOMM_011
 WHERE MONTH_ID = '201602'
 GROUP BY MONTH_ID, CHANNEL_ID, CHANNEL_COMM_TYPE, RECORD_TYPE

用户级佣金
/*使用方法同应付佣金口径*/
SELECT USER_ID, SUM(NVL(CHANNEL_USER_COMM_AMMOUNT, 0)) COMM_AMMOUNT
  FROM ZB_DWD.DWD_M_MRT_BSDM_USER_YTCOMM_011
 WHERE MONTH_ID = '201602'
   AND SERVICE_TYPE = '01' --业务类型
 GROUP BY USER_ID
上层渠道与下属渠道之间关系表（战略渠道相关需求需利用此表）
月表
SELECT *
  FROM ZB_DWA.DWA_C_M_BDSM_CHNLKPI_COL_MID C
 WHERE C.MONTH_ID = '201510'
   AND PROV_ID = '011'
AND CHNL_NO = '09b01ao'

使用规则：
1. CHNL_NO 为上层渠道，CHNL_ID 为下层渠道，限制CHNL_NO可取出其所有下属渠道；
2. CHNL_NO，CHNL_ID 均可和渠道表ZB_DWD.DWD_D_MRT_AL_BSDM_CHANNEL_S进行关联；
3. 因为渠道有分级，一个下级渠道会对应多个上级渠道，一个上级渠道也可能为其他渠道的下级渠道。

若想取最上层的渠道及其下属渠道的方法如下（以管理本部为例）：
SELECT *
  FROM ZB_DWA.DWA_C_M_BDSM_CHNLKPI_COL_MID C 
 WHERE C.MONTH_ID = '201506'
   AND EXISTS (SELECT 1
          FROM ZB_DWD.DWD_M_MRT_AL_BSDM_CHANNEL_S B
         WHERE B.CHNL_KIND_ID = '2040100'  --依据实际情况限制
           AND B.MONTH_ID = '201506'
           AND B.SUPER_CHNL_ID IS NULL
           AND B.IS_SUPER_CHNL = '1'
           AND B.STATE IN ('10', '11') -- 渠道状态：10 正常；11 清算；12 终止，是否限制依据需求情况
           AND B.CHNL_ID = C.CHNL_NO)

日表
SELECT CHNL_NO, CHNL_ID,COUNT(1)
  FROM ZB_DWA.DWA_C_D_BDSM_CHNLKPI_COL_MID C
 WHERE C.MONTH_ID = '201510'
   AND C.DAY_ID BETWEEN '01' AND '15'
   AND PROV_ID = '011'
GROUP BY CHNL_NO, CHNL_ID --GROUP BY 是为了排重

使用规则：
1.表中字段含义同月表；
2.因为日表每天的数据会有重复，如果要取某一段时间的渠道，必须排重；故按照以上SQL对渠道进行排重之后再去和其他表进行关联。
上层加工表
ZB_DWD.DWD_D_A_MRT_CHANNEL_ADDREASS
ESS侧订单
合约理信息表
存费送机和购机送费 订单表：ZB_DWA.DWA_D_ESS_ORD_AGRM
注意：ACTIVITY_TYPE： 2:上网卡,4 存费送机,5购机送费。主要涉及机卡分离、零预存、终端补贴等。
存费送费及存费送业务 订单表：ZB_DWA.DWA_D_ESS_ORD_SAVE_CHARGE
ACTIVITY_TYPE：3:存费送费;6:存费送流量;7:存费送语音;8:存费送短信
零预存
适用范围：存费送机用户 ACTIVITY_TYPE ：4
是否零预存按照担保类型来判断，可参考码表ZB_DIM.DIM_ESS_DEPOSIT_TYPE查看：
04	无担保
05	社保卡担保
07	银行信贷担保
01	担保人
02	保证金担保
03	零信用度
10	专业担保公司担保
11	集客专用银行存款担保(三方协议)
12	基于新险种的保险公司担保
99	固网免预存
06	单位担保
08	银行保险担保
09	银行存款担保
定义：订单里担保类型为如下九种类型的即为零预存
单位担保、固网免预存、银行存款担保、银行保险担保、押金担保（保证金担保）、专业担保公司担保、集客专用银行存款担保、基于新险种的保险公司、中小企业客户固网免预存
其中“中小企业客户固网免预存”已确认目前这个还没有业务，暂时零预存用户按照八类来统计。
对应模型：订单表ZB_DWA.DWA_D_ESS_ORD_AGRM
DEPOSIT_TYPE 担保类型
  ('10', '11', '12', '06', '99', '09', '08', '02') 
注意：使用订单表要剔除返销，目前我们常用到的是剔除当月受理当月返销且仅有一条有效订单，对于隔月返销没有剔除，对于连续受理多条有效订单剔除，需要在邮件中注明，语句：
SELECT *
  FROM (SELECT /*+parallel(a,3)*/
         A.*,
         ROW_NUMBER() OVER(PARTITION BY DEVICE_NUMBER ORDER BY ACCEPT_TIME DESC NULLS LAST) RN
          FROM ZB_DWA.DWA_D_ESS_ORD_AGRM A
         WHERE IS_STA_ORD = '1'
           AND MONTH_ID = '201505'
           AND OPER_PROV_ID = '011') A
 WHERE RN = 1) C, (SELECT /*+parallel(a,3)*/
              DEVICE_NUMBER, SUM(IS_STA_ORD)
               FROM ZB_DWA.DWA_D_ESS_ORD_AGRM A
              WHERE MONTH_ID = '201505'
                AND OPER_PROV_ID = '011'
              GROUP BY DEVICE_NUMBER
             HAVING SUM(IS_STA_ORD) = 1) B
 WHERE B.DEVICE_NUMBER = C.DEVICE_NUMBER
3G机卡分离
SELECT /*+PARALLEL(T,8)*/
T.BSS_DEVICE_NUMBER,
 T.ESS_TERMINAL_ID,
 T.ESS_ACTIVITY_TYPE,
 T.ESS_CHANNEL_ID,
 CASE
   WHEN T.IMEI_TYPE = '04' THEN
    '01' --机卡匹配
   WHEN T.IMEI_TYPE = '03' THEN
    '03' --全月无使用
   WHEN T.IMEI_TYPE = '10' AND IS_INTROAM = '1' AND IS_SPEC = '0' THEN
    '04' --发生国际漫游
   WHEN T.IMEI_TYPE = '10' AND T.IS_SPEC = '0' AND T.IS_INTROAM = '0'
     AND (T.IS_IMEI_UNNOR = '1' OR T.IS_IMEI_NULL = '1' OR T.ESS_IS_IMEI_UNNOR = '1') THEN
    '05' --手机IMEI异常
   WHEN T.IMEI_TYPE = '10' AND T.IS_SPEC = '0' AND T.IS_INTROAM = '0'
     AND T.IS_IMEI_UNNOR = '0' AND T.IS_IMEI_NULL = '0' AND T.ESS_IS_IMEI_UNNOR = '0'
     AND T.IS_OPER = '1' THEN
    '06' --挂失
   WHEN IMEI_TYPE = '10' AND IS_SPEC = '1' THEN
    '07' --白名单
   ELSE
    '02' --机卡分离
 END USER_TYPE
  FROM ZBA_DWA.DWA_V_M_CUS_JKFL_USE_INFO  T
 WHERE T.MONTH_ID = ''|| V_YEARMONTH_OBS ||'' --观察机卡分离账期
   AND T.ESS_MONTH =  ''|| V_YEARMONTH_ACPT ||'' --受理账期
   AND T.PROV_ID='011'
   AND ESS_ACTIVITY_TYPE = '4'

1、分终端
  取上表中的ESS_TERMINAL_ID与ZBA_CODE.DIM_C_TERM_MODEL的TERM_MODEL关联
取ZBA_CODE.DIM_C_TERM_MODEL的TERM_BRAND_DESC品牌，DEVICE_MODEL_DESC终端型号
2、受理量
机卡分离需求里的受理量是取的机卡匹配及机卡分离用户之和，而不是所有的受理用户，剔除不参与比对的特殊用户：白名单用户、国际漫游用户、手机IMEI异常的用户、无使用记录的用户、挂失用户。邮件中告知用户上表中。
SUM(CASE WHEN T.USER_TYPE IN (''01'',''02'') THEN 1 ELSE 0 END)
3、机卡分离用户数
取上表的SUM(CASE WHEN T.USER_TYPE=''02'' THEN 1 ELSE 0 END) 
4、分渠道
取上表中ESS_CHANNEL_TYPE：
CASE
         WHEN SUBSTR(T.ESS_CHANNEL_TYPE, 1, 2) IN ('01','10') THEN
          '自有渠道'
         WHEN SUBSTR(T.ESS_CHANNEL_TYPE,1,2) IN ('02','20') THEN
          '社会渠道'
         ELSE
          '其他渠道'
END

5、分IPHONE,千元智能机、其他
取上表中的ESS_TERMINAL_ID与ZBA_CODE.DIM_C_TERM_MODEL的TERM_MODEL关联取ZBA_CODE.DIM_C_TERM_MODEL的TERM_TYPE5
IPHONE 终端：
SELECT *
  FROM ZBA_CODE.DIM_C_TERM_MODEL
 WHERE UPPER(DEVICE_MODEL_DESC) LIKE '%IPHONE%'
其中根据TERML_TYPE5可部分区分iphone型号，以'01','0105','0106','0107','0108'开头，TERML_TYPE5为空的根据DEVICE_MODEL_DESC可进行再次区分。
千元智能机：TERML_TYPE5 = '02'
终端补贴金额（公允价值法）
取自ZB_DWA.DWA_D_ESS_ORD_AGRM里的SUM(-MOBILE_LOSS_FEE2)
终端补贴金额（剩余价值法）
取自ZB_DWA.DWA_D_ESS_ORD_AGRM里的SUM(-MOBILE_LOSS_FEE1)
终端补贴成本(剩余价值法)
取自ZB_DWA.DWA_D_ESS_ORD_AGRM里的ALLOWANCE_FEE
受理套餐月费
取自ZB_DWA.DWA_D_ESS_ORD_AGRM里的PRO_FEE
注意：套餐名称ess侧取不到，ess侧只能取到套餐月费；
   但是针对终端ess侧详细记录了用户办理合约的时候的终端，这个要比省份上传的合约计划表中的终端准确的多
3G公允值终端补贴金额分摊 
SELECT DEVICE_NUMBER,
       AREA_ID,
       SUM(NVL(MON_SHARE_FEE, 0)) / 100 MON_SHARE_FEE
  FROM ZBA_DWA.DWA_V_M_RES_AL_TERMSUBSIDY_N T
 WHERE MONTH_ID = '201505'
   AND PROV_ID = '011'
 GROUP BY DEVICE_NUMBER, AREA_ID --终端补贴金额分摊
CBSS侧订单
4G合约受理信息表
1. 关于返销字段 CANCEL_FLAG ：正常订单的话，订单标识为0（如果一个订单返销，比如用户2号办理了一个存费送机合约，则2号存在记录标识为0，用户在20号返销这条合约，则先UPDATE表中的订单记录，即把2号订单的标识改为1，然后插入一条新纪录标识为2）.   
2. 关于USER_ID，存在-100的USER_ID，这些用户是因为次月或者次次月才开户的用户，暂时没有分配用户ID导致的
SELECT *
  FROM ZBG_DWA.DWA_S_M_EVT_CB_ACT_TRADE_011@LINK_DSSDWE
 WHERE MONTH_ID = '201501' --受理账期
   AND CANCEL_FLAG = '0' 　 --剔除返销
注意：使用trade_type来剔重，01:开户，02：单卡老用户办理合约，03：合约用户续约，04：迁转合约用户，为空的注意保留。
3. 关于SERIAL_NUMBER，表中存在某些不是电话号码的订单，是因为订购“共享组合套餐”的用户的记录中USER_ID和SERIAL_NUMBER存储的都是组ID和组电话号码字段。如果涉及取“共享组合套餐”的话，需要关联DWA_V_D_CUS_CB_OM_DERIVE_011表，如下。COMP_ID是组USER_ID.
SELECT *
  FROM ZBG_DWA.DWA_V_D_CUS_CB_OM_DERIVE_011@LINK_DSSDWE T
 WHERE T.MONTH_ID = '201412'
   AND T.DAY_ID = '05'
   AND T.COMP_ID = '1114112827882401'

4G零预存
SELECT T.*,
       CASE
         WHEN DEPOSIT_TYPE_CBSS IN ('2', '6', '8', 'D', 'L', 'M', 'N') THEN
          '零预存'
         ELSE
          '非零预存'
       END DEPOSIT_TYPE
  FROM ZBG_DIM.DIM_MAP_CBSS_DEPOSIT_TYPE@LINK_DSSDWE T
4G机卡分离
SELECT *
  FROM ZB_MAC_CD.DW_V_M_CB_USER_PLAN_DTL@LINK_DSSDWE T
 WHERE T.IF_VAILD = '1'
   AND T.IMEI_TYPE = '10' --违约用户 机卡分离
   AND T.UNCOMPARE_TYPE IN ('00', '05') --00：参与比对，05：合约期已超过6个月
   AND T.CONTRACT_TYPE IN ('01', '02', '12') /*01：存费送机，12：合约惠机，02：购机送费*/
   AND T.PROV_ID = '011'
   AND T.MONTH_ID = '201602' --观察机卡分离月
   --AND SUBSTR(PLAN_ACCEPT_DATE, 1, 6) = '201601' --合约受理月





4G裸机销售
SELECT '&month_id',
       SUM(SALE_NUMS)
  FROM ZBG_DWA.DWA_S_D_RES_CB_TERM_SALE_&prov_id@LINK_DSSDWE--日全量表
 WHERE MONTH_ID = '&month_id'
   AND DAY_ID = '&v_day_end'
   AND SALE_TYPE = '3'--销售类型  1 存费送机 2 购机送费 3 裸机 4 合约惠机
   AND SUBSTR(SALE_TIME, 1, 6) = '&month_id';

4G裸机销售明细（剔除返销）
SELECT LJ_4G1.MONTH_ID,
       LJ_4G1.CHANNEL_TYPE,
       LJ_4G1.SALE_TYPE ACTIVITY_TYPE, --销售类型
       LJ_4G1.PURCHASE_PRICE MOB_COST_FEE, --手机成本价
       LJ_4G1.SALE_FEE TERMINAL_FEE, --终端款（销售金额）
       0 CON_PLAN_FEE, --合约计划总价
       SUBSTR(LJ_4G1.IMEI, 1, 8) IMEI_8,
       SUBSTR(LJ_4G1.IMEI, 1, 14) IMEI_14,
       LJ_4G1.TERMINAL_ID,
       LJ_4G1.TERM_TYPE,
       NULL PRODUCT_ID
  FROM (SELECT /*+PARALLEL(A,8)*/
         A.*,
         ROW_NUMBER() OVER(PARTITION BY SUBSTR(IMEI, 1, 14) ORDER BY DAY_ID DESC NULLS LAST) RN
          FROM ZBG_DWD.DWD_D_RES_CB_TERM_SALE_&prov_id@LINK_DSSDWE A--日全量表
         WHERE MONTH_ID = '&month_id'
           AND DAY_ID = '&v_day_end'
           AND SALE_TYPE = '3'--销售类型  1 存费送机 2 购机送费 3 裸机 4 合约惠机
           AND IS_BACK = '0'
           AND SUBSTR(SALE_TIME, 0, 6) = '&month_id'
           AND (CHANNEL_TYPE LIKE '01%' OR CHANNEL_TYPE LIKE '10%') --自有渠道
        ) LJ_4G1,
       (SELECT SUBSTR(IMEI, 1, 14) IMEI, --电子串号
               SUM(CASE WHEN IS_BACK = '1' THEN -1 ELSE 1 END) SALE_NUM --销售量
          FROM ZBG_DWD.DWD_D_RES_CB_TERM_SALE_&prov_id@LINK_DSSDWE
         WHERE MONTH_ID = '&month_id'
           AND DAY_ID = '&v_day_end'
           AND SALE_TYPE = '3' --裸机
           AND SUBSTR(SALE_TIME, 1, 6) = '&month_id'
         GROUP BY SUBSTR(IMEI, 1, 14)
        HAVING SUM(CASE WHEN IS_BACK = '1' THEN -1 ELSE 1 END) >= 1
       ) LJ_4G2
 WHERE LJ_4G1.RN = 1
   AND SUBSTR(LJ_4G1.IMEI, 1, 14) = LJ_4G2.IMEI;
手厅APP
指使用了手机营业厅APP的用户，炎黄厂商按天和按月给经分系统传过来接口表。

手厅APP用户月表

SELECT MONTH_ID, DEVICE_NUMBER, PROVINCE_CODE PROV_ID
  FROM ZBA_DWD.DWD_M_ECS_APP_ACTIVE
 WHERE MONTH_ID = '''||V_MONTH||'''
 AND PROVINCE_CODE ='''||V_PROV||'''
   AND CHNL_TYPE IN (''iphone_c'', ''android'')
 GROUP BY MONTH_ID, DEVICE_NUMBER, PROVINCE_CODE
手厅APP日表
SELECT MONTH_ID, PROV_ID, DAY_ID, DEVICE_NUMBER
  FROM ZBA_DWD.DWD_D_EVT_AL_ECS_PHONEHALL
 WHERE MONTH_ID = '''||V_MONTH||'''
   AND DAY_ID = '''||V_DAY||'''
   AND PROV_ID = '''||V_PROV||'''
   AND RESULT_CODE = ''1''
   AND CHANNEL_ID IN (''113000004'', ''113000005'')
 GROUP BY MONTH_ID, PROV_ID, DAY_ID, DEVICE_NUMBER

客户服务域
移动业务
按照套餐分类
按照用户使用的套餐进行分类
CBSS套餐
手机
维度
信用等级和信用额度
4G用户资料表里的CREDIT_CLASS字段
信用等级A级：CREDIT_CLASS='65'
信用等级B级：CREDIT_CLASS='66'
信用等级C级：CREDIT_CLASS='67'
--4G信用额度，信用等级
SELECT  CREDIT_VALUE, --信用额度：单位是分 
        CREDIT_CLASS  --信用等级：65代表A 66代表B  67代表C
  FROM ZBG_DWA.DWA_V_M_CUS_CB_USER_INFO_'||V_PROV||' @LINK_DSSDWE
 WHERE MONTH_ID = ''201409''
   AND SERVICE_TYPE = ''40AAAAAA''
   AND IS_STAT = ''1''
4G高价值（客服部张驰）
高价值用户口径：入网时间6个月及以上，剔除降欠收入的出账用户，入网时长>=24或者连续6个月ARPU>=90元，包含4G手机。
参考过程P_TEMP_YCH_SNAP_GJZ_4G。高价值用户细分类：
SELECT USER_ID,
       CASE
         WHEN INNET_MONTHS >= 24 AND TOTAL_FEE_6 < 540 THEN
          1 --指入网24个月（含）以上，但不满足连续6个月ARPU大于等于90元
         WHEN INNET_MONTHS < 24 AND TOTAL_FEE_6 >= 540 THEN
          2 --指入网不满足24个月（含）以上，但连续6个月ARPU大于等于90元
         WHEN INNET_MONTHS >= 24 AND TOTAL_FEE_6 >= 540 THEN
          3 --指入网24个月（含）以上且连续6个月ARPU大于等于90元
       END GJZ_TYPE
  FROM TEMP_YCH_SNAP_GJZ_4G
 WHERE MONTH_ID = '201412'
   AND PROV_ID = '011'

4G用户价值标签
SELECT CASE
         WHEN (TA8.USER_LEVEL = '5' AND TA9.STABLE_FLAG = '01') OR
              (TA8.USER_LEVEL = '4' AND TA9.STABLE_FLAG = '01') THEN
          '01' --黄金客户
         WHEN (TA8.USER_LEVEL = '5' AND TA9.STABLE_FLAG = '03') OR
              (TA8.USER_LEVEL = '4' AND TA9.STABLE_FLAG = '03') OR
              (TA8.USER_LEVEL = '3' AND TA9.STABLE_FLAG = '03') THEN
          '02' --高危客户
         WHEN (TA8.USER_LEVEL = '5' AND TA9.STABLE_FLAG = '02') OR
              (TA8.USER_LEVEL = '4' AND TA9.STABLE_FLAG = '02') OR
              (TA8.USER_LEVEL = '3' AND TA9.STABLE_FLAG = '02') THEN
          '03' --波动客户
         WHEN (TA8.USER_LEVEL = '2' AND TA9.STABLE_FLAG = '03') OR
              (TA8.USER_LEVEL = '1' AND TA9.STABLE_FLAG = '02') OR
              (TA8.USER_LEVEL = '2' AND TA9.STABLE_FLAG = '02') THEN
          '04' --低端客户
         WHEN (TA8.USER_LEVEL = '3' AND TA9.STABLE_FLAG = '01') OR
              (TA8.USER_LEVEL = '2' AND TA9.STABLE_FLAG = '01') OR
              (TA8.USER_LEVEL = '1' AND TA9.STABLE_FLAG = '01') THEN
          '05' --潜力客户
         WHEN TA8.USER_LEVEL = '1' AND TA9.STABLE_FLAG = '03' THEN
          '06' --潮汐客户
         ELSE
          '07'
       END
  FROM (SELECT USER_ID,
               IS_CARD,
               NVL(INNET_DATE, '209901') INNET_DATE,
               PRODUCT_CLASS,
               CHANNEL_ID
          FROM ZBG_DWA.DWA_V_M_CUS_CB_USER_INFO_011 @LINK_DSSDWE
         WHERE SERVICE_TYPE = '40AAAAAA'
           AND IS_STAT = '1'
           AND IS_CARD = '0'
           AND MONTH_ID = '201506') T1,
       (SELECT USER_ID, USER_LEVEL
          FROM (SELECT USER_ID,
                       USER_LEVEL,
                       ROW_NUMBER() OVER(PARTITION BY USER_ID ORDER BY MONTH_ID DESC NULLS LAST) RN
                  FROM ZBG_DWA.DWA_V_M_CUS_CBM_VALUE_LIST_011 @LINK_DSSDWE --CBSS用户价值评级模型
                 WHERE MONTH_ID >= '201505'
                   AND MONTH_ID <= '201506')
         WHERE RN = 1) TA8, --CBSS用户价值评级模型
       (SELECT SUBS_INSTANCE_ID USER_ID, STABLE_FLAG --稳定度
          FROM ZBA_DEV.DWA_V_M_4G_LOST_END --CBSS用户稳定度模型
         WHERE MONTH_ID = '201506'
           AND PROV_ID = '011') TA9 --CBSS用户稳定度模型
 WHERE T1.USER_ID = TA8.USER_ID(+)
   AND T1.USER_ID = TA9.USER_ID(+)
           AND C.PAYMENT_OP = '16000' --储值操作类型为“16000 储值”（必加条件）（16000	储值;16001	清退;16003	返销;16004	转出;16005	转入）
         GROUP BY C.USER_ID,C.PAY_METHOD) T3
 WHERE T1.USER_ID = T3.USER_ID(+)
 GROUP BY T1.USER_ID, NVL(T3.PAY_METHOD, '本月无缴费')
指标
上网卡
维度
指标
3G套餐
3G手机
维度
3G高价值（客服部张驰）
高价值用户口径：入网时间6个月及以上，剔除降欠收入的出账用户，入网时长>=24或者连续6个月ARPU>=90元，包含3G手机及23G融合用户。
参考过程P_TEMP_YCH_SNAP_GJZ_3G。高价值用户细分类：
SELECT USER_ID,
       CASE
         WHEN INNET_MONTHS >= 24 AND TOTAL_FEE_6 < 540 THEN
          1 --指入网24个月（含）以上，但不满足连续6个月ARPU大于等于90元
         WHEN INNET_MONTHS < 24 AND TOTAL_FEE_6 >= 540 THEN
          2 --指入网不满足24个月（含）以上，但连续6个月ARPU大于等于90元
         WHEN INNET_MONTHS >= 24 AND TOTAL_FEE_6 >= 540 THEN
          3 --指入网24个月（含）以上且连续6个月ARPU大于等于90元
       END GJZ_TYPE
  FROM TEMP_YCH_SNAP_GJZ_3G
 WHERE MONTH_ID = '201412'
   AND PROV_ID = '011'
3G用户价值（客户标签）
SELECT CASE
         WHEN (TA7.USER_LEVEL = '5' AND TA8.STABLE_FLAG = '01') OR
              (TA7.USER_LEVEL = '4' AND TA8.STABLE_FLAG = '01') THEN
          '01' --黄金客户
         WHEN (TA7.USER_LEVEL = '5' AND TA8.STABLE_FLAG = '03') OR
              (TA7.USER_LEVEL = '4' AND TA8.STABLE_FLAG = '03') OR
              (TA7.USER_LEVEL = '3' AND TA8.STABLE_FLAG = '03') THEN
          '02' --高危客户
         WHEN (TA7.USER_LEVEL = '5' AND TA8.STABLE_FLAG = '02') OR
              (TA7.USER_LEVEL = '4' AND TA8.STABLE_FLAG = '02') OR
              (TA7.USER_LEVEL = '3' AND TA8.STABLE_FLAG = '02') THEN
          '03' --波动客户
         WHEN (TA7.USER_LEVEL = '2' AND TA8.STABLE_FLAG = '03') OR
              (TA7.USER_LEVEL = '1' AND TA8.STABLE_FLAG = '02') OR
              (TA7.USER_LEVEL = '2' AND TA8.STABLE_FLAG = '02') THEN
          '04' --低端客户
         WHEN (TA7.USER_LEVEL = '3' AND TA8.STABLE_FLAG = '01') OR
              (TA7.USER_LEVEL = '2' AND TA8.STABLE_FLAG = '01') OR
              (TA7.USER_LEVEL = '1' AND TA8.STABLE_FLAG = '01') THEN
          '05' --潜力客户
         WHEN TA7.USER_LEVEL = '1' AND TA8.STABLE_FLAG = '03' THEN
          '06' --潮汐客户
         ELSE
          '07'
       END
  FROM (SELECT USER_ID,
               IS_CARD,
               NVL(INNET_DATE, '209901') INNET_DATE,
               IS_THIS_ACCT,
               NVL(PRODUCT_MODE, '020299') PRODUCT_MODE,
               PKG_PROD_CLASS
          FROM ZBA_DWA.DWA_V_M_CUS_3G_USER_INFO_011 A
         WHERE IS_CARD IN ('0', '2')
           AND IS_STAT = '1'
           AND MONTH_ID = '201506') T1,
       (SELECT USER_ID, USER_LEVEL
          FROM (SELECT USER_ID,
                       USER_LEVEL,
                       ROW_NUMBER() OVER(PARTITION BY USER_ID ORDER BY MONTH_ID DESC NULLS LAST) RN
                  FROM ZBA_DWA.DWA_V_M_CUS_MB_VALUE_LIST_011 --BSS用户价值评级模型
                 WHERE MONTH_ID >= '201505'
                   AND MONTH_ID <= '201506')
         WHERE RN = 1) TA7, --BSS用户价值评级模型
       (SELECT SUBS_INSTANCE_ID USER_ID, STABLE_FLAG --稳定度
          FROM ZBA_DEV.DWA_V_M_3G_LOST_END --3G用户稳定度模型
         WHERE MONTH_ID = '201506'
           AND PROV_ID = '011') TA8 --3G用户稳定度模型
 WHERE T1.USER_ID = TA7.USER_ID(+)
   AND T1.USER_ID = TA8.USER_ID(+)
指标
3G用户积分
SELECT SUM(NVL(T.ALL_APPT_SCORE, 0)) USE_SCORES, --本期总应用积分数
       SUM(NVL(T.REW_SCORE, 0)) NEW_REWARD_SCORES, --其中本期新增奖励积分
       SUM(NVL(T.COMM_CONS_SCORE, 0)) NEW_CALL_SCORES, --其中本期新增通信消费积分
       SUM(NVL(T.ALL_PRO_SCORE, 0)) NEW_SCORES, --本期新增积分数,
       '3G',
       IS_THIS_ACCT
  FROM ZBA_DWA.DWA_V_M_CUS_3G_SCORE_INFO_011 T
 GROUP BY IS_THIS_ACCT
积分用户
SELECT SUBS_INSTANCE_ID,
       IS_SCORE, --是否积分用户
       IS_EXCH_SCORE --是本年内否兑换积分
  FROM ZBA_DWA.DWA_V_M_CUS_3G_SCORE_INFO_011
 WHERE MONTH_ID = '201506'

信用额度
SELECT SUBS_INSTANCE_ID, SUM(NOW_CREDIT) NOW_CREDIT
  FROM ZBA_DWD.DWD_M_ACC_AL_CREDIT_011
 WHERE MONTH_ID = '201506'
 GROUP BY SUBS_INSTANCE_ID
23G融合
维度
指标
3G上网卡
维度
指标
2G套餐
维度
指标
用户积分
SELECT SUM(NVL(T.ALL_APPT_SCORE, 0)) USE_SCORES, --本期总应用积分数
       SUM(NVL(T.REW_SCORE, 0)) NEW_REWARD_SCORES, --其中本期新增奖励积分
       SUM(NVL(T.COMM_CONS_SCORE, 0)) NEW_CALL_SCORES, --其中本期新增通信消费积分
       SUM(NVL(T.ALL_PRO_SCORE, 0)) NEW_SCORES, --本期新增积分数,
       '2G',
       IS_THIS_ACCT
  FROM ZBA_DWA.DWA_V_M_CUS_2G_SCORE_INFO_011 T
 WHERE MONTH_ID = '201505'
 GROUP BY IS_THIS_ACCT

是否积分用户
SELECT USER_ID,
       IS_SCORE, --是否积分用户
       IS_EXCH_SCORE --是本年内否兑换积分
  FROM ZBA_DWA.DWA_V_M_CUS_2G_SCORE_INFO_011
 WHERE MONTH_ID = '201506'

2G高价值（客服部张驰）
高价值用户口径：入网时间6个月及以上，剔除降欠收入的出账用户，入网时长>=24或者连续6个月ARPU>=90元，包含2G手机。
参考过程P_TEMP_YCH_SNAP_GJZ_2G。高价值用户细分类：
SELECT USER_ID,
       CASE
         WHEN INNET_MONTHS >= 24 AND TOTAL_FEE_6 < 540 THEN
          1 --指入网24个月（含）以上，但不满足连续6个月ARPU大于等于90元
         WHEN INNET_MONTHS < 24 AND TOTAL_FEE_6 >= 540 THEN
          2 --指入网不满足24个月（含）以上，但连续6个月ARPU大于等于90元
         WHEN INNET_MONTHS >= 24 AND TOTAL_FEE_6 >= 540 THEN
          3 --指入网24个月（含）以上且连续6个月ARPU大于等于90元
       END GJZ_TYPE
  FROM TEMP_YCH_SNAP_GJZ_2G
 WHERE MONTH_ID = '201412'
   AND PROV_ID = '011'
 
2G用户价值（客户标签）
SELECT CASE
         WHEN (TA6.USER_LEVEL = '5' AND TA7.STABLE_FLAG = '01') OR
              (TA6.USER_LEVEL = '4' AND TA7.STABLE_FLAG = '01') THEN
          '01' --黄金客户
         WHEN (TA6.USER_LEVEL = '5' AND TA7.STABLE_FLAG = '03') OR
              (TA6.USER_LEVEL = '4' AND TA7.STABLE_FLAG = '03') OR
              (TA6.USER_LEVEL = '3' AND TA7.STABLE_FLAG = '03') THEN
          '02' --高危客户
         WHEN (TA6.USER_LEVEL = '5' AND TA7.STABLE_FLAG = '02') OR
              (TA6.USER_LEVEL = '4' AND TA7.STABLE_FLAG = '02') OR
              (TA6.USER_LEVEL = '3' AND TA7.STABLE_FLAG = '02') THEN
          '03' --波动客户
         WHEN (TA6.USER_LEVEL = '2' AND TA7.STABLE_FLAG = '03') OR
              (TA6.USER_LEVEL = '1' AND TA7.STABLE_FLAG = '02') OR
              (TA6.USER_LEVEL = '2' AND TA7.STABLE_FLAG = '02') THEN
          '04' --低端客户
         WHEN (TA6.USER_LEVEL = '3' AND TA7.STABLE_FLAG = '01') OR
              (TA6.USER_LEVEL = '2' AND TA7.STABLE_FLAG = '01') OR
              (TA6.USER_LEVEL = '1' AND TA7.STABLE_FLAG = '01') THEN
          '05' --潜力客户
         WHEN TA6.USER_LEVEL = '1' AND TA7.STABLE_FLAG = '03' THEN
          '06' --潮汐客户
         ELSE
          '07'
       END
  FROM (SELECT USER_ID, IS_THIS_ACCT, INNET_DATE, PAY_MODE
          FROM ZBA_DWA.DWA_V_M_CUS_2G_USER_INFO_011 A
         WHERE IS_STAT = '1'
           AND MONTH_ID = '201506') T1,
       (SELECT USER_ID, USER_LEVEL
          FROM (SELECT USER_ID,
                       USER_LEVEL,
                       ROW_NUMBER() OVER(PARTITION BY USER_ID ORDER BY MONTH_ID DESC NULLS LAST) RN
                  FROM ZBA_DWA.DWA_V_M_CUS_MB_VALUE_LIST_011 --BSS用户价值评级模型
                 WHERE MONTH_ID >= '201505'
                   AND MONTH_ID <= '201506')
         WHERE RN = 1) TA6, --BSS用户价值评级模型
       (SELECT USER_ID, STABLE_FLAG --稳定度
          FROM ZBA_DEV.DYL_2G_LOST_FLAG_END2 --2G用户稳定度模型
         WHERE MONTH_ID = '201506'
           AND PROV_ID = '011') TA7 --2G用户稳定度模型
 WHERE T1.USER_ID = TA6.USER_ID(+)
   AND T1.USER_ID = TA7.USER_ID(+)
按照网络分类
按照用户使用的网络进行分类，分为4G网络、3G网络、2G网络和无法识别的网络四种。

相关维度和指标可根据用户的套餐类型（2G/3G/4G）分别按对应口径去取
宽带业务
BSS侧
维度
指标

CBSS侧
维度
指标
固话业务
BSS侧
维度
指标

CBSS侧
维度
指标
融合业务
首先要确定用户属于哪种套餐类型（2G/3G/4G），然后参见不同套餐相关指标的取法，取出对应的维度或指标信息
合作伙伴域
VOP业务
网上用户
SELECT /*+PARALLEL(T,2)*/ *
  FROM ZBA_DWA.DWA_V_M_PRD_VOP_USER_INFO
 WHERE MONTH_ID = '201603'
   AND PROV_ID = '011'
   AND IS_STAT = '1'
   AND IS_INNET = '1'; 
出账用户
SELECT /*+PARALLEL(T,2)*/  *
  FROM ZBA_DWA.DWA_V_M_PRD_VOP_USER_INFO
WHERE MONTH_ID = '201603'
   AND PROV_ID = '011'
   AND IS_STAT = '1'
   AND IS_ACCT = '1'; 
活跃用户
SELECT *
  FROM (SELECT /*+PARALLEL(T,2)*/
         USER_ID
          FROM ZBA_DWA.DWA_V_M_PRD_VOP_USER_INFO
         WHERE MONTH_ID = '201603'
           AND PROV_ID = '011'
           AND IS_STAT = '1'
           AND IS_INNET = '1') T,
       (SELECT USER_ID
          FROM ZBA_DWA.DWA_V_M_CUS_VOP_SING_USE
         WHERE MONTH_ID = '201603'
           AND PROV_ID = '011'
           AND IS_ACTIVE = '1') T2 --活跃用户
 WHERE T.USER_ID = T2.USER_ID(+)
   AND T2.USER_ID IS NOT NULL;
三无用户
SELECT T2.USER_ID,
       CASE WHEN NVL(T2.IS_FLUX, '0') = '0' --无流量
                 AND NVL(T2.SMS_NUM, 0) = 0  --无短信
                 AND NVL(T2.IS_CALL, '0') = '0' --无语音
                 THEN  '1'
            ELSE '0'
       END IS_SANWU1
  FROM (SELECT *
          FROM ZBA_DWA.DWA_V_M_CUS_VOP_SING_USE --VOP单用户使用表
         WHERE MONTH_ID = '201603'
           AND PROV_ID = '011'
         ) T2;
来电显示业务用户
SELECT USER_ID
  FROM ZBA_DWD.DWD_M_ACC_VOP_MONTHLY_FEE T
 WHERE T.MONTH_ID = '201603'
   AND FEE_CODE = 'LDXSJR ' --来电显示
   AND PROV_ID = '011'
   AND FEE > 0
 GROUP BY USER_ID;
 
用户收入
SELECT USER_ID, --用户ID   
       TOTAL_FEE, --总的收入  
       VOICE_FEE, --其中：语音收入 
       SMS_FEE, -- 其中：短信收入 
       FLUX_FEE, --其中：流量收入 
       VAC_FEE, --其中：增值收入 
       MON_FEE, --其中：包月收入 
       BEF_TOTAL_FEE --优惠前收入
  FROM ZBA_DWA.DWA_V_M_CUS_VOP_CHARGE
 WHERE MONTH_ID = '201603'; 
   AND PROV_ID = '011'
计费时长区分漫游地统计
SELECT USER_ID,
       VISIT_AREA_CODE, --漫游地市
       SUM(BASE_BILL_TIMES) TOTAL_BILL_TIMES, --计费时长
       SUM(CASE WHEN CALL_TYPE IN ('01', '03') THEN BASE_BILL_TIMES
                ELSE 0
           END) ZJ_BILL_TIMES, --主叫计费时长
       SUM(CASE WHEN CALL_TYPE IN ('02', '04') THEN BASE_BILL_TIMES
                ELSE 0
           END) BJ_BILL_TIMES --被叫计费时长
  FROM ZBA_DWA.DWA_S_D_USE_VOP_VOICE T
 WHERE MONTH_ID = '201603'
   AND PROV_ID = '011'
 GROUP BY USER_ID, VISIT_AREA_CODE;
公共域
码表
BSS侧
地市编码
ZB_DIM.V_DIM_BI_AREA，用于DW库分地市。此数据与ZB_DIM.V_DIM_AREA一致，但考虑到后期的编码维护会逐步转移到DIM_BI_XXX，故以后使用此编码表
注意：遇到从DM侧提供分地市数据的时候使用以下码表，不用加限制条件。
  SELECT * FROM DMCODE_PUB.DMCODE_AREA@DSSMSS_BA 
套餐码表
ZB_DIM.DIM_PRODUCT_CLASS
1、套餐产品表ZB_DIM.DIM_PRODUCT_CLASS 在使用时，限定业务类型（SERVICE_TYPE）及是否卡类（IS_CARD），但不限定产品是否有效（IS_VALID），剩余关联不到的，统一ESLE 为其他
2、针对下面两个问题，统一对外解释如下：
【出现无效产品问题】解释为存在之前办理的用户，但套餐失效后，用户依然存在，故有失效套餐 
【其他套餐相关问题】解释为非3G手机标准产品的套餐，如果问到上网卡套餐，则应是省份上传问题，现阶段已不存在此类问题
合约类型
SELECT * FROM ZB_DIM.DIM_BI_ACTIVITY_TYPE WHERE IS_ZB_ACTIVITY = '1'
01	预存话费送手机
02	购手机送话费
03	存费送费
06	预存话费送业务(送语音)
07	预存话费送业务(送流量)
08	预存话费送业务(送短信)
注意：
存费送业务从201310月账期开始生效，而页面上是从201311月才展现存费送业务数据。
业务类型
SELECT * FROM ZB_DIM.DIM_BI_SERVICE_TYPE WHERE IS_VALID='1'
注意：从8月账期开始增加了以下编码：
2001AAAA	2G移动电话
200101AA	GSM电话
200102AA	无线座机
2002AAAA	2G公用电话
2099AAAA	2G其他基础语音业务
以后所有涉及要限制SERVICE_TYPE为2G的都要做如下设置
SERVICE_TYPE IN ('20AAAAAA','2001AAAA','200101AA','200102AA','2002AAAA','2099AAAA')
计费模式
SELECT * FROM ZB_DIM.DIM_BI_PROD_BILL_MODE
01	包年      
02	包季度    
03	包月限时  
04	包月不限时
05	包天      
06	按时      
07	按业务量
08	包半年
09	包多月
99	其它      
城乡类型
01	城市
02	乡村
99	其它
服务标识
SELECT *  FROM ZB_DIM.DIM_BI_SERVE_ID
0001	基本语音
0002	国内长途
0003	国际长途
0004	国内漫游
0005	国际漫游
0101	短信
0102	GPRS
0103	WCDMA
0104	WLAN
0201	来电显示
0202	呼叫转移
9999	其他
0105	LTE
省会城市码表
DIM_PROV_AREA
国家代码表
ZB_DIM.DIM_BI_STATE_CODE
可以与ZBG_DWA.DWA_S_M_USE_CB_FLUX_011@LINK_DSSDWE 里的 ROAM_AREA_CODE关联，由于ROAM_AREA_CODE数据长度不一致，需做如下处理：
  SELECT DISTINCT T.ROAM_AREA_CODE, T1.STATE_CODE_DESC
  FROM (SELECT SUBSTR('00000' || ROAM_AREA_CODE, -5, 5) ROAM_AREA_CODE,
                  LPAD(ROAM_AREA_CODE, 5, 0) --自动在左边补0
          FROM ZBG_DWA.DWA_S_M_USE_CB_FLUX_011@LINK_DSSDWE
         WHERE MONTH_ID = '201509'
           AND ROAM_TYPE IN ('0203', '0204')) T,
       ZB_DIM.DIM_BI_STATE_CODE T1
 WHERE T.ROAM_AREA_CODE = T1.STATE_CODE(+)
漫游类型
SELECT * FROM ZB_DIM.DIM_BI_ROAM_TYPE
终端品牌、终端型号
使用imei前八位与ZB_OUT.ZB_M_TAC_INFO中TAC字段关联，MANU_NAME 终端品牌,MODEL_NAME 终端型号
SELECT * FROM  ZB_OUT.ZB_M_TAC_INFO
CBSS侧
合约码表
SELECT *
  FROM ZBG_DIM.DIM_CBSS_ACTIVITY_TYPE@LINK_DSSDWE
 WHERE IS_VALID = '1' –在网 
   AND ACTIVITY_TYPE <> '04'
渠道偏好
SELECT USER_ID, CHNL_TYPE1
  FROM ZB_CSM.DWA_V_M_QUDAO_ALL_ST8_2
 WHERE PROV_ID = '079'
   AND MONTH_ID = '&max_month' --取模型支撑的最大账期值，使用之前注意查一下数据的最新账期
   AND NET_TYPE LIKE '4G%' --注意修改业务类型：4G,3G,2G
归集标签
取用户资料表中的USER_ID字段，与 ZBA_DWD.DWD_M_PRD_AL_GC_USER_FLAG_PROV（集客标签表） 中 USER_ID 进行关联，取集客标签表中BELONG_FLAG字段，无需限定其他条件，取值为0集团，1和空为公众。

注意：
1. 集客标签表ZBA_DWD.DWD_M_PRD_AL_GC_USER_FLAG_PROV数据从201308账期开始具备
2. 2013年10月账期之前如下集客标签表一直使用
SELECT /*+PARALLEL(T,2)*/
 T.USER_ID, T.INCOME_BELONG_FLAG -- 1和空的都是公众，0是集团
  FROM ZBA_DWA.DWA_V_D_CUS_GROUP_FLAG_011 T
 WHERE MONTH_ID = '201306'
   AND DAY_ID = '03'
3. OCS上网卡部分关联集客标签的时候只需要关联北京的集客标签表,如下例：
SELECT '201404',
       '011',
       AREA_ID,
       'OCS' NETTYPE,
       A.USER_ID,
       NVL(BELONG_FLAG, '1') BELONG_FLAG,
       NVL(USER_GROUP_FLAG, '1') USER_GROUP_FLAG,
       IS_INNET,
       IS_THIS_ACCT
  FROM (SELECT SUBS_INSTANCE_ID USER_ID, AREA_ID, IS_INNET, IS_THIS_ACCT
          FROM ZBA_DWA.DWA_V_M_CUS_OCS_USER_INFO
         WHERE IS_TEST = '0'
           AND STATUS_ID NOT IN ('51', '13')
           AND PROV_ID = '011'
           AND MONTH_ID = '201404') A,
       (SELECT USER_ID, BELONG_FLAG, USER_GROUP_FLAG
          FROM ZBA_DWD.DWD_M_PRD_AL_GC_USER_FLAG_011
         WHERE MONTH_ID = '201404') B
 WHERE A.USER_ID = B.USER_ID(+)
用户群标签
取ZBA_DWD.DWD_M_PRD_AL_GC_USER_FLAG表的USER_GROUP_FLAG，0为集团客户，空和1为公众用户，与用户资料表的关联方法详见公共域—归集标签。
中小企业（只针对集客用户）
首先限定集客用户（集客用户取法详见公共域—归集标签），
再通过USER_ID与ZBA_DWA.DWA_V_M_CUS_AL_GC_RELATION模型关联，利用该模型中CUST_SIZE来区分用户的企业类型。

利用CUST_SIZE区分用户企业类型的方法如下：
DECODE(CUST_SIZE,'1','小微','2','中小企业','3','大客户','其他')

终端模型
老终端模型
2G套餐&3G套餐
201403账期之前
SELECT USER_ID, ONEIN1MON_TERM_TYPE --00,2G，3G，4G
  FROM ZBA_DWA.DWA_V_M_CUS_MB_SI_IMEI_IF_&PROV_ID
 WHERE MONTH_ID = '&MONTH_ID'
   AND IS_RECOGNIZABLE_TERM = '1';
201403账期及之后
SELECT USER_ID, ONEIN1MON_TERM_TYPE_4G --00,2G，3G，4G
  FROM ZBA_DWA.DWA_V_M_CUS_MB_SI_IMEI_IF_&PROV_ID
 WHERE MONTH_ID = '&MONTH_ID'
   AND IS_RECOGNIZABLE_TERM = '1';
4G套餐
SELECT USER_ID, ONEIN1MON_TERM_TYPE --00,2G，3G，4G
  FROM ZBG_DWA.DWA_V_M_CUS_CB_SING_IMEI_&PROV_ID@LINK_DSSDWE
 WHERE MONTH_ID = '&MONTH_ID'
   AND IS_RECOGNIZABLE_TERM = '1';
新终端模型
 
1.  DATA_SOURCE 1 ESS 2 CB
2.      3G部分渠道类型不可用，渠道编码从第三位截取
3.      包含转网用户终端
4.      自备机办理合约也包括在内
先裸机购买终端，然后再办理合约，保留的是合约销售的记录
SELECT A.*
  FROM ZBG_DWA.DWA_V_M_TERM_SALE@LINK_DSSDWE A
WHERE MONTH_ID = '201708'
   AND IS_BACK = '0'
   AND PROV_ID = '011'

纯综采终端模型（2G套餐&3G套餐&4G套餐）
SELECT USER_ID, --对应ZBG_DWA.DWA_V_M_CUS_NM_USER_INFO_&prov_id@LINK_DSSDWE中user_id，即新网络模型新user_id
       ONEIN1MON_NET_TYPE_REV-- 00=无法区分，04=4G、03=3G、02=2G
  FROM ZBG_DWA.DWA_V_M_CUS_ALL_ZCTMF2_011@LINK_DSSDWE
 WHERE MONTH_ID = '201602'
   AND SERVICE_TYPE LIKE '40%'; --套餐类型 2G套餐：LIKE '20%'；3G套餐：LIKE '30%'；4G套餐：LIKE '40%'；
分网络流量模型
O域模型(DEVICE_NUMBER唯一)
2G套餐&3G套餐 
2G、3G、4G的O域流量都是取自表ZBA_DWA.DWA_V_CUS_ALL_IMEI_FLUX，通过DEVICE_NUMBER与对应的用户资料表进行关联

SELECT CASE
         WHEN FLUX_2G > 0 AND FLUX_3G = 0 AND FLUX_4G = 0 AND FLUX_WZ = 0 THEN
          '只在2G网络上使用'
         WHEN FLUX_2G = 0 AND FLUX_3G > 0 AND FLUX_4G = 0 AND FLUX_WZ = 0 THEN
          '只在3G网络上使用'
         WHEN FLUX_2G = 0 AND FLUX_3G = 0 AND FLUX_4G > 0 AND FLUX_WZ = 0 THEN
          '只在4G网络上使用'
         WHEN FLUX_2G > 0 AND FLUX_3G > 0 AND FLUX_4G = 0 AND FLUX_WZ = 0 THEN
          '在2G网络/3G网络上都使用过'
         WHEN FLUX_2G > 0 AND FLUX_3G = 0 AND FLUX_4G > 0 AND FLUX_WZ = 0 THEN
          '在2G网络/4G网络上都使用过'
         WHEN FLUX_2G = 0 AND FLUX_3G > 0 AND FLUX_4G > 0 AND FLUX_WZ = 0 THEN
          '在3G网络/4G网络上都使用过'
         WHEN FLUX_2G > 0 AND FLUX_3G > 0 AND FLUX_4G > 0 AND FLUX_WZ = 0 THEN
          '在2G网络/3G网络/4G网络上都使用过'
         WHEN FLUX_2G > 0 AND FLUX_3G = 0 AND FLUX_4G = 0 AND FLUX_WZ > 0 THEN
          '在2G网络/无法区分的网络上使用过'
         WHEN FLUX_2G = 0 AND FLUX_3G > 0 AND FLUX_4G = 0 AND FLUX_WZ > 0 THEN
          '在3G网络/无法区分的网络上使用过'
         WHEN FLUX_2G = 0 AND FLUX_3G = 0 AND FLUX_4G > 0 AND FLUX_WZ > 0 THEN
          '在4G网络/无法区分的网络上使用过'
         WHEN FLUX_2G > 0 AND FLUX_3G > 0 AND FLUX_4G = 0 AND FLUX_WZ > 0 THEN
          '在2G网络/3G网络/无法区分的网络上使用过'
         WHEN FLUX_2G = 0 AND FLUX_3G > 0 AND FLUX_4G > 0 AND FLUX_WZ > 0 THEN
          '在3G网络/4G网络/无法区分的网络上使用过'
         WHEN FLUX_2G > 0 AND FLUX_3G = 0 AND FLUX_4G > 0 AND FLUX_WZ > 0 THEN
          '2G网络/4G网络/无法区分的网络上使用过'
         WHEN FLUX_2G > 0 AND FLUX_3G > 0 AND FLUX_4G > 0 AND FLUX_WZ > 0 THEN
          '2G网络/3G网络/4G网络/无法区分的网络上使用过'
         WHEN NVL(FLUX, 0) = 0 THEN
          '0流量'
         ELSE
          '完全无法区分'
       END NET_TYPE,
       SUM(FLUX_2G) FLUX_2G_ALL,
       SUM(FLUX_3G) FLUX_3G_ALL,
       SUM(FLUX_4G) FLUX_4G_ALL,
       SUM(FLUX_WZ) FLUX_WZ_ALL
  FROM (SELECT MONTH_ID, PROV_ID, AREA_ID, USER_ID, DEVICE_NUMBER, IS_CARD
          FROM ZBA_DWA.DWA_V_M_CUS_3G_USER_INFO_030
         WHERE IS_THIS_ACCT = '1'
           AND IS_STAT = '1'
           AND IS_CARD IN ('0', '2')
           AND MONTH_ID = '201504') A,
       (SELECT MONTH_ID,
               PROV_DESC,
               DEVICE_NUMBER,
               SUM(FLUX_2G) FLUX_2G, --2G流量
               SUM(FLUX_3G) FLUX_3G, --3G流量
               SUM(FLUX_4G) FLUX_4G, --4G流量
               SUM(FLUX) FLUX, --总流量
               SUM(FLUX_WZ) FLUX_WZ --无法区分流量
          FROM ZBA_DWA.DWA_V_CUS_ALL_IMEI_FLUX
         WHERE MONTH_ID = '201504'
           AND PROV_DESC = '030'
         GROUP BY MONTH_ID, PROV_DESC, DEVICE_NUMBER) B
 WHERE A.DEVICE_NUMBER = B.DEVICE_NUMBER(+)
 GROUP BY CASE
            WHEN FLUX_2G > 0 AND FLUX_3G = 0 AND FLUX_4G = 0 AND FLUX_WZ = 0 THEN
             '只在2G网络上使用'
            WHEN FLUX_2G = 0 AND FLUX_3G > 0 AND FLUX_4G = 0 AND FLUX_WZ = 0 THEN
             '只在3G网络上使用'
            WHEN FLUX_2G = 0 AND FLUX_3G = 0 AND FLUX_4G > 0 AND FLUX_WZ = 0 THEN
             '只在4G网络上使用'
            WHEN FLUX_2G > 0 AND FLUX_3G > 0 AND FLUX_4G = 0 AND FLUX_WZ = 0 THEN
             '在2G网络/3G网络上都使用过'
            WHEN FLUX_2G > 0 AND FLUX_3G = 0 AND FLUX_4G > 0 AND FLUX_WZ = 0 THEN
             '在2G网络/4G网络上都使用过'
            WHEN FLUX_2G = 0 AND FLUX_3G > 0 AND FLUX_4G > 0 AND FLUX_WZ = 0 THEN
             '在3G网络/4G网络上都使用过'
            WHEN FLUX_2G > 0 AND FLUX_3G > 0 AND FLUX_4G > 0 AND FLUX_WZ = 0 THEN
             '在2G网络/3G网络/4G网络上都使用过'
            WHEN FLUX_2G > 0 AND FLUX_3G = 0 AND FLUX_4G = 0 AND FLUX_WZ > 0 THEN
             '在2G网络/无法区分的网络上使用过'
            WHEN FLUX_2G = 0 AND FLUX_3G > 0 AND FLUX_4G = 0 AND FLUX_WZ > 0 THEN
             '在3G网络/无法区分的网络上使用过'
            WHEN FLUX_2G = 0 AND FLUX_3G = 0 AND FLUX_4G > 0 AND FLUX_WZ > 0 THEN
             '在4G网络/无法区分的网络上使用过'
            WHEN FLUX_2G > 0 AND FLUX_3G > 0 AND FLUX_4G = 0 AND FLUX_WZ > 0 THEN
             '在2G网络/3G网络/无法区分的网络上使用过'
            WHEN FLUX_2G = 0 AND FLUX_3G > 0 AND FLUX_4G > 0 AND FLUX_WZ > 0 THEN
             '在3G网络/4G网络/无法区分的网络上使用过'
            WHEN FLUX_2G > 0 AND FLUX_3G = 0 AND FLUX_4G > 0 AND FLUX_WZ > 0 THEN
             '2G网络/4G网络/无法区分的网络上使用过'
            WHEN FLUX_2G > 0 AND FLUX_3G > 0 AND FLUX_4G > 0 AND FLUX_WZ > 0 THEN
             '2G网络/3G网络/4G网络/无法区分的网络上使用过'
            WHEN NVL(FLUX, 0) = 0 THEN
             '0流量'
            ELSE
             '完全无法区分'
          END;
4G套餐
SELECT CASE
         WHEN FLUX_2G > 0 AND FLUX_3G = 0 AND FLUX_4G = 0 AND FLUX_WZ = 0 THEN
          '只在2G网络上使用'
         WHEN FLUX_2G = 0 AND FLUX_3G > 0 AND FLUX_4G = 0 AND FLUX_WZ = 0 THEN
          '只在3G网络上使用'
         WHEN FLUX_2G = 0 AND FLUX_3G = 0 AND FLUX_4G > 0 AND FLUX_WZ = 0 THEN
          '只在4G网络上使用'
         WHEN FLUX_2G > 0 AND FLUX_3G > 0 AND FLUX_4G = 0 AND FLUX_WZ = 0 THEN
          '在2G网络/3G网络上都使用过'
         WHEN FLUX_2G > 0 AND FLUX_3G = 0 AND FLUX_4G > 0 AND FLUX_WZ = 0 THEN
          '在2G网络/4G网络上都使用过'
         WHEN FLUX_2G = 0 AND FLUX_3G > 0 AND FLUX_4G > 0 AND FLUX_WZ = 0 THEN
          '在3G网络/4G网络上都使用过'
         WHEN FLUX_2G > 0 AND FLUX_3G > 0 AND FLUX_4G > 0 AND FLUX_WZ = 0 THEN
          '在2G网络/3G网络/4G网络上都使用过'
         WHEN FLUX_2G > 0 AND FLUX_3G = 0 AND FLUX_4G = 0 AND FLUX_WZ > 0 THEN
          '在2G网络/无法区分的网络上使用过'
         WHEN FLUX_2G = 0 AND FLUX_3G > 0 AND FLUX_4G = 0 AND FLUX_WZ > 0 THEN
          '在3G网络/无法区分的网络上使用过'
         WHEN FLUX_2G = 0 AND FLUX_3G = 0 AND FLUX_4G > 0 AND FLUX_WZ > 0 THEN
          '在4G网络/无法区分的网络上使用过'
         WHEN FLUX_2G > 0 AND FLUX_3G > 0 AND FLUX_4G = 0 AND FLUX_WZ > 0 THEN
          '在2G网络/3G网络/无法区分的网络上使用过'
         WHEN FLUX_2G = 0 AND FLUX_3G > 0 AND FLUX_4G > 0 AND FLUX_WZ > 0 THEN
          '在3G网络/4G网络/无法区分的网络上使用过'
         WHEN FLUX_2G > 0 AND FLUX_3G = 0 AND FLUX_4G > 0 AND FLUX_WZ > 0 THEN
          '2G网络/4G网络/无法区分的网络上使用过'
         WHEN FLUX_2G > 0 AND FLUX_3G > 0 AND FLUX_4G > 0 AND FLUX_WZ > 0 THEN
          '2G网络/3G网络/4G网络/无法区分的网络上使用过'
         WHEN NVL(FLUX, 0) = 0 THEN
          '0流量'
         ELSE
          '完全无法区分'
       END NET_TYPE,
       SUM(FLUX_2G) FLUX_2G_ALL,
       SUM(FLUX_3G) FLUX_3G_ALL,
       SUM(FLUX_4G) FLUX_4G_ALL,
       SUM(FLUX_WZ) FLUX_WZ_ALL
  FROM (SELECT /*+parallel(t,2)*/
         MONTH_ID, PROV_ID, AREA_ID, USER_ID, DEVICE_NUMBER
          FROM ZBG_DWA.DWA_V_M_CUS_CB_USER_INFO_030@LINK_DSSDWE T
         WHERE T.MONTH_ID = '201504'
           AND T.IS_STAT = '1' ---观察
           AND T.SERVICE_TYPE = '40AAAAAA'
           AND T.IS_ACCT = '1') A,
       (SELECT MONTH_ID,
               PROV_DESC,
               DEVICE_NUMBER,
               SUM(FLUX_2G) FLUX_2G, --2G流量
               SUM(FLUX_3G) FLUX_3G, --3G流量
               SUM(FLUX_4G) FLUX_4G, --4G流量
               SUM(FLUX) FLUX, --总流量
               SUM(FLUX_WZ) FLUX_WZ --无法区分流量
          FROM ZBA_DWA.DWA_V_CUS_ALL_IMEI_FLUX
         WHERE MONTH_ID = '201504'
           AND PROV_DESC = '030'
         GROUP BY MONTH_ID, PROV_DESC, DEVICE_NUMBER) B
 WHERE A.DEVICE_NUMBER = B.DEVICE_NUMBER(+)
 GROUP BY CASE
            WHEN FLUX_2G > 0 AND FLUX_3G = 0 AND FLUX_4G = 0 AND FLUX_WZ = 0 THEN
             '只在2G网络上使用'
            WHEN FLUX_2G = 0 AND FLUX_3G > 0 AND FLUX_4G = 0 AND FLUX_WZ = 0 THEN
             '只在3G网络上使用'
            WHEN FLUX_2G = 0 AND FLUX_3G = 0 AND FLUX_4G > 0 AND FLUX_WZ = 0 THEN
             '只在4G网络上使用'
            WHEN FLUX_2G > 0 AND FLUX_3G > 0 AND FLUX_4G = 0 AND FLUX_WZ = 0 THEN
             '在2G网络/3G网络上都使用过'
            WHEN FLUX_2G > 0 AND FLUX_3G = 0 AND FLUX_4G > 0 AND FLUX_WZ = 0 THEN
             '在2G网络/4G网络上都使用过'
            WHEN FLUX_2G = 0 AND FLUX_3G > 0 AND FLUX_4G > 0 AND FLUX_WZ = 0 THEN
             '在3G网络/4G网络上都使用过'
            WHEN FLUX_2G > 0 AND FLUX_3G > 0 AND FLUX_4G > 0 AND FLUX_WZ = 0 THEN
             '在2G网络/3G网络/4G网络上都使用过'
            WHEN FLUX_2G > 0 AND FLUX_3G = 0 AND FLUX_4G = 0 AND FLUX_WZ > 0 THEN
             '在2G网络/无法区分的网络上使用过'
            WHEN FLUX_2G = 0 AND FLUX_3G > 0 AND FLUX_4G = 0 AND FLUX_WZ > 0 THEN
             '在3G网络/无法区分的网络上使用过'
            WHEN FLUX_2G = 0 AND FLUX_3G = 0 AND FLUX_4G > 0 AND FLUX_WZ > 0 THEN
             '在4G网络/无法区分的网络上使用过'
            WHEN FLUX_2G > 0 AND FLUX_3G > 0 AND FLUX_4G = 0 AND FLUX_WZ > 0 THEN
             '在2G网络/3G网络/无法区分的网络上使用过'
            WHEN FLUX_2G = 0 AND FLUX_3G > 0 AND FLUX_4G > 0 AND FLUX_WZ > 0 THEN
             '在3G网络/4G网络/无法区分的网络上使用过'
            WHEN FLUX_2G > 0 AND FLUX_3G = 0 AND FLUX_4G > 0 AND FLUX_WZ > 0 THEN
             '2G网络/4G网络/无法区分的网络上使用过'
            WHEN FLUX_2G > 0 AND FLUX_3G > 0 AND FLUX_4G > 0 AND FLUX_WZ > 0 THEN
             '2G网络/3G网络/4G网络/无法区分的网络上使用过'
            WHEN NVL(FLUX, 0) = 0 THEN
             '0流量'
            ELSE
             '完全无法区分'
          END;
O域模型(USER_ID唯一)
2G套餐&3G套餐
SELECT MONTH_ID,
       PROV_ID,
       USER_ID,
       MAX(NET_TYPE) --00 无法区分,02 2G,03 3G,04 4G
       SUM(FLUX_2G) FLUX_2G,
       SUM(FLUX_3G) FLUX_3G,
       SUM(FLUX_4G) FLUX_4G,
       SUM(FLUX) FLUX,
       SUM(FLUX_WZ) FLUX_WZ
  FROM ZBA_DWA.DWA_V_M_CUS_MB_NET_CARRY_010 T
 WHERE MONTH_ID = '201512'
 GROUP BY MONTH_ID, PROV_ID, USER_ID;
4G套餐
SELECT MONTH_ID,
       PROV_ID,
       USER_ID,
       MAX(NET_TYPE) --00 无法区分,02 2G,03 3G,04 4G
       SUM(FLUX_2G) FLUX_2G,
       SUM(FLUX_3G) FLUX_3G,
       SUM(FLUX_4G) FLUX_4G,
       SUM(FLUX) FLUX,
       SUM(FLUX_WZ) FLUX_WZ
  FROM ZBG_DWA.DWA_V_M_CUS_CB_NET_CARRY_010@LINK_DSSDWE T
 WHERE MONTH_ID = '201512'
 GROUP BY MONTH_ID, PROV_ID, USER_ID
纯综采模型（2G套餐&3G套餐&4G套餐）
SELECT DEVICE_NUMBER,
       SUM(NVL(FLUX_2G, 0)),--2G网络流量
       SUM(NVL(FLUX_3G, 0)),--3G网络流量
       SUM(NVL(FLUX_4G, 0)),--4G网络流量
       SUM(NVL(FLUX_NULL, 0) + NVL(FLUX_OTHER, 0)) FLUX_OTHER,--其他网络流量
       SUM(NVL(FLUX, 0)) FLUX--总流量
  FROM ZBG_DWA.DWA_V_M_CUS_PP_USER_NET_011@LINK_DSSDWE
 WHERE MONTH_ID = '201603'
 GROUP BY DEVICE_NUMBER;

取综采使用的终端的价值(不区分234G)
select * from (SELECT USER_ID,
               ONEIN1MON_VERSION_TYPE,
               ONEIN1MON_TERM_IMEI,
               ONEIN1MON_TERM_TAC
          FROM ZBG_DWA.DWA_V_M_CUS_ALL_ZCTMF2_'||V_PROV||'@LINK_DSSDWE
         WHERE MONTH_ID = '''||V_MONTH||''') A,

      (SELECT TAC, MODEL_ID
                          FROM ZBG_DWA.DIM_TAC_LABEL@LINK_DSSDWE
                         GROUP BY TAC,MODEL_ID) B,
   (SELECT SUBSTR(IMEI, 1, 14) IMEI_14,
                               MODEL_ID
                          FROM ZBG_DWA.DIM_IMEI_LABEL@LINK_DSSDWE
                         GROUP BY SUBSTR(IMEI, 1, 14),
                                  MODEL_ID) C,
       terbi.marketing_name_price201708 D1,
       terbi.marketing_name_price201708 D2
       where SUBSTR(A.ONEIN1MON_TERM_IMEI, 0, 8) = B.TAC(+)
                   AND SUBSTR(A.ONEIN1MON_TERM_IMEI, 0, 14) = C.IMEI_14(+)
                   and B.MODEL_ID=D1.MODEL_ID(+)
                   and C.MODEL_ID=D2.MODEL_ID(+);
                   
                   select * from  terbi.marketing_name_price201708
查询指标/来源表/过程常用语句
指标来源表查询
16库上，或Dblink @DSSMSS_BA连接：
根据指标名称模糊查询：
SELECT *
  FROM ZBA_DM_MAN.ISP_ENTITY_KPI_ORDER
 WHERE IS_VALID = '1'
   AND KPI_NAME LIKE '%积分%';
组合指标查询可参考：
SELECT *
  FROM ZBA_DM_MAN.DMCODE_COMP_KPI
 WHERE COMP_KPI_NAME LIKE '%上网出账%';
其余方法：
SELECT /* + PARALLEL (T, 8)*/
 *
  FROM ZBA_DM_MAN.DMCODE_ALL_KPI_LIB T
 WHERE T.COMP_KPI_CODE IN ('NZHTJ1104'); --指标配置表（M域）

SELECT /* + PARALLEL (T, 4)*/
 T.IS_VALID, T.*
  FROM ZBA_DM_MAN.DMCODE_COMP_KPI T
 WHERE T.COMP_KPI_CODE IN = 'CKP_10763' --指标配置表
查询来源表/过程
DM层查询来源表
SELECT *
   FROM ZBA_DM_MAN.ISP_ENTITY_KPI_ORDER T --指标订购表
WHERE T.DST_ENTITY_NAME = 'DM_C_D_CNT_RH_WIT_USER';

SELECT *
  FROM ZBA_DM_MAN.ISP_ENTITY_ETL T --指标字段映射表
 WHERE T.DST_ENTITY_NAME = 'DM_C_D_CNT_RH_WIT_USER';
页面s_表查询数据源：
SELECT *
  FROM ZBA_DM_MAN.ISP_ENTITY_ETL_STG
 WHERE DST_ENTITY_NAME = 'S_DM_C_CNT_RH_WIT_BASE_D';
模糊查询过程（DM层、DW层、33库都适用）
ALL_SOURCE表，可用于各种过程查询。不能登陆的数据库，利用dblink连接查询。
以4G过程举例：
1、只知道表或模糊的描述，不知道过程：
SELECT *
  FROM ALL_SOURCE @LINK_DSSDWE
 WHERE UPPER(TEXT) LIKE '%DWA_V_M_CUS_CB_USER_INFO%'
2、知道过程：
 SELECT *
  FROM ALL_SOURCE @LINK_DSSDWE
 WHERE NAME = 'P_DWA_V_M_CUS_CB_USER_INFO'
模糊查询表
适用于找表、表的用户名、或模糊的表名
SELECT TABLE_NAME,OWNER FROM ALL_TABLES WHERE TABLE_NAME LIKE '%CITY%' AND OWNER='ZB_DIM';
33库视图查询
 SELECT * FROM ALL_VIEWS@LINK_DSSDWE WHERE VIEW_NAME LIKE '%V_DM_C_D_CNT_RH_WIT_BASE%'
查找接口表
BSS
--明细对应表及流程的表  
SELECT * FROM ZB_SRC.ZB_SYS_FILE_TABLE_MAP WHERE TAB_NAME LIKE '%BIDWMB02003%'; --接口文档编码
SELECT * FROM ZB_SRC.ZB_SYS_FILE_TABLE_MAP WHERE FILE_NAME LIKE '%彩信%'; --文件名查询
接口文档名称含义解释：例 CMYY02AYYYYMM001
C 代表正式, A 表示第一次上传，要是这位是“B”，表示重传的文件，YYYYMM 是年月，这几个都去掉。
CBSS
--接口表查询 
SELECT *
  FROM ZBG_DI.ZB_SYS_CBSS_TABLE_MAP@LINK_DSSDWE
 WHERE TABLE_NAME LIKE '%SRC_D_BCD02003%'; --知道接口表
SELECT *
  FROM ZBG_DI.ZB_SYS_CBSS_TABLE_MAP@LINK_DSSDWE
 WHERE TABLE_NAME_ODS LIKE '%TD_S_CODE_STATIC%'---接口规范对应表
页面指标查询举例
举例
3G套餐-->3G业务-->计费收入(日)，3G业务计费收入
1、查询页面表和对应的模块编码、模块对应表名
SELECT *
  FROM ISP_DSS.KC_DIM_APP_BASE_INFO
 WHERE DATE_TYPE = 'D'
   AND UPPER(APP_CLASS) = '3G'
   AND APP_NAME = '计费收入';

2、查询指标名称对应的KPI_CODE   
SELECT *
  FROM ISP_DSS.KC_DM_APPKPI_MAP_INFO T
 WHERE DATE_TYPE = 'D'
   AND APP_CODE = '000211'
   AND T.DISPLAY_KPI_NAME LIKE '%3G业务计费收入%';
   
3、查询页面表中数据
SELECT *
  FROM DM.V_DM_KPI_D_000211 T
 WHERE T.MONTH_ID = '201404'
   AND T.DAY_ID = '15'
   AND T.PROV_ID = '111'
   AND T.KPI_CODE = 'CKP_6000';
   
4、查询DM.DM_KPI_DATA_D表中数据
视图DM.V_DM_KPI_D_000211对应来源表DM.DM_KPI_D_000211
SELECT *
  FROM DM.DM_KPI_D_000211 T
 WHERE T.MONTH_ID = '201404'
   AND T.DAY_ID = '15'
   AND T.PROV_ID = '111'
   AND T.KPI_CODE = 'CKP_6000';
5、使用ALL_SOURCE查询对应包体或过程
SELECT * FROM ALL_SOURCE WHERE UPPER(TEXT) LIKE '%INSERT%INTO%DM_KPI_DATA_D%';
一般找OWNER='ZBA_DM_MAN'的，NAME 字段可能对应包，也可能对应的过程，一般找TYPE字段为PACKAGE BODY的


总结
1、沉淀表 
表名是S开头的（如：ZBA_DMA.S_DM_C_M_DEV_CB_BASE),直接通过配置表ZBA_DM_MAN.ISP_ENTITY_ETL_STG即可查询

SELECT * FROM ZBA_DM_MAN.ISP_ENTITY_ETL_STG WHERE DST_ENTITY_OWNER='ZBA_DMA' AND DST_ENTITY_NAME='S_DM_C_M_DEV_CB_BASE';
SELECT SUM(ACCT_USER) 
  FROM ZBG_DM.V_DM_C_M_DEV_CB_BASE@LINK_DSSDWE
 WHERE MONTH_ID='201506'
   AND PROV_ID='017'
   AND SERVICE_TYPE  =  '40AAAAAA'; --4502290

2、符合指标表
查到DM.DM_KPI_DATA_M 、DM.DM_KPI_DATA_D、ZBA_DMA.DM_KPI_COMP_D、ZBA_DMA.DM_KPI_COMP_M，即可直接从ZBA_DM_MAN.DMCODE_COMP_KPI表中直接查脚本
SELECT * FROM ZBA_DM_MAN.DMCODE_COMP_KPI T WHERE T.COMP_KPI_CODE = 'YDBG0049';--3G手机用户户均流量
若查得的结果是计算指标DECODE(NVL({UABG2302,AVG,0,-1},0),0,NULL,NVL({MSWG2026},0)/NVL({UABG2302,AVG,0,-1},0))，则需要将编码进行转换，继续查ZBA_DM_MAN.DMCODE_COMP_KPI表

如此处的UABG2302，先在ZBA_DM_MAN.DM_KPI_DETIAL_RELATION表中找到COMP_KPI_CODE对应的值，再在ZBA_DM_MAN.DMCODE_COMP_KPI中查找指标出处

SELECT * FROM ZBA_DM_MAN.DM_KPI_DETIAL_RELATION T WHERE T.KPI_CODE = 'UABG2302';--月编码转换表
SELECT * FROM ZBA_DM_MAN.DMCODE_COMP_KPI T WHERE T.COMP_KPI_CODE = 'CKP_782';



3、订购表
用ALL_SOURCE搜下,查询结果都是FROM的，一般都是通过订购跑的 ,通过配置表ZBA_DM_MAN.ISP_ENTITY_ETL查询

 SELECT * FROM ZBA_DM_MAN.ISP_ENTITY_ETL T WHERE T.DST_ENTITY_NAME = 'DM_KPI_ACC_AL_REV_SUM_M_1';
通过REPORT_ID或页面报表名称找SQL
16库
SELECT *
  FROM REPORT_NEW.INFO_REPORT
 WHERE REPORT_NAME LIKE '%2G数据与信息业务用户月报（逐月）%';
1.运行完之后点击如下图1红框所示部分，就可以看到报表加工代码如图2
图1

图2

2. 对图2代码做一些处理，就可以看到一段完整的SQL，从而找到来源表
	1. \\n ，\\r\\n替换为换行符；
	2. \\\ 替换为空
查询日志
DM层查询日志
SELECT /* + PARALLEL (A, 4)*/
*
  FROM ZBA_DM_MAN.DM_EXECUTE_LOG T
 WHERE T.PKG_NAME = 'PKG_DM_KPI_PORTAL_FIRE'
   AND T.ACCT_MONTH = '201504';
	 
DW层查询日志
SELECT *
  FROM ZB_DWA.ODS_EXECUTE_LOG
 WHERE PROCNAME LIKE 'P_DWA_C_M_BDSM_CHNLKPI_COL_BI'
   AND ACCT_MONTH = '201505'
   AND RESULT = 'SUCCESS'
 ORDER BY ENDDATE DESC;
Hadoop日志查询
/*月账单的加工过程已迁至Hadoop，4G全国是099*/
SELECT *
  FROM ZBG_DWA.ODS_EXECUTE_LOG_HD@LINK_DSSDWE
 WHERE ACCT_MONTH = '201602'
   AND PROCNAME = 'P_DWA_V_M_CUS_CB_USER_INFO'
业务知识理解补充
本地、长途、漫游区分
考虑元素： “本号码”归属地 、“通话号码”归属地、“本号码”到访地
本地(市话)：
公式：“本号码”归属地=“本号码”到访地 且 “本号码”归属地= “通话号码”归属地。
描述：在“本号码”归属地拨打与“本号码”相同的归属地的号码，在“本号码”归属地接听所有电话都是本地市话。
长途：
公式：“本号码”归属地 = “本号码”到访地 且 “本号码”归属地<> “通话号码”归属地。
描述：在“本号码”归属地拨打与“本号码”不同的归属地的号码。
漫游：
首要条件：“本号码”归属地<> “本号码”到访地。不在“本号码”归属地拨打接听的所有通话。
漫游本地：
公式：“本号码”归属地<> “本号码”到访地 且 “本号码”归属地 = “通话号码”归属地。
描述：在漫游地（非“本号码”归属地，到访地）拨打与“本号码”相同的归属地的号码。
漫游长途：
公式：“本号码”归属地<> “本号码”到访地 且 “本号码”归属地 <> “通话号码”归属地。
描述：在漫游地（非“本号码”归属地，到访地）拨打与“本号码”不同的归属地的号码。

分星级模型加工口径
描述：根据星级评定沉淀结果，标记用户所属星级，分为：一星、二星、三星、四星、五星、未评星。星级评分规则为综合得分按照码表进行等级划分，综合得分是根据平均值和网龄以及相关系数计算得出。
MB_VALUE_A=30
综合得分分档：
MB_VALUE_B=90
MB_VALUE_C=140
MB_VALUE_D=260
根据综合得分分档评定等级：
CASE WHEN INTEGRATE_SCORE >= MB_VALUE_A AND INTEGRATE_SCORE< MB_VALUE_B THEN ''2''
           WHEN INTEGRATE_SCORE >= MB_VALUE_B AND INTEGRATE_SCORE< MB_VALUE_C THEN ''3''
          WHEN INTEGRATE_SCORE >= MB_VALUE_C AND INTEGRATE_SCORE< MB_VALUE_D THEN ''4''
          WHEN INTEGRATE_SCORE >= MB_VALUE_D  THEN ''5''
ELSE ''1'' END USER_LEVEL , --用户等级
根据网龄和平均值计算综合得分：					  
CASE WHEN INNET_MONTHS > 60 THEN AVG_ARPU*2
          WHEN INNET_MONTHS >=49 AND INNET_MONTHS <=60 THEN AVG_ARPU*1.9
          WHEN INNET_MONTHS >=37 AND INNET_MONTHS <=48 THEN AVG_ARPU*1.7
          WHEN INNET_MONTHS >=25 AND INNET_MONTHS <=36 THEN AVG_ARPU*1.5
          WHEN INNET_MONTHS >=13 AND INNET_MONTHS <=24 THEN AVG_ARPU*1.1
ELSE AVG_ARPU END INTEGRATE_SCORE, --综合得分  
定义收入分档
THIS_FEE   ,------本月
LAST_FEE   , ----上月
LAST2_FEE  , ----上2个月
LAST3_FEE  , ----上3个月
LAST4_FEE  , ----上4个月
LAST5_FEE  , ----上5个月
LAST6_FEE  , ----上6个月
LAST7_FEE  , ----上7个月
LAST8_FEE  , ----上8个月
LAST9_FEE  , ----上9个月
LAST10_FEE , ----上10个月
LAST11_FEE ,----上11个月
根据网龄和分档收入计算平均值：
CASE WHEN A.INNET_MONTHS >= 12 THEN (THIS_FEE + LAST_FEE + LAST2_FEE + LAST3_FEE + LAST4_FEE + LAST5_FEE + LAST6_FEE + LAST7_FEE + LAST8_FEE + LAST9_FEE + LAST10_FEE + LAST11_FEE)/12
          WHEN A.INNET_MONTHS = 11 THEN (THIS_FEE + LAST_FEE + LAST2_FEE + LAST3_FEE + LAST4_FEE + LAST5_FEE + LAST6_FEE + LAST7_FEE + LAST8_FEE + LAST9_FEE + LAST10_FEE)/11  
          WHEN A.INNET_MONTHS = 10 THEN (THIS_FEE + LAST_FEE + LAST2_FEE + LAST3_FEE + LAST4_FEE + LAST5_FEE + LAST6_FEE + LAST7_FEE + LAST8_FEE + LAST9_FEE)/10
          WHEN A.INNET_MONTHS = 9 THEN (THIS_FEE + LAST_FEE + LAST2_FEE + LAST3_FEE + LAST4_FEE + LAST5_FEE + LAST6_FEE + LAST7_FEE + LAST8_FEE)/9
          WHEN A.INNET_MONTHS = 8 THEN (THIS_FEE + LAST_FEE + LAST2_FEE + LAST3_FEE + LAST4_FEE + LAST5_FEE + LAST6_FEE + LAST7_FEE)/8
          WHEN A.INNET_MONTHS = 7 THEN (THIS_FEE + LAST_FEE + LAST2_FEE + LAST3_FEE + LAST4_FEE + LAST5_FEE + LAST6_FEE)/7
          WHEN A.INNET_MONTHS = 6 THEN (THIS_FEE + LAST_FEE + LAST2_FEE + LAST3_FEE + LAST4_FEE + LAST5_FEE)/6
END AVG_ARPU  --平均值
根据以上评定规则，
一星：综合得分小于30
二星：综合得分大于等于30小于90
三星：综合得分大于等于90小于140
四星：综合得分大于等于140小于260
五星：综合得分大于等于260
相关过程：ZBA_DWA.P_DWA_V_M_CUS_MB_VALUE_LIST
ZBA_DWA.P_DWA_V_M_CUS_MB_STAR_LIST、
ZBA_DWA.P_DWA_V_M_CUS_MB_VALUE、
ZBA_DWA.P_DWA_V_M_CUS_MB_AVG_ARPU 、
ZBA_DWA.P_DWA_V_M_CUS_MB_FEE_HIS
稳定度模型加工口径
用户稳定度定义：
根据得分情况升序排名等分三区间
第一区间为 03
第二区间为 02 
第三区间为 01
CASE WHEN SUM(COUNT(1)) OVER ( ORDER BY ROUND(USER_SCORE))/SUM(COUNT(1)) OVER (PARTITION BY 1) <= 0.3333 THEN '03'
     WHEN SUM(COUNT(1)) OVER ( ORDER BY ROUND(USER_SCORE))/SUM(COUNT(1)) OVER (PARTITION BY 1) >= 0.6666 THEN '01'
    ELSE '02'
END STABLE_FLAG
计算得分参数：
LAST_STOP_DATE	  --最近一次停机日期
INNET_MONTH       --在网时长 
CALL_RATIO        --语音使用度 
STREAM_RATIO      --流量使用度
ACCT_FEE          --出账费用
JF_TIMES          --计费时长
TOTAL_FLUX        --总流量
FLUX_34G_CN       --
ACCT_CN           --出账费用较上月使用增长比例
FLUX_CN           --流量较上月使用增长比例
TIMES_CN          --计费时长较上月使用增长比例
VALID_CALL_RING   --有效交往圈
YIWANG_CNT        --与异网通话次数
DEV_NUM_SHANG     --号码熵
CHANNEL_TYPE      --发展渠道类型
AGREE_EXP         --合约到期时间
TERM_TYPE         --终端类型
USE_STATUS_INNET  --在网使用情况
LAST_IS_ACCT      --上期是否出账
IF_MBTOCB         --是否来自迁转
MEMBER_LVL        --俱乐部会员级别
P2P_SMS_CNT       --点对点短信次数
NET_TYPE          --终端网络制式
MANU_NAME         --终端品牌
计算得分规则：
100-ROUND(1/(1+EXP(-(
   -0.008729 * LAST_STOP_DATE + 
   -0.149 * INNET_MONTH + 
   0.01835 * CALL_RATIO + 
   0.5156 * STREAM_RATIO + 
   0.6046 * ACCT_FEE + 
   0.1052 * JF_TIMES + 
   0.1005 * TOTAL_FLUX + 
   -0.1275 * FLUX_34G_CN + 
   0.1441 * ACCT_CN + 
   -0.3166 * FLUX_CN + 
   -0.08298 * TIMES_CN + 
   -0.2049 * VALID_CALL_RING + 
   -0.05078 * YIWANG_CNT + 
   0.5767 * DEV_NUM_SHANG + 
   0.3875 * (CASE WHEN CHANNEL_TYPE=1 THEN 1 ELSE 0 END) + 
   -2.693 * (CASE WHEN AGREE_EXP=0 THEN 1 ELSE 0 END) + 
   -0.1746 * (CASE WHEN TERM_TYPE='2G' THEN 1 ELSE 0 END) + 
   -0.1197 * (CASE WHEN TERM_TYPE='3G' THEN 1 ELSE 0 END) + 
   -0.4091 * (CASE WHEN USE_STATUS_INNET=1 THEN 1 ELSE 0 END) + 
   -0.3208 * (CASE WHEN USE_STATUS_INNET=2 THEN 1 ELSE 0 END) + 
   0.09374 * (CASE WHEN LAST_IS_ACCT=0 THEN 1 ELSE 0 END) + 
   -0.4012 * (CASE WHEN IF_MBTOCB=0 THEN 1 ELSE 0 END) + 
   0.2622 * (CASE WHEN MEMBER_LVL=0 THEN 1 ELSE 0 END) + 
   0.147 * (CASE WHEN P2P_SMS_CNT=0 THEN 1 ELSE 0 END) + 
   0.2458 * (CASE WHEN NET_TYPE=0 THEN 1 ELSE 0 END) + 
   0.1637 * (CASE WHEN MANU_NAME=0 THEN 1 ELSE 0 END) + 
   -1.12
)))*100,2) USER_SCORE
根据以上评定规则，得分越高的用户稳定度值越低。
相关过程：
ZBA_DEV.P_DWA_V_M_4G_LOST_END
ZBA_DEV.P_DWA_V_M_3G_LOST_END
ZBA_DEV.P_DYL_2G_LOST_FLAG_END2
用户价值标签分类规则
根据星级评定模型和用户稳定度模型，对用户进行分类，分为：黄金用户、高危用户、波动用户、低端用户、潜力用户、潮汐用户。
组合规则为：
              黄金客户：5-1，4-1
              高危客户：5-3，4-3，3-3
              波动客户：5-2，4-2，3-2
              低端客户：2-3，1-2，2-2
              潜力客户：3-1，2-1，1-1
              潮汐客户：1-3
 其中，5-1 的含义为：星级取值为5，稳定性取值为01的用户
